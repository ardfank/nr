<?php
include ('../include/API.php');

function cektop($conn) {
    $conn = $conn;
    $prop = $_POST['kode_prov1'];
    $route = $_POST['route'];
    $distid = str_replace("0", "", $_SESSION['distr_id']);
    $jenis_kemasan = $_POST['jenis_kemasan'];
    if ($route == 'ZR0001') {
        $routess = 'sea';
    } else {
        $routess = 'land';
    }
    $sqlget1 = "select TOP,NAME_KEY from (select *  from OR_MAP_TOP
                left join ZREPORT_M_PRICE ON KEY = TOP AND ZREPORT_M_PRICE.DELETE_MARK = 0
                WHERE MATERIAL = '" . $jenis_kemasan . "' 
                AND (DISTRIBUTOR_ID = '" . $distid . "' OR DISTRIBUTOR_ID = 'all') 
                AND (KODE_PROP = '" . $prop . "' OR KODE_PROP = 'all') 
                AND (ROUTE = '" . $routess . "' OR ROUTE = 'all') ) a 
                where KODE_PROP <> 'all' or DISTRIBUTOR_ID <> 'all' or ROUTE <> 'all'";
    $queryget1 = oci_parse($conn, $sqlget1);
    oci_execute($queryget1);
    $top = oci_fetch_assoc($queryget1);
    if (!$top) {
        $sqlget2 = "select TOP,NAME_KEY from OR_MAP_TOP 
                    left join ZREPORT_M_PRICE ON KEY = TOP AND ZREPORT_M_PRICE.DELETE_MARK = 0
                    WHERE MATERIAL = '" . $jenis_kemasan . "' 
                    AND DISTRIBUTOR_ID = 'all' 
                    AND KODE_PROP = 'all' 
                    AND ROUTE = 'all'";
        $queryget2 = oci_parse($conn, $sqlget2);
        oci_execute($queryget2);
        $top = oci_fetch_assoc($queryget2);
    }
    return $top;
}

function botTelegram($chatid, $pesan) {
    $TOKEN = "836107993:AAFQkgrAsgtYmElWAg89z2rhGpJHi_0j_1o"; //token 
    $chatid = $chatid; //id chat
    $pesan = $pesan;  //"TestKirim\n\nTestKirim"; //pesan
    // ----------- code -------------
    $method = "sendMessage";
    $url = "https://api.telegram.org/bot" . $TOKEN . "/" . $method;
    $post = array(
        'chat_id' => $chatid,
        // 'parse_mode' => 'HTML', // aktifkan ini jika ingin menggunakan format type HTML, bisa juga diganti menjadi Markdown
        'text' => $pesan
    );
    $header = array(
        "X-Requested-With: XMLHttpRequest",
        "User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.84 Safari/537.36"
    );
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_URL, $url);
    //curl_setopt($ch, CURLOPT_REFERER, $refer);
    //curl_setopt($ch, CURLOPT_VERBOSE, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $header);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    $datas = curl_exec($ch);
    $error = curl_error($ch);
    $status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    $debug['text'] = $pesan;
    $debug['code'] = $status;
    $debug['status'] = $error;
    $debug['respon'] = json_decode($datas, true);

    return $debug;
}

function insertPOSBI($param = array()) {
    if (!empty($param)) {
        $options = array('login' => 'revelino', 'password' => 'semenindonesia1');
        // $wsdl = 'wsdl_qas_sbi_insert_po.xml'; // bapi
        $wsdl = 'wsdl_qas_sbi_insert_zpo.xml'; // zbapi
        try {
            $soap = new SoapClient($wsdl, $options);
            $fce = new stdClass();

            $fce = $param;
            $return = $soap->SI_ZPO_Create($fce);

            return array("success" => true, "return" => $return);
        } catch (SoapFault $eX) {
//            echo "<pre>";
//            print_r($eX);
            // return $eX->faultstring;
            return $eX;
        }
    } else
        return array("success" => false, "msg" => "No parameter!");
}

switch ($action) {
    case "tambah":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            $user_org_in = $_SESSION['user_org'];
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = $_POST['cara_bayar'];
            $branch_plant_in = $_POST['branch_plant'];
            $nama_plant_in = trim($_POST['nama_plant']);
            $jenis_kirim_in = $_POST['jenis_kirim'];
            $nama_kirim_in = $_POST['jenis_kirim'];
            $nama_kirim_in = $_POST['nama_kirim'];
            $sold_to_in = $_POST['sold_to'];
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = $_POST['nama_sold_to'];
            $route_in = $_POST['route'];
            $plant = $_POST['plant'];
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = $_POST['so_type'];
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = $_POST['kd_kapal'];
            $nm_kapal = $_POST['nm_kapal'];
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $no_pp_in = $fungsi->or_new_pp_number($conn);

            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE');
            $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);

            $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

            if ($user_org_in == '6000' && $no_pp_in != '') {
                $aksicetak = "../or_laporan/cetak_hargatebus.php?pporder=$no_pp_in";
            }

            $pesan_telegram = "";
            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "qty" . $k;
                $uom = "uom" . $k;
                $tgl_kirim = "tgl_kirim" . $k;
                $polisinumber = "nopol" . $k;
                $driverlicen = "drivernamenopol" . $k;
                $simdriverlicen = "simdrivernamenopol" . $k;
                $typetruk = "tipetruk" . $k;
                $catatk = "val_addnote" . $k;
                $ktprodukff = "ktproduk" . $k;

                if (isset($_POST[$shipto])) {
                    $tgl_kirim_in = $_POST[$tgl_kirim];
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $shipto_in = $_POST[$shipto];
                    $nama_shipto_in = $_POST[$nama_shipto];
                    $alamat_in = $_POST[$alamat];
                    $produk_in = $_POST[$produk];
                    $kode_distrik_in = $_POST[$kode_distrik];
                    $nama_distrik_in = $_POST[$nama_distrik];
                    $kode_prov_in = $_POST[$kode_prov];
                    $nama_prov_in = $_POST[$nama_prov];
                    $nama_produk_in = $_POST[$nama_produk];
                    $qty_in = $_POST[$qty];
                    $uom_in = $_POST[$uom];
                    $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                    $drivernamenopol_in = trim($_POST[$driverlicen]);
                    $simdrivernamenopol_in = trim($_POST[$simdriverlicen]);
                    $typetruk_in = $_POST[$typetruk];
                    $catatkval = trim($_POST[$catatk]);
                    $ktprodukffval = trim($_POST[$ktprodukff]);

//                                $catatkval=$drivernamenopol_in."|".$simdrivernamenopol_in."|".$catatkval;

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                    $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$nopolisi_in", "$typetruk_in", "$catatkval", "$ktprodukffval", "$drivernamenopol_in", "$simdrivernamenopol_in");
                    $tablename = "OR_TRANS_DTL";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);

                    $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";

                    $pesan_telegram .= "PP Baru OPEN (PP $no_pp_in)\nDistributor : $nama_sold_to_in \nShipto : $nama_shipto_in \nTipe Order : $nama_so_type \nMaterial : $nama_produk_in \nQty : $qty_in $uom_in \nKet : $ket";
                }

                if ($user_org_in == 4000) {
                    botTelegram('-394888712', $pesan_telegram);
                }
            }
        }
        if (isset($_POST['lasthalaman'])) {
            $habis = "tambah2.php";
        } else {
            $habis = "tambah.php";
        }
        break;
//============================================================================================================================
//========================================================================================================
    case "buatsoadmin_oto":

        // CEK MAPPING PLANT ADA ATAU TIDAK
        $plantcek = $_POST['plant'];
        $str = "SELECT * FROM ZMD_MAPPING_PLANT
        WHERE PLANT_MD = '{$plantcek}' AND  DEL=0
        ";
        $query = oci_parse($conn, $str);
        oci_execute($query);
        $row = oci_fetch_array($query, OCI_ASSOC);
        $lanjut = 'Y';
        $next = 'Y';
        $SO1 = '';
        $IDH1 = '';
        $SO2 = '';
        $IDH2 = '';
        $SO3 = '';
        $IDH3 = '';
        $SO4 = '';
        $IDH4 = '';
        $jerror = 0;
        $SOMDNE = "N";

            $user_name_in = $_SESSION['user_name'];
        $no_pp = $fungsi->or_new_pp_number($conn);

        if (count($row) > 0) {
            // CEK MAPPING CUSTOMER ADA ATAU TIDAK
            $soldtocek = $_POST['sold_to'];
            $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'";
            $querysoldto = oci_parse($conn, $strsoldto);
            oci_execute($querysoldto);
            $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
            if (count($rowsoldto) < 1) {
                $lanjut = 'N';
                $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
            }
        } else {
            $lanjut = 'N';
            $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
            ;
        }


        // CEK ICS
        if ($row["COM_MD_2"] != "" && $row["PLANT_MD_2"] != "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 3;
            $ics = "Y";
            $loncat = "N";
        } else if ($row["COM_MD_2"] == "" && $row["PLANT_MD_2"] == "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 2;
            $ics = "Y";
            $loncat = "Y"; /// MD @ tidak di pakai
        } else {
            $perulangan = 3;
            $perulanganSO = 2;
            $perulanganPO = 1;
            $ics = "N";
            $loncat = "N";
        }
        // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
        if ($lanjut == 'Y') {
            // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
            for ($ul = 1; $ul <= $perulangan; $ul++) {

                if ($next == 'Y') {

                    $incoterm1 = $_POST['incoterm'];
                    $incoterm2 = $_POST['nama_incoterm'];
                    $route     = $_POST['route'];
                    $top       = $_POST['top'];
                    $nama_top  = $_POST['nama_top'];
                    
                    if ($ul == 1) {
                        $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $soldto = $_POST['sold_to'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
                        $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2 
                    } else if ($ul == 2 || $ul == 3) {
                        $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2 
                        $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org2 = $row['COM_OPCO'];
                        $plant2 = $row['PLANT_OPCO'];
                        $incotermPO1 = $incoterm1;
                        $incotermPO12 = $incoterm2;
                    } else if ($ul == 3 && $ics == "Y") {
                        $sales_org = $row['COM_MD_2'];
                        $plant = $row['PLANT_MD_2'];
                        $soldto = $rowsoldto['SOLD_TO_MD_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org3 = $row['COM_MD_2'];
                        $plant3 = $row['PLANT_MD_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['route'];
                        //penambahan rute dan top
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                    } else if ($ul == 4 && $ics == "Y") {
                        $sales_org = $row['COM_OPCO_2'];
                        $plant = $row['PLANT_OPCO_2'];
                        $soldto = $rowsoldto['SOLD_TO_OPCO_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org4 = $row['COM_OPCO_2'];
                        $plant4 = $row['PLANT_OPCO_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        //penambahan rute dan TOP
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        $topPO2    = $top;
                        //penambahan rute top
                        $incotermPO2  = $incoterm1;
                        $incotermPO22 = $incoterm2;
                        
                    }

                    $user_name = $_SESSION['user_name'];
                    $idh = $_POST['idh'];
                    $iddtl = $_POST['iddtl'];
                    $so_type = $_POST['so_type'];
                    $toko = $_POST['shipto1'];
                    //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        //echo $sap->PrintStatus();
                        exit;
                    }

                    $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
                    if ($fce1 == false) {
                        $sap->PrintStatus();
                        exit;
                    }

                    //header entri

                    $fce1->ZNMORG = $sales_org;
                    $fce1->ZKUNNR = $toko;
                    $fce1->Call();
                    if ($fce1->GetStatus() == SAPRFC_OK) {
                        $fce1->RETURN_DATA->Reset();
                        while ($fce1->RETURN_DATA->Next()) {
                            $sales_grp = $fce1->RETURN_DATA->row["VKGRP"];
                        }
                    }
                    //xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                    $nama_so_type = $_POST['nama_so_type'];
                    $ket = trim($_POST['keterangan']);
                    $channelnew = $_POST['channels'];
                    if ($so_type == 'ZEX') {
                        $distr_chan = "30";
                    } elseif ($so_type == 'ZPR') {
                        if ($sales_org == '2000') {
                            $distr_chan = "10";
                        } else if ($sales_org == '3000' || $sales_org == '5000' || $sales_org == '7000' || $sales_org == '7900' || $sales_org == '4000') { // tambahan pak yusuf untuk bisa memilih dist channel proyek MD
                            $distr_chan = $_POST['channels'];
                        } else if ($sales_org == '6000') {
                            $distr_chan = "10";
                        } else {
                            $distr_chan = "50";
                        }
                    } elseif ($so_type == 'ZPR1') {
                        $distr_chan = "50";
                        $so_type == 'ZPR';
                    } else {
                        $distr_chan = "10";
                    }
                    $division = "00";
                    $dlv_block = "";
                    $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
                    if ($distr_chancondi != '') {
                        $distr_chan = $distr_chancondi;
                    }
                    if ($channelnew != '') {
                        $distr_chan = $channelnew;
                    }


                    $distr_chanPO1 = $distr_chan;
                    if ($ul == 3 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                    } else if ($ul == 4 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                        $distr_chanPO2 = $distr_chan;
                    }
                    $nama_sold_to = $_POST['nama_sold_to'];
                    $tgl_pp = date("d-m-Y");
                    list($day, $month, $year) = split("-", $tgl_pp);
                    $tgl_pp = $year . $month . $day;
                    //$tanggal=gmdate("Ymd",time()+60*60*7);
                    
                    $reason = $_POST['reason'];
                    $nama_reason = $_POST['nama_reason'];
                    $oldso = $_POST['oldso'];
                    //$shipment=$_POST['shipment'];
                    $price_datep = $_POST['price_date'];
                    list($dayp, $monthp, $yearp) = split("-", $price_datep);
                    $price_date = $yearp . $monthp . $dayp;


                    $nama_plant = trim($_POST['nama_plant']);
                    //$route = $_POST['route'];
                    $kd_kapal = $_POST['kd_kapal'];
                    $nm_kapal = $_POST['nm_kapal'];
                    $nama_kapal = $kd_kapal . '-' . $nm_kapal;
                    $pricelist = $_POST['pricelist'];
                    $nama_pricelist = $_POST['nama_pricelist'];
                    $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
                    $valperlcnum = trim($_POST['perslcnum']);
                    $lcnum = $_POST['lcnum'];
                    $lcnum = $fungsi->sapcode($lcnum);
                    $sampai1 = $_POST['jumlah'];
                    $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
                    for ($j = 0; $j <= $sampai1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $kontrakh = $_POST['com_kontrak' . $j];
                        }
                        $nilai_kontrak = $_POST['com_kontrak' . $j];
                    }

                    $sisa_kredit_limit = $_POST['sisa_cl'];
                    $hutang_jt = $_POST['hutang_jt'];
                    $umur_jt = $_POST['umur_hutang_jt'];

                    //cek sisa QTY kontrak
                    if ($nilai_kontrak <> '') {
                        $sap = new SAPConnection();
                        $sap->Connect("../include/sapclasses/logon_data.conf");
                        if ($sap->GetStatus() == SAPRFC_OK)
                            $sap->Open();
                        if ($sap->GetStatus() != SAPRFC_OK) {
                            $sap->PrintStatus();
                            exit;
                        }

                        $fce = $sap->NewFunction("Z_ZAPPSD_KONTRAK_SI ");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }
                        $fce->XVKORG = $sales_org;
                        $fce->XVBELN = $nilai_kontrak; //"kontrak";
                        $fce->XKUNNR = $soldto; //"dist";
                        $fce->XFLAG = 'O'; //open
                        $fce->Call();

                        $fce->RETURN_DATA->Reset();
                        while ($fce->RETURN_DATA->Next()) {
                            $qty = $fce->RETURN_DATA->row["KWMENG"];
                            $real = $fce->RETURN_DATA->row["RFMNG"];
                            $sisa = $qty - $real;
                        }
                        $fce->Close();
                        $sap->Close();
                    }

                    //$show_ket .= "Melebihi sisa kontrak = ".$sisa."Qty=".$qty."REAL".$real;

                    if ($sisa < $_POST['com_qty1'] and $nilai_kontrak <> '') {
                        $show_ket .= "Melebihi sisa kontrak = " . $sisa . " dan Qty So = " . $_POST['com_qty1'];
                        $next = 'N';
                    }
                    //end cek kontrak
                    //call bapi sales order sap
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        $sap->PrintStatus();
                        exit;
                    }

                    // PROSES FOR 1 DAN 2 MENYIMPAN SO

                    if ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) {
                        $COM = 'MD';
                    } else {
                        $COM = 'SBI';
                    }

                    if ($ul <= $perulanganSO && $COM == 'MD') {
                        if ($loncat == "N") {
                            $gass = "Y";
                        } else if ($loncat == "Y") {
                            if ($ul == 3) {
                                $gass = "N";
                            } else {
                                $gass = "Y";
                            }
                        }

                        if ($gass == "Y") { // loncat tidak membuat SO MD 2 karena tidak di mammping plant
                            $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
                            if ($fce == false) {
                                $sap->PrintStatus();
                                exit;
                            }



                            //header entri
                            if ($so_type == 'ZFC') {
                                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
                            } else {
                                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                            }

                            $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
                            $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
                            $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
                            $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
                            $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                            $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
                            $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
                            $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
                            $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
                            $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
                            $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
                            $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
                            $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
                            $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
                            //$fce->ORDER_HEADER_IN["COLLECT_NO"] = $oldso;
                            $fce->ORDER_HEADER_IN["REF_1"] = $oldso;
                            $fce->ORDER_HEADER_IN["PRICE_DATE"] = $price_date;
                            $fce->ORDER_HEADER_IN["SALES_GRP"] = $sales_grp;

                            if ($sales_org == "7900" || $sales_org == "7000") {
                                $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
                                $querytax = oci_parse($conn, $strtax);
                                oci_execute($querytax);
                                $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
                                if (ISSET($rowtax["KD_SOLD_TO"])) {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                } else {
                                    if ($so_type == 'ZFC') {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                    }else{
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1";    
                                    }
                                }

//                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
                            }

                            if ($lcnum != '') {
                                $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                                $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
                                //$fce->ORDER_HEADER_IN["DEPARTM_NO"] = 9;
                                $fce->ORDER_HEADER_IN["REC_POINT"] = 2;
                            }
//                            if ($kontrakh != '' && $sales_org =="7900") {
//                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
//                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
//                            }
                            if ($kontrakh != '') {
                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
                            }

                            //detail entri item'
                            $sampai = $_POST['jumlah'];
                            $shipto_awal = '';
                            for ($j = 1; $j <= $sampai; $j++) {
                                $item_num = $j;
                                $shipto_awal = $_POST['shipto1'];
                                $shipto = "shipto" . $j;
                                $kode_distrik = "kode_distrik" . $j;
                                $produk = "produk" . $j;
                                $produk = $_POST[$produk];
                                $qty = "com_qty" . $j;
                                $tgl_kirim = "tgl_kirim" . $j;
                                $kontrak = "com_kontrak" . $j;
                                $posnr = "com_posnr" . $j;
                                $shp = "com_shipment" . $j;
                                //if(isset($_POST[$shipto])){
                                $tgl_kirim = $_POST['tgl_kirim' . $j];
                                list($day, $month, $year) = split("-", $tgl_kirim);
                                $tgl_kirim = $year . $month . $day;
                                if ($ul == 1) {
                                    $shipto = $_POST['shipto' . $j];     // GANTI BERDASARKAN MAPPING CUSTOMER 
                                    $produk1 = $_POST['produk' . $j];
                                } else if ($ul == 2) {
                                    $shiptotocek = $_POST['shipto' . $j];
                                    
                                    $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                    $queryshipto = oci_parse($conn, $strshipto);
                                    oci_execute($queryshipto);
                                    $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                    if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                        $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                        $queryshipto = oci_parse($conn, $strshipto);
                                        oci_execute($queryshipto);
                                        $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                    }
                                    if ($ul == 2) {
                                        $shipto = $rowshipto['SHIP_TO_OPCO'];
                                        $soldto = $rowshipto['SOLD_TO_OPCO'];
                                    } else if ($ul == 3) {
                                        $shipto = $rowshipto['SHIP_TO_MD_2'];
                                        $soldto = $rowshipto['SOLD_TO_MD_2'];
                                    } else if ($ul == 4) {
                                        $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                        $soldto = $rowshipto['SOLD_TO_OPCO_2'];
                                    }



                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                    $querymaterial = oci_parse($conn, $strmaterial);
                                    oci_execute($querymaterial);
                                    $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                    if ($ul == 2) {
                                        $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                    } else if ($ul == 3) {
                                        $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                    } else if ($ul == 4) {
                                        $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                    }
//                                    print_r($rowmaterial);
//                                    print_r($sales_org1);
//                                    print_r($plant1);
//                                    print_r($produk1);
                                }
                                $shipto = $fungsi->sapcode($shipto);
                                $kode_distrik = $_POST[$kode_distrik];
                                $qty = $_POST[$qty];

//                                if($sales_org=="7900"){ 
//                                    $kontrak = $_POST[$kontrak];
//                                }else{
//                                    $kontrak = "";
//                                }
                                $kontrak = $_POST[$kontrak];

                                //$posnr=$fungsi->linenum($_POST[$posnr]);
                                $posnr = "10";
                                $shipment = $_POST[$shp];

                                //$show_ket .= "shipto $shipto / kode_distrik $kode_distrik / produk $produk / qty $qty / route $route / plant $plant<br>";

                                $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $produk;

                                $fce->ORDER_ITEMS_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_ITEMS_INX->row["UPDATEFLAG"] = 'I'; //'000010';
                                $fce->ORDER_ITEMS_INX->row["MATERIAL"] = 'X';
                                if ($so_type == 'ZFC') {
                                    $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                                    if ($sales_org == '6000') {
                                        $ITEM_CATEGvali = 'ZKNN';
                                    } else if ($sales_org == '4000' || $sales_org == '3000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900') {
                                        $ITEM_CATEGvali = 'ZKLN';
                                    } else {
                                        $ITEM_CATEGvali = 'ZKNN';
                                    }
                                            if($sales_org=='7900' || $sales_org=='7000'){
                                                $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";    // Tambahan MD 
                                            }    
                                    $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;                   
                                }
                                $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                                   
                                $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

                                $fce->ORDER_ITEMS_INX->row["PLANT"] = 'X';
                                $fce->ORDER_ITEMS_INX->row["ROUTE"] = 'X';

                                // Penambahan
                                $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $kode_distrik; // penambahan distrik
                                $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($kode_distrik, 0, 2);

//                                if ($kontrak != '' && $sales_org == "7900") {
//                                    $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
//                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
//                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
//
//                                    $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
//                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
//                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
//                                }
                                if ($kontrak != '') {
                                    $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';

                                    $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
                                }

                                // @liyantanto buat tlcc
//                if ($lcnum!='') {
//                    $fce->ORDER_ITEMS_IN->row["DEPREC_PER"] = $valperlcnum;
//                    $fce->ORDER_ITEMS_INX->row["DEPREC_PER"] = 'X';
//		} 
                                //if ($reason =='Z02') {
                                //$show_ket .= " shp nya euii ". $shipment;
                                //$fce->ORDER_ITEMS_IN->row["REF_1_S"] = $shipment;
                                //$fce->ORDER_ITEMS_INX->row["REF_1_S"] ='X';
                                //}		

                                $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);
                                $fce->ORDER_ITEMS_INX->Append($fce->ORDER_ITEMS_INX->row);

                                //detail entri schedule n qty'
                                $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                                $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                                $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);
//		if ($reason =='Z02') {
                                $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                                $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                                $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                                $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);
//		}
                                //detail entri distributor dan agen
                                if ($j == 1)
                                    $item_num = '000000';
                                else
                                    $item_num = $item_num;
                                $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                                //}
                            }

                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto_awal;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                            $fce->Call();
                            if ($fce->GetStatus() == SAPRFC_OK) {
                                $nomorso = $fce->SALESDOCUMENT;
                                $fce->RETURN->Reset();
                                while ($fce->RETURN->Next()) {
                                    $tipe = $fce->RETURN->row["TYPE"];
                                    $msg = $fce->RETURN->row["MESSAGE"];
                                    if ($tipe != 'S') {
                                        $show_ket .= $msg;
                                        $show_ket .= '<br>';
                                    }
                                }
                                //Commit Transaction
                                $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fcecom->Call();
                                $fcecom->Close();

                                //Update SO
                                if ($nomorso != '' && $j > 1) {
                                    sleep(5); //seconds to wait..   
                                    $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                    $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                                    $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                                    $fce->Call();

                                    //Commit Transaction
                                    $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                    $fce->Call();
                                }

                                if ($sales_org == '6000') {
                                    sleep(5); //seconds to wait..
                                    //Teks
                                    unset($tgl_kirimapp);
                                    for ($j = 1; $j <= $sampai; $j++) {
                                        $item_num1 = $j * 10;
                                        $item_num = $fungsi->linenum($item_num1);
                                        $com_nopolisiv = trim($_POST['nopol' . $j]);
                                        $com_drivernamenopolv = trim($_POST['drivernamenopol' . $j]);
                                        $com_simdrivernamenopolv = trim($_POST['simdrivernamenopol' . $j]);
                                        $com_typetruckv = trim($_POST['tipenopol' . $j]);
                                        $com_catatanv = trim($_POST['val_addnote' . $j]);
                                        $com_kodekantong = trim($_POST['ktproduk' . $j]);
                                        $tgl_kirimappT = trim($_POST['tgl_kirim' . $j]);
                                        list($day, $month, $year) = split("-", $tgl_kirimappT);
                                        $tgl_kirimapp .= $year . $month . $day . "!";


                                        $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                        $fce->I_VBELN = $nomorso; //'000010';
                                        $fce->I_POSNR = sprintf("%06d", $item_num); //'000010';
                                        $fce->I_TEXT1 = $com_nopolisiv;
                                        $fce->I_TEXT2 = $com_typetruckv;
                                        $fce->I_TEXT3 = $com_catatanv;
                                        $fce->I_TEXT4 = $com_kodekantong;
                                        $fce->I_TEXT6 = $com_drivernamenopolv;
                                        $fce->I_TEXT7 = $com_simdrivernamenopolv;
                                        $fce->Call();
//                            echo "<pre>";
//                            print_r($fce);
//                            echo "</pre>";
                                    }

                                    if ($sales_org == '6000' && $nomorso != '') {
                                        $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                                    }
                                }
                            }
                            if ($ul == 1 || $ul == 3) {
                                $numbering = $ul . ". SO MD = ";
                            } else {
                                $numbering = $ul . ". SO OPCO = ";
                            }
                            if ($next == 'Y') {
                                $show_ket .= $numbering . 'Sales Order has been made with a number : ' . $nomorso . '<br>';
                            }

                            //update no shipment ke so
                            if ($reason == 'Z02') {
                                $sap = new SAPConnection();
                                $sap->Connect("../include/sapclasses/logon_data.conf");
                                if ($sap->GetStatus() == SAPRFC_OK)
                                    $sap->Open();
                                if ($sap->GetStatus() != SAPRFC_OK) {
                                    $sap->PrintStatus();
                                    exit;
                                }

                                $fce1 = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                if ($fce1 == false) {
                                    $sap->PrintStatus();
                                    exit;
                                }
                                $fce1->SALESDOCUMENT = $nomorso; //"ZOR";
                                $fce1->ORDER_HEADER_INX["UPDATEFLAG"] = 'U'; //"Z1";

                                $sampai = $_POST['jumlah'];
                                for ($j = 1; $j <= $sampai; $j++) {
                                    $idke = "idke" . $j;
                                    $item_num1 = $j;
                                    $id_dtl = $_POST['com_iddtl' . $j];
                                    $item_num = $fungsi->linenum($item_num1 * 10);
                                    $nospj = $_POST['com_shipment' . $j];

                                    //update detail item
                                    $fce1->ORDER_ITEM_INX->row["UPDATEFLAG"] = 'U';
                                    $fce1->ORDER_ITEM_INX->row["ITM_NUMBER"] = $item_num;
                                    $fce1->ORDER_ITEM_INX->row["REF_1_S"] = 'X';
                                    $fce1->ORDER_ITEM_INX->Append($fce1->ORDER_ITEM_INX->row);

                                    $fce1->ORDER_ITEM_IN->row["ITM_NUMBER"] = $item_num; //'000010';
                                    $fce1->ORDER_ITEM_IN->row["REF_1_S"] = $nospj;
                                    $fce1->ORDER_ITEM_IN->Append($fce1->ORDER_ITEM_IN->row);
                                    //$show_ket.= $nospj.'-'.$nomorso;
                                }
                                $fce1->Call();

                                if ($fce1->GetStatus() == SAPRFC_OK) {
                                    $fce1->RETURN->Reset();
                                    while ($fce1->RETURN->Next()) {
                                        $error = $fce1->RETURN->row["TYPE"];
                                        $msg = $fce1->RETURN->row["MESSAGE"];
                                        $show_ket .= $msg;
                                        $show_ket .= '<br>';
                                    }
                                    //Commit Transaction
                                    $fce1 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                    $fce1->Call();
                                    $fce1->Close();
                                }
                                $sap->Close();
                            }

                            // Setelah SO ter create
                            if ($ul == 1) {
                                $SO1 = $nomorso;
                                $IDH1 = $idh;
                            } else if ($ul == 2) {
                                $SO2 = $nomorso;
                                $IDH2 = $idh;
                            } else if ($ul == 3) {
                                $SO3 = $nomorso;
                                $IDH3 = $idh;
                            } else if ($ul == 4) {
                                $SO4 = $nomorso;
                                $IDH4 = $idh;
                            }
                            if ($next == "Y" && $ul == 1) {

                                if (($nomorso != "") and ( $ada == 0))
                                    $status = "APPROVE";
                                else
                                    $status = "PROCESS";

                                $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'NO_SO_OLD', 'PRICE_DATE', 'KD_REASON', 'NM_REASON', 'TIPEPP', 'SISA_KREDIT_LIMIT', 'HUTANG_JATUH_TEMPO', 'UMUR_HUTANG_JT');
                                $field_data = array("$soldto", "$nama_sold_to", "$no_pp", "SYSDATE", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "$status", "SYSDATE", "$user_name", "SYSDATE", "$user_name", "0", "$route", "$sales_org", "$pricelist", "$nama_pricelist", "$lcnum", "$oldso", "instgl_$price_datep", "$reason", "$nama_reason", "$tipeCreatePP_isi", "$sisa_kredit_limit", "$hutang_jt", "$umur_jt");
                                $tablename = "OR_TRANS_HDR";
                                $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                $show_ket .= "Order Reservation Success Made with No. $no_pp <br>";

                                $sampai = $_POST['jumlah'];
                                for ($k = 1; $k <= $sampai; $k++) {
                                    $shipto = "shipto" . $k;
                                    $nama_shipto = "nama_shipto" . $k;
                                    $alamat = "alamat" . $k;
                                    $kode_distrik = "kode_distrik" . $k;
                                    $nama_distrik = "nama_distrik" . $k;
                                    $kode_prov = "kode_prov" . $k;
                                    $nama_prov = "nama_prov" . $k;
                                    $produk = "produk" . $k;
                                    $nama_produk = "nama_produk" . $k;
                                    $qty = "com_qty" . $k;
                                    $uom = "uom" . $k;
                                    $tgl_kirim = "tgl_kirim" . $k;
                                    $kontrak = "com_kontrak" . $k;
                                    $shipment = "com_shipment" . $k;
                                    $polisinumber = "nopol" . $k;
                                    $drivernamenopolfg = "drivernamenopol" . $k;
                                    $simdrivernamenopolfg = "simdrivernamenopol" . $k;
                                    $typetruk = "tipetruk" . $k;
                                    $catatnke = "val_addnote" . $k;
                                    $ktprodukke = "ktproduk" . $k;


                                    if (isset($_POST[$shipto])) {
                                        $tgl_kirim_in = $_POST[$tgl_kirim];
                                        if ($tgl_kirim_in == "")
                                            $tgl_kirim_in = date('d-m-Y');
                                        // $shipto_in = $_POST[$shipto];
                                        $nama_shipto_in = $_POST[$nama_shipto];
                                        $alamat_in = $_POST[$alamat];

                                        if ($ul == 1) {
                                            $shipto_in = $_POST['shipto' . $k];     // GANTI BERDASARKAN MAPPING CUSTOMER
                                            $produk_in = $_POST[$produk];
                                        } else if ($ul == 2 || $ul == 3 || $ul == 4) {
                                            $shiptotocek = $_POST['shipto' . $k];
                                            
                                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                            $queryshipto = oci_parse($conn, $strshipto);
                                            oci_execute($queryshipto);
                                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                                $queryshipto = oci_parse($conn, $strshipto);
                                                oci_execute($queryshipto);
                                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            }
                                            
                                            if ($ul == 2) {
                                                $shipto_in = $rowshipto['SHIP_TO_OPCO'];
                                                $soldto = $rowshipto['SOLD_TO_OPCO'];
                                            } else if ($ul == 3) {
                                                $shipto_in = $rowshipto['SHIP_TO_MD_2'];
                                                $soldto = $rowshipto['SOLD_TO_MD_2'];
                                            } else if ($ul == 4) {
                                                $shipto_in = $rowshipto['SHIP_TO_OPCO_2']; 
                                                $soldto = $rowshipto['SOLD_TO_OPCO_2'];
                                            } 


                                            $materialtocek = $_POST['produk' . $k];
                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                            $produk_in = $rowmaterial['KD_MATERIAL_OPCO'];
                                        }

                                        $kode_distrik_in = $_POST[$kode_distrik];
                                        $nama_distrik_in = $_POST[$nama_distrik];
                                        $kode_prov_in = $_POST[$kode_prov];
                                        $nama_prov_in = $_POST[$nama_prov];
                                        $nama_produk_in = $_POST[$nama_produk];
                                        $qty_in = $_POST[$qty];
                                        $uom = $_POST[$uom];

//                                        if($sales_org=="7900"){ 
//                                            $kontrak = $_POST[$kontrak];
//                                        }else{
//                                            $kontrak = "";
//                                        }
                                        $kontrak = $_POST[$kontrak];

                                        $shipment = $_POST[$shipment];
                                        $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                                        $drivernamenopolfg_in = trim($_POST[$drivernamenopolfg]);
                                        $simdrivernamenopolfg_in = trim($_POST[$simdrivernamenopolfg]);
                                        $typetruk_in = trim($_POST[$typetruk]);
                                        $catatnke_in = trim($_POST[$catatnke]);
                                        $ktprodukke_in = trim($_POST[$ktprodukke]);

                                        $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                                        $field_data = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep", "$nopolisi_in", "$typetruk_in", "$catatnke_in", "$ktprodukke_in", "$drivernamenopolfg_in", "$simdrivernamenopolfg_in");
                                        $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                                        $field_data1 = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep");

                                        $tablename = "OR_TRANS_DTL";
                                        $tablename1 = "OR_TRANS_APP";
                                        $fungsi->insert($conn, $field_names, $field_data, $tablename);
                                        $fungsi->insert($conn, $field_names1, $field_data1, $tablename1);
                                        $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                                    }
                                }
                            } else {
                                $status = "PROCESS";
                                $show_ket .= "Order Reservation Failed ! <br>";
                            }
                            $jerror += 1;
                        }//if loncat MD 2 tidak pakai
                    } else if ($ul == 2 || $ul == 4 && $COM == "SBI") {

//                        print_r($ul);
//                        print_r("<br />");
                        // build array material
                        $Tmaterial = array();
                        $Tmaterial['MaterialCode'] = array();
                        $Tmaterial['PlantCode'] = array();
                        $Tmaterial['Qty'] = array();
                        $Tmaterial['QtyUnit'] = array();
                        $Tmaterial['ScheduleLine'] = array();
                        $Tmaterial['RequestDeliveryDate'] = array();
                        $Tmaterial['RequestDeliveryQty'] = array();
                        $Dmaterial = array();
                        for ($j = 1; $j <= $sampai; $j++) {
                            $material = $_POST['produk' . $j];

                            $strmat = "SELECT CAST(NTGEW AS float) as BERAT, A.* FROM RFC_Z_ZCSD_LIST_MAT_SALES_2 A WHERE VKORG = '{$sales_org1}' AND MATNR = '{$material}'  AND WERKS = '{$plant1}'";
                            $querymat = oci_parse($conn, $strmat);
                            oci_execute($querymat);
                            $rowmat = oci_fetch_array($querymat, OCI_ASSOC);
                            if (count($rowmat) > 0 && $rowmat['MEINS'] == "ZAK") {
                                $qty = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
                                $qtyx = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
                            } else {
                                $qty = $_POST['com_qty' . $j];
                                $qtyx = $_POST['com_qty' . $j];
                            }

                            $shiptotocek = $_POST['com_shipto' . $j];
                            $item_numline = sprintf("%04d", $j + 1);
                            $tanggall = $_POST['tgl_kirim' . $j];
                            list($day, $month, $year) = split("-", $tanggall);
                            $tgl_kirim = $year . "-" . $month . "-" . $day;

                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                            $querymaterial = oci_parse($conn, $strmaterial);
                            oci_execute($querymaterial);
                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);

                            if ($ul == 2) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO"];
                            } else if ($ul == 4) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO_2"];
                            }
                            $Tmaterial['MaterialCode'] = $materialsbi;
                            $Tmaterial['PlantCode'] = $plant;
                            $Tmaterial['Qty'] = $qty;
                            $Tmaterial['QtyUnit'] = "TO";
                            $Tmaterial['ScheduleLine'] = $item_numline;
                            $Tmaterial['RequestDeliveryDate'] = $tgl_kirim;
                            $Tmaterial['RequestDeliveryQty'] = $qtyx;
                            $Dmaterial[] = $Tmaterial;
                        }

                        $strorder = "SELECT * FROM ZMD_MAPPING_ORDER WHERE ORDER_TYPE_MD = '{$so_type}' AND COMPANY_OPCO = '{$sales_org}' AND DEL = 0";
                        $queryorder = oci_parse($conn, $strorder);
                        oci_execute($queryorder);
                        $roworder = oci_fetch_array($queryorder, OCI_ASSOC);

                        list($day, $month, $year) = split("-", $tanggall);
                        $tgl_kirim = $year . $month . $day;

                        
                        if ($ul == 2) {
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO'];
                            $shipto = $rowshipto['SHIP_TO_OPCO'];
                            $SOMD = $SO1;
                        } else if ($ul == 4) {
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO_2'];
                            $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                            $SOMD = $SO3;
                        }

                        $tgl_pp = $_POST['tgl_pp'];
                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_pp = $year . $month . $day;

                        if(empty($ship_condition)){
                        
                            if ($incoterm1 == "FOT") {
                                $shipcond_sbi = "PK";
                            } else if ($incoterm1 == "FRC") {
                                $shipcond_sbi = "D0";
                            } else if ($incoterm1 == "CNF") {
                                $shipcond_sbi = "DV";
                            } else {
                                $shipcond_sbi = "";
                            }
                        
                        }else{
                            $shipcond_sbi = $ship_condition;
                        }
                        
                        $strtop = "SELECT * FROM ZMD_MAPPING_TOP WHERE COM_SMI = '{$sales_org1}' AND TOP_SMI = '{$top}' AND (COM_SB = '{$sales_org}' or COM_SB = 'ALL')  AND DEL = 0 order by COM_SB DESC ";
                        $querytop = oci_parse($conn, $strtop);
                        oci_execute($querytop);
                        $rowtop = oci_fetch_array($querytop, OCI_ASSOC);
                        if (ISSET($rowtop['TOP_SB'])) {
                            $topsbi = $rowtop['TOP_SB'];
                        }else{
                            $topsbi = null;
                        }    
                        
                        $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
                        $data = array('Token' => 'aSsMx7GV0HFGzlufM4DH',
                            'SystemID' => 'PASSO',
                            'Data' => array('SalesDocumentType' => $roworder["ORDER_TYPE_OPCO"],
                                'SalesOrganization' => 'SCBD',
                                'DistributionChannel' => 'DB',
                                'Division' => 'CM',
                                'SalesDocumentDate' => $tgl_pp,
                                'ShippingCondition' => $shipcond_sbi,
                                'ShippingType' => 'G4',
                                'SoldToCode' => $soldtosbi,
                                'ShipToCode' => $shipto,
                                'MDReferenceSONumber' => $SOMD,
                                'MDPurchaseOrderNumber' => $no_pp,
                                'MDPurchaseOrderItem' => '00010',
                                'PaymentTerms' => $topsbi,
                                'Items' => $Dmaterial
                            )
                        );
                        $options = array(
                            'http' => array(
                                'header' => "Content-type: application/json\r\n",
                                'method' => 'POST',
                                'content' => json_encode($data),
                            )
                        );



                        $context = stream_context_create($options);
                        $result = file_get_contents($url, false, $context);
                        $response = json_decode($result);
                        if ($ul == 4) {
                            $responseSBI2 = $response;
                        }
                        $status = $response->Status;
                        $Message = $response->Message;

                        $Message_detail = $response->MessageDetail;
                        $param_send = json_encode($data);
                        $param_return = json_encode($response);

                        $field_names = array(
                            'SEND_PARAM', 'RETURN_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN', 'PESAN_DETAIL', 'TGL'
                        );
                        $field_data = array(
                            "$param_send", "$param_return", "$user_name_in", "$no_pp", "$Message", "$Message_detail", "SYSDATE"
                        );
                        $tablename = "ZMD_LOG_SBI";
                        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);
//                        print_r($status);
//                        print_r($Message);
                        if ($ul == 2) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO2 = $response->Data->SAPSalesOrderNumber;
                            $tgl_deleteSO2 = $response->Data->SAPCreatedDateStr;
                        } else if ($ul == 4) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO4 = $response->Data->SAPSalesOrderNumber;
                            $tgl_deleteSO4 = $response->Data->SAPCreatedDateStr;
                        }

                        if ($status != 1) {
                            $next = 'N';
                            $show_ket .= $ul . ". SO OPCO = " . $Message_detail;
                            $show_ket .= '<br>';
                        } else {
                            $show_ket .= $ul . ". SO OPCO = Sales Order has been made with a number : " . $nomorso;
                            $show_ket .= '<br>';
                        }
                        $Dataarray = json_decode(json_encode($response->Data->Items), true);
//                        print_r($nomorso);
//                        echo json_encode($data);
                        $SOMDNE = "Y";
                        $jerror += 1;
                    } else if ($ul == $perulangan) { // PROSES PERULANGAN TERAKHIR CREATE PO 
                        for ($p = 1; $p <= $perulanganPO; $p++) { // perulangan PO MULTI ICS atau TIDAK
                            //
                        
                            
                            if ($p == 1) {
                                $incoterm1 = $incotermPO1;
                                $incoterm2 = $incotermPO12;
                                $distr_chan = $distr_chanPO1;
                            } else {
                                $incoterm1 = $incotermPO2;
                                $incoterm2 = $incotermPO22;
                                $distr_chan= $distr_chanPO2;
                                //tambahan top po
                                $top       = $topPO2;
                            }
                            //perubahan get KD VENDOR
                            $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'  AND DEL = 0";
                            $querykdven = oci_parse($conn, $strkdven);
                            oci_execute($querykdven);
                            $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

                            if ($p == 1) {
                                $SO_PO = $SO2;
                                $vendorFIX = $rowkdven["KET"];
                                $COM = $rowkdven["COM_MD"];
                                $COM_HARGA = $rowkdven["COM_OPCO"];
                                $plantPO = $plant1;
                            } else if ($p == 2) {
                                $SO_PO = ($SO3 != "" ? $SO3 : $SO4);
                                $vendorFIX = $rowkdven["KET_OPCO"];
                                $COM = $rowkdven["COM_OPCO"];
                                $COM_HARGA = $rowkdven["COM_MD_2"];
                                $plantPO = $plant2;
                            } else if ($p == 3) {
                                $SO_PO = $SO4;
                                $vendorFIX = $rowkdven["KET2"];
                                $COM = $rowkdven["COM_MD_2"];
                                $COM_HARGA = $rowkdven["COM_OPCO_2"];
                                $plantPO = $plant3;
                            }

                            if ($COM != "PTSC" && $COM != "ID50") {
                                if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
                                    $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
                                    $fce->I_BAPI_VIEW["SDCOND"] = "X";
                                    $fce->SALES_DOCUMENTS->row["VBELN"] = $nomorso;
                                    $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

                                    $fce->Call();
                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $fce->ORDER_CONDITIONS_OUT->Reset();
                                        $totL = 0;
                                        $builder = array();
                                        $dataH = array();
                                        $dataH["item_number"] = array();
                                        $dataH["nilai_harga"] = array();
                                        $dataH["per"] = array();
                                        $dataH["satuan"] = array();
                                        while ($fce->ORDER_CONDITIONS_OUT->Next()) {
                                            if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
                                                $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
                                                $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
                                                $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
                                                $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
                                                $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
                                                $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];

                                                $builder[] = $dataH;
                                                $totL += 1;
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();

                                        if ($totL != $_POST['jumlah']) {
                                            $next = "N";
                                            $show_ket .= "Master Harga Belum Ada...!!!";
                                            $show_ket .= '<br>';
                                        }
                                    }
                                }

                                if ($next == "Y") {

                                    // CREATE PO
                                    $fce = $sap->NewFunction("BAPI_PO_CREATE1");
                                    $tgl_sekarang = date("Ymd");
                                    $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$COM}' AND KD_VENDOR = '{$vendorFIX}' AND DEL =0";
//                                    $org_po = $_POST['org'];
//                                    $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$org_po}'";
                                    $queryven = oci_parse($conn, $strven);
                                    oci_execute($queryven);
                                    $rowven = oci_fetch_array($queryven, OCI_ASSOC);



                                    $fce->POHEADER["COMP_CODE"] = $COM; // company pertama
                                    $fce->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
                                    $fce->POHEADER["VENDOR"] = $vendorFIX; //
                                    $fce->POHEADER["PMNTTRMS"] = $top;
                                    $fce->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
                                    $fce->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"];
                                    //                        $fce->POHEADER["CURRENCY"] = "IDR";
                                    //                        $fce->POHEADER["EXCH_RATE"] = "1";
                                    $fce->POHEADER["DOC_DATE"] = $tgl_sekarang;
                                    $fce->POHEADER["INCOTERMS1"] = $incoterm1;
                                    $fce->POHEADER["INCOTERMS2"] = $incoterm2;


                                    $fce->POHEADERX["COMP_CODE"] = "x";
                                    $fce->POHEADERX["DOC_TYPE"] = "x";
                                    $fce->POHEADERX["VENDOR"] = "x";
                                    $fce->POHEADERX["PMNTTRMS"] = "x";
                                    $fce->POHEADERX["PURCH_ORG"] = "x";
                                    $fce->POHEADERX["PUR_GROUP"] = "x";
                                    //                        $fce->POHEADERX["CURRENCY"] = "x";
                                    //                        $fce->POHEADERX["EXCH_RATE"] = "x";
                                    $fce->POHEADERX["DOC_DATE"] = "x";
                                    $fce->POHEADERX["INCOTERMS1"] = "x";
                                    $fce->POHEADERX["INCOTERMS2"] = "x";

                                    $fce->POTEXTHEADER->row["TEXT_ID"] = "F01";
                                    $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
                                    $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

                                    $fce->POTEXTHEADER->row["TEXT_ID"] = "F14";
                                    $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
                                    $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

                                    $sampai = $_POST['jumlah'];
                                    for ($j = 1; $j <= $sampai; $j++) {
                                        $idke = "idke" . $j;
                                        $id_dtl = $_POST['com_iddtl' . $j];
                                        // $item_num1 = $_POST['com_line' . $j];
                                        // $item_num = $fungsi->linenum($item_num1);
                                        // $item_numline = sprintf("%06d", $item_num * 10);
                                        $item_num = $j * 10;
                                        $item_numline = sprintf("%05d", $item_num);
                                        $item_numlinePO = sprintf("%06d", $item_num);
                                        // $material = $_POST['produk' . $j];
                                        // $material1 = $_POST['produk' . $j];


                                        $materialtocek = $_POST['produk' . $j];

                                        $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                        $querymaterial = oci_parse($conn, $strmaterial);
                                        oci_execute($querymaterial);
                                        $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                        $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                        if ($p == 1) {
                                            $material = $_POST['produk' . $j];
                                        } else if ($p == 2) {
                                            $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                        } else if ($p == 3) {
                                            $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                        }



                                        $qty = $_POST['com_qty' . $j];
                                        $qtyx = $_POST['com_qty' . $j];

//                                    if($sales_org=="7900"){ 
//                                        $kontrak = $_POST['com_kontrak' . $j];
//                                    }else{
//                                        $kontrak = "";
//                                    }
                                        $kontrak = $_POST['com_kontrak' . $j];
                                        $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                        $distrik = $_POST['kode_distrik' . $j];

                                        $tgl_kirimPO = $_POST['tgl_kirim' . $j];
                                        list($day, $month, $year) = split("-", $tgl_kirimPO);
                                        $tgl_kirim = $year . $month . $day;

                                        $mtr_group = substr($material, 0, 7);


                                        if (($nomorso != "") and ( $qty1 == $qtyx1))
                                            $status1 = "APPROVE";
                                        else
                                            $status1 = "PROCESS";

                                        if ($mtr_group == "121-301") {
                                            $nm_material = "SEMEN ZAK";
                                            $po_unit = "ZAK";
                                        } else if ($mtr_group == "121-302") {
                                            $nm_material = "SEMEN CURAH";
                                            $po_unit = "TO";
                                        } else if ($mtr_group == "121-200") {
                                            $nm_material = "CLINKER";
                                            $po_unit = "TO";
                                        }

//                                    $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$org_po}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
//                                    $queryloc = oci_parse($conn, $strsloc);
//                                    oci_execute($queryloc);
//                                    $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
                                        // CEK HARGA DARI BAPI COMMIT HARGA 
                                        if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
                                            foreach ($builder as $val) {
                                                if ($item_numlinePO == $val['item_number']) {
                                                    $hargaPO = $val['nilai_harga'];
                                                    $perPO = $val['per'];
                                                    $satuanPO = $val['satuan'];
                                                    $satuan2PO = $val['satuan2'];
                                                    $currencyPO = $val['currency'];
                                                }
                                            }
                                        } else {
                                            if ($p == 1) {
                                                $datas = $response->Data->Items[$j - 1];
                                            } else if ($p == 3) {
                                                $datas = $responseSBI2->Data->Items[$j - 1];
                                            }
                                            $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
                                            $perPO = $datas->SAPSalesOrderPerUnit;
                                            $satuanPO = $datas->SAPSalesOrderUnit;
                                            $satuan2PO = $datas->SAPSalesOrderUnit;
                                            $currencyPO = $datas->SAPSalesOrderCurrency;
                                        }


//                                    print_r($builder);
//                                    print_r($hargaPO);
//                                    print_r($item_numline);

                                        $fce->POITEM->row["PO_ITEM"] = $item_numline;
                                        $fce->POITEM->row["SHORT_TEXT"] = $nm_material;
                                        $fce->POITEM->row["MATERIAL"] = $material;
                                        $fce->POITEM->row["PLANT"] = $plantPO;
                                        // $fce->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];

                                        $fce->POITEM->row["STGE_LOC"] = "D101";
                                        $fce->POITEM->row["MATL_GROUP "] = $mtr_group;
                                        $fce->POITEM->row["QUANTITY"] = $qtyx;
                                        //                                $fce->POITEM->row["PO_UNIT"] = $po_unit;
                                        //                                $fce->POITEM->row["PO_UNIT_ISO"] = "TO";
                                        //                                $fce->POITEM->row["ORDERPR_UN"] = "TO";
                                        //                                $fce->POITEM->row["ORDERPR_UN_ISO"] = "TO";
                                        // $fce->POITEM->row["PRICE_UNIT"] = $satuanPO; //per
                                        $fce->POITEM->row["GR_IND"] = "X";
                                        $fce->POITEM->row["IR_IND"] = "X";
                                        $fce->POITEM->row["GR_BASEDIV"] = "X";
                                        // $fce->POITEM->row["FUNDS_CTR"] = "7902000000"; 
                                        //                                $fce->POITEM->row["NET_WEIGHT"] = "10000";
                                        //                                $fce->POITEM->row["WEIGHTUNIT"] = "KG";
                                        //                                $fce->POITEM->row["WEIGHTUNIT_ISO"] = "KG";
                                        //                                $fce->POITEM->row["FUNDS_CTR"] = "DUMMY";
                                        // $fce->POITEM->row["PO_PRICE"] = $hargaPO;
                                        $fce->POITEM->Append($fce->POITEM->row);

                                        $fce->POITEMX->row["PO_ITEM"] = $item_numline;
                                        $fce->POITEMX->row["SHORT_TEXT"] = "X";
                                        $fce->POITEMX->row["MATERIAL"] = "X";
                                        $fce->POITEMX->row["PLANT"] = "X";
                                        $fce->POITEMX->row["STGE_LOC"] = "X";
                                        $fce->POITEMX->row["MATL_GROUP "] = "X";
                                        $fce->POITEMX->row["QUANTITY"] = "X";
                                        //                                $fce->POITEMX->row["PO_UNIT"] = "X";
                                        //                                $fce->POITEMX->row["PO_UNIT_ISO"] = "X";
                                        //                                $fce->POITEMX->row["ORDERPR_UN"] = "X";
                                        //                                $fce->POITEMX->row["ORDERPR_UN_ISO"] = "X";
                                        // $fce->POITEMX->row["PRICE_UNIT"] = "X";
                                        $fce->POITEMX->row["GR_IND"] = "X";
                                        $fce->POITEMX->row["IR_IND"] = "X";
                                        $fce->POITEMX->row["GR_BASEDIV"] = "X";
                                        // $fce->POITEMX->row["FUNDS_CTR"] = "X"; 
                                        //                                $fce->POITEMX->row["NET_WEIGHT"] = "X";
                                        //                                $fce->POITEMX->row["WEIGHTUNIT"] = "X";
                                        //                                $fce->POITEMX->row["WEIGHTUNIT_ISO"] = "X";
                                        //                                $fce->POITEMX->row["FUNDS_CTR"] = "X";
                                        // $fce->POITEMX->row["PO_PRICE"] = "X";
                                        $fce->POITEMX->Append($fce->POITEMX->row);

                                        $fce->POTEXTITEM->row["PO_ITEM"] = $item_numline;
                                        $fce->POTEXTITEM->row["TEXT_ID"] = "F01";
                                        $fce->POTEXTITEM->row["TEXT_FORM"] = "/";
                                        $fce->POTEXTITEM->row["TEXT_LINE"] = "SEMEN PPC";
                                        $fce->POTEXTITEM->Append($fce->POTEXTITEM->row);

                                        $fce->POSCHEDULE->row["PO_ITEM"] = $item_numline;
                                        $fce->POSCHEDULE->row["SCHED_LINE"] = "0001";
                                        $fce->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
                                        $fce->POSCHEDULE->row["QUANTITY "] = $qtyx;
                                        $fce->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
                                        $fce->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
                                        $fce->POSCHEDULE->Append($fce->POSCHEDULE->row);

                                        $fce->POSCHEDULEX->row["PO_ITEM"] = $item_numline;
                                        $fce->POSCHEDULEX->row["SCHED_LINE"] = "X";
                                        $fce->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
                                        $fce->POSCHEDULEX->row["QUANTITY "] = "X";
                                        $fce->POSCHEDULEX->row["STAT_DATE"] = "X";
                                        $fce->POSCHEDULEX->row["PO_DATE"] = "X";
                                        $fce->POSCHEDULEX->Append($fce->POSCHEDULEX->row);


                                        $fce->POCOND->row["ITM_NUMBER"] = $item_numline;
                                        $fce->POCOND->row["COND_ST_NO"] = '001';
                                        $fce->POCOND->row["COND_TYPE"] = "PBXX";
                                        $fce->POCOND->row["COND_VALUE"] = $hargaPO;
                                        $fce->POCOND->row["COND_P_UNT"] = $perPO;
                                        $fce->POCOND->row["COND_UNIT"] = $satuanPO;
                                        $fce->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
                                        $fce->POCOND->row["CURRENCY"] = $currencyPO;
                                        $fce->POCOND->row["CURRENCY_ISO"] = $currencyPO;
                                        $fce->POCOND->row["CHANGE_ID"] = "U";
                                        $fce->POCOND->Append($fce->POCOND->row);

                                        $fce->POCONDX->row["ITM_NUMBER"] = $item_numline;
                                        $fce->POCONDX->row["COND_ST_NO"] = '001';
                                        $fce->POCONDX->row["COND_TYPE"] = "x";
                                        $fce->POCONDX->row["COND_VALUE"] = "x";
                                        $fce->POCONDX->row["COND_P_UNT"] = "x";
                                        $fce->POCONDX->row["COND_UNIT"] = "x";
                                        $fce->POCONDX->row["COND_UNIT_SO"] = "x";
                                        $fce->POCONDX->row["CURRENCY"] = "x";
                                        $fce->POCONDX->row["CURRENCY_ISO"] = "x";
                                        $fce->POCONDX->row["CHANGE_ID"] = "x";
                                        $fce->POCONDX->Append($fce->POCONDX->row);
                                    }


                                    $fce->Call();

                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $nopoT = $fce->EXPPURCHASEORDER;
                                        $fce->RETURN->Reset();
                                        while ($fce->RETURN->Next()) {
                                            $tipe = $fce->RETURN->row["TYPE"];
                                            $msg = $fce->RETURN->row["MESSAGE"];
                                            $show_ket .= $msg;
                                            $show_ket .= '<br>';
                                            if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                                $next = "N";
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();
                                    }
                                    $user_org = $_POST['org'];

                                    if ($p == 1) {
                                        $PO1 = $nopoT;
                                    } else if ($p == 2) {
                                        $PO2 = $nopoT;
                                    } else if ($p == 3) {
                                        $PO3 = $nopoT;
                                    }
                                    //SIMPAN PP KEDUA

                                    if ($next == "Y" && $p == 1) {
                                        $sampai = $_POST['jumlah'];
                                        for ($j = 1; $j <= $sampai; $j++) {
                                            $idke = "idke" . $j;
                                            $id_dtl = $_POST['com_iddtl' . $j];
                                            $item_num1 = $j * 10;
                                            $item_numline = $fungsi->linenum($item_num1);
                                            $PO_LINE = sprintf("%05d", $item_num1); //'00010';
                                            if ($j == 1) {
                                                $numline_pertama = sprintf("%05d", $item_num1); //'000010';
                                            }
                                            $alamat1 = $_POST['alamat' . $j];
                                            // $material = $_POST['produk' . $j];
                                            // $material1 = $_POST['produk' . $j];

                                            $materialtocek = $_POST['produk' . $j];
                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                            if ($p == 1) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                            } else if ($p == 2) {
                                                $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                            } else if ($p == 3) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                            }


                                            $qty = $_POST['com_qty' . $j];
                                            $qtyx = $_POST['com_qty' . $j];
//                                        if($sales_org=="7900"){ 
//                                            $kontrak = $_POST['com_kontrak' . $j];
//                                        }else{
//                                            $kontrak = "";
//                                        } 
                                            $kontrak = $_POST['com_kontrak' . $j];
                                            $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                            $distrik = $_POST['kode_distrik' . $j];
                                            $shiptotocek = $_POST['com_shipto' . $j];
                                            
                                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                            $queryshipto = oci_parse($conn, $strshipto);
                                            oci_execute($queryshipto);
                                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                                $queryshipto = oci_parse($conn, $strshipto);
                                                oci_execute($queryshipto);
                                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            }
                                            if ($p == 1) {
                                                $shipto = $rowshipto['SHIP_TO_OPCO'];
                                            } else if ($p == 2) {
                                                $shipto = $rowshipto['SHIP_TO_MD_2'];
                                            } else if ($p == 3) {
                                                $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                            }

                                            $shipto = $fungsi->sapcode($shipto);
                                            $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
                                            $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                            list($day, $month, $year) = split("-", $tgl_kirimPO);
                                            $tgl_kirim = $year . $month . $day;

                                            $mtr_group = substr($material, 0, 7);


                                            if (($nomorso != "") and ( $qty1 == $qtyx1))
                                                $status1 = "APPROVE";
                                            else
                                                $status1 = "PROCESS";

                                            if ($p == 1) {
                                                $SO_ICS = $SO1;
                                            } else if ($p == 2) {
                                                $SO_ICS = $SO2;
                                            } else if ($p == 3) {
                                                $SO_ICS = $SO3;
                                            }
                                            $field_names = array(
                                                'NO_PP',
                                                'NO_PO',
                                                'PO_LINE',
                                                'PLANT_PO',
                                                'NMPLANT_PO',
                                                'KOTA',
                                                'NAMA_KOTA',
                                                'KODE_PRODUK',
                                                'NM_PRODUK',
                                                'HARGA_PO',
                                                'ORG_PO',
                                                'VENDOR',
                                                'NM_VENDOR',
                                                'QTY_PO',
                                                'UOM',
                                                'TGL_PO',
                                                'STATUS',
                                                'NOTE',
                                                'CREATE_DATE',
                                                'CREATED_BY',
                                                'DELETE_MARK',
                                                'BULAN',
                                                'TAHUN',
                                                'QTY_APPROVE',
                                                'TGL_PP',
                                                'ORG_BY',
                                                'VBELN'
                                            );
                                            $kd_vendor = $vendorFIX;
                                            $nopoplus = $nopoT . $PO_LINE;
                                            $field_data = array(
                                                "$no_pp",
                                                "$nopoplus",
                                                "$PO_LINE",
                                                "$plant1",
                                                "$plant1", //belum                   
                                                "$distrik",
                                                "$distrik", //belum
                                                "$material",
                                                "$material", //belum
                                                "$hargaPO",
                                                "$org_po",
                                                "$kd_vendor",
                                                "$kd_vendor", //belum
                                                "$qty",
                                                "$po_unit",
                                                "instgl_$tgl_kirimPO",
                                                "$status1",
                                                "$ket",
                                                "SYSDATE",
                                                "$user_name_in",
                                                "0",
                                                "$month",
                                                "$year",
                                                "$qtyx",
                                                "SYSDATE",
                                                "$user_org",
                                                "$SO_ICS"
                                            );
                                            $tablename = "OR_TRANS_HDR_ICS";
                                            $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                            //Oracle Detail
                                            $field_names2 = array(
                                                'NO_PP',
                                                'KODE_PRODUK',
                                                'NAMA_PRODUK',
                                                'QTY_PP',
                                                'QTY_APPROVE',
                                                'TGL_KIRIM_PP',
                                                'TGL_KIRIM_APPROVE',
                                                'TGL_TERIMA',
                                                'SHIP_TO',
                                                'NAMA_SHIP_TO',
                                                'ALAMAT_SHIP_TO',
                                                'DELETE_MARK',
                                                'STATUS_LINE',
                                                'KODE_TUJUAN',
                                                'NAMA_TUJUAN',
                                                'ITEM_NUMBER',
                                                'NO_SO',
                                                'FLAG_KAPAL',
                                                'KETERANGAN',
                                                'NAMA_KAPAL',
                                                'NO_KONTRAK',
                                                'KD_PROV',
                                                'NM_PROV',
                                                'UOM',
                                                'PLANT',
                                                'NM_PLANT',
                                                'PRICE_DATE',
                                                'SOLD_TO',
                                                'INCOTERM',
                                                'CARA_BAYAR',
                                                'TERM_PAYMENT',
                                                'NAMA_SOLD_TO',
                                                'BPLANT',
                                                'CREATED_BY',
                                                'CREATE_DATE',
                                                'NAMA_INCOTERM',
                                                'SO_TYPE',
                                                'NAMA_SO_TYPE',
                                                'ROUTE',
                                                'NAMA_TOP',
                                                'ORG',
                                                'PRICELIST',
                                                'NAMA_PRICELIST',
                                                'NO_KONTRAK_LC',
                                                'KD_REASON',
                                                'NM_REASON',
                                                'ROUTE_TXT',
                                                'CHANNEL',
                                                'DIVISION',
                                                'TIPE_PEMBELIAN',
                                                'NO_POH'
                                            );

                                            $kodedistrik2 = substr($distrik, 0, 2);
                                            $kd_provinsi = "10" . $kodedistrik2;
                                            $itemnumplus = sprintf("%06d", $item_numline); //'000010';
                                            $field_data2 = array(
                                                "$no_pp",
                                                "$material",
                                                "$material",
                                                "$qty",
                                                "$qtyx",
                                                "instgl_$tgl_kirimPO",
                                                "instgl_$tgl_kirimPO",
                                                "instgl_$tgl_terimaPO",
                                                "$shipto",
                                                "$shipto",
                                                "$alamat1", // belum
                                                "0",
                                                "$status1",
                                                "$distrik",
                                                "$distrik",
                                                "$itemnumplus",
                                                "$SO_ICS",
                                                "0",
                                                "$ket",
                                                " ", //belum
                                                "$kontrak", //belum
                                                "$kd_provinsi", //belum
                                                "$kd_provinsi", //belum
                                                "$po_unit", //belum
                                                "$plant", // plant kedua
                                                "$plant",
                                                "instgl_$tgl_kirimPO",
                                                "$soldto", //kedua
                                                "$incoterm1",
                                                "$ketbayar", //belum
                                                "$top",
                                                "$soldto",
                                                "$plant", //
                                                "$user_name_in",
                                                "SYSDATE",
                                                "$incoterm2",
                                                "$so_type",
                                                "$so_type",
                                                "$route",
                                                "$nama_top",
                                                "$sales_org",
                                                "$pricelist",
                                                "$nama_pricelist",
                                                "$lcnum",
                                                "$reason",
                                                "$nama_reason",
                                                "$ship_cond-$route_desc", //belum
                                                "$distr_chan",
                                                "$division",
                                                "D", //belum
                                                "$nopoT"
                                            );
                                            $tablename2 = "OR_TRANS_DTL_ICS";
                                            $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
                                        }
                                    }
                                }
                            }// IF bukan SBI
                        }
                    }
                }
            }


            if ($next == 'Y') {
                //  INSERT TABEL MAPPING
                $fceM = $sap->NewFunction("ZCSD_MAP_SO_MD_FM");
                if ($fceM == false) {
                    $sap->PrintStatus();
                    exit;
                }

                for ($ref = 1; $ref <= $perulanganSO; $ref++) {
                    $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
                    if ($fce == false) {
                        $sap->PrintStatus();
                        exit;
                    }
                    if ($ref == 1) {
                        $fce->I_ZVBELN = $SO1;
                        $fce->I_VBELN = $SO2;
                        $SOM = 'SO Mega Distributor 1 : ' . $SO1;
                        $PO_REF = $PO1;
                        $SOMAP = $SO1;
                        $orgMAP = $sales_org1;
                        $plantMAP = $plant1;
                    } else if ($ref == 2) {
                        $fce->I_ZVBELN = $SO2;
                        $fce->I_VBELN = $SO1;
                        $SOM = 'SO OPCO 1 : ' . $SO2;
                        $PO_REF = $PO1;
                        $SOMAP = $SO2;
                        $orgMAP = $sales_org2;
                        $plantMAP = $plant2;
                    } else if ($ref == 3) {
                        $fce->I_ZVBELN = $SO3;
                        $fce->I_VBELN = $SO4;
                        $SOM = 'SO Mega Distributor 2 : ' . $SO3;
                        $PO_REF = ($SO3 != '' ? $PO2 : "");
                        $SOMAP = $SO3;
                        $orgMAP = $sales_org3;
                        $plantMAP = $plant3;
                    } else if ($ref == 4) {
                        if ($SO3 == "") {
                            $fce->I_ZVBELN = $SO3;
                            $fce->I_VBELN = $SO4;
                        } else {
                            $fce->I_ZVBELN = $SO4;
                            $fce->I_VBELN = $SO3;
                        }
                        $SOM = 'SO OPCO 2 : ' . $SO4;
                        $PO_REF = ($SO3 == '' ? $PO2 : $PO3);
                        $SOMAP = $SO4;
                        $orgMAP = $sales_org4;
                        $plantMAP = $plant4;
                    }
                    $fce->I_PO = $PO_REF;
                    $fce->I_LINE_ITEM = $numline_pertama;
                    $fce->Call();
                    if ($fce->GetStatus() == SAPRFC_OK) {
                        //while ( $fce->ZMESSAGE->Next() ){
                        $tipe = $fce->ZMESSAGE["TYPE"];
                        $msg = $fce->ZMESSAGE["MESSAGE"];
                        $show_ket .= $SOM . ' ' . $msg . '<br>';
                        //}
                    }


                    if ($SOMAP != "") {
                        $fceM->T_DATA->row["NO_PP"] = $no_pp;
                        $fceM->T_DATA->row["VKORG"] = $orgMAP;
                        $fceM->T_DATA->row["WERKS"] = $plantMAP;
                        $fceM->T_DATA->row["NO_SO"] = $SOMAP;
                        $fceM->T_DATA->row["SEQ_NO"] = $ref * 10;
                        $fceM->T_DATA->row["NO_PO"] = $PO_REF;
                        $fceM->T_DATA->Append($fceM->T_DATA->row);
                    }
                }


                $fceM->Call();
                if ($fceM->GetStatus() == SAPRFC_OK) {
                    //while ( $fce->ZMESSAGE->Next() ){
//                    $tipe = $fceM->ZMESSAGE["TYPE"];
//                    $msg = $fceM->ZMESSAGE["MESSAGE"];
//                    $show_ket .= $ref . ' ' . $msg . '<br>';
                    //}
                }
            }

            //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
            if ($next == "N") {
                $SOSBI = "N";
                if ($SOMDNE == "Y") {
                    $SOSBIK = "Y";
                } else {
                    $SOSBIK = "N";
                }
                for ($e = 1; $e <= $jerror; $e++) {
                    $return = "Y";

                    // CEK SO SBI ATAU TIDAK
                    $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'";
                    $querykdven = oci_parse($conn, $strkdven);
                    oci_execute($querykdven);
                    $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);
                    if ($e == 1) {
                        $noyo = $SO1;
                        $IDHU = $IDH1;
                        $SOSBICEK = "N";
                    } else if ($e == 2) {
                        $noyo = $SO2;
                        $IDHU = $IDH2;
                        if ($rowkdven["COM_OPCO"] == "PTSC" || $rowkdven["COM_OPCO"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    } else if ($e == 3) {
                        $noyo = $SO3;
                        $IDHU = $IDH3;
                        $SOSBICEK = "N";
                    } else if ($e == 4) {
                        $noyo = $SO4;
                        $IDHU = $IDH4;
                        if ($rowkdven["COM_OPCO_2"] == "PTSC" || $rowkdven["COM_OPCO_2"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    }

                    if ($SOSBICEK == 'Y') {
                        if ($e == 2 || $e == 4) {

                            if ($e == 2) {
                                $TGLend = $tgl_deleteSO2;
                            } else if ($e == 4) {
                                $TGLend = $tgl_deleteSO4;
                            }

                            $url = 'https://sip.solusibangunindonesia.com/APIMD/DeleteSalesOrder';
                            $data = array(
                                'Token' => 'aSsMx7GV0HFGzlufM4DH',
                                'SystemID' => 'PASSO',
                                'SAPSalesOrderNumber' => $noyo,
                                'SAPCreatedDate' => $TGLend,
                            );
                            $options = array(
                                'http' => array(
                                    'header' => "Content-type: application/json\r\n",
                                    'method' => 'POST',
                                    'content' => json_encode($data),
                                )
                            );

                            $context = stream_context_create($options);
                            $result = file_get_contents($url, false, $context);
                            $response = json_decode($result);
                            $status = $response->Status;
                            $Message = $response->Message;
                            if ($status != '1') {
                                $return = 'N';
                            }
                        }
                    } else {
                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }

                        //header entri    
                        $fce->SALESDOCUMENT = $noyo; //"ZOR";
                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";

                        $fce->Call();

                        if ($fce->GetStatus() == SAPRFC_OK) {
                            $fce->RETURN->Reset();
                            while ($fce->RETURN->Next()) {
                                $msg .= '<div align="center">';
                                $error = $fce->RETURN->row["TYPE"];
                                $msg .= $fce->RETURN->row["MESSAGE"];

                                if ($error == 'A' || $error == 'X' || $error == 'E') {
                                    $return = 'N';
                                }
                            }
                            $msg .= '<br></div>';
                            //Commit Transaction
                            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            $fce->Call();
                        } else {
                            $fce->PrintStatus();
                        }
                    }

                    if ($return == 'Y') {
                        $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_HDR_ICS SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE VBELN='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL_ICS SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
                    } else {
                        $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
                    }
                }
            }

            $fce->Close();
            $sap->Close();
        } else {
            $show_ket .= $komentarerror;
        }
        
        $field_names = array(
            'SEND_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN_DETAIL', 'TGL'
        );
        $field_data = array(
            "SI", "$user_name_in", "$no_pp", "$show_ket", "SYSDATE"
        );
        $tablename = "ZMD_LOG_SBI";
        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

        if (isset($_POST['lasthalaman'])) {
            $habis = trim($_POST['lasthalaman']);
        } else {
            $habis = "tambahadmin.php";
        }


        break;
// =========================================================================================================
    case "tambahnew":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            $user_org_in = $_SESSION['user_org'];
            if (trim($_POST['org']) == '') {
                $user_org_in = $_SESSION['user_org'];
            } else {
                $user_org_in = trim($_POST['org']);
            }
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = trim($_POST['cara_bayar']);
            $branch_plant_in = trim($_POST['branch_plant']);
            $nama_plant_in = trim($_POST['nama_bplant']);
            $jenis_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['nama_kirim']);
            $sold_to_in = trim($_POST['sold_to']);
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = trim($_POST['nama_sold_to']);
            $route_in = trim($_POST['route']);
            $plant = trim($_POST['plant']);
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = trim($_POST['so_type']);
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = trim($_POST['kd_kapal']);
            $nm_kapal = trim($_POST['nm_kapal']);
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $no_pp_in = $fungsi->or_new_pp_number($conn);
            $tgl_kirim_in = trim($_POST['tgl_kirim']);
            if ($tgl_kirim_in == "")
                $tgl_kirim_in = date('d-m-Y');
            $lelang_isi = trim($_POST['lelangFLAG']);
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);

            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'FLAG_LELANG', 'TIPEPP');
            $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", "$lelang_isi", "$tipeCreatePP_isi");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);
            $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "qty" . $k;
                $uom = "uom" . $k;
                $noppref_inc = "refpp" . $k;

                if (isset($_POST[$shipto])) {
                    $shipto_in = trim($_POST[$shipto]);
                    $nama_shipto_in = trim($_POST[$nama_shipto]);
                    $alamat_in = trim($_POST[$alamat]);
                    $produk_in = trim($_POST[$produk]);
                    $kode_distrik_in = trim($_POST[$kode_distrik]);
                    $nama_distrik_in = trim($_POST[$nama_distrik]);
                    $kode_prov_in = trim($_POST[$kode_prov]);
                    $nama_prov_in = trim($_POST[$nama_prov]);
                    $nama_produk_in = trim($_POST[$nama_produk]);
                    $qty_in = trim($_POST[$qty]);
                    $uom_in = trim($_POST[$uom]);
                    $noppref_in = trim($_POST[$noppref_inc]);

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_PPREF');
                    $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$noppref_in");
                    $tablename = "OR_TRANS_DTL";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);
                    $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                }
            }
        }


        $habis = $_POST['lasthalaman'];
        break;
//============================================================================================================================
    case "tambahnew_dist":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            $user_org_in = $_SESSION['user_org'];
            // $user_org_in = trim($_POST['org']);
            $user_name_in = $_SESSION['user_name'];
            $branch_plant_in = trim($_POST['branch_plant']);
            $nama_plant_in = trim($_POST['nama_bplant']);
            $jenis_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['nama_kirim']);
            $sold_to_in = trim($_POST['sold_to']);
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = trim($_POST['nama_sold_to']);
            $route_in = trim($_POST['route']);
            $plant = trim($_POST['plant']);
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = trim($_POST['so_type']);
            $j_kemasan = trim($_POST['jenis_kemasan']);
            
            if($so_type =="ZFC"){
            $cara_bayar_in = "CASH";       
            }else{
            $cara_bayar_in = trim($_POST['cara_bayar']);     
            }
            
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = trim($_POST['kd_kapal']);
            $nm_kapal = trim($_POST['nm_kapal']);
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $posnr = trim($_POST['com_posnr']);
            $com_sisa = trim($_POST['com_sisa']);
            $nokontrakhead = trim($_POST['com_kontrak']);
            $no_pp_in = $fungsi->or_new_pp_number($conn);
            $lelang_isi = trim($_POST['lelangFLAG']);
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);

            //field bypass
            /* $datatop = cektop();
              if ($datatop) {
              $top=$datatop['TOP'];
              $nama_top=$datatop['NAME_KEY'];
              }else{
              $show_ket.= "TOP Tidak ditemukan!!!";
              break;
              } */
            $top = $_POST['top'];
//            $nama_top = $_POST['nama_top'];
            $nama_top = $_POST['top'];

            $pricelist = $_POST['pricelist'];
            $nama_pricelist = $_POST['nama_pricelist'];
            $valperlcnum = trim($_POST['perslcnum']);
            $lcnum = $_POST['lcnum'];
            $lcnum = $fungsi->sapcode($lcnum);

            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'FLAG_LELANG', 'TIPEPP', 'TERM_PAYMENT', 'NAMA_TOP', 'PRICELIST', 'NAMA_PRICELIST');
            $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", "$lelang_isi", "$tipeCreatePP_isi", "$top", "$nama_top", "$pricelist", "$nama_pricelist");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);
            $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "qty" . $k;
                $uom = "uom" . $k;
                $com_kontrak = "com_kontrak" . $k;
                // $com_posnr="com_posnr".$k;
                $noppref_inc = "refpp" . $k;
                ////////////////////////////////////SOCC-v.2
                $tgl_leadtime = "tgl_kirim" . $k;
                // $tgl_leadtime2 = "tgl_kirim" . $k;
                ////////////////////////////////////
                

                if (isset($_POST[$shipto])) {
                    $shipto_in = trim($_POST[$shipto]);
                    $nama_shipto_in = trim($_POST[$nama_shipto]);
                    $alamat_in = trim($_POST[$alamat]);
                    $produk_in = trim($_POST[$produk]);
                    $kode_distrik_in = trim($_POST[$kode_distrik]);
                    $nama_distrik_in = trim($_POST[$nama_distrik]);
                    $kode_prov_in = trim($_POST[$kode_prov]);
                    $nama_prov_in = trim($_POST[$nama_prov]);
                    $nama_produk_in = trim($_POST[$nama_produk]);
                    /////////////////////////////////SOCC-v.2
                    $leadtime1 = trim($_POST[$tgl_leadtime]);
                    // if($leadtime1=='' or $leadtime1==null){
                    //     $leadtime1 = trim($_POST[$tgl_leadtime2]);
                    // }

                    $tgl_leadtimeval=$leadtime1;
                    //////////////////////////////////    
                    $qty_in = trim($_POST[$qty]);
                    if($j_kemasan == 'M3 PALLET1'){   // konversi per pallet = 1.6 M3
                       $qty_in = $qty_in * 1.6;    
                    }
                    
                    $uom_in = trim($_POST[$uom]);
                    $kontrak = $_POST[$com_kontrak];
                    // $posnr = $_POST[$com_posnr];
                    $tgl_kirim_in = trim($_POST['tgl_kirim' . $k]);
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $noppref_in = trim($_POST[$noppref_inc]);

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_PPREF', 'NO_KONTRAK', 'NO_KONTRAK_POSNR', 'PLANT', 'NM_PLANT',"TGL_LEADTIME");
                    $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$noppref_in", "$kontrak", "$posnr", "$plant", "$nama_plant","instgl_$tgl_leadtimeval");
                    $tablename = "OR_TRANS_DTL";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);
                    $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                }
            }
        }

        $habis = $_POST['lasthalaman'];
        break;

//============================================================================================================================
    //============================================================================================================================
    case "tambahnew_dist_appreplenishment":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            //$user_org_in=$_SESSION['user_org'];
            $no_pp_gelondong_in = trim($_POST['no_pp_up']);
            $user_org_in = trim($_POST['org']);
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = trim($_POST['cara_bayar_up']);
            $branch_plant_in = trim($_POST['branch_plant']);
            $nama_plant_in = trim($_POST['nama_bplant']);
            $jenis_kirim_in = trim($_POST['jenis_kirim_up']);
            $nama_kirim_in = trim($_POST['nama_jenis_kirim_up']);
            $sold_to_in = trim($_POST['sold_to_up']);
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = trim($_POST['nama_sold_to_up']);
            $route_in = trim($_POST['route']);
            $plant = trim($_POST['plant_asal_up']);
            $nama_plant = trim($_POST['nama_plant_up']);
            $so_type = trim($_POST['so_type']);
            $nama_so_type = trim($_POST['nama_so_type_up']);
            $ket = trim($_POST['ket_oq']);
            $kd_kapal = trim($_POST['kd_kapal']);
            $nm_kapal = trim($_POST['nm_kapal']);
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $posnr = trim($_POST['com_posnr']);      // posnr kontrak
            $com_sisa = trim($_POST['com_sisa']); //sisa kontrak
            $nokontrakhead = trim($_POST['com_kontrak']);
            $no_pp_in = $fungsi->or_new_pp_number($conn);
            $lelang_isi = trim($_POST['lelangFLAG']);
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
            $top = $_POST['top_up'];
            $nama_top = $_POST['nama_top_up'];
            $pricelist = $_POST['pricelist_up'];
            $nama_pricelist = $_POST['nama_pricelist_up'];
            $valperlcnum = trim($_POST['perslcnum']);
            $lcnum = $_POST['lcnum'];
            $lcnum = $fungsi->sapcode($lcnum);

            $shipto_in = trim($_POST['kd_shipto']);
            $nama_shipto_in = trim($_POST['nm_shipto']);
            $alamat_in = trim($_POST['alamat_ship_to_up']);
            $produk_in = trim($_POST['produk_up']);
            $kode_distrik_in = trim($_POST['distrik_up']);
            $nama_distrik_in = trim($_POST['nama_distrik_up']);
            $kode_prov_in = trim($_POST['prov_up']);
            $nama_prov_in = trim($_POST['nama_prov_up']);
            $nama_produk_in = trim($_POST['nama_produk_up']);
            $qty_in = trim($_POST['oq_zak']);
            $uom_in = trim($_POST['uom_up']);
            $kontrak = $_POST['com_kontrak'];
            $tgl_kirim_in = trim($_POST['tgl_kirim']);
            if ($tgl_kirim_in == "")
                $tgl_kirim_in = date('d-m-Y');
            $noppref_in = trim($_POST['noppref_inc']);

            if ($qty_in >= 32) {

                $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'FLAG_LELANG', 'TIPEPP', 'TERM_PAYMENT', 'NAMA_TOP', 'PRICELIST', 'NAMA_PRICELIST');
                $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", "$lelang_isi", "$tipeCreatePP_isi", "$top", "$nama_top", "$pricelist", "$nama_pricelist");
                $tablename = "OR_TRANS_HDR";
                $fungsi->insert($conn, $field_names, $field_data, $tablename);
                $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

                //insert dtl
                $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_PPREF', 'NO_KONTRAK', 'NO_KONTRAK_POSNR', 'PLANT', 'NM_PLANT');
                $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "1", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$noppref_in", "$kontrak", "$posnr", "$plant", "$nama_plant");
                $tablename = "OR_TRANS_DTL";
                $fungsi->insert($conn, $field_names, $field_data, $tablename);
                $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";

                //insert dtl pp replenishment
                $field_names = array('NO_PP_GELONDONG', 'NO_PP', 'QTY_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'TGL_PP', 'SOLD_TO', 'NAMA_SOLD_TO', 'SHIP_TO', 'NAMA_SHIP_TO', 'PLANT', 'KODE_TUJUAN', 'PROV', 'DEL');
                $field_data = array("$no_pp_gelondong_in", "$no_pp_in", "$qty_in", "$produk_in", "$nama_produk_in", "instgl_$tgl_kirim_in", "$sold_to_in", "$nama_sold_to_in", "$shipto_in", "$nama_shipto_in", "$plant", "$kode_distrik_in", "$kode_prov_in", "0");
                $tablename = "OR_AUTO_REPLENISHMENT";
                $fungsi->insert($conn, $field_names, $field_data, $tablename);
                $show_ket .= "Generate No PP $no_pp_in with Reff No. PP Replenishment : $no_pp_gelondong_in Success<br>";
            } else {

                $field_names = array('NO_PP_GELONDONG', 'NO_PP', 'QTY_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'TGL_PP', 'SOLD_TO', 'NAMA_SOLD_TO', 'SHIP_TO', 'NAMA_SHIP_TO', 'PLANT', 'KODE_TUJUAN', 'PROV', 'DEL', 'KETERANGAN');
                $field_data = array("$no_pp_gelondong_in", "$no_pp_in", "$qty_in", "$produk_in", "$nama_produk_in", "instgl_$tgl_kirim_in", "$sold_to_in", "$nama_sold_to_in", "$shipto_in", "$nama_shipto_in", "$plant", "$kode_distrik_in", "$kode_prov_in", "1", "$ket");
                $tablename = "OR_AUTO_REPLENISHMENT";
                $fungsi->insert($conn, $field_names, $field_data, $tablename);

                $show_ket .= "Order Quantity < 32 TO<br>";
            }
        }

        $habis = $_POST['lasthalaman'];
        break;

//============================================================================================================================

    case "tambahnew_dist_gelondong":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            //$user_org_in=$_SESSION['user_org'];
            $user_org_in = trim($_POST['org']);
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = trim($_POST['cara_bayar']);
            $branch_plant_in = trim($_POST['branch_plant']);
            $nama_plant_in = trim($_POST['nama_bplant']);
            $jenis_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['nama_kirim']);
            $sold_to_in = trim($_POST['sold_to']);
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = trim($_POST['nama_sold_to']);
            $route_in = trim($_POST['route']);
            $plant = trim($_POST['plant']);
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = trim($_POST['so_type']);
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = trim($_POST['kd_kapal']);
            $nm_kapal = trim($_POST['nm_kapal']);
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $posnr = trim($_POST['com_posnr']);
            $com_sisa = trim($_POST['com_sisa']);
            $nokontrakhead = trim($_POST['com_kontrak']);
            $no_pp_in = $fungsi->or_new_pp_gelondong_number($conn);
            $lelang_isi = trim($_POST['lelangFLAG']);
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);

            //field bypass
            /* $datatop = cektop();
              if ($datatop) {
              $top=$datatop['TOP'];
              $nama_top=$datatop['NAME_KEY'];
              }else{
              $show_ket.= "TOP Tidak ditemukan!!!";
              break;
              } */
            $top = $_POST['top'];
            $nama_top = $_POST['nama_top'];

            $pricelist = $_POST['pricelist'];
            $nama_pricelist = $_POST['nama_pricelist'];
            $valperlcnum = trim($_POST['perslcnum']);
            $lcnum = $_POST['lcnum'];
            $lcnum = $fungsi->sapcode($lcnum);

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "qty" . $k;
                $uom = "uom" . $k;
                $com_kontrak = "com_kontrak" . $k;
                // $com_posnr="com_posnr".$k;
                $noppref_inc = "refpp" . $k;

                if (isset($_POST[$shipto])) {
                    $shipto_in = trim($_POST[$shipto]);
                    $nama_shipto_in = trim($_POST[$nama_shipto]);
                    $alamat_in = trim($_POST[$alamat]);
                    $produk_in = trim($_POST[$produk]);
                    $kode_distrik_in = trim($_POST[$kode_distrik]);
                    $nama_distrik_in = trim($_POST[$nama_distrik]);
                    $kode_prov_in = trim($_POST[$kode_prov]);
                    $nama_prov_in = trim($_POST[$nama_prov]);
                    $nama_produk_in = trim($_POST[$nama_produk]);
                    $qty_in = trim($_POST[$qty]);
                    $uom_in = trim($_POST[$uom]);
                    $kontrak = $_POST[$com_kontrak];
                    // $posnr = $_POST[$com_posnr];
                    $tgl_kirim_in = trim($_POST['tgl_kirim' . $k]);
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $noppref_in = trim($_POST[$noppref_inc]);

                    //cek sudah di inputkan atau belum
                    $tgl_cekdt = explode('-', $tgl_kirim_in);
                    $tgl_ml = $tgl_cekdt[2] . $tgl_cekdt[1];
                    $str = "SELECT
                                        COUNT (*) AS JML_DATA
                                FROM
                                        OR_TRANS_REPLENISHMENT
                                WHERE
                                TO_CHAR (TGL_KIRIM_AWAL, 'YYYYMM') = '$tgl_ml'
                                AND SHIP_TO = '$shipto_in'
                                AND PLANT = '$plant'
                                AND KODE_PRODUK = '$produk_in'
                                AND DELETE_MARK = '0'";
                    $query2 = oci_parse($conn, $str);
                    oci_execute($query2);
                    while ($data = oci_fetch_assoc($query2)) {
                        if ($data['JML_DATA'] > 0) {

                            $show_ket .= "Gagal menyimpan data !!! <br> PP Replenishment tujuan gudang : " . $shipto_in . " - " . $nama_shipto_in . ", material " . $produk_in . " - " . $nama_produk_in . " data sudah dibuat sebelumnya pada plant : " . $plant . " - " . $nama_plant . " .Silahkan untuk dilakukan update data jika ada perubahan";
                        } else {

                            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP_GELONDONG', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_AWAL', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'DELETE_MARK', 'STATUS_LINE', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'ITEM_NUMBER', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT', 'CATATAN', 'INCOTERM', 'CARA_BAYAR', 'TERM_PAYMENT', 'NAMA_INCOTERM', 'SO_TYPE', 'NAMA_SO_TYPE', 'ROUTE', 'NAMA_TOP', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'DATE_CREATE', 'CREATE_BY');
                            $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "0", "OPEN", "$kode_distrik_in", "$nama_distrik_in", "$k", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$plant", "$nama_plant", "$ket", "$jenis_kirim_in", "$cara_bayar_in", "$top", "$nama_kirim_in", "$so_type", "$nama_so_type", "$route_in", "$nama_top", "$user_org_in", "$pricelist", "$nama_pricelist", "SYSDATE", "$user_name_in");
                            $tablename = "OR_TRANS_REPLENISHMENT";

                            $fungsi->insert($conn, $field_names, $field_data, $tablename);
                            $show_ket .= "PP Replenishment Success Created with No. $no_pp_in <br>";
                        }
                    }
                }
            }
        }

        $habis = $_POST['lasthalaman'];
        break;
//============================================================================================================================
//============================================================================================================================
    case "tambahnew2":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            $user_org_in = $_SESSION['user_org'];
            if (trim($_POST['org']) == '') {
                $user_org_in = $_SESSION['user_org'];
            } else {
                $user_org_in = trim($_POST['org']);
            }
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = trim($_POST['cara_bayar']);
            $branch_plant_in = trim($_POST['branch_plant']);
            $nama_plant_in = trim($_POST['nama_bplant']);
            $jenis_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['jenis_kirim']);
            $nama_kirim_in = trim($_POST['nama_kirim']);
            $sold_to_in = trim($_POST['sold_to']);
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = trim($_POST['nama_sold_to']);
            $route_in = trim($_POST['route']);
            $plant = trim($_POST['plant']);
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = trim($_POST['so_type']);
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = trim($_POST['kd_kapal']);
            $nm_kapal = trim($_POST['nm_kapal']);
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $no_pp_in = $fungsi->or_new_pp_number($conn);
            $lelang_isi = trim($_POST['lelangFLAG']);
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);

            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'FLAG_LELANG', 'TIPEPP');
            $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", "$lelang_isi", "$tipeCreatePP_isi");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);
            $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "qty" . $k;
                $uom = "uom" . $k;
                $tgl_kirim = "tgl_kirim" . $k;
                $noppref_inc = "refpp" . $k;

                if (isset($_POST[$shipto])) {
                    $tgl_kirim_in = $_POST[$tgl_kirim];
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $shipto_in = trim($_POST[$shipto]);
                    $nama_shipto_in = trim($_POST[$nama_shipto]);
                    $alamat_in = trim($_POST[$alamat]);
                    $produk_in = trim($_POST[$produk]);
                    $kode_distrik_in = trim($_POST[$kode_distrik]);
                    $nama_distrik_in = trim($_POST[$nama_distrik]);
                    $kode_prov_in = trim($_POST[$kode_prov]);
                    $nama_prov_in = trim($_POST[$nama_prov]);
                    $nama_produk_in = trim($_POST[$nama_produk]);
                    $qty_in = trim($_POST[$qty]);
                    $uom_in = trim($_POST[$uom]);
                    $noppref_in = trim($_POST[$noppref_inc]);

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_PPREF');
                    $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$noppref_in");
                    $tablename = "OR_TRANS_DTL";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);
                    $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                }
            }
        }

        $habis = $_POST['lasthalaman'];
        break;
//============================================================================================================================

    case "buatso":

        $pesan_telegram = "";
        //data header so
        $user_name_in = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        $channelnew = $_POST['channels'];
        if ($so_type == 'ZEX') {
            $distr_chan = "30";
        } elseif ($so_type == 'ZPR') {
            if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000')
                $distr_chan = "10";
            else if ($sales_org == '6000')
                $distr_chan = "10";
            else
                $distr_chan = "50";
        } else {
            $distr_chan = "10";
        }
        $division = "00";
        $dlv_block = "";
        $soldto = $_POST['distr_id'];
        $soldto = $fungsi->sapcode($soldto);
        $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
        if ($distr_chancondi != '') {
            $distr_chan = $distr_chancondi;
        }
        if ($channelnew != '') {
            $distr_chan = $channelnew;
        }
        $no_pp = $_POST['no_pp'];
        $tgl_pp = $_POST['tgl_pp'];
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        //$tanggal=gmdate("Ymd",time()+60*60*7);
        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $plant = $_POST['plant'];
        $nama_plant = trim($_POST['nama_plant']);
        $nm_kapal = $_POST['nm_kapal'];
        $incoterm1 = $_POST['incoterm'];
        $incoterm2 = $_POST['nama_incoterm'];
        $route = $_POST['route'];
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $lcnum = $_POST['lcnum'];
        $lcnum = $fungsi->sapcode($lcnum);
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $ket = "";
        $sampai1 = $_POST['jumlah'];
        for ($j = 0; $j <= $sampai1; $j++) {
            $idke = "idke" . $j;
            $pesan_telegram .= "PP $no_pp";

            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $kontrakh = $_POST['com_kontrak' . $j];
            }
        }

        // jalankan bapi create so sap	
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        unset($ex_so);
        $ex_so = true;
        //cegatan credit limit so khusus tlcc
//                if($sales_org=='6000'){
//                    require_once 'loadcreditlimit.php';
//                }

        if ($ex_so == true) {
            // SOCC v2
            $looping_end=1;
            $movetestrun='Z';
            for ($looping = 0; $looping <= $looping_end; $looping++) {
            if($movetestrun!='X'){
            ////////////
            $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
            if ($fce == false) {
                $sap->PrintStatus();
                exit;
            }
            //detail entri item'
            //$zak=$fungsi->qtyso($totalzak*1000);
            $sampai = $_POST['jumlah'];
            $ada = 0;
            for ($j = 0; $j <= $sampai - 1; $j++) {
                $idke = "idke" . $j;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $id_dtl = $_POST['com_iddtl' . $j];
                    $item_num1 = $_POST['com_line' . $j];
                    $item_num = $fungsi->linenum($item_num1);
                    $material = $_POST['com_produk' . $j];
                    $shipto = $_POST['com_shipto' . $j];
                    $shipto = $fungsi->sapcode($shipto);
                    $distrik = $_POST['com_distrik' . $j];
                    $qty = $_POST['com_qty' . $j];
                    $qtyx = $_POST['com_qtyx' . $j];
                    $tgl_kirim = $_POST['com_tgl_kirim' . $j];
                    $kontrak = $_POST['com_kontrak' . $j];
                    $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);

                    list($day, $month, $year) = split("-", $tgl_kirim);
                    $tgl_kirim = $year . $month . $day;
                                        //////////////////////////////////////////// proyek SOCC v.2
                                        // $plant_socc = $_POST['plant'];
                                        // $kode_distrik_socc = $_POST['com_distrik' . $j];
                                        // $material_for_socc = substr($_POST['com_produk' . $j],0,7);
                                        // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                                        // $tgl_terima_leadtime=$tgl_terima_leadtime;
                                        // if((date('H:i')>='15:00')){
                                        //     $tgl_terima_leadtime = $_POST['com_tgl_terima' . $j];
                                        //     $tgl_terima_leadtime = date('d-m-Y', strtotime($tgl_terima_leadtime. ' + 1 days'));
                                        // }
                                        // else{
                                            $tgl_terima_leadtime = $_POST['com_tgl_terima' . $j];
                                        // }
                                        list($day, $month, $year) = split("-", $tgl_terima_leadtime);
                                        $tgl_terima_leadtime = $year . $month . $day;


                                        // $tgl_fdate_socc=Date('d-m-Y');
                                        // list($day, $month, $year) = split("-", $tgl_fdate_socc);
                                        // $tgl_fdate_socc = $year . $month . $day;
                                        $tgl_fdate_socc=$tgl_kirim;
                                        ///////////////////////////////////////////
                    if ($qtyx != $qty) {
                        $ada = $ada + 1;
                    }

                    $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                    if ($so_type == 'ZFC') {
                        //$fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'ZKNN';//$item_cat;///salah revisi dibawah ini   
                        $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                        if ($sales_org == '6000') {
                            $ITEM_CATEGvali = 'ZKNN';
                        } else if ($sales_org == '4000' || $sales_org == '3000' || $sales_org == '7000' || $sales_org == '5000') {
                            $ITEM_CATEGvali = 'ZKLN';
                            //sales FOC distrik
                            if ($sales_org == '7000' || $sales_org == '5000') {
                                $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                                $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                            }
                        } else {
                            $ITEM_CATEGvali = 'ZKNN';
                        }
                        $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;
                    }
                    $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                    $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

                    if ($sales_org == '7900') {
                        $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                        $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                    }

                    //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                    if ($kontrak != '') {
                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                    }
                    $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                    //detail entri schedule n qty'
                    $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                    //////////////////////////////////////////////////////////// proyek SOCC V.2
                    // $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                    $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_fdate_socc;
                    ///////////////////////////////////////////////////////////
                    $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                    $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                    //detail entri distributor dan agen
                    if ($j == 0)
                        $item_num = '000000';
                    else
                        $item_num = $item_num;
                    $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                    $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                    $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                }
            }

            if ($sales_org == '3000') {
                $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
                if ($fce1 == false) {
                    $sap->PrintStatus();
                    exit;
                }

                //header entri

                $fce1->ZNMORG = 3000;
                $fce1->ZKUNNR = $shipto;
                $fce1->Call();
                if ($fce1->GetStatus() == SAPRFC_OK) {
                    $fce1->RETURN_DATA->Reset();
                    while ($fce1->RETURN_DATA->Next()) {
                        $kode = $fce1->RETURN_DATA->row["VKGRP"];
                    }
                }
                $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
            }
            if ($so_type == 'ZFC') {
            $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
            }
            
            $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
            $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
            $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
            $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
            $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
            $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
            $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
            $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
            $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
            $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
            $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
            $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
            $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
            // SOCC V2
            $fce->ORDER_HEADER_IN["TP_DATE"] = 'D';
            $fce->ORDER_HEADER_IN["REQ_DATE_H"] = $tgl_terima_leadtime;  
            /////
            if ($lcnum != '') {
                $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
            }
            if ($kontrakh != '') {
                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
            }

            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
            // SOCC V.2
            if($looping=='0' or $looping==0){
                $fce->TESTRUN = "X";
            }
            //
            // echo "mantap";
            // echo '<pre>';
            // print_r($fce);
            // echo '</pre>';
            $fce->Call();

            if ($fce->GetStatus() == SAPRFC_OK) {
                $nomorso = $fce->SALESDOCUMENT;
                $fce->RETURN->Reset();
                while ($fce->RETURN->Next()) {
                    $tipe = $fce->RETURN->row["TYPE"];
                    $msg = $fce->RETURN->row["MESSAGE"];
                    $id = $fce->RETURN->row["ID"];
                    $number = $fce->RETURN->row["NUMBER"];
                    if ($tipe != 'S') {
                        $show_ket .= $msg;
                        $show_ket .= '<br>';
                    // if($tipe=='W' && $id=='V1' && $number=='555'){

                        //SOCC v2
                        $show_ket .= 'SO long text';
                        $show_ket .= '<br>';
                        $movetestrun='X';
                        $nomorso = '';
                        ///
                    // }
                    }
                    //tambah pengujian rfc test run SOCC
                }
            }
            //SOCC v2
            }
            // $looping +=1;
            }
            ////////////////////////////////////////////////////////////// batas socc testrun
            if ($nomorso != '') {
                //Commit Transaction
                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                $fce->Call();

                //Update SO
                if ($nomorso != '' && $j > 0) {
                    sleep(5); //seconds to wait..    
                    $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                    $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                    $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                    $fce->Call();

                    //Commit Transaction
                    $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                    $fce->Call();
                }

                if ($sales_org == '6000') {
                    sleep(5); //seconds to wait..
                    //Teks
                    unset($tgl_kirimapp);
                    for ($j = 0; $j <= $sampai - 1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $item_num1 = $_POST['com_line' . $j];
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopolisiv = $_POST['com_nopolisi' . $j];
                            $com_typetruckv = $_POST['com_typetruck' . $j];
                            $com_catatanv = $_POST['com_catatan' . $j];
                            $com_kodekantong = $_POST['com_viewkodebag' . $j];
                            $tgl_kirimappT = $_POST['com_tgl_kirim' . $j];
                            $com_viewdrivern = $_POST['com_viewdrivern' . $j];
                            $com_viewsimv = $_POST['com_viewsim' . $j];
                            list($day, $month, $year) = split("-", $tgl_kirimappT);
                            $tgl_kirimapp .= $year . $month . $day . "!";

                            $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                            $fce->I_VBELN = $nomorso; //'000010';
                            $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                            $fce->I_TEXT1 = $com_nopolisiv;
                            $fce->I_TEXT2 = $com_typetruckv;
                            $fce->I_TEXT3 = $com_catatanv;
                            $fce->I_TEXT4 = $com_kodekantong;
                            $fce->I_TEXT6 = $com_viewdrivern;
                            $fce->I_TEXT7 = $com_viewsimv;
                            $fce->Call();
//                            echo "<pre>";
//                            //print_r($fce);
//                            echo "</pre>";
                        }
                    }

                    if ($sales_org == '6000' && $nomorso != '') {
                        $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                    }
                }

                //@liyantanto penambahan no ref pp
                if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000') {
                    sleep(5); //s
                    for ($j = 0; $j <= $sampai - 1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $item_num1 = $_POST['com_line' . $j];
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopppref = trim($_POST['com_ppref' . $j]);

                            if ($com_nopppref != '' && $nomorso != '') {
                                $pputam = substr($com_nopppref, 0, 10);
                                $itempputam = @(substr($com_nopppref, 10, 6) / 10);
                                $sql_ppref = "
                                    select ID,NO_SO,ITEM_NUMBER,NO_PPREF from OR_TRANS_DTL where DELETE_MARK=0 
                                    and NO_PP='$pputam' 
                                    and ITEM_NUMBER='$itempputam'
                                    ";
                                $query_ppref = oci_parse($conn, $sql_ppref);
                                oci_execute($query_ppref);
                                while ($row_ref = oci_fetch_array($query_ppref)) {
                                    $idPPREF = $row_ref[ID];
                                    $no_soref = $row_ref[NO_SO];
                                    $item_soref = $row_ref[ITEM_NUMBER];
                                }
                                $com_noppputam = $no_pp . sprintf("%06d", $item_num * 10);
                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                $fce->I_VBELN = $no_soref; //'000010';
                                $fce->I_POSNR = sprintf("%06d", $item_soref * 10); //'000010';
                                $fce->I_TEXT5 = $nomorso . sprintf("%06d", $item_num * 10); //pp ref
                                $fce->Call();

                                //update so pp ref
                                $field_namesppru = array('NO_PPREF');
                                $field_datapput = array("$com_noppputam");
                                $tablenamepput = "OR_TRANS_DTL";
                                $field_idpput = array('ID');
                                $value_idpput = array("$idPPREF");
                                $fungsi->update($conn, $field_namesppru, $field_datapput, $tablenamepput, $field_idpput, $value_idpput);

                                $nosoref = $no_soref . sprintf("%06d", $item_soref * 10);
                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                $fce->I_VBELN = $nomorso; //'000010';
                                $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                                $fce->I_TEXT5 = $nosoref; //pp ref
                                $fce->Call();
//                                echo "<pre>";
//                                //print_r($fce);
//                                echo "</pre>";
                            }
                        }
                    }
                }
            }
            $fce->Close();
            $sap->Close();

            if (($nomorso != "") and ( $ada == 0))
                $status = "APPROVE";
            else
                $status = "PROCESS";
            //update data header
            $field_names = array('PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'STATUS', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON', 'ORG');
            $field_data = array("$plant", "$nama_plant", "$top", "$status", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$lcnum", "$reason", "$nama_reason", "$sales_org");
            $tablename = "OR_TRANS_HDR";
            $field_id = array('ID');
            $value_id = array("$idh");
            $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
            // update data detail
            $sampai1 = $_POST['jumlah'];
            for ($k = 0; $k <= $sampai1; $k++) {
                $idke = "idke" . $k;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $id_dtl1 = $_POST['com_iddtl' . $k];
                    $qty1 = $_POST['com_qty' . $k];
                    $qtyx1 = $_POST['com_qtyx' . $k];
                    $kontrak = $_POST['com_kontrak' . $k];
                    $posnr = $_POST['com_posnr' . $k];
                    $kode_distrik = $_POST['com_distrik' . $k];
                    $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                    $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                    $item_numline1 = trim($_POST['com_line' . $k]);
                    $item_numline = $fungsi->linenum($item_numline1);
                    $com_kodekantong = $_POST['com_viewkodebag' . $k];
                    /////////////////////////////////////////// proyek SOCC V.2
                    $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                    $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                    //old
                    //-----------------------------------------------------------------------//
                    //new
                    $tgl_terima1 = $_POST['com_tgl_terima' . $k];
                    // $plant_socc = $_POST['plant'];
                    // $kode_distrik_socc = $_POST['com_distrik' . $k];
                    // $material_for_socc = substr($_POST['com_produk' . $k],0,7);
                    // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                    //                     if((date('H:i')>='15:00')){
                    //                         $tgl_terima_leadtime = date('d-m-Y', strtotime($tgl_terima_leadtime. ' - 1 days'));
                    //                     }
                    // $tglterimaleadtime = date('d-m-Y', strtotime($tgl_terima_leadtime));
                    
                    ///////////////////////////////////////////
                    if (($nomorso != "") and ( $qty1 == $qtyx1)){
                        $status1 = "APPROVE";
                        $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT', 'KODE_BAG');
                        $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$kontrak", "$plant", "$nama_plant", "$com_kodekantong");
                    }else{
                        $status1 = "PROCESS";
                        $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT', 'KODE_BAG');
                        $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$kontrak", "$plant", "$nama_plant", "$com_kodekantong");
                    }


                    $tablename = "OR_TRANS_DTL";
                    $field_id = array('ID');
                    $value_id = array("$id_dtl1");
                    $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                    if ($nomorso != "") {
                        $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                        $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', "SYSDATE", 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                        $tablenamefrom = "OR_TRANS_DTL";
                        $tablenameto = "OR_TRANS_APP";
                        $field_id1 = array('ID');
                        $value_id1 = array("$id_dtl1");
                        $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);

                        //@liyantanto update qty approve
                        if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000') {
                            $sql_qtya = "
                                        update OR_TRANS_DTL set QTY_APPROVE=(
                                                select sum(nvl(QTY_APPROVE,0)) as QTY from OR_TRANS_APP where NO_PP='$no_pp' and ITEM_NUMBER='$item_numline1'
                                                and DELETE_MARK=0 and STATUS_LINE='APPROVE'
                                        ) where ID='$id_dtl1'
                                    ";
                            $query_qtya = oci_parse($conn, $sql_qtya);
                            oci_execute($query_qtya);
                        }
                    }
                }
            }
            $show_ket .= 'Sales Order has been made with a number : ' . $nomorso;
            $pesan_telegram .= " Approve dengan no SO $nomorso (Approve By $user_name_in)";

            if ($sales_org == 4000) {
                botTelegram('-394888712', $pesan_telegram);
            }
        }
        if (isset($_POST['lasthalaman'])) {
            $habis = "list_approve_pp2.php";
        } else {
            $habis = "approve_pp.php";
        }
        break;
    //============================================================================================================================

    case "buatsomd":

        // CEK MAPPING PLANT ADA ATAU TIDAK
        $plantcek   = $_POST['plant'];
        $prclst     = $_POST['pricelist'];
        $str = "SELECT * FROM ZMD_MAPPING_PLANT
        WHERE PLANT_MD = '{$plantcek}' AND  DEL=0 AND PRICE_LIST ='{$prclst}'
        ";
        $query = oci_parse($conn, $str);
        oci_execute($query);
        $row = oci_fetch_array($query, OCI_ASSOC);
        //echo '<br> count:'.count($row);
        //jika tidak ada data plant berdasarkan price list
        if(count($row) <= 1){
        $str1 = "SELECT * FROM ZMD_MAPPING_PLANT
        WHERE PLANT_MD = '{$plantcek}' AND  DEL=0
        ";
        $query1 = oci_parse($conn, $str1);
        oci_execute($query1);
        $row = oci_fetch_array($query1, OCI_ASSOC);
        //echo '<br> count:'.count($row);exit;
        }
        
        $lanjut = 'Y';
        $next = 'Y';
        $SO1 = '';
        $IDH1 = '';
        $SO2 = '';
        $IDH2 = '';
        $SO3 = '';
        $IDH3 = '';
        $SO4 = '';
        $IDH4 = '';
        $jerror = 0;
        $SOMDNE = 'N';
        
        if (count($row) > 1) {
            // CEK MAPPING CUSTOMER ADA ATAU TIDAK
            $soldtocek = $_POST['distr_id'];
            
            $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'  AND DEL = 0 AND PLANT_MD ='{$plantcek}'";
            $querysoldto = oci_parse($conn, $strsoldto);
            oci_execute($querysoldto);
            $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
            
            if(count($rowsoldto) <= 1){
                $strsoldto1 = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'  AND DEL = 0";
                $querysoldto1 = oci_parse($conn, $strsoldto1);
                oci_execute($querysoldto1);
                
                $rowsoldto = oci_fetch_array($querysoldto1, OCI_ASSOC); 
            }
            
            if (count($rowsoldto) <= 1) {
                $lanjut = 'N';
                $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
            }
            } else {
            $lanjut = 'N';
            $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
            ;
        }

        // CEK ICS
        if ($row["COM_MD_2"] != "" && $row["PLANT_MD_2"] != "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 3;
            $ics = "Y";
            $loncat = "N";
//            echo 'ICS INI 2';
        } else if ($row["COM_MD_2"] == "" && $row["PLANT_MD_2"] == "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 2;
            $ics = "Y";
            $loncat = "Y"; /// MD @ tidak di pakai
//            echo 'ICS INI 1';
        } else {
            $perulangan = 3;
            $perulanganSO = 2;
            $perulanganPO = 1;
            $ics = "N";
            $loncat = "N";
//            echo 'ICS INI 3';
        }



        // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
        if ($lanjut == 'Y') {
            // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
            for ($ul = 1; $ul <= $perulangan; $ul++) {

                if ($next == 'Y') {

                    $incoterm1 = $_POST['incoterm'];
                    $incoterm2 = $_POST['nama_incoterm'];
                    $route     = $_POST['route'];
                    $top       = $_POST['top'];
                    $nama_top  = $_POST['nama_top'];

                    if ($ul == 1) {
                        $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $soldto = $_POST['distr_id'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
                        $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2
                    } else if ($ul == 2) {
                        $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2
                        $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org2 = $row['COM_OPCO'];
                        $plant2 = $row['PLANT_OPCO'];
                        
                        $incoterm1 = ISSET($row['INCOTERM_OPCO_1']) ? $row['INCOTERM_OPCO_1'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_OPCO_1']) ? $row['INCOTERM_OPCO_1'] : $_POST['nama_incoterm'];
                        
                        $incotermPO1  = $incoterm1;
                        $incotermPO12 = $incoterm2;
                        
                        //penambahan rute
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        
                    } else if ($ul == 3 && $ics == "Y") {
                        $sales_org = $row['COM_MD_2'];
                        $plant = $row['PLANT_MD_2'];
                        $soldto = $rowsoldto['SOLD_TO_MD_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org3 = $row['COM_MD_2'];
                        $plant3 = $row['PLANT_MD_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
                        
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        //penambahan rute dan TOP
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        //echo '<br> hasil rute :'.$route;
                        
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        //penambahan rute top
                        
                    } else if ($ul == 4 && $ics == "Y") {
                        $sales_org = $row['COM_OPCO_2'];
                        $plant = $row['PLANT_OPCO_2'];
                        $soldto = $rowsoldto['SOLD_TO_OPCO_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org4 = $row['COM_OPCO_2'];
                        $plant4 = $row['PLANT_OPCO_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
                        //penambahan rute dan TOP
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        $topPO2    = $top;
                        //penambahan rute top
                        
                        $incotermPO2 = $incoterm1;
                        $incotermPO22 = $incoterm2;
                    }
                    $pesan_telegram = "";
                    //data header so
                    $user_name_in = $_SESSION['user_name'];
                    $idh = $_POST['idh'];
                    $ship_condition = $_POST['ship_condition'];
                    $iddtl = $_POST['iddtl'];
                    $so_type = $_POST['so_type'];
                    $nama_so_type = $_POST['nama_so_type'];
                    $channelnew = $_POST['channels'];
                    if ($so_type == 'ZEX') {
                        $distr_chan = "30";
                    } elseif ($so_type == 'ZPR') {
                        if ($sales_org == '2000') {
                            $distr_chan = "10";
                        } else if ($sales_org == '3000' || $sales_org == '5000' || $sales_org == '7000' || $sales_org == '7900' || $sales_org == '4000') { // tambahan pak yusuf untuk bisa memilih dist channel proyek MD
                            $distr_chan = $_POST['channels'];
                        } else if ($sales_org == '6000') {
                            $distr_chan = "10";
                        } else {
                            $distr_chan = "50";
                        }
                    } else {
                        $distr_chan = "10";
                    }
                    $division = "00";
                    $dlv_block = "";
                    $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
                    if ($distr_chancondi != '') {
                        $distr_chan = $distr_chancondi;
                    }
                    if ($channelnew != '') {
                        $distr_chan = $channelnew;
                    }

                    $distr_chanPO1 = $distr_chan;
                    if ($ul == 3 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                    } else if ($ul == 4 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                        $distr_chanPO2 = $distr_chan;
                    }

                    $no_pp = $_POST['no_pp'];
                    $tgl_pp = $_POST['tgl_pp'];
                    list($day, $month, $year) = split("-", $tgl_pp);
                    $tgl_pp = $year . $month . $day;
                    //$tanggal=gmdate("Ymd",time()+60*60*7);
                    //$top = $_POST['top'];
                    //$nama_top = $_POST['nama_top'];
                    $reason = $_POST['reason'];
                    $nama_reason = $_POST['nama_reason'];
                    $nama_plant = trim($_POST['nama_plant']);
                    $nm_kapal = $_POST['nm_kapal'];
                    //$route = $_POST['route'];
                    $pricelist = $_POST['pricelist'];
                    $nama_pricelist = $_POST['nama_pricelist'];
                    $ketbayar = $_POST['bayar'];
                    $lcnum = $_POST['lcnum'];
                    $lcnum = $fungsi->sapcode($lcnum);
                    $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
                    $route_desc = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "ROUTE_DESC");
                    $ket = "";
                    $sampai1 = $_POST['jumlah'];
                    for ($j = 0; $j <= $sampai1; $j++) {
                        $idke = "idke" . $j;
                        $pesan_telegram .= "PP $no_pp";

                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $kontrakh = $_POST['com_kontrak' . $j];
                        }
                    }

                    // jalankan bapi create so sap	
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        $sap->PrintStatus();
                        exit;
                    }


                    if ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) {
                        $COM = 'MD';
                    } else {
                        $COM = 'SBI';
                    }


                    unset($ex_so);
                    $ex_so = true;
                    //cegatan credit limit so khusus tlcc
                    //                if($sales_org=='6000'){
                    //                    require_once 'loadcreditlimit.php';
                    //                }
                    // PROSES FOR 1 DAN 2 MENYIMPAN SO
                 //   echo "Loncat gak ".$loncat ;
                    if ($ul <= $perulanganSO && $COM == 'MD') {
                        
                        if ($loncat == "N") {
                            $gass = "Y";
                        } else if ($loncat == "Y") { 
                            if ($ul == '3') {
                                $gass = "N"; 
                            } else {
                                $gass = "Y";
                            }
                        }

                        if ($gass == "Y") { // loncat tidak membuat SO MD 2 karena tidak di mammping plant
                            if ($ex_so == true) {
                                // SOCC v2
                                $looping_end=1;
                                $movetestrun='Z';
                                for ($looping = 0; $looping <= $looping_end; $looping++) {
                                if($movetestrun!='X'){
                                ////////////
                                $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
                                // echo "mantap";
                                if ($fce == false) {
                                    $sap->PrintStatus();
                                    exit;
                                }
                                
                                //detail entri item'
                                //$zak=$fungsi->qtyso($totalzak*1000);
                                $sampai = $_POST['jumlah'];
                                $ada = 0;
                                $shipto_awal = '';
                                for ($j = 0; $j <= $sampai - 1; $j++) {
                                    $idke = "idke" . $j;
                                    $shipto_awal = $_POST['com_shipto0'];
                                    if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                        $id_dtl = $_POST['com_iddtl' . $j];
                                        $item_num1 = $_POST['com_line' . $j];
                                        $item_num = $fungsi->linenum($item_num1);

                                        $material = $_POST['com_produk' . $j];
                                        if ($ul == 1) {
                                            $shipto = $_POST['com_shipto' . $j];     // GANTI BERDASARKAN MAPPING CUSTOMER 
                                            $material1 = $_POST['com_produk' . $j];
                                        } else if ($ul == 2 || $ul == 3 || $ul == 4) {
                                            $shiptotocek = $_POST['com_shipto' . $j];
                                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}' AND PLANT_MD ='{$plantcek}'";
                                            $queryshipto = oci_parse($conn, $strshipto);
                                            oci_execute($queryshipto);
                                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            
                                            if(count($rowshipto) <= 1){
                                                $strshipto1 = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                                $queryshipto1 = oci_parse($conn, $strshipto1);
                                                oci_execute($queryshipto1);
                                                $rowshipto = oci_fetch_array($queryshipto1, OCI_ASSOC); 
                                            }
                                            
                                            if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND PLANT_MD ='{$plantcek}'";
                                                $queryshipto = oci_parse($conn, $strshipto);
                                                oci_execute($queryshipto);
                                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                                
                                                if(count($rowshipto) <= 1){
                                                    $strshipto1 = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                                    $queryshipto1 = oci_parse($conn, $strshipto1);
                                                    oci_execute($queryshipto1);
                                                    $rowshipto = oci_fetch_array($queryshipto1, OCI_ASSOC);  
                                                }
                                            }
                                            if ($ul == 2) {
                                                $shipto = $rowshipto['SHIP_TO_OPCO'];
                                                $soldto = $rowshipto['SOLD_TO_OPCO'];
                                            } else if ($ul == 3) {
                                                $shipto = $rowshipto['SHIP_TO_MD_2'];
                                                $soldto = $rowshipto['SOLD_TO_MD_2'];
                                            } else if ($ul == 4) {
                                                $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                                $soldto = $rowshipto['SOLD_TO_OPCO_2'];
//                                                echo "empat ".$shipto;echo "<br>";
//                                                echo "empat ".$soldto;
                                            }


                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                            if ($ul == 2) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                            } else if ($ul == 3) {
                                                $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                            } else if ($ul == 4) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                            }
                                        }

                                        $shipto = $fungsi->sapcode($shipto);
                                        $distrik = $_POST['com_distrik' . $j];
                                        $qty = $_POST['com_qty' . $j];
                                        $qtyx = $_POST['com_qtyx' . $j];
                                        $tgl_kirim = $_POST['com_tgl_kirim' . $j];
//                                        if($sales_org=="7900"){ 
//                                            $kontrak = $_POST['com_kontrak' . $j];
//                                        }else{
//                                            $kontrak = "";
//                                        }
                                        $kontrak = $_POST['com_kontrak' . $j];

                                        $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);

                                        list($day, $month, $year) = split("-", $tgl_kirim);
                                        $tgl_kirim = $year . $month . $day;

                                        //////////////////////////////////////////// proyek SOCC v.2
                                        // $plant_socc = $_POST['plant'];
                                        // $kode_distrik_socc = $_POST['com_distrik' . $j];
                                        // $material_for_socc = substr($_POST['com_produk' . $j],0,7);
                                        // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                                        // $tgl_terima_leadtime=$tgl_terima_leadtime;
                                        // list($day, $month, $year) = split("-", $tgl_terima_leadtime);
                                        // $tgl_terima_leadtime = $year . $month . $day;

                                        // $tgl_fdate_socc=Date('d-m-Y');
                                        // list($day, $month, $year) = split("-", $tgl_fdate_socc);
                                        // $tgl_fdate_socc = $year . $month . $day;
                    
                                                            $tgl_terima_leadtime = $_POST['com_tgl_terima' . $j];
                                                            list($day, $month, $year) = split("-", $tgl_terima_leadtime);
                                                            $tgl_terima_leadtime = $year . $month . $day;
                                        
                                                            $tgl_fdate_socc=$tgl_kirim;
                    
                                        ///////////////////////////////////////////

                                        if ($qtyx != $qty) {
                                            $ada = $ada + 1;
                                        }
                                        $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                        $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                                        if ($so_type == 'ZFC') {
                                            if($sales_org=='7900' || $sales_org=='7000'){
                                                $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";    // Tambahan MD 
                                            }    
                                            //$fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'ZKNN';//$item_cat;///salah revisi dibawah ini   
                                            $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                                            if ($sales_org == '6000') {
                                                $ITEM_CATEGvali = 'ZKNN';
                                            } else if ($sales_org == '4000' || $sales_org == '3000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900') {
                                                $ITEM_CATEGvali = 'ZKLN';
                                                //sales FOC distrik
                                            } else {
                                                $ITEM_CATEGvali = 'ZKNN';
                                            }
                                            $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;
                                        }



                                        $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik; // penambahan distrik
                                        $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                                        $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                                        $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
                                        //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
//                                        if ($kontrak != '' && $sales_org == "7900") {
//                                            $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
//                                            $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
//                                            $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
//                                        }
                                        if ($kontrak != '') {
                                            $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                                            $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                                            $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                                        }
                                        $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                                        //detail entri schedule n qty'
                                        $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                        $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                                        //////////////////////////////////////////////////////////// proyek SOCC V.2
                                        // $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                                        $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_fdate_socc;
                                        ///////////////////////////////////////////////////////////
                                        $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                                        $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                        $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                                        $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                                        $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                                        $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                                        //detail entri distributor dan agen
                                        if ($j == 0)
                                            $item_num = '000000';
                                        else
                                            $item_num = $item_num;
                                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                        $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                                        $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                                        $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                                    }
                                }

                                if ($sales_org == '3000') {
                                    $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
                                    if ($fce1 == false) {
                                        $sap->PrintStatus();
                                        exit;
                                    }

                                    //header entri

                                    $fce1->ZNMORG = 3000;
                                    $fce1->ZKUNNR = $shipto;
                                    $fce1->Call();
                                    if ($fce1->GetStatus() == SAPRFC_OK) {
                                        $fce1->RETURN_DATA->Reset();
                                        while ($fce1->RETURN_DATA->Next()) {
                                            $kode = $fce1->RETURN_DATA->row["VKGRP"];
                                        }
                                    }
                                    $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
                                    
                                }

                                // if($ul==1 || $ul==2 ){
                                //	$fce->TESTRUN = "X"; 
                                // }
                                //penambahan sales office
                                $dt_shipto = "SELECT BZIRK, VKBUR, VKGRP FROM RFC_Z_ZCSD_SHIPTO WHERE KUNN2 = '{$shipto}' AND ROWNUM =1";
                                //                            echo $dt_shipto;
                                $dt_shipto_q = oci_parse($conn, $dt_shipto);
                                oci_execute($dt_shipto_q);
                                $row_dt_shipto = oci_fetch_array($dt_shipto_q, OCI_ASSOC);

                                $fce->ORDER_HEADER_IN["SALES_GRP"] = $row_dt_shipto["VKGRP"];
                                $fce->ORDER_HEADER_IN["SALES_DIST"] = $row_dt_shipto["BZIRK"];
                                $fce->ORDER_HEADER_IN["SALES_OFF"] = $row_dt_shipto["VKBUR"];
                                // end penambahan sales office


                                if ($so_type == 'ZFC') {
                                    $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
                                } else {
                                    $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                                }
                                $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
                                $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
                                $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
                                $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
                                $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
                                $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
                                $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
                                $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
                                $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
                                $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
                                $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
                                $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
                                $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
                                // SOCC V2
                                $fce->ORDER_HEADER_IN["TP_DATE"] = 'D';
                                $fce->ORDER_HEADER_IN["REQ_DATE_H"] = $tgl_terima_leadtime;  
                                /////
                                if ($sales_org == "7900" || $sales_org == "7000") {
                                $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
                                $querytax = oci_parse($conn, $strtax);
                                oci_execute($querytax);
                                $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
                                if (ISSET($rowtax["KD_SOLD_TO"])) {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                } else {
                                    if ($so_type == 'ZFC') {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                    }else{
                                    
                                    $sldto_fr = substr($soldto, 0, 6);
                                    $sldto_bw = substr($soldto, 6, 4);
                                    
                                    if($sldto_fr != '000000' || $sldto_bw < 3000){
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
                                    }
                                    }
                                }

//                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
                            }

                                if ($lcnum != '') {
                                    $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                                    $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
                                }
//                                if ($kontrakh != '' && $sales_org=="7900") {
//                                    $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
//                                    $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
//                                }
                                if ($kontrakh != '') {
                                    $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                                    $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
                                }

                                $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
                                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
                                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                                $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto_awal;
                                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                                // SOCC V.2
                                if($looping=='0' or $looping==0){
                                    $fce->TESTRUN = "X";
                                }
                                //
                                        // echo "<pre>";
                                        // print_r($fce);
                                        // echo "</pre>";
                                $fce->Call();
                                if ($fce->GetStatus() == SAPRFC_OK) {
                                    $nomorso = $fce->SALESDOCUMENT;
                                    $fce->RETURN->Reset();
                                    while ($fce->RETURN->Next()) {
                                        $tipe = $fce->RETURN->row["TYPE"];
                                        $msg = $fce->RETURN->row["MESSAGE"];
                                        //SOCC V.2
                                        if ($tipe != 'S') {
                                        // if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                            $show_ket .= $msg;
                                            $show_ket .= '<br>';
                                            $next = "N";
                                            $show_ket .= 'SO long text';
                                            $show_ket .= '<br>';
                                            $movetestrun='X';
                                            $nomorso = '';
                                        }
                                        ///////////////
                                    }
                                //SOCC v.2
                                }
                                }   
                                // $looping +=1;
                                }

                                if($nomorso!=''or $nomorso!=null){
                                ///////////////

                                    //Commit Transaction
                                    $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                    $fce->Call();

                                    //Update SO
                                    if ($nomorso != '' && $j > 0) {
                                        sleep(5); //seconds to wait..    
                                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                        $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                                        $fce->Call();

                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();
                                    }

                                    if ($sales_org == '6000') {
                                        sleep(5); //seconds to wait..
                                        //Teks
                                        unset($tgl_kirimapp);
                                        for ($j = 0; $j <= $sampai - 1; $j++) {
                                            $idke = "idke" . $j;
                                            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                                $item_num1 = $_POST['com_line' . $j];
                                                $item_num = $fungsi->linenum($item_num1);
                                                $com_nopolisiv = $_POST['com_nopolisi' . $j];
                                                $com_typetruckv = $_POST['com_typetruck' . $j];
                                                $com_catatanv = $_POST['com_catatan' . $j];
                                                $com_kodekantong = $_POST['com_viewkodebag' . $j];
                                                $tgl_kirimappT = $_POST['com_tgl_kirim' . $j];
                                                $com_viewdrivern = $_POST['com_viewdrivern' . $j];
                                                $com_viewsimv = $_POST['com_viewsim' . $j];
                                                list($day, $month, $year) = split("-", $tgl_kirimappT);
                                                $tgl_kirimapp .= $year . $month . $day . "!";

                                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                                $fce->I_VBELN = $nomorso; //'000010';
                                                $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                                                $fce->I_TEXT1 = $com_nopolisiv;
                                                $fce->I_TEXT2 = $com_typetruckv;
                                                $fce->I_TEXT3 = $com_catatanv;
                                                $fce->I_TEXT4 = $com_kodekantong;
                                                $fce->I_TEXT6 = $com_viewdrivern;
                                                $fce->I_TEXT7 = $com_viewsimv;
                                                $fce->Call();
                                                //                            echo "<pre>";
                                                //                            //print_r($fce);
                                                //                            echo "</pre>";
                                            }
                                        }

                                        if ($sales_org == '6000' && $nomorso != '') {
                                            $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                                        }
                                    }

                                    //@liyantanto penambahan no ref pp
                                    if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000') {
                                        sleep(5); //s
                                        for ($j = 0; $j <= $sampai - 1; $j++) {
                                            $idke = "idke" . $j;
                                            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                                $item_num1 = $_POST['com_line' . $j];
                                                $item_num = $fungsi->linenum($item_num1);
                                                $com_nopppref = trim($_POST['com_ppref' . $j]);

                                                if ($com_nopppref != '' && $nomorso != '') {
                                                    $pputam = substr($com_nopppref, 0, 10);
                                                    $itempputam = @(substr($com_nopppref, 10, 6) / 10);
                                                    $sql_ppref = "
											select ID,NO_SO,ITEM_NUMBER,NO_PPREF from OR_TRANS_DTL where DELETE_MARK=0 
											and NO_PP='$pputam' 
											and ITEM_NUMBER='$itempputam'
											";
                                                    $query_ppref = oci_parse($conn, $sql_ppref);
                                                    oci_execute($query_ppref);
                                                    while ($row_ref = oci_fetch_array($query_ppref)) {
                                                        $idPPREF = $row_ref[ID];
                                                        $no_soref = $row_ref[NO_SO];
                                                        $item_soref = $row_ref[ITEM_NUMBER];
                                                    }
                                                    $com_noppputam = $no_pp . sprintf("%06d", $item_num * 10);
                                                    $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                                    $fce->I_VBELN = $no_soref; //'000010';
                                                    $fce->I_POSNR = sprintf("%06d", $item_soref * 10); //'000010';
                                                    $fce->I_TEXT5 = $nomorso . sprintf("%06d", $item_num * 10); //pp ref
                                                    $fce->Call();

                                                    //update so pp ref
                                                    $field_namesppru = array('NO_PPREF');
                                                    $field_datapput = array("$com_noppputam");
                                                    $tablenamepput = "OR_TRANS_DTL";
                                                    $field_idpput = array('ID');
                                                    $value_idpput = array("$idPPREF");
                                                    $fungsi->update($conn, $field_namesppru, $field_datapput, $tablenamepput, $field_idpput, $value_idpput);

                                                    $nosoref = $no_soref . sprintf("%06d", $item_soref * 10);
                                                    $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                                    $fce->I_VBELN = $nomorso; //'000010';
                                                    $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                                                    $fce->I_TEXT5 = $nosoref; //pp ref
                                                    $fce->Call();
                                                    //                                echo "<pre>";
                                                    //                                //print_r($fce);
                                                    //                                echo "</pre>";
                                                }
                                            }
                                        }
                                    }
                                }

                                // Setelah SO ter create
                                if ($ul == 1) {
                                    $SO1 = $nomorso;
                                    $IDH1 = $idh;
                                } else if ($ul == 2) {
                                    $SO2 = $nomorso;
                                    $IDH2 = $idh;
                                } else if ($ul == 3) {
                                    $SO3 = $nomorso;
                                    $IDH3 = $idh;
                                } else if ($ul == 4) {
                                    $SO4 = $nomorso;
                                    $IDH4 = $idh;
                                }
                                if ($next == "Y" && $ul == 1) {

                                    if (($nomorso != "") and ( $ada == 0))
                                        $status = "APPROVE";
                                    else
                                        $status = "PROCESS";
                                    //update data header
                                    $field_names = array('PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'STATUS', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON', 'ORG', "SHIPPING_CONDITION" );
                                    $field_data = array("$plant", "$nama_plant", "$top", "$status", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$lcnum", "$reason", "$nama_reason", "$sales_org", "$ship_condition");
                                    $tablename = "OR_TRANS_HDR";
                                    $field_id = array('ID');
                                    $value_id = array("$idh");
                                    $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                                    // update data detail
                                    $sampai1 = $_POST['jumlah'];
                                    for ($k = 0; $k <= $sampai1; $k++) {
                                        $idke = "idke" . $k;
                                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                            $id_dtl1 = $_POST['com_iddtl' . $k];
                                            $qty1 = $_POST['com_qty' . $k];
                                            $qtyx1 = $_POST['com_qtyx' . $k];
//                                            if($sales_org=="7900"){ 
//                                                $kontrak = $_POST['com_kontrak' . $k];
//                                            }else{
//                                                $kontrak = "";
//                                            }
                                            $kontrak = $_POST['com_kontrak' . $k];

                                            $posnr = $_POST['com_posnr' . $k];
                                            $kode_distrik = $_POST['com_distrik' . $k];
                                            /////////////////////////////////////////// proyek SOCC V.2
                                            $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                                            $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                                            //old
                                            //-----------------------------------------------------------------------//
                                            //new
                                            $tgl_terima1 = $_POST['com_tgl_terima' . $k];
                                            // if((date('H:i')>='15:00')){
                                            //     $tgl_terima_leadtime = date('d-m-Y', strtotime($tgl_terima_leadtime. ' - 1 days'));
                                            // }
                                            // $tglterimaleadtime = date('d-m-Y', strtotime($tgl_terima_leadtime));
                                            // $plant_socc = $_POST['plant'];
                                            // $kode_distrik_socc = $_POST['com_distrik' . $k];
                                            // $material_for_socc = substr($_POST['com_produk' . $k],0,7);
                                            // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                                            ///////////////////////////////////////////
                                            $item_numline1 = trim($_POST['com_line' . $k]);
                                            $item_numline = $fungsi->linenum($item_numline1);
                                            $com_kodekantong = $_POST['com_viewkodebag' . $k];

                                            if (($nomorso != "") and ( $qty1 == $qtyx1)){
                                                $status1 = "APPROVE";
                                                $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT', 'KODE_BAG');
                                                $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$kontrak", "$plant", "$nama_plant", "$com_kodekantong");
                                            }else{
                                                $status1 = "PROCESS";
                                                $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT', 'KODE_BAG');
                                                $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$kontrak", "$plant", "$nama_plant", "$com_kodekantong");
                                            }

                                            $tablename = "OR_TRANS_DTL";
                                            $field_id = array('ID');
                                            $value_id = array("$id_dtl1");
                                            $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                                            if ($nomorso != "") {
                                                $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                                                $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', "SYSDATE", 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                                                $tablenamefrom = "OR_TRANS_DTL";
                                                $tablenameto = "OR_TRANS_APP";
                                                $field_id1 = array('ID');
                                                $value_id1 = array("$id_dtl1");
                                                $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);

                                                //@liyantanto update qty approve
                                                if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000') {
                                                    $sql_qtya = "
														update OR_TRANS_DTL set QTY_APPROVE=(
																select sum(nvl(QTY_APPROVE,0)) as QTY from OR_TRANS_APP where NO_PP='$no_pp' and ITEM_NUMBER='$item_numline1'
																and DELETE_MARK=0 and STATUS_LINE='APPROVE'
														) where ID='$id_dtl1'
													";
                                                    $query_qtya = oci_parse($conn, $sql_qtya);
                                                    oci_execute($query_qtya);
                                                }
                                            }
                                        }
                                    }
                                }

                                if ($ul == 1 || $ul == 3) {
                                    $numbering = " SO MD = ";
                                } else {
                                    $numbering = " SO OPCO = ";
                                }
                                $show_ket .= $ul . '' . $numbering . ' Sales Order has been made with a number : ' . $nomorso . '<br />';
                                $pesan_telegram .= " Approve dengan no SO $nomorso (Approve By $user_name_in)";

                                if ($sales_org == 4000) {
                                    botTelegram('-394888712', $pesan_telegram);
                                }
                            
                        }
                        }//if loncat MD 2 tidak pakai
                        $jerror += 1;
                    } else if ($ul == 2 || $ul == 4 && $COM == "SBI") {

                        //print_r($ul);
                        //print_r("<br />");
                        // build array material
                        $Tmaterial = array();
                        $Tmaterial['MaterialCode'] = array();
                        $Tmaterial['PlantCode'] = array();
                        $Tmaterial['Qty'] = array();
                        $Tmaterial['QtyUnit'] = array();
                        $Tmaterial['ScheduleLine'] = array();
                        $Tmaterial['RequestDeliveryDate'] = array();
                        $Tmaterial['RequestDeliveryQty'] = array();
                        $Dmaterial = array();
                        for ($j = 0; $j <= $sampai - 1; $j++) {
                            $material = $_POST['com_produk' . $j];
                            $strmat = "SELECT CAST(NTGEW AS float) as BERAT, A.* FROM RFC_Z_ZCSD_LIST_MAT_SALES_2 A WHERE VKORG = '{$sales_org1}' AND MATNR = '{$material}'  AND WERKS = '{$plant1}'";
                            $querymat = oci_parse($conn, $strmat);
                            oci_execute($querymat);
                            $rowmat = oci_fetch_array($querymat, OCI_ASSOC);
//                            echo json_encode($rowmat); 
                            if (count($rowmat) > 0 && $rowmat['MEINS'] == "ZAK") {
                                $qty = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
                                $qtyx = ( intval($_POST['com_qtyx' . $j]) * $rowmat['BERAT'] ) / 1000;
                            } else {
                                $qty = $_POST['com_qty' . $j];
                                $qtyx = $_POST['com_qtyx' . $j];
                            }



                            $shiptotocek = $_POST['com_shipto' . $j];
                            $item_numline = sprintf("%04d", $j + 1);
                            $tanggall = $_POST['com_tgl_kirim' . $j];
                            list($day, $month, $year) = split("-", $tanggall);
                            $tgl_kirim = $year . "-" . $month . "-" . $day;

                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                            $querymaterial = oci_parse($conn, $strmaterial);
                            oci_execute($querymaterial);
                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);

                            if ($ul == 2) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO"];
                            } else if ($ul == 4) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO_2"];
                            }
                            $Tmaterial['MaterialCode'] = $materialsbi;
                            $Tmaterial['PlantCode'] = $plant;
                            $Tmaterial['Qty'] = $qty;
                            $Tmaterial['QtyUnit'] = "TO";
                            $Tmaterial['ScheduleLine'] = $item_numline;
                            $Tmaterial['RequestDeliveryDate'] = $tgl_kirim;
                            $Tmaterial['RequestDeliveryQty'] = $qtyx;
                            $Dmaterial[] = $Tmaterial;
                        }

                        $strorder = "SELECT * FROM ZMD_MAPPING_ORDER WHERE ORDER_TYPE_MD = '{$so_type}' AND COMPANY_OPCO = '{$sales_org}' AND DEL = 0";
                        $queryorder = oci_parse($conn, $strorder);
                        oci_execute($queryorder);
                        $roworder = oci_fetch_array($queryorder, OCI_ASSOC);

                        list($day, $month, $year) = split("-", $tanggall);
                        $tgl_kirim = $year . $month . $day;


                        $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                        $queryshipto = oci_parse($conn, $strshipto);
                        oci_execute($queryshipto);
                        $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                        if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                            $queryshipto = oci_parse($conn, $strshipto);
                            oci_execute($queryshipto);
                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                        }
                        if ($ul == 2) {
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO'];
                            $shipto = $rowshipto['SHIP_TO_OPCO'];
                            $SOMD = $SO1;
                        } else if ($ul == 4) {
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO_2'];
                            $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                            $SOMD = $SO3;
                        }

                        // proyek SOCC V2
                        $tgl_pp = $_POST['tgl_pp'];

                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_ppPO = $year . "-" . $month . "-" . $day . " 00:00:00";
                        $tgl_pp = $tgl_fdate_socc;
                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_pp = $year . $month . $day;


                        if ($sales_org == "PTSC") {
                            $sales_organization = "SCBD";
                        } else if ($sales_org == "ID50") {
                            $sales_organization = "ID11";
                        }

                        if(empty($ship_condition)){
                        
                            if ($incoterm1 == "FOT") {
                                $shipcond_sbi = "PK";
                            } else if ($incoterm1 == "FRC") {
                                $shipcond_sbi = "D0";
                            } else if ($incoterm1 == "CNF") {
                                $shipcond_sbi = "DV";
                            } else {
                                $shipcond_sbi = "";
                            }
                        
                        }else{
                            $shipcond_sbi = $ship_condition;
                        }
                        
                        $strtop = "SELECT * FROM ZMD_MAPPING_TOP WHERE COM_SMI = '{$sales_org1}' AND TOP_SMI = '{$top}' AND (COM_SB = '{$sales_org}' or COM_SB = 'ALL')  AND DEL = 0 order by COM_SB DESC";
                        $querytop = oci_parse($conn, $strtop);
                        oci_execute($querytop);
                        $rowtop = oci_fetch_array($querytop, OCI_ASSOC);
                        if (ISSET($rowtop['TOP_SB'])) {
                            $topsbi = $rowtop['TOP_SB'];
                        }else{
                            $topsbi = null;
                        }    
                        $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
                        $data = array('Token' => 'aSsMx7GV0HFGzlufM4DH',
                            'SystemID' => 'PASSO',
                            'Data' => array('SalesDocumentType' => $roworder["ORDER_TYPE_OPCO"],
                                'SalesOrganization' => $sales_organization,
                                'DistributionChannel' => 'DB',
                                'Division' => 'CM',
                                'SalesDocumentDate' => $tgl_pp,
                                'ShippingCondition' => $shipcond_sbi, //shipcond
                                'ShippingType' => 'G4',
                                'SoldToCode' => $soldtosbi,
                                'ShipToCode' => $shipto,
                                'MDReferenceSONumber' => $SOMD,
                                'MDPurchaseOrderNumber' => $no_pp,
                                'MDPurchaseOrderItem' => '00010',
                                'PurchaseOrderNumber' => $no_pp,
                                'PurchaseOrderDate' => $tgl_ppPO,
                                'PaymentTerms' => $topsbi,
                                'Items' => $Dmaterial
                            )
                        );
                        $options = array(
                            'http' => array(
                                'header' => "Content-type: application/json\r\n",
                                'method' => 'POST',
                                'content' => json_encode($data),
                            )
                        );

//                        print_r($option);


                        $context = stream_context_create($options);
                        $result = file_get_contents($url, false, $context);
                        $response = json_decode($result);
                        if ($ul == 4) {
                            $responseSBI2 = $response;
                        }
                        $status = $response->Status;
                        $Message = $response->Message;


                        $Message_detail = $response->MessageDetail;
                        $param_send = json_encode($data);
                        $param_return = json_encode($response);

                        $field_names = array(
                            'SEND_PARAM', 'RETURN_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN', 'PESAN_DETAIL', 'TGL'
                        );
                        $field_data = array(
                            "$param_send", "$param_return", "$user_name_in", "$no_pp", "$Message", "$Message_detail", "SYSDATE"
                        );
                        $tablename = "ZMD_LOG_SBI";
                        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);
                        //print_r($status);
                        //print_r($Message);
                        if ($ul == 2) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO2 = $response->Data->SAPSalesOrderNumber;
                            $tgl_deleteSO2 = $response->Data->SAPCreatedDateStr;
                        } else if ($ul == 4) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO4 = $response->Data->SAPSalesOrderNumber;
                            $tgl_deleteSO4 = $response->Data->SAPCreatedDateStr;
                        }
                        if ($status != 1) {
                            $next = 'N';
                            $show_ket .= $ul . ". SO OPCO = " . $Message_detail;
                            $show_ket .= '<br>';
                        } else {
                            $show_ket .= $ul . ". SO OPCO = Sales Order has been made with a number : " . $nomorso;
                            $show_ket .= '<br>';
                        }
                        $Dataarray = json_decode(json_encode($response->Data->Items), true);
                        //print_r($nomorso);
//                        echo json_encode($response->Data);
//                        echo json_encode($data);

                        $SOMDNE = 'Y';
                        $jerror += 1;
                    } else if ($ul == $perulangan) { // PROSES PERULANGAN TERAKHIR CREATE PO
                        // GET HARGA PER LINE ITEM
                        for ($p = 1; $p <= $perulanganPO; $p++) { // perulangan PO MULTI ICS atau TIDAK
                            if ($p == 1) {
                                $incoterm1 = $incotermPO1;
                                $incoterm2 = $incotermPO12;
                                $distr_chan = $distr_chanPO1;
                            } else {
                                $incoterm1 = $incotermPO2;
                                $incoterm2 = $incotermPO22;
                                $distr_chan = $distr_chanPO2;
                            }

                            //perubahan get KD VENDOR
                            $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'  AND DEL = 0";
                            $querykdven = oci_parse($conn, $strkdven);
                            oci_execute($querykdven);
                            $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

                            if ($p == 1) {
                                $SO_PO = $SO2;
                                $vendorFIX = $rowkdven["KET"];
                                $COM = $rowkdven["COM_MD"];
                                $COM_HARGA = $rowkdven["COM_OPCO"];
                                $plantPO = $plant1;
                            } else if ($p == 2) {
                                $SO_PO = ($SO3 != "" ? $SO3 : $SO4);
                                $vendorFIX = $rowkdven["KET_OPCO"];
                                $COM = $rowkdven["COM_OPCO"];
                                $COM_HARGA = $rowkdven["COM_MD_2"];
                                $plantPO = $plant2;
                            } else if ($p == 3) {
                                $SO_PO = $SO4;
                                $vendorFIX = $rowkdven["KET2"];
                                $COM = $rowkdven["COM_MD_2"];
                                $COM_HARGA = $rowkdven["COM_OPCO_2"];
                                $plantPO = $plant3;
                            }

                            if ($COM != "PTSC" && $COM != "ID50") {
                                if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
                                    $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
                                    $fce->I_BAPI_VIEW["SDCOND"] = "X";
                                    $fce->SALES_DOCUMENTS->row["VBELN"] = $SO_PO;
                                    $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

                                    $fce->Call();
                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $fce->ORDER_CONDITIONS_OUT->Reset();
                                        $totL = 0;
                                        $builder = array();
                                        $dataH = array();
                                        $dataH["item_number"] = array();
                                        $dataH["nilai_harga"] = array();
                                        $dataH["per"] = array();
                                        $dataH["satuan"] = array();
                                        while ($fce->ORDER_CONDITIONS_OUT->Next()) {
                                            if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
                                                $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
                                                $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
                                                $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
                                                $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
                                                $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
                                                $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];
                                                $builder[] = $dataH;
                                                $totL += 1;
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();

                                        if ($totL != $_POST['jumlah']) {
                                            $next = "N";
                                            $show_ket .= "Master Harga Belum Ada...!!!";
                                            $show_ket .= '<br>';
                                        }
                                    }
                                }

                                if ($next == "Y") {

                                    // CREATE PO
                                    $fce = $sap->NewFunction("BAPI_PO_CREATE1");
                                    $tgl_sekarang = date("Ymd");

                                    $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$COM}' AND KD_VENDOR = '{$vendorFIX}' AND DEL =0";
                                    
                                    //print_r($strven);
                                    $queryven = oci_parse($conn, $strven);
                                    oci_execute($queryven);
                                    $rowven = oci_fetch_array($queryven, OCI_ASSOC);

                                    $fce->POHEADER["COMP_CODE"] = $COM; // company kedua
                                    $fce->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
                                    $fce->POHEADER["VENDOR"] = $vendorFIX; //
                                    $fce->POHEADER["PMNTTRMS"] = $top; 
                                    $fce->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
                                    $fce->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"]; 
                                    //                        $fce->POHEADER["CURRENCY"] = "IDR";
                                    //                        $fce->POHEADER["EXCH_RATE"] = "1";
                                    $fce->POHEADER["DOC_DATE"] = $tgl_sekarang;
                                    $fce->POHEADER["INCOTERMS1"] = $incoterm1;
                                    $fce->POHEADER["INCOTERMS2"] = $incoterm2;


                                    $fce->POHEADERX["COMP_CODE"] = "x";
                                    $fce->POHEADERX["DOC_TYPE"] = "x";
                                    $fce->POHEADERX["VENDOR"] = "x";
                                    $fce->POHEADERX["PMNTTRMS"] = "x";
                                    $fce->POHEADERX["PURCH_ORG"] = "x";
                                    $fce->POHEADERX["PUR_GROUP"] = "x";
                                    //                        $fce->POHEADERX["CURRENCY"] = "x";
                                    //                        $fce->POHEADERX["EXCH_RATE"] = "x";
                                    $fce->POHEADERX["DOC_DATE"] = "x";
                                    $fce->POHEADERX["INCOTERMS1"] = "x";
                                    $fce->POHEADERX["INCOTERMS2"] = "x";

                                    $fce->POTEXTHEADER->row["TEXT_ID"] = "F01";
                                    $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
                                    $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

                                    $fce->POTEXTHEADER->row["TEXT_ID"] = "F14";
                                    $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
                                    $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

                                    $sampai = $_POST['jumlah'];
                                    for ($j = 0; $j <= $sampai - 1; $j++) {
                                        $idke = "idke" . $j;
                                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                            $id_dtl = $_POST['com_iddtl' . $j];
                                            $item_num1 = $_POST['com_line' . $j];
                                            $item_num = $fungsi->linenum($item_num1);
                                            $item_numli = $item_num * 10;
                                            $item_numline = sprintf("%06d", $item_numli);
                                            $item_numlinePO = sprintf("%05d", $item_numli);
                                            $material = $_POST['com_produk' . $j];
//                                    $material1 = $_POST['com_produk' . $j];
//                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
//                                    $querymaterial = oci_parse($conn, $strmaterial);
//                                    oci_execute($querymaterial);
//                                    $rowmaterial  = oci_fetch_array($querymaterial, OCI_ASSOC);
//                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];

                                            $qty = $_POST['com_qty' . $j];
                                            $qtyx = $_POST['com_qtyx' . $j];

//                                        if($sales_org=="7900"){ 
//                                            $kontrak = $_POST['com_kontrak' . $j];
//                                        }else{
//                                            $kontrak = "";
//                                        }
                                            $kontrak = $_POST['com_kontrak' . $j];

                                            $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                            $distrik = $_POST['com_distrik' . $j];

                                            $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                            list($day, $month, $year) = split("-", $tgl_kirimPO);
                                            $tgl_kirim = $year . $month . $day;

                                            ///////////////////////////////////////////////////////////// SOCC v2.0
                                            // $plant_socc = $_POST['plant'];
                                            // $kode_distrik_socc = $_POST['com_distrik' . $j];
                                            // $material_for_socc_deldate = substr($_POST['com_produk' . $j],0,7);
                                            // $tgl_terima_leadtime_deliverydate = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc_deldate);
                                            ////////////////////////////////////////////////////////////


                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                            if ($p == 1) {
                                                $material = $_POST['com_produk' . $j];
                                            } else if ($p == 2) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                            } else if ($p == 3) {
                                                $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                            }

                                            $mtr_group = substr($material, 0, 7);


                                            if (($nomorso != "") and ( $qty1 == $qtyx1))
                                                $status1 = "APPROVE";
                                            else
                                                $status1 = "PROCESS";

                                            if ($mtr_group == "121-301") {
                                                $nm_material = "SEMEN ZAK";
                                                $po_unit = "ZAK";
                                            } else if ($mtr_group == "121-302") {
                                                $nm_material = "SEMEN CURAH";
                                                $po_unit = "TO";
                                            } else if ($mtr_group == "121-200") {
                                                $nm_material = "CLINKER";
                                                $po_unit = "TO";
                                            }

//                                        $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$sales_org1}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
//                                        $queryloc = oci_parse($conn, $strsloc);
//                                        oci_execute($queryloc);
//                                        $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
                                            // CEK HARGA DARI BAPI COMMIT HARGA
                                            if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
                                                foreach ($builder as $val) {
                                                    if ($item_numline == $val['item_number']) {
                                                        $hargaPO = $val['nilai_harga'];
                                                        $perPO = $val['per'];
                                                        $satuanPO = $val['satuan'];
                                                        $satuan2PO = $val['satuan2'];
                                                        $currencyPO = $val['currency'];
                                                    }
                                                }
                                            } else {
                                                if ($p == 1) {
                                                    $datas = $response->Data->Items[$j];
                                                } else if ($p == 3) {
                                                    $datas = $responseSBI2->Data->Items[$j];
                                                }
                                                $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
                                                $perPO = $datas->SAPSalesOrderPerUnit;
                                                $satuanPO = $datas->SAPSalesOrderUnit;
                                                $satuan2PO = $datas->SAPSalesOrderUnit;
                                                $currencyPO = $datas->SAPSalesOrderCurrency;
                                            }
//                                    //print_r($builder);
//                                    //print_r($hargaPO);
//                                    //print_r($item_numline);

                                            $fce->POITEM->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POITEM->row["SHORT_TEXT"] = $nm_material;
                                            $fce->POITEM->row["MATERIAL"] = $material;
                                            $fce->POITEM->row["PLANT"] = $plantPO;
//                                    $fce->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];
                                            $fce->POITEM->row["MATL_GROUP "] = $mtr_group;
                                            $fce->POITEM->row["QUANTITY"] = $qtyx;
                                            $fce->POITEM->row["STGE_LOC"] = "D101";
                                            $fce->POITEM->row["GR_IND"] = "X";
                                            $fce->POITEM->row["IR_IND"] = "X";
                                            $fce->POITEM->row["GR_BASEDIV"] = "X";
//                                        $fce->POITEM->row["FUNDS_CTR"] = "7902000000";
                                            $fce->POITEM->Append($fce->POITEM->row);

                                            $fce->POITEMX->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POITEMX->row["SHORT_TEXT"] = "X";
                                            $fce->POITEMX->row["MATERIAL"] = "X";
                                            $fce->POITEMX->row["PLANT"] = "X";
//                                    $fce->POITEMX->row["STGE_LOC"] = "X"; 
                                            $fce->POITEMX->row["MATL_GROUP "] = "X";
                                            $fce->POITEMX->row["QUANTITY"] = "X";
                                            $fce->POITEMX->row["STGE_LOC"] = "X";
                                            $fce->POITEMX->row["GR_IND"] = "X";
                                            $fce->POITEMX->row["IR_IND"] = "X";
                                            $fce->POITEMX->row["GR_BASEDIV"] = "X";
//                                        $fce->POITEMX->row["FUNDS_CTR"] = "X";
                                            $fce->POITEMX->Append($fce->POITEMX->row);

                                            $fce->POTEXTITEM->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POTEXTITEM->row["TEXT_ID"] = "F01";
                                            $fce->POTEXTITEM->row["TEXT_FORM"] = "/";
                                            $fce->POTEXTITEM->row["TEXT_LINE"] = "SEMEN PPC";
                                            $fce->POTEXTITEM->Append($fce->POTEXTITEM->row);

                                            $fce->POSCHEDULE->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POSCHEDULE->row["SCHED_LINE"] = "0001";
                                            //////////////////////////////////////////////////// SOCC V.2
                                            $fce->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
                                            //old
                                            //------------------------------------------------------
                                            //new
                                            // $fce->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_terima_leadtime_deliverydate;
                                            ///////////////////////////////////////////////////
                                            $fce->POSCHEDULE->row["QUANTITY "] = $qtyx;
                                            $fce->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
                                            $fce->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
                                            $fce->POSCHEDULE->Append($fce->POSCHEDULE->row);

                                            $fce->POSCHEDULEX->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POSCHEDULEX->row["SCHED_LINE"] = "X";
                                            $fce->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
                                            $fce->POSCHEDULEX->row["QUANTITY "] = "X";
                                            $fce->POSCHEDULEX->row["STAT_DATE"] = "X";
                                            $fce->POSCHEDULEX->row["PO_DATE"] = "X";
                                            $fce->POSCHEDULEX->Append($fce->POSCHEDULEX->row);



                                            $fce->POCOND->row["ITM_NUMBER"] = $item_numlinePO;
                                            $fce->POCOND->row["COND_ST_NO"] = '001';
                                            $fce->POCOND->row["COND_TYPE"] = "PBXX";
                                            $fce->POCOND->row["COND_VALUE"] = $hargaPO;
                                            $fce->POCOND->row["COND_P_UNT"] = $perPO;
                                            $fce->POCOND->row["COND_UNIT"] = $satuanPO;
                                            $fce->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
                                            $fce->POCOND->row["CURRENCY"] = $currencyPO;
                                            $fce->POCOND->row["CURRENCY_ISO"] = $currencyPO;
                                            $fce->POCOND->row["CHANGE_ID"] = "U";
                                            $fce->POCOND->Append($fce->POCOND->row);

                                            $fce->POCONDX->row["ITM_NUMBER"] = $item_numlinePO;
                                            $fce->POCONDX->row["COND_ST_NO"] = '001';
                                            $fce->POCONDX->row["COND_TYPE"] = "x";
                                            $fce->POCONDX->row["COND_VALUE"] = "x";
                                            $fce->POCONDX->row["COND_P_UNT"] = "x";
                                            $fce->POCONDX->row["COND_UNIT"] = "x";
                                            $fce->POCONDX->row["COND_UNIT_SO"] = "x";
                                            $fce->POCONDX->row["CURRENCY"] = "x";
                                            $fce->POCONDX->row["CURRENCY_ISO"] = "x";
                                            $fce->POCONDX->row["CHANGE_ID"] = "x";
                                            $fce->POCONDX->Append($fce->POCONDX->row);
                                        }
                                    }

//                                echo "<pre>"; 
//                                print_r($fce);

                                    $fce->Call();

                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $nopoT = $fce->EXPPURCHASEORDER;
                                        $fce->RETURN->Reset();
                                        while ($fce->RETURN->Next()) {
                                            $tipe = $fce->RETURN->row["TYPE"];
                                            $msg = $fce->RETURN->row["MESSAGE"];
                                            $show_ket .= $msg;
                                            $show_ket .= '<br>';
                                            if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                                $next = "N";
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();
                                    }
                                    $user_org = $_SESSION['user_org'];

                                    if ($p == 1) {
                                        $PO1 = $nopoT;
                                    } else if ($p == 2) {
                                        $PO2 = $nopoT;
                                    } else if ($p == 3) {
                                        $PO3 = $nopoT;
                                    }
                                    //SIMPAN PP ICS KEDUA

                                    if ($next == "Y" && $p == 1) {
                                        $sampai = $_POST['jumlah'];
                                        for ($j = 0; $j <= $sampai - 1; $j++) {
                                            $idke = "idke" . $j;
                                            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                                $id_dtl = $_POST['com_iddtl' . $j];
                                                $item_num1 = $_POST['com_line' . $j];
                                                $item_num = $fungsi->linenum($item_num1);
                                                $item_numline = $item_num * 10; //'000010'; 
                                                $PO_LINE = sprintf("%05d", $item_numline); //'00010';
                                                if ($j == 0) {
                                                    $numline_pertama = sprintf("%06d", $item_numline * 10); //'000010';
                                                }
                                                $alamat1 = $_POST['com_alamat' . $j];
//                                        $material = $_POST['com_produk' . $j];
//                                        $material1 = $_POST['com_produk' . $j];
                                                $material = $_POST['com_produk' . $j];
                                                $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                                $querymaterial = oci_parse($conn, $strmaterial);
                                                oci_execute($querymaterial);
                                                $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                                if ($p == 1) {
                                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                                } else if ($p == 2) {
                                                    $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                                } else if ($p == 3) {
                                                    $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                                }


                                                $qty = $_POST['com_qty' . $j];
                                                $qtyx = $_POST['com_qtyx' . $j];


//                                            if($sales_org=="7900"){ 
//                                                $kontrak = $_POST['com_kontrak' . $j];
//                                            }else{
//                                                $kontrak = "";
//                                            }
                                                $kontrak = $_POST['com_kontrak' . $j];

                                                $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                                $distrik = $_POST['com_distrik' . $j];
                                                $shiptotocek = $_POST['com_shipto' . $j];
                                                
                                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                                $queryshipto = oci_parse($conn, $strshipto);
                                                oci_execute($queryshipto);
                                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                                if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                                    $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                                    $queryshipto = oci_parse($conn, $strshipto);
                                                    oci_execute($queryshipto);
                                                    $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                                }

                                                if ($p == 1) {
                                                    $shipto = $rowshipto['SHIP_TO_OPCO'];
                                                } else if ($p == 2) {
                                                    $shipto = $rowshipto['SHIP_TO_MD_2'];
                                                } else if ($p == 3) {
                                                    $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                                }

                                                $shipto = $fungsi->sapcode($shipto);
                                                $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
                                                $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                                list($day, $month, $year) = split("-", $tgl_kirimPO);
                                                $tgl_kirim = $year . $month . $day;

                                                $mtr_group = substr($material, 0, 7);


                                                if (($nomorso != "") and ( $qty1 == $qtyx1))
                                                    $status1 = "APPROVE";
                                                else
                                                    $status1 = "PROCESS";

                                                if ($p == 1) {
                                                    $SO_ICS = $SO1;
                                                } else if ($p == 2) {
                                                    $SO_ICS = $SO2;
                                                } else if ($p == 3) {
                                                    $SO_ICS = $SO3;
                                                }

                                                $field_names = array(
                                                    'NO_PP',
                                                    'NO_PO',
                                                    'PO_LINE',
                                                    'PLANT_PO',
                                                    'NMPLANT_PO',
                                                    'KOTA',
                                                    'NAMA_KOTA',
                                                    'KODE_PRODUK',
                                                    'NM_PRODUK',
                                                    'HARGA_PO',
                                                    'ORG_PO',
                                                    'VENDOR',
                                                    'NM_VENDOR',
                                                    'QTY_PO',
                                                    'UOM',
                                                    'TGL_PO',
                                                    'STATUS',
                                                    'NOTE',
                                                    'CREATE_DATE',
                                                    'CREATED_BY',
                                                    'DELETE_MARK',
                                                    'BULAN',
                                                    'TAHUN',
                                                    'QTY_APPROVE',
                                                    'TGL_PP',
                                                    'ORG_BY',
                                                    'VBELN'
                                                );
                                                $kd_vendor = $vendorFIX;
                                                $nopoplus = $nopoT . $PO_LINE;
                                                $field_data = array(
                                                    "$no_pp",
                                                    "$nopoplus",
                                                    "$PO_LINE",
                                                    "$plant1",
                                                    "$plant1", //belum                   
                                                    "$distrik",
                                                    "$distrik", //belum
                                                    "$material",
                                                    "$material", //belum
                                                    "$hargaPO",
                                                    "$sales_org1",
                                                    "$kd_vendor",
                                                    "$kd_vendor", //belum
                                                    "$qty",
                                                    "$po_unit",
                                                    "instgl_$tgl_kirimPO",
                                                    "$status1",
                                                    "$ket",
                                                    "SYSDATE",
                                                    "$user_name_in",
                                                    "0",
                                                    "$month",
                                                    "$year",
                                                    "$qtyx",
                                                    "SYSDATE",
                                                    "$user_org",
                                                    "$SO_ICS"
                                                );
                                                $tablename = "OR_TRANS_HDR_ICS";
                                                $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                                //Oracle Detail
                                                $field_names2 = array(
                                                    'NO_PP',
                                                    'KODE_PRODUK',
                                                    'NAMA_PRODUK',
                                                    'QTY_PP',
                                                    'QTY_APPROVE',
                                                    'TGL_KIRIM_PP',
                                                    'TGL_KIRIM_APPROVE',
                                                    'TGL_TERIMA',
                                                    'SHIP_TO',
                                                    'NAMA_SHIP_TO',
                                                    'ALAMAT_SHIP_TO',
                                                    'DELETE_MARK',
                                                    'STATUS_LINE',
                                                    'KODE_TUJUAN',
                                                    'NAMA_TUJUAN',
                                                    'ITEM_NUMBER',
                                                    'NO_SO',
                                                    'FLAG_KAPAL',
                                                    'KETERANGAN',
                                                    'NAMA_KAPAL',
                                                    'NO_KONTRAK',
                                                    'KD_PROV',
                                                    'NM_PROV',
                                                    'UOM',
                                                    'PLANT',
                                                    'NM_PLANT',
                                                    'PRICE_DATE',
                                                    'SOLD_TO',
                                                    'INCOTERM',
                                                    'CARA_BAYAR',
                                                    'TERM_PAYMENT',
                                                    'NAMA_SOLD_TO',
                                                    'BPLANT',
                                                    'CREATED_BY',
                                                    'CREATE_DATE',
                                                    'NAMA_INCOTERM',
                                                    'SO_TYPE',
                                                    'NAMA_SO_TYPE',
                                                    'ROUTE',
                                                    'NAMA_TOP',
                                                    'ORG',
                                                    'PRICELIST',
                                                    'NAMA_PRICELIST',
                                                    'NO_KONTRAK_LC',
                                                    'KD_REASON',
                                                    'NM_REASON',
                                                    'ROUTE_TXT',
                                                    'CHANNEL',
                                                    'DIVISION',
                                                    'TIPE_PEMBELIAN',
                                                    'NO_POH'
                                                );

                                                $kodedistrik2 = substr($distrik, 0, 2);
                                                $kd_provinsi = "10" . $kodedistrik2;
                                                $itemnumplus = sprintf("%06d", $item_numline); //'000010';
                                                $field_data2 = array(
                                                    "$no_pp",
                                                    "$material",
                                                    "$material",
                                                    "$qty",
                                                    "$qtyx",
                                                    "instgl_$tgl_kirimPO",
                                                    "instgl_$tgl_kirimPO",
                                                    "instgl_$tgl_terimaPO",
                                                    "$shipto",
                                                    "$shipto",
                                                    "$alamat1", // belum
                                                    "0",
                                                    "$status1",
                                                    "$distrik",
                                                    "$distrik",
                                                    "$itemnumplus",
                                                    "$SO_ICS",
                                                    "0",
                                                    "$ket",
                                                    " ", //belum
                                                    "$kontrak", //belum
                                                    "$kd_provinsi", //belum
                                                    "$kd_provinsi", //belum
                                                    "$po_unit", //belum
                                                    "$plant", // plant kedua
                                                    "$plant",
                                                    "instgl_$tgl_kirimPO",
                                                    "$soldto", //kedua
                                                    "$incoterm1",
                                                    "$ketbayar", //belum
                                                    "$top",
                                                    "$soldto",
                                                    "$plant", //
                                                    "$user_name_in",
                                                    "SYSDATE",
                                                    "$incoterm2",
                                                    "$so_type",
                                                    "$so_type",
                                                    "$route",
                                                    "$nama_top",
                                                    "$sales_org",
                                                    "$pricelist",
                                                    "$nama_pricelist",
                                                    "$lcnum",
                                                    "$reason",
                                                    "$nama_reason",
                                                    "$ship_cond-$route_desc", //belum
                                                    "$distr_chan",
                                                    "$division",
                                                    "D", //belum
                                                    "$nopoT"
                                                );
                                                $tablename2 = "OR_TRANS_DTL_ICS";
                                                $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
                                            }
                                        }
                                    }
                                }
                            }//if bukan SBI
                        } // IF
                    }// Perulangan PO
                }
            }

            //PROSES REFERENSI 2 SO, UNTUK MENGHUBUNGKAN 2 SO
            if ($next == 'Y') {
                //  INSERT TABEL MAPPING
                $fceM = $sap->NewFunction("ZCSD_MAP_SO_MD_FM");
                if ($fceM == false) {
                    $sap->PrintStatus();
                    exit;
                }

                for ($ref = 1; $ref <= $perulanganSO; $ref++) {
                    $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
                    if ($fce == false) {
                        $sap->PrintStatus();
                        exit;
                    }
                    if ($ref == 1) {
                        $fce->I_ZVBELN = $SO1;
                        $fce->I_VBELN = $SO2;
                        $SOM = 'SO Mega Distributor 1 : ' . $SO1;
                        $PO_REF = $PO1;
                        $SOMAP = $SO1;
                        $orgMAP = $sales_org1;
                        $plantMAP = $plant1;
                    } else if ($ref == 2) {
                        $fce->I_ZVBELN = $SO2;
                        $fce->I_VBELN = $SO1;
                        $SOM = 'SO OPCO 1 : ' . $SO2;
                        $PO_REF = $PO1;
                        $SOMAP = $SO2;
                        $orgMAP = $sales_org2;
                        $plantMAP = $plant2;
                    } else if ($ref == 3) {
                        $fce->I_ZVBELN = $SO3;
                        $fce->I_VBELN = $SO4;
                        $SOM = 'SO Mega Distributor 2 : ' . $SO3;
                        $PO_REF = ($SO3 != '' ? $PO2 : "");
                        $SOMAP = $SO3;
                        $orgMAP = $sales_org3;
                        $plantMAP = $plant3;
                    } else if ($ref == 4) {
                        if ($SO3 == "") {
                            $fce->I_ZVBELN = $SO3;
                            $fce->I_VBELN = $SO4;
                        } else {
                            $fce->I_ZVBELN = $SO4;
                            $fce->I_VBELN = $SO3;
                        }
                        $SOM = 'SO OPCO 2 : ' . $SO4;
                        $PO_REF = ($SO3 == '' ? $PO2 : $PO3);
                        $SOMAP = $SO4;
                        $orgMAP = $sales_org4;
                        $plantMAP = $plant4;
                    }
                    $fce->I_PO = $PO_REF;
                    $fce->I_LINE_ITEM = $numline_pertama;
                    $fce->Call();
                    if ($fce->GetStatus() == SAPRFC_OK) {
                        //while ( $fce->ZMESSAGE->Next() ){
                        $tipe = $fce->ZMESSAGE["TYPE"];
                        $msg = $fce->ZMESSAGE["MESSAGE"];
                        $show_ket .= $SOM . ' ' . $msg . '<br>';
                        //}
                    }


                    if ($SOMAP != "") {
                        $fceM->T_DATA->row["NO_PP"] = $no_pp;
                        $fceM->T_DATA->row["VKORG"] = $orgMAP;
                        $fceM->T_DATA->row["WERKS"] = $plantMAP;
                        $fceM->T_DATA->row["NO_SO"] = $SOMAP;
                        $fceM->T_DATA->row["SEQ_NO"] = $ref * 10;
                        $fceM->T_DATA->row["NO_PO"] = $PO_REF;
                        $fceM->T_DATA->Append($fceM->T_DATA->row);
                    }
                }


                $fceM->Call();
                if ($fceM->GetStatus() == SAPRFC_OK) {
                    //while ( $fce->ZMESSAGE->Next() ){
//                    $tipe = $fceM->ZMESSAGE["TYPE"];
//                    $msg = $fceM->ZMESSAGE["MESSAGE"];
//                    $show_ket .= $ref . ' ' . $msg . '<br>';
                    //}
                }
            }
//            echo "Jumlah error ".$jerror ." - ".$SO4;
            //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
            if ($next == "N") {
                $SOSBI = "N";
                if ($SOMDNE == "Y") {
                    $SOSBIK = "Y";
                } else {
                    $SOSBIK = "N";
                }
                for ($e = 1; $e <= $jerror; $e++) {

                    $return = "Y";

                    // CEK SO SBI ATAU TIDAK
                    $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'";
                    $querykdven = oci_parse($conn, $strkdven);
                    oci_execute($querykdven);
                    $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);
                    if ($e == 1) {
                        $noyo = $SO1;
                        $IDHU = $IDH1;
                        $SOSBICEK = "N";
                    } else if ($e == 2) {
                        $noyo = $SO2;
                        $IDHU = $IDH2;
                        if ($rowkdven["COM_OPCO"] == "PTSC" || $rowkdven["COM_OPCO"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    } else if ($e == 3) {
                        $noyo = $SO3;
                        $IDHU = $IDH3;
                        $SOSBICEK = "N";
                    } else if ($e == 4) {
                        $noyo = $SO4;
                        $IDHU = $IDH4;
                        if ($rowkdven["COM_OPCO_2"] == "PTSC" || $rowkdven["COM_OPCO_2"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    }

                    if ($SOSBICEK == 'Y') {
                        if ($e == 2 || $e == 4) {

                            if ($e == 2) {
                                $TGLend = $tgl_deleteSO2;
//                                print_r("TGL DELETE". $TGLend);
                            } else if ($e == 4) {
                                $TGLend = $tgl_deleteSO4;
//                                print_r("TGL DELETE". $TGLend);
                            }

                            $url = 'https://sip.solusibangunindonesia.com/APIMD/DeleteSalesOrder';
                            $data = array(
                                'Token' => 'aSsMx7GV0HFGzlufM4DH',
                                'SystemID' => 'PASSO',
                                'SAPSalesOrderNumber' => $noyo,
                                'SAPCreatedDate' => $TGLend,
                            );
                            $options = array(
                                'http' => array(
                                    'header' => "Content-type: application/json\r\n",
                                    'method' => 'POST',
                                    'content' => json_encode($data),
                                )
                            );

                            $context = stream_context_create($options);
                            $result = file_get_contents($url, false, $context);
                            $response = json_decode($result);
                            $status = $response->Status;
                            $Message = $response->Message;
                            if ($status != '1') {
                                $return = 'N';
                            }
                        }
                    } else {
                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }

                        //header entri    
                        $fce->SALESDOCUMENT = $noyo; //"ZOR";
                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";

                        $fce->Call();

                        if ($fce->GetStatus() == SAPRFC_OK) {
                            $fce->RETURN->Reset();
                            while ($fce->RETURN->Next()) {
                                $msg .= '<div align="center">';
                                $error = $fce->RETURN->row["TYPE"];
                                $msg .= $fce->RETURN->row["MESSAGE"];

                                if ($error == 'A' || $error == 'X' || $error == 'E') {
                                    $return = 'N';
                                }
                            }
                            $msg .= '<br></div>';
                            //Commit Transaction
                            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            $fce->Call();
                        } else {
                            $fce->PrintStatus();
                        }
                    }

                    if ($return == 'Y') {
                        $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_HDR_ICS SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE VBELN='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL_ICS SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
                    } else {
                        $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
                    }
                }
            }
            $fce->Close();
            $sap->Close();
        } else {
            $show_ket .= $komentarerror;
        }
        
        
        $field_names = array(
            'SEND_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN_DETAIL', 'TGL'
        );
        $field_data = array(
            "SI", "$user_name_in", "$no_pp", "$show_ket", "SYSDATE"
        );
        $tablename = "ZMD_LOG_SBI";
        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

        if (isset($_POST['lasthalaman'])) {
            $habis = "list_approve_pp.php";
        } else {
            $habis = "approve_pp.php";
        }
        break;
//============================================================================================================================
//============================================================================================================================

    case "buatsoaac":

        $pesan_telegram = "";
        //data header so
        $user_name_in = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        $channelnew = $_POST['channels'];
        if ($so_type == 'ZEX') {
            $distr_chan = "30";
        } elseif ($so_type == 'ZPR') {
            if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900')
                $distr_chan = "10";
            else if ($sales_org == '6000')
                $distr_chan = "10";
            else
                $distr_chan = "50";
        } else {
            $distr_chan = "10";
        }
        $division = "00";
        $dlv_block = "";
        $soldto = $_POST['distr_id'];
        $soldto = $fungsi->sapcode($soldto);
        $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
        if ($distr_chancondi != '') {
            $distr_chan = $distr_chancondi;
        }
        if ($channelnew != '') {
            $distr_chan = $channelnew;
        }
        $no_pp = $_POST['no_pp'];
        $tgl_pp = $_POST['tgl_pp'];
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        //$tanggal=gmdate("Ymd",time()+60*60*7);
        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $plant = $_POST['plant'];
        $nama_plant = trim($_POST['nama_plant']);
        $nm_kapal = $_POST['nm_kapal'];
        $incoterm1 = $_POST['incoterm'];
        $incoterm2 = $_POST['nama_incoterm'];
        $route = $_POST['route'];
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $lcnum = $_POST['lcnum'];
        $lcnum = $fungsi->sapcode($lcnum);
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $ket = "";
        $sampai1 = $_POST['jumlah'];
        for ($j = 0; $j <= $sampai1; $j++) {
            $idke = "idke" . $j;
            $pesan_telegram .= "PP $no_pp";

            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $kontrakh = $_POST['com_kontrak' . $j];
            }
        }

        // jalankan bapi create so sap	
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        unset($ex_so);
        $ex_so = true;
        //cegatan credit limit so khusus tlcc
//                if($sales_org=='6000'){
//                    require_once 'loadcreditlimit.php';
//                }

        if ($ex_so == true) {
            $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
            if ($fce == false) {
                $sap->PrintStatus();
                exit;
            }
            //detail entri item'
            //$zak=$fungsi->qtyso($totalzak*1000);
            $sampai = $_POST['jumlah'];
            $ada = 0;
            for ($j = 0; $j <= $sampai - 1; $j++) {
                $idke = "idke" . $j;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $id_dtl = $_POST['com_iddtl' . $j];
                    $item_num1 = $_POST['com_line' . $j];
                    $item_num = $fungsi->linenum($item_num1);
                    $material = $_POST['com_produk' . $j];
                    $shipto = $_POST['com_shipto' . $j];
                    $shipto = $fungsi->sapcode($shipto);
                    $distrik = $_POST['com_distrik' . $j];
                    $qty = $_POST['com_qty' . $j];
                    $qtyx = $_POST['com_qtyx' . $j];
                    $tgl_kirim = $_POST['com_tgl_kirim' . $j];
                    $kontrak = $_POST['com_kontrak' . $j];
                    $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);

                    list($day, $month, $year) = split("-", $tgl_kirim);
                    $tgl_kirim = $year . $month . $day;

                    if ($qtyx != $qty) {
                        $ada = $ada + 1;
                    }

                    $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                    if ($so_type == 'ZFC') {
                        //$fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'ZKNN';//$item_cat;///salah revisi dibawah ini   
                        $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                        if ($sales_org == '6000') {
                            $ITEM_CATEGvali = 'ZKNN';
                        } else if ($sales_org == '4000' || $sales_org == '3000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900') {
                            $ITEM_CATEGvali = 'ZKLN';
                            //sales FOC distrik
                            if ($sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900' ) {
                                $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                                $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                            }
                        } else {
                            $ITEM_CATEGvali = 'ZKNN';
                        }
                        $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;
                    }
                    $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                    $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

                    if ($sales_org == '7900') {
                        $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                        $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                    }

                    //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                    if ($kontrak != '') {
                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                    }
                    $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                    //detail entri schedule n qty'
                    $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                    $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                    $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                    $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                    //detail entri distributor dan agen
                    if ($j == 0)
                        $item_num = '000000';
                    else
                        $item_num = $item_num;
                    $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                    $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                    $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                }
            }

            if ($sales_org == '3000') {
                $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
                if ($fce1 == false) {
                    $sap->PrintStatus();
                    exit;
                }

                //header entri

                $fce1->ZNMORG = 3000;
                $fce1->ZKUNNR = $shipto;
                $fce1->Call();
                if ($fce1->GetStatus() == SAPRFC_OK) {
                    $fce1->RETURN_DATA->Reset();
                    while ($fce1->RETURN_DATA->Next()) {
                        $kode = $fce1->RETURN_DATA->row["VKGRP"];
                    }
                }
                $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
            }

            $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
            $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
            $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
            $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
            $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
            $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
            $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
            $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
            $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
            $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
            $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
            $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
            $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
            $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
            if ($lcnum != '') {
                $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
            }
            if ($kontrakh != '') {
                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
            }

            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

            $fce->Call();
            if ($fce->GetStatus() == SAPRFC_OK) {
                $nomorso = $fce->SALESDOCUMENT;
                $fce->RETURN->Reset();
                while ($fce->RETURN->Next()) {
                    $tipe = $fce->RETURN->row["TYPE"];
                    $msg = $fce->RETURN->row["MESSAGE"];
                    if ($tipe != 'S') {
                        $show_ket .= $msg;
                        $show_ket .= '<br>';
                    }
                }

                //Commit Transaction
                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                $fce->Call();

                //Update SO
                if ($nomorso != '' && $j > 0) {
                    sleep(5); //seconds to wait..    
                    $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                    $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                    $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                    $fce->Call();

                    //Commit Transaction
                    $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                    $fce->Call();
                }

                if ($sales_org == '6000') {
                    sleep(5); //seconds to wait..
                    //Teks
                    unset($tgl_kirimapp);
                    for ($j = 0; $j <= $sampai - 1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $item_num1 = $_POST['com_line' . $j];
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopolisiv = $_POST['com_nopolisi' . $j];
                            $com_typetruckv = $_POST['com_typetruck' . $j];
                            $com_catatanv = $_POST['com_catatan' . $j];
                            $com_kodekantong = $_POST['com_viewkodebag' . $j];
                            $tgl_kirimappT = $_POST['com_tgl_kirim' . $j];
                            $com_viewdrivern = $_POST['com_viewdrivern' . $j];
                            $com_viewsimv = $_POST['com_viewsim' . $j];
                            list($day, $month, $year) = split("-", $tgl_kirimappT);
                            $tgl_kirimapp .= $year . $month . $day . "!";

                            $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                            $fce->I_VBELN = $nomorso; //'000010';
                            $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                            $fce->I_TEXT1 = $com_nopolisiv;
                            $fce->I_TEXT2 = $com_typetruckv;
                            $fce->I_TEXT3 = $com_catatanv;
                            $fce->I_TEXT4 = $com_kodekantong;
                            $fce->I_TEXT6 = $com_viewdrivern;
                            $fce->I_TEXT7 = $com_viewsimv;
                            $fce->Call();
//                            echo "<pre>";
//                            //print_r($fce);
//                            echo "</pre>";
                        }
                    }

                    if ($sales_org == '6000' && $nomorso != '') {
                        $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                    }
                }

                //@liyantanto penambahan no ref pp
                if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000' || $sales_org == '7900') {
                    sleep(5); //s
                    for ($j = 0; $j <= $sampai - 1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $item_num1 = $_POST['com_line' . $j];
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopppref = trim($_POST['com_ppref' . $j]);

                            if ($com_nopppref != '' && $nomorso != '') {
                                $pputam = substr($com_nopppref, 0, 10);
                                $itempputam = @(substr($com_nopppref, 10, 6) / 10);
                                $sql_ppref = "
                                    select ID,NO_SO,ITEM_NUMBER,NO_PPREF from OR_TRANS_DTL where DELETE_MARK=0 
                                    and NO_PP='$pputam' 
                                    and ITEM_NUMBER='$itempputam'
                                    ";
                                $query_ppref = oci_parse($conn, $sql_ppref);
                                oci_execute($query_ppref);
                                while ($row_ref = oci_fetch_array($query_ppref)) {
                                    $idPPREF = $row_ref[ID];
                                    $no_soref = $row_ref[NO_SO];
                                    $item_soref = $row_ref[ITEM_NUMBER];
                                }
                                $com_noppputam = $no_pp . sprintf("%06d", $item_num * 10);
                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                $fce->I_VBELN = $no_soref; //'000010';
                                $fce->I_POSNR = sprintf("%06d", $item_soref * 10); //'000010';
                                $fce->I_TEXT5 = $nomorso . sprintf("%06d", $item_num * 10); //pp ref
                                $fce->Call();

                                //update so pp ref
                                $field_namesppru = array('NO_PPREF');
                                $field_datapput = array("$com_noppputam");
                                $tablenamepput = "OR_TRANS_DTL";
                                $field_idpput = array('ID');
                                $value_idpput = array("$idPPREF");
                                $fungsi->update($conn, $field_namesppru, $field_datapput, $tablenamepput, $field_idpput, $value_idpput);

                                $nosoref = $no_soref . sprintf("%06d", $item_soref * 10);
                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                $fce->I_VBELN = $nomorso; //'000010';
                                $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                                $fce->I_TEXT5 = $nosoref; //pp ref
                                $fce->Call();
//                                echo "<pre>";
//                                //print_r($fce);
//                                echo "</pre>";
                            }
                        }
                    }
                }
            }
            $fce->Close();
            $sap->Close();

            if (($nomorso != "") and ( $ada == 0))
                $status = "APPROVE";
            else
                $status = "PROCESS";
            //update data header
            $field_names = array('PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'STATUS', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON', 'ORG');
            $field_data = array("$plant", "$nama_plant", "$top", "$status", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$lcnum", "$reason", "$nama_reason", "$sales_org");
            $tablename = "OR_TRANS_HDR";
            $field_id = array('ID');
            $value_id = array("$idh");
            $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
            // update data detail
            $sampai1 = $_POST['jumlah'];
            for ($k = 0; $k <= $sampai1; $k++) {
                $idke = "idke" . $k;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $id_dtl1 = $_POST['com_iddtl' . $k];
                    $qty1 = $_POST['com_qty' . $k];
                    $qtyx1 = $_POST['com_qtyx' . $k];
                    $kontrak = $_POST['com_kontrak' . $k];
                    $posnr = $_POST['com_posnr' . $k];
                    $kode_distrik = $_POST['com_distrik' . $k];
                    $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                    $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                    $item_numline1 = trim($_POST['com_line' . $k]);
                    $item_numline = $fungsi->linenum($item_numline1);
                    $com_kodekantong = $_POST['com_viewkodebag' . $k];

                    if (($nomorso != "") and ( $qty1 == $qtyx1))
                        $status1 = "APPROVE";
                    else
                        $status1 = "PROCESS";

                    $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT', 'KODE_BAG');
                    $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$kontrak", "$plant", "$nama_plant", "$com_kodekantong");
                    $tablename = "OR_TRANS_DTL";
                    $field_id = array('ID');
                    $value_id = array("$id_dtl1");
                    $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                    if ($nomorso != "") {
                        $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                        $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', "SYSDATE", 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                        $tablenamefrom = "OR_TRANS_DTL";
                        $tablenameto = "OR_TRANS_APP";
                        $field_id1 = array('ID');
                        $value_id1 = array("$id_dtl1");
                        $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);

                        //@liyantanto update qty approve
                        if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000' || $sales_org == '7900') {
                            $sql_qtya = "
                                        update OR_TRANS_DTL set QTY_APPROVE=(
                                                select sum(nvl(QTY_APPROVE,0)) as QTY from OR_TRANS_APP where NO_PP='$no_pp' and ITEM_NUMBER='$item_numline1'
                                                and DELETE_MARK=0 and STATUS_LINE='APPROVE'
                                        ) where ID='$id_dtl1'
                                    ";
                            $query_qtya = oci_parse($conn, $sql_qtya);
                            oci_execute($query_qtya);
                        }
                    }
                }
            }
            $show_ket .= 'Sales Order has been made with a number : ' . $nomorso;
            $pesan_telegram .= " Approve dengan no SO $nomorso (Approve By $user_name_in)";

            if ($sales_org == 4000) {
                botTelegram('-394888712', $pesan_telegram);
            }
        }
        if (isset($_POST['lasthalaman'])) {
            $habis = "list_approve_pp_aac.php";
        } else {
            $habis = "approve_pp_aac.php";
        }
        break;
    //============================================================================================================================       
// buatso admin
    case "buatsoadmin":

        $user_name = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        $channelnew = $_POST['channels'];
        if ($so_type == 'ZEX') {
            $distr_chan = "30";
        } elseif ($so_type == 'ZPR') {
            if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000')
                $distr_chan = "10";
            else if ($sales_org == '6000')
                $distr_chan = "10";
            else
                $distr_chan = "50";
        } else {
            $distr_chan = "10";
        }
        $division = "00";
        $dlv_block = "";
        $soldto = $_POST['sold_to'];
        $soldto = $fungsi->sapcode($soldto);
        $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
        if ($distr_chancondi != '') {
            $distr_chan = $distr_chancondi;
        }
        if ($channelnew != '') {
            $distr_chan = $channelnew;
        }
        $nama_sold_to = $_POST['nama_sold_to'];
        $tgl_pp = date("d-m-Y");
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        //$tanggal=gmdate("Ymd",time()+60*60*7);
        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $oldso = $_POST['oldso'];
        //$shipment=$_POST['shipment'];
        $price_datep = $_POST['price_date'];
        list($dayp, $monthp, $yearp) = split("-", $price_datep);
        $price_date = $yearp . $monthp . $dayp;

        $plant = $_POST['plant'];
        $nama_plant = trim($_POST['nama_plant']);
        $incoterm1 = $_POST['jenis_kirim'];
        $incoterm2 = $_POST['nama_kirim'];
        $route = $_POST['route'];
        $kd_kapal = $_POST['kd_kapal'];
        $nm_kapal = $_POST['nm_kapal'];
        $nama_kapal = $kd_kapal . '-' . $nm_kapal;
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $no_pp = $fungsi->or_new_pp_number($conn);
        $valperlcnum = trim($_POST['perslcnum']);
        $lcnum = $_POST['lcnum'];
        $lcnum = $fungsi->sapcode($lcnum);
        $sampai1 = $_POST['jumlah'];
        $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
        for ($j = 0; $j <= $sampai1; $j++) {
            $idke = "idke" . $j;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $kontrakh = $_POST['com_kontrak' . $j];
            }
        }

        //call bapi sales order sap
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
        if ($fce == false) {
            $sap->PrintStatus();
            exit;
        }

        //header entri
        $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
        $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
        $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
        $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
        $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
        $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
        $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
        $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
        $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
        //$fce->ORDER_HEADER_IN["COLLECT_NO"] = $oldso;
        $fce->ORDER_HEADER_IN["REF_1"] = $oldso;
        $fce->ORDER_HEADER_IN["PRICE_DATE"] = $price_date;

        if ($lcnum != '') {
            $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
            $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
            //$fce->ORDER_HEADER_IN["DEPARTM_NO"] = 9;
            $fce->ORDER_HEADER_IN["REC_POINT"] = 2;
        }
        if ($kontrakh != '') {
            $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
            $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
        }

        //detail entri item'
        $sampai = $_POST['jumlah'];
        for ($j = 1; $j <= $sampai; $j++) {
            $item_num = $j;
            $shipto = "shipto" . $j;
            $kode_distrik = "kode_distrik" . $j;
            $produk = "produk" . $j;
            $qty = "com_qty" . $j;
            $tgl_kirim = "tgl_kirim" . $j;
            $kontrak = "com_kontrak" . $j;
            $posnr = "com_posnr" . $j;
            $shp = "com_shipment" . $j;
            //if(isset($_POST[$shipto])){
            $tgl_kirim = $_POST['tgl_kirim' . $j];
            list($day, $month, $year) = split("-", $tgl_kirim);
            $tgl_kirim = $year . $month . $day;
            $shipto = $_POST[$shipto];
            $produk = $_POST[$produk];
            $kode_distrik = $_POST[$kode_distrik];
            $qty = $_POST[$qty];
            $kontrak = $_POST[$kontrak];
            $posnr = $fungsi->linenum($_POST[$posnr]);
            $shipment = $_POST[$shp];

            //$show_ket .= "shipto $shipto / kode_distrik $kode_distrik / produk $produk / qty $qty / route $route / plant $plant<br>";

            $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $produk;

            $fce->ORDER_ITEMS_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_ITEMS_INX->row["UPDATEFLAG"] = 'I'; //'000010';
            $fce->ORDER_ITEMS_INX->row["MATERIAL"] = 'X';
            if ($so_type == 'ZFC') {
                $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                if ($sales_org == '6000') {
                    $ITEM_CATEGvali = 'ZKNN';
                } else if ($sales_org == '4000' || $sales_org == '3000') {
                    $ITEM_CATEGvali = 'ZKLN';
                } else {
                    $ITEM_CATEGvali = 'ZKNN';
                }
                $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;                   
            }
            $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
            $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

            $fce->ORDER_ITEMS_INX->row["PLANT"] = 'X';
            $fce->ORDER_ITEMS_INX->row["ROUTE"] = 'X';
            //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $kode_distrik;
            if ($kontrak != '') {
                $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';

                $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
                $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
                $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
            }

            // @liyantanto buat tlcc
//                if ($lcnum!='') {
//                    $fce->ORDER_ITEMS_IN->row["DEPREC_PER"] = $valperlcnum;
//                    $fce->ORDER_ITEMS_INX->row["DEPREC_PER"] = 'X';
//		} 
            //if ($reason =='Z02') {
            //$show_ket .= " shp nya euii ". $shipment;
            //$fce->ORDER_ITEMS_IN->row["REF_1_S"] = $shipment;
            //$fce->ORDER_ITEMS_INX->row["REF_1_S"] ='X';
            //}		

            $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);
            $fce->ORDER_ITEMS_INX->Append($fce->ORDER_ITEMS_INX->row);

            //detail entri schedule n qty'
            $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
            $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
            $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);
//		if ($reason =='Z02') {
            $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
            $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
            $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
            $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);
//		}
            //detail entri distributor dan agen
            if ($j == 1)
                $item_num = '000000';
            else
                $item_num = $item_num;
            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
            //}
        }

        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
        $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
        $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
        $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

        $fce->Call();
        if ($fce->GetStatus() == SAPRFC_OK) {
            $nomorso = $fce->SALESDOCUMENT;
            $fce->RETURN->Reset();
            while ($fce->RETURN->Next()) {
                $tipe = $fce->RETURN->row["TYPE"];
                $msg = $fce->RETURN->row["MESSAGE"];
                if ($tipe != 'S') {
                    $show_ket .= $msg;
                    $show_ket .= '<br>';
                }
            }
            //Commit Transaction
            $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
            $fcecom->Call();
            $fcecom->Close();

            //Update SO
            if ($nomorso != '' && $j > 1) {
                sleep(5); //seconds to wait..   
                $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                $fce->Call();

                //Commit Transaction
                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                $fce->Call();
            }

            if ($sales_org == '6000') {
                sleep(5); //seconds to wait..
                //Teks
                unset($tgl_kirimapp);
                for ($j = 1; $j <= $sampai; $j++) {
                    $item_num1 = $j * 10;
                    $item_num = $fungsi->linenum($item_num1);
                    $com_nopolisiv = trim($_POST['nopol' . $j]);
                    $com_drivernamenopolv = trim($_POST['drivernamenopol' . $j]);
                    $com_simdrivernamenopolv = trim($_POST['simdrivernamenopol' . $j]);
                    $com_typetruckv = trim($_POST['tipenopol' . $j]);
                    $com_catatanv = trim($_POST['val_addnote' . $j]);
                    $com_kodekantong = trim($_POST['ktproduk' . $j]);
                    $tgl_kirimappT = trim($_POST['tgl_kirim' . $j]);
                    list($day, $month, $year) = split("-", $tgl_kirimappT);
                    $tgl_kirimapp .= $year . $month . $day . "!";


                    $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                    $fce->I_VBELN = $nomorso; //'000010';
                    $fce->I_POSNR = sprintf("%06d", $item_num); //'000010';
                    $fce->I_TEXT1 = $com_nopolisiv;
                    $fce->I_TEXT2 = $com_typetruckv;
                    $fce->I_TEXT3 = $com_catatanv;
                    $fce->I_TEXT4 = $com_kodekantong;
                    $fce->I_TEXT6 = $com_drivernamenopolv;
                    $fce->I_TEXT7 = $com_simdrivernamenopolv;
                    $fce->Call();
//                            echo "<pre>";
//                            //print_r($fce);
//                            echo "</pre>";
                }

                if ($sales_org == '6000' && $nomorso != '') {
                    $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                }
            }
        }
        $fce->Close();
        $sap->Close();

        $show_ket .= 'Sales Order has been made with a number : ' . $nomorso . '<br>';

        //update no shipment ke so
        if ($reason == 'Z02') {
            $sap = new SAPConnection();
            $sap->Connect("../include/sapclasses/logon_data.conf");
            if ($sap->GetStatus() == SAPRFC_OK)
                $sap->Open();
            if ($sap->GetStatus() != SAPRFC_OK) {
                $sap->PrintStatus();
                exit;
            }

            $fce1 = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
            if ($fce1 == false) {
                $sap->PrintStatus();
                exit;
            }
            $fce1->SALESDOCUMENT = $nomorso; //"ZOR";
            $fce1->ORDER_HEADER_INX["UPDATEFLAG"] = 'U'; //"Z1";

            $sampai = $_POST['jumlah'];
            for ($j = 1; $j <= $sampai; $j++) {
                $idke = "idke" . $j;
                $item_num1 = $j;
                $id_dtl = $_POST['com_iddtl' . $j];
                $item_num = $fungsi->linenum($item_num1 * 10);
                $nospj = $_POST['com_shipment' . $j];

                //update detail item
                $fce1->ORDER_ITEM_INX->row["UPDATEFLAG"] = 'U';
                $fce1->ORDER_ITEM_INX->row["ITM_NUMBER"] = $item_num;
                $fce1->ORDER_ITEM_INX->row["REF_1_S"] = 'X';
                $fce1->ORDER_ITEM_INX->Append($fce1->ORDER_ITEM_INX->row);

                $fce1->ORDER_ITEM_IN->row["ITM_NUMBER"] = $item_num; //'000010';
                $fce1->ORDER_ITEM_IN->row["REF_1_S"] = $nospj;
                $fce1->ORDER_ITEM_IN->Append($fce1->ORDER_ITEM_IN->row);
                //$show_ket.= $nospj.'-'.$nomorso;
            }
            $fce1->Call();

            if ($fce1->GetStatus() == SAPRFC_OK) {
                $fce1->RETURN->Reset();
                while ($fce1->RETURN->Next()) {
                    $error = $fce1->RETURN->row["TYPE"];
                    $msg = $fce1->RETURN->row["MESSAGE"];
                    $show_ket .= $msg;
                    $show_ket .= '<br>';
                }
                //Commit Transaction
                $fce1 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                $fce1->Call();
                $fce1->Close();
            }
            $sap->Close();
        }


        if ($nomorso != "") {
            $status = "APPROVE";
            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'NO_SO_OLD', 'PRICE_DATE', 'KD_REASON', 'NM_REASON', 'TIPEPP');
            $field_data = array("$soldto", "$nama_sold_to", "$no_pp", "SYSDATE", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "$status", "SYSDATE", "$user_name", "SYSDATE", "$user_name", "0", "$route", "$sales_org", "$pricelist", "$nama_pricelist", "$lcnum", "$oldso", "instgl_$price_datep", "$reason", "$nama_reason", "$tipeCreatePP_isi");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);

            $show_ket .= "Order Reservation Success Made with No. $no_pp <br>";

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "com_qty" . $k;
                $uom = "uom" . $k;
                $tgl_kirim = "tgl_kirim" . $k;
                $kontrak = "com_kontrak" . $k;
                $shipment = "com_shipment" . $k;
                $polisinumber = "nopol" . $k;
                $drivernamenopolfg = "drivernamenopol" . $k;
                $simdrivernamenopolfg = "simdrivernamenopol" . $k;
                $typetruk = "tipetruk" . $k;
                $catatnke = "val_addnote" . $k;
                $ktprodukke = "ktproduk" . $k;


                if (isset($_POST[$shipto])) {
                    $tgl_kirim_in = $_POST[$tgl_kirim];
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $shipto_in = $_POST[$shipto];
                    $nama_shipto_in = $_POST[$nama_shipto];
                    $alamat_in = $_POST[$alamat];
                    $produk_in = $_POST[$produk];
                    $kode_distrik_in = $_POST[$kode_distrik];
                    $nama_distrik_in = $_POST[$nama_distrik];
                    $kode_prov_in = $_POST[$kode_prov];
                    $nama_prov_in = $_POST[$nama_prov];
                    $nama_produk_in = $_POST[$nama_produk];
                    $qty_in = $_POST[$qty];
                    $uom = $_POST[$uom];
                    $kontrak = $_POST[$kontrak];
                    $shipment = $_POST[$shipment];
                    $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                    $drivernamenopolfg_in = trim($_POST[$drivernamenopolfg]);
                    $simdrivernamenopolfg_in = trim($_POST[$simdrivernamenopolfg]);
                    $typetruk_in = trim($_POST[$typetruk]);
                    $catatnke_in = trim($_POST[$catatnke]);
                    $ktprodukke_in = trim($_POST[$ktprodukke]);

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                    $field_data = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep", "$nopolisi_in", "$typetruk_in", "$catatnke_in", "$ktprodukke_in", "$drivernamenopolfg_in", "$simdrivernamenopolfg_in");
                    $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                    $field_data1 = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep");

                    $tablename = "OR_TRANS_DTL";
                    $tablename1 = "OR_TRANS_APP";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);
                    $fungsi->insert($conn, $field_names1, $field_data1, $tablename1);
                    $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                }
            }
        } else {
            $status = "PROCESS";
            $show_ket .= "Order Reservation Failed ! <br>";
        }

        if (isset($_POST['lasthalaman'])) {
            $habis = trim($_POST['lasthalaman']);
        } else {
            $habis = "tambahadmin.php";
        }
        break;

//============================================================================================================================
//============================================================================================================================
// buatso admin MD
    case "buatsoadminmd":
        // CEK MAPPING PLANT ADA ATAU TIDAK

        $user_name_in = $_SESSION['user_name'];
        $plantcek = $_POST['plant'];
        $str = "SELECT * FROM ZMD_MAPPING_PLANT
        WHERE PLANT_MD = '{$plantcek}' AND  DEL=0
        ";
        $query = oci_parse($conn, $str);
        oci_execute($query);
        $row = oci_fetch_array($query, OCI_ASSOC);
        $lanjut = 'Y';
        $next = 'Y';
        $SO1 = '';
        $IDH1 = '';
        $SO2 = '';
        $IDH2 = '';
        $SO3 = '';
        $IDH3 = '';
        $SO4 = '';
        $IDH4 = '';
        $jerror = 0;
        $SOMDNE = "N";
        $no_pp = $fungsi->or_new_pp_number($conn);

        if (count($row) > 0) {

            $soldtocek = $_POST['sold_to']; //$_POST['distr_id']; Upd Tham
            $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND DEL = 0 ";
            $querysoldto = oci_parse($conn, $strsoldto);
            oci_execute($querysoldto);
            $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
            if (count($rowsoldto) < 1) {
                $lanjut = 'N';
                $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
            }
        } else {
            $lanjut = 'N';
            $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
            ;
        }


        // CEK ICS
        if ($row["COM_MD_2"] != "" && $row["PLANT_MD_2"] != "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 3;
            $ics = "Y";
            $loncat = "N";
        } else if ($row["COM_MD_2"] == "" && $row["PLANT_MD_2"] == "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 2;
            $ics = "Y";
            $loncat = "Y"; /// MD @ tidak di pakai
        } else {
            $perulangan = 3;
            $perulanganSO = 2;
            $perulanganPO = 1;
            $ics = "N";
            $loncat = "N";
        }

        // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
        if ($lanjut == 'Y') {
            // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
            for ($ul = 1; $ul <= $perulangan; $ul++) {

                if ($next == 'Y') {
                    $user_name = $_SESSION['user_name'];
                    $idh = $_POST['idh'];
                    $iddtl = $_POST['iddtl'];
                    $so_type = $_POST['so_type'];
                    $nama_so_type = $_POST['nama_so_type'];
                    $sales_org = $_POST['org']; //$_POST['org'];
                    $channelnew = $_POST['channels'];
                    if ($so_type == 'ZEX') {
                        $distr_chan = "30";
                    } elseif ($so_type == 'ZPR') {
                        if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900' || $sales_org == '4000' || $sales_org == '3000')
                            $distr_chan = "10";
                        else if ($sales_org == '6000')
                            $distr_chan = "10";
                        else
                            $distr_chan = "50";
                    } else {
                        $distr_chan = "10";
                    }
                    $division = "00";
                    $dlv_block = "";
                    $soldto = $_POST['sold_to'];
                    $soldto = $fungsi->sapcode($soldto);
                    $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
                    if ($distr_chancondi != '') {
                        $distr_chan = $distr_chancondi;
                    }
                    if ($channelnew != '') {
                        $distr_chan = $channelnew;
                    }
                    $distr_chanPO1 = $distr_chan;
                    if ($ul == 3 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                    } else if ($ul == 4 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                        $distr_chanPO2 = $distr_chan;
                    }
                    $nama_sold_to = $_POST['nama_sold_to'];
                    $tgl_pp = date("d-m-Y");
                    list($day, $month, $year) = split("-", $tgl_pp);
                    $tgl_pp = $year . $month . $day;
                    $top = $_POST['top'];
                    $nama_top = $_POST['nama_top'];
                    $reason = $_POST['reason'];
                    $nama_reason = $_POST['nama_reason'];
                    $oldso = $_POST['oldso'];
                    $price_datep = $_POST['price_date'];
                    list($dayp, $monthp, $yearp) = split("-", $price_datep);
                    $price_date = $yearp . $monthp . $dayp;

                    $plant = $_POST['plant'];
                    $nama_plant = trim($_POST['nama_plant']);
                    $incoterm1 = $_POST['jenis_kirim'];
                    $incoterm2 = $_POST['nama_kirim'];
                    $route = $_POST['route'];
                    $kd_kapal = $_POST['kd_kapal'];
                    $nm_kapal = $_POST['nm_kapal'];
                    $nama_kapal = $kd_kapal . '-' . $nm_kapal;
                    $pricelist = $_POST['pricelist'];
                    $nama_pricelist = $_POST['nama_pricelist'];
                    $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
                    $valperlcnum = trim($_POST['perslcnum']);
                    $lcnum = $_POST['lcnum'];
                    $lcnum = $fungsi->sapcode($lcnum);
                    $sampai1 = $_POST['jumlah'];
                    $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
                    for ($j = 0; $j <= $sampai1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $kontrakh = $_POST['com_kontrak' . $j];
                        }
                    }


                    if ($ul == 1) {
                        $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $soldto = $_POST['sold_to']; // $_POST['distr_id'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
                        $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2 
                    } else if ($ul == 2) {
                        $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2
                        $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org2 = $row['COM_OPCO'];
                        $plant2 = $row['PLANT_OPCO'];
                        $incotermPO1 = $incoterm1;
                        $incotermPO12 = $incoterm2;
                    } else if ($ul == 3 && $ics == "Y") {
                        $sales_org = $row['COM_MD_2'];
                        $plant = $row['PLANT_MD_2'];
                        $soldto = $rowsoldto['SOLD_TO_MD_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org3 = $row['COM_MD_2'];
                        $plant3 = $row['PLANT_MD_2'];

                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['jenis_kirim'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_kirim'];
                        
                        //penambahan rute dan TOP
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           //
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           //
                        }
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        //penambahan rute top
                        
                    } else if ($ul == 4 && $ics == "Y") {
                        $sales_org = $row['COM_OPCO_2'];
                        $plant = $row['PLANT_OPCO_2'];
                        $soldto = $rowsoldto['SOLD_TO_OPCO_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org4 = $row['COM_OPCO_2'];
                        $plant4 = $row['PLANT_OPCO_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['jenis_kirim'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_kirim'];
                        
                        //penambahan rute dan TOP
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           //
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           //
                        }
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        $topPO2    = $top;
                        //penambahan rute top
                        
                        $incotermPO2 = $incoterm1;
                        $incotermPO22 = $incoterm2;
                    }

                    //call bapi sales order sap
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        $sap->PrintStatus();
                        exit;
                    }

                    if ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) {
                        $COM = 'MD';
                    } else {
                        $COM = 'SBI';
                    }
                    //print_r($sales_org);
                    if ($ul <= $perulanganSO && $COM == 'MD') { // PROSES FOR 1 DAN 2 MENYIMPAN SO 
                        if ($loncat == "N") {
                            $gass = "Y";
                        } else if ($loncat == "Y") {
                            if ($ul == 3) {
                                $gass = "N";
                            } else {
                                $gass = "Y";
                            }
                        }

                        if ($gass == "Y") { // loncat tidak membuat SO MD 2 karena tidak di mammping plant
                            $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
                            if ($fce == false) {
                                $sap->PrintStatus();
                                exit;
                            }

                            //header entri
                            if ($so_type == 'ZFC') {
                                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
                            } else {
                                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                            }

                            $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
                            $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
                            $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
                            $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00"; 
                            $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
                            $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
                            $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
                            $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
                            $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
                            $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
                            $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
                            $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
                            $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
                            //$fce->ORDER_HEADER_IN["COLLECT_NO"] = $oldso;
                            $fce->ORDER_HEADER_IN["REF_1"] = $oldso;
                            $fce->ORDER_HEADER_IN["PRICE_DATE"] = $price_date;
                            if ($sales_org == "7900" || $sales_org == "7000") {
                                $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
                                $querytax = oci_parse($conn, $strtax);
                                oci_execute($querytax);
                                $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
                                if (ISSET($rowtax["KD_SOLD_TO"])) {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                } else {
                                    if ($so_type == 'ZFC') {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                    }else{
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1";    
                                    }
                                }

//                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
                            }


                            if ($lcnum != '') {
                                $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                                $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
                                //$fce->ORDER_HEADER_IN["DEPARTM_NO"] = 9;
                                $fce->ORDER_HEADER_IN["REC_POINT"] = 2;
                            }
//                            if ($kontrakh != '' && $sales_org == "7900") {
//                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
//                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
//                            }
                            if ($kontrakh != '') {
                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
                            }

                            //detail entri item'
                            $sampai = $_POST['jumlah'];

                            for ($j = 1; $j <= $sampai; $j++) {
                                $shipto_awal = $_POST['shipto1'];

                                $item_num = $j;
                                $shipto = "shipto" . $j;
                                $kode_distrik = "kode_distrik" . $j;
                                $produk = "produk" . $j;
                                $qty = "com_qty" . $j;
                                $tgl_kirim = "tgl_kirim" . $j;
                                $kontrak = "com_kontrak" . $j;
                                $posnr = "com_posnr" . $j;
                                $shp = "com_shipment" . $j;
                                $tgl_kirim = $_POST['tgl_kirim' . $j];
                                list($day, $month, $year) = split("-", $tgl_kirim);
                                $tgl_kirim = $year . $month . $day;
                                $produk = $_POST[$produk];
                                $kode_distrik = $_POST[$kode_distrik];
                                $qty = $_POST[$qty];

//                                if($sales_org=="7900"){ 
//                                    $kontrak = $_POST[$kontrak];
//                                }else{
//                                    $kontrak = "";
//                                }
                                $kontrak = $_POST[$kontrak];

                                $posnr = $fungsi->linenum($_POST[$posnr]);
                                $shipment = $_POST[$shp];

                                if ($ul == 1) {
                                    $shipto = $_POST[$shipto];     // GANTI BERDASARKAN MAPPING CUSTOMER                                
                                    $produk1 = $_POST[$produk];
                                } else if ($ul == 2 || $ul == 3 || $ul == 4) {
                                    $shiptotocek = $_POST[$shipto];
                                    
                                    $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                    $queryshipto = oci_parse($conn, $strshipto);
                                    oci_execute($queryshipto);
                                    $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                    if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                        $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                        $queryshipto = oci_parse($conn, $strshipto);
                                        oci_execute($queryshipto);
                                        $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                    }
                                    if ($ul == 2) {
                                        $shipto = $rowshipto['SHIP_TO_OPCO'];
                                        $soldto = $rowshipto['SOLD_TO_OPCO'];
                                    } else if ($ul == 3) {
                                        $shipto = $rowshipto['SHIP_TO_MD_2'];
                                        $soldto = $rowshipto['SOLD_TO_MD_2'];
                                    } else if ($ul == 4) {
                                        $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                        $soldto = $rowshipto['SOLD_TO_OPCO_2'];
                                    }



                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                    $querymaterial = oci_parse($conn, $strmaterial);
                                    oci_execute($querymaterial);
                                    $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                    if ($ul == 2) {
                                        $produk = $rowmaterial['KD_MATERIAL_OPCO'];
                                    } else if ($ul == 3) {
                                        $produk = $rowmaterial['KD_MATERIAL_MD_2'];
                                    } else if ($ul == 4) {
                                        $produk = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                    }
                                }

                                //$show_ket .= "shipto $shipto / kode_distrik $kode_distrik / produk $produk / qty $qty / route $route / plant $plant<br>";

                                $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $produk;

                                $fce->ORDER_ITEMS_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_ITEMS_INX->row["UPDATEFLAG"] = 'I'; //'000010';
                                $fce->ORDER_ITEMS_INX->row["MATERIAL"] = 'X';
                                if ($so_type == 'ZFC') {
                                    $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                                    if ($sales_org == '6000') {
                                        $ITEM_CATEGvali = 'ZKNN';
                                    } else if ($sales_org == '4000' || $sales_org == '3000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900') {
                                        $ITEM_CATEGvali = 'ZKLN';
                                    } else {
                                        $ITEM_CATEGvali = 'ZKNN';
                                    }
                                            if($sales_org=='7900' || $sales_org=='7000'){
                                                $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";    // Tambahan MD 
                                            }    
                                    $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;                   
                                }
                                $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                                $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

                                $fce->ORDER_ITEMS_INX->row["PLANT"] = 'X';
                                $fce->ORDER_ITEMS_INX->row["ROUTE"] = 'X';

                                //penambahan
//                                $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $kode_distrik; // penambahan distrik
//                                $fce->ORDER_ITEMS_IN->row["SALES_OFF"]  = '10'.substr($kode_distrik,0,2);
//                                if ($kontrak != '' && $sales_org == "7900") {
//                                    $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
//                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
//                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
//
//                                    $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
//                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
//                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
//                                }
                                if ($kontrak != '') {
                                    $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                                    $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';

                                    $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
                                    $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
                                }

                                $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);
                                $fce->ORDER_ITEMS_INX->Append($fce->ORDER_ITEMS_INX->row);

                                //detail entri schedule n qty'
                                $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                                $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                                $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);
                                //		if ($reason =='Z02') {
                                $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                                $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                                $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                                $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);
                                //		}
                                //detail entri distributor dan agen
                                if ($j == 1)
                                    $item_num = '000000';
                                else
                                    $item_num = $item_num;
                                $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                                //}
                            }



                            //penambahan sales office
                            $dt_shipto = "SELECT BZIRK, VKBUR, VKGRP FROM RFC_Z_ZCSD_SHIPTO WHERE KUNN2 = '{$shipto}' AND ROWNUM =1";
//                            echo $dt_shipto;
                            $dt_shipto_q = oci_parse($conn, $dt_shipto);
                            oci_execute($dt_shipto_q);
                            $row_dt_shipto = oci_fetch_array($dt_shipto_q, OCI_ASSOC);

                            $fce->ORDER_HEADER_IN["SALES_GRP"] = $row_dt_shipto["VKGRP"];
                            $fce->ORDER_HEADER_IN["SALES_DIST"] = $row_dt_shipto["BZIRK"];
                            $fce->ORDER_HEADER_IN["SALES_OFF"] = $row_dt_shipto["VKBUR"];
                            // end penambahan sales office


                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto_awal;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                            $fce->Call();
                            if ($fce->GetStatus() == SAPRFC_OK) {
                                $nomorso = $fce->SALESDOCUMENT;
                                $fce->RETURN->Reset();
                                while ($fce->RETURN->Next()) {
                                    $tipe = $fce->RETURN->row["TYPE"];
                                    $msg = $fce->RETURN->row["MESSAGE"];
                                    if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                        $show_ket .= $msg;
                                        $show_ket .= '<br>';
                                        $next = 'N';

                                        //echo $msg;
                                    }
                                }
                                //Commit Transaction
                                $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fcecom->Call();
                                $fcecom->Close();

                                //Update SO
                                if ($nomorso != '' && $j > 1) {
                                    sleep(5); //seconds to wait..   
                                    $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                    $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                                    $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                                    $fce->Call();

                                    //Commit Transaction
                                    $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                    $fce->Call();
                                }

                                if ($sales_org == '6000') {
                                    sleep(5); //seconds to wait..
                                    //Teks
                                    unset($tgl_kirimapp);
                                    for ($j = 1; $j <= $sampai; $j++) {
                                        $item_num1 = $j * 10;
                                        $item_num = $fungsi->linenum($item_num1);
                                        $com_nopolisiv = trim($_POST['nopol' . $j]);
                                        $com_drivernamenopolv = trim($_POST['drivernamenopol' . $j]);
                                        $com_simdrivernamenopolv = trim($_POST['simdrivernamenopol' . $j]);
                                        $com_typetruckv = trim($_POST['tipenopol' . $j]);
                                        $com_catatanv = trim($_POST['val_addnote' . $j]);
                                        $com_kodekantong = trim($_POST['ktproduk' . $j]);
                                        $tgl_kirimappT = trim($_POST['tgl_kirim' . $j]);
                                        list($day, $month, $year) = split("-", $tgl_kirimappT);
                                        $tgl_kirimapp .= $year . $month . $day . "!";


                                        $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                        $fce->I_VBELN = $nomorso; //'000010';
                                        $fce->I_POSNR = sprintf("%06d", $item_num); //'000010';
                                        $fce->I_TEXT1 = $com_nopolisiv;
                                        $fce->I_TEXT2 = $com_typetruckv;
                                        $fce->I_TEXT3 = $com_catatanv;
                                        $fce->I_TEXT4 = $com_kodekantong;
                                        $fce->I_TEXT6 = $com_drivernamenopolv;
                                        $fce->I_TEXT7 = $com_simdrivernamenopolv;
                                        $fce->Call();
                                    }

                                    if ($sales_org == '6000' && $nomorso != '') {
                                        $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                                    }
                                }
                            }
                            if ($next == 'Y') {
                                if ($ul == 1 || $ul == 3) {
                                    $numbering = " SO MD = ";
                                } else {
                                    $numbering = " SO OPCO = ";
                                }
                                $show_ket .= $ul . '' . $numbering . ' Sales Order has been made with a number : ' . $nomorso . '<br>';
                            }

                            //update no shipment ke so
                            if ($reason == 'Z02') {
                                $sap = new SAPConnection();
                                $sap->Connect("../include/sapclasses/logon_data.conf");
                                if ($sap->GetStatus() == SAPRFC_OK)
                                    $sap->Open();
                                if ($sap->GetStatus() != SAPRFC_OK) {
                                    $sap->PrintStatus();
                                    exit;
                                }

                                $fce1 = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                if ($fce1 == false) {
                                    $sap->PrintStatus();
                                    exit;
                                }
                                $fce1->SALESDOCUMENT = $nomorso; //"ZOR";
                                $fce1->ORDER_HEADER_INX["UPDATEFLAG"] = 'U'; //"Z1";

                                $sampai = $_POST['jumlah'];
                                for ($j = 1; $j <= $sampai; $j++) {
                                    $idke = "idke" . $j;
                                    $item_num1 = $j;
                                    $id_dtl = $_POST['com_iddtl' . $j];
                                    $item_num = $fungsi->linenum($item_num1 * 10);
                                    $nospj = $_POST['com_shipment' . $j];

                                    //update detail item
                                    $fce1->ORDER_ITEM_INX->row["UPDATEFLAG"] = 'U';
                                    $fce1->ORDER_ITEM_INX->row["ITM_NUMBER"] = $item_num;
                                    $fce1->ORDER_ITEM_INX->row["REF_1_S"] = 'X';
                                    $fce1->ORDER_ITEM_INX->Append($fce1->ORDER_ITEM_INX->row);

                                    $fce1->ORDER_ITEM_IN->row["ITM_NUMBER"] = $item_num; //'000010';
                                    $fce1->ORDER_ITEM_IN->row["REF_1_S"] = $nospj;
                                    $fce1->ORDER_ITEM_IN->Append($fce1->ORDER_ITEM_IN->row);
                                    //$show_ket.= $nospj.'-'.$nomorso;
                                }
                                $fce1->Call();

                                if ($fce1->GetStatus() == SAPRFC_OK) {
                                    $fce1->RETURN->Reset();
                                    while ($fce1->RETURN->Next()) {
                                        $error = $fce1->RETURN->row["TYPE"];
                                        $msg = $fce1->RETURN->row["MESSAGE"];
                                        $show_ket .= $msg;
                                        $show_ket .= '<br>';
                                    }
                                    //Commit Transaction
                                    $fce1 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                    $fce1->Call();
                                    $fce1->Close();
                                }
                                $sap->Close();
                            }

                            // Setelah SO ter create
                            if ($ul == 1) {
                                $SO1 = $nomorso;
                                $IDH1 = $idh;
                            } else if ($ul == 2) {
                                $SO2 = $nomorso;
                                $IDH2 = $idh;
                            } else if ($ul == 3) {
                                $SO3 = $nomorso;
                                $IDH3 = $idh;
                            } else if ($ul == 4) {
                                $SO4 = $nomorso;
                                $IDH4 = $idh;
                            }
                            if ($next == "Y" && $ul == 1) { // 
                                if ($nomorso != "") {
                                    $status = "APPROVE";
                                    $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'NO_SO_OLD', 'PRICE_DATE', 'KD_REASON', 'NM_REASON', 'TIPEPP');
                                    $field_data = array("$soldto", "$nama_sold_to", "$no_pp", "SYSDATE", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "$status", "SYSDATE", "$user_name", "SYSDATE", "$user_name", "0", "$route", "$sales_org", "$pricelist", "$nama_pricelist", "$lcnum", "$oldso", "instgl_$price_datep", "$reason", "$nama_reason", "$tipeCreatePP_isi");
                                    $tablename = "OR_TRANS_HDR";
                                    $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                    $show_ket .= "Order Reservation Success Made with No. $no_pp <br>";

                                    $sampai = $_POST['jumlah'];
                                    for ($k = 1; $k <= $sampai; $k++) {
                                        $shipto = "shipto" . $k;
                                        $nama_shipto = "nama_shipto" . $k;
                                        $alamat = "alamat" . $k;
                                        $kode_distrik = "kode_distrik" . $k;
                                        $nama_distrik = "nama_distrik" . $k;
                                        $kode_prov = "kode_prov" . $k;
                                        $nama_prov = "nama_prov" . $k;
                                        $produk = "produk" . $k;
                                        $nama_produk = "nama_produk" . $k;
                                        $qty = "com_qty" . $k;
                                        $uom = "uom" . $k;
                                        $tgl_kirim = "tgl_kirim" . $k;
                                        $kontrak = "com_kontrak" . $k;
                                        $shipment = "com_shipment" . $k;
                                        $polisinumber = "nopol" . $k;
                                        $drivernamenopolfg = "drivernamenopol" . $k;
                                        $simdrivernamenopolfg = "simdrivernamenopol" . $k;
                                        $typetruk = "tipetruk" . $k;
                                        $catatnke = "val_addnote" . $k;
                                        $ktprodukke = "ktproduk" . $k;


                                        if (isset($_POST[$shipto])) {
                                            $tgl_kirim_in = $_POST[$tgl_kirim];
                                            if ($tgl_kirim_in == "")
                                                $tgl_kirim_in = date('d-m-Y');
                                            $nama_shipto_in = $_POST[$nama_shipto];
                                            $alamat_in = $_POST[$alamat];

                                            $shipto_in = $_POST[$shipto];    // GANTI BERDASARKAN MAPPING CUSTOMER
                                            $produk_in = $_POST[$produk];
                                            $produk1 = $_POST[$produk];


                                            $kode_distrik_in = $_POST[$kode_distrik];
                                            $nama_distrik_in = $_POST[$nama_distrik];
                                            $kode_prov_in = $_POST[$kode_prov];
                                            $nama_prov_in = $_POST[$nama_prov];
                                            $nama_produk_in = $_POST[$nama_produk];
                                            $qty_in = $_POST[$qty];
                                            $uom = $_POST[$uom];

//                                            if($sales_org=="7900"){ 
//                                                $kontrak = $_POST[$kontrak];
//                                            }else{
//                                                $kontrak = "";
//                                            }
                                            $kontrak = $_POST[$kontrak];

                                            $shipment = $_POST[$shipment];
                                            $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                                            $drivernamenopolfg_in = trim($_POST[$drivernamenopolfg]);
                                            $simdrivernamenopolfg_in = trim($_POST[$simdrivernamenopolfg]);
                                            $typetruk_in = trim($_POST[$typetruk]);
                                            $catatnke_in = trim($_POST[$catatnke]);
                                            $ktprodukke_in = trim($_POST[$ktprodukke]);

                                            $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                                            $field_data = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep", "$nopolisi_in", "$typetruk_in", "$catatnke_in", "$ktprodukke_in", "$drivernamenopolfg_in", "$simdrivernamenopolfg_in");
                                            $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                                            $field_data1 = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep");

                                            $tablename = "OR_TRANS_DTL";
                                            $tablename1 = "OR_TRANS_APP";
                                            $fungsi->insert($conn, $field_names, $field_data, $tablename);
                                            $fungsi->insert($conn, $field_names1, $field_data1, $tablename1);
                                            $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                                        }
                                    }
                                } else {
                                    $status = "PROCESS";
                                    $show_ket .= "Order Reservation Failed ! <br>";
                                }
                            }
                        }
                        $jerror += 1;
                    } else if ($ul == 2 || $ul == 4 && $COM == "SBI") {
                        // build array material
                        // build array material
                        $Tmaterial = array();
                        $Tmaterial['MaterialCode'] = array();
                        $Tmaterial['PlantCode'] = array();
                        $Tmaterial['Qty'] = array();
                        $Tmaterial['QtyUnit'] = array();
                        $Tmaterial['ScheduleLine'] = array();
                        $Tmaterial['RequestDeliveryDate'] = array();
                        $Tmaterial['RequestDeliveryQty'] = array();
                        $Dmaterial = array();
                        for ($j = 1; $j <= $sampai; $j++) {
                            $material = $_POST['produk' . $j];
                            $strmat = "SELECT CAST(NTGEW AS float) as BERAT, A.* FROM RFC_Z_ZCSD_LIST_MAT_SALES_2 A WHERE VKORG = '{$sales_org1}' AND MATNR = '{$material}'  AND WERKS = '{$plant1}'";
                            $querymat = oci_parse($conn, $strmat);
                            oci_execute($querymat);
                            $rowmat = oci_fetch_array($querymat, OCI_ASSOC);
                            if (count($rowmat) > 0 && $rowmat['MEINS'] == "ZAK") {
                                $qty = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
                                $qtyx = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
                            } else {
                                $qty = $_POST['com_qty' . $j];
                                $qtyx = $_POST['com_qty' . $j];
                            }

                            $shiptotocek = $_POST['shipto' . $j];
                            $item_numline = sprintf("%04d", $j + 1);
                            $tanggall = $_POST['tgl_kirim' . $j];
                            list($day, $month, $year) = split("-", $tanggall);
                            $tgl_kirim = $year . "-" . $month . "-" . $day;



                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                            $querymaterial = oci_parse($conn, $strmaterial);
                            oci_execute($querymaterial);
                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);

                            if ($ul == 2) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO"];
                            } else if ($ul == 4) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO_2"];
                            }
                            $Tmaterial['MaterialCode'] = $materialsbi;
                            $Tmaterial['PlantCode'] = $plant;
                            $Tmaterial['Qty'] = $qty;
                            $Tmaterial['QtyUnit'] = "TO";
                            $Tmaterial['ScheduleLine'] = $item_numline;
                            $Tmaterial['RequestDeliveryDate'] = $tgl_kirim;
                            $Tmaterial['RequestDeliveryQty'] = $qtyx;
                            $Dmaterial[] = $Tmaterial;
                        }
                        $strorder = "SELECT * FROM ZMD_MAPPING_ORDER WHERE ORDER_TYPE_MD = '{$so_type}' AND COMPANY_OPCO = '{$sales_org}' AND DEL = 0";
                        $queryorder = oci_parse($conn, $strorder);
                        oci_execute($queryorder);
                        $roworder = oci_fetch_array($queryorder, OCI_ASSOC);

                        list($day, $month, $year) = split("-", $tanggall);
                        $tgl_kirim = $year . $month . $day;

                        $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                        $queryshipto = oci_parse($conn, $strshipto);
                        oci_execute($queryshipto);
                        $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                        if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                            $queryshipto = oci_parse($conn, $strshipto);
                            oci_execute($queryshipto);
                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                        }
                        if ($ul == 2) {
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO'];
                            $shipto = $rowshipto['SHIP_TO_OPCO'];
                            $SOMD = $SO1;
                        } else if ($ul == 4) {
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO_2'];
                            $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                            $SOMD = $SO3;
                        }

                        $tgl_pp = date("d-m-Y");

                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_ppPO = $year . "-" . $month . "-" . $day . " 00:00:00";

                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_pp = $year . $month . $day;

                        if ($sales_org == "PTSC") {
                            $sales_organization = "SCBD";
                        } else if ($sales_org == "ID50") {
                            $sales_organization = "ID11";
                        }
                        
                        if(empty($ship_condition)){
                        
                            if ($incoterm1 == "FOT") {
                                $shipcond_sbi = "PK";
                            } else if ($incoterm1 == "FRC") {
                                $shipcond_sbi = "D0";
                            } else if ($incoterm1 == "CNF") {
                                $shipcond_sbi = "DV";
                            } else {
                                $shipcond_sbi = "";
                            }
                        
                        }else{
                            $shipcond_sbi = $ship_condition;
                        }
                        
                        $strtop = "SELECT * FROM ZMD_MAPPING_TOP WHERE COM_SMI = '{$sales_org1}' AND TOP_SMI = '{$top}' AND (COM_SB = '{$sales_org}' or COM_SB = 'ALL')  AND DEL = 0 order by COM_SB DESC";
                        $querytop = oci_parse($conn, $strtop);
                        oci_execute($querytop);
                        $rowtop = oci_fetch_array($querytop, OCI_ASSOC);
                        if (ISSET($rowtop['TOP_SB'])) {
                            $topsbi = $rowtop['TOP_SB'];
                        }else{
                            $topsbi = null;
                        }    
                        
                        $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
                        $data = array('Token' => 'aSsMx7GV0HFGzlufM4DH',
                            'SystemID' => 'PASSO',
                            'Data' => array('SalesDocumentType' => $roworder["ORDER_TYPE_OPCO"],
                                'SalesOrganization' => $sales_organization,
                                'DistributionChannel' => 'DB',
                                'Division' => 'CM',
                                'SalesDocumentDate' => $tgl_pp,
                                'ShippingCondition' => $shipcond_sbi,
                                'ShippingType' => 'G4',
                                'SoldToCode' => $soldtosbi,
                                'ShipToCode' => $shipto,
                                'MDReferenceSONumber' => $SOMD,
                                'MDPurchaseOrderNumber' => $no_pp,
                                'MDPurchaseOrderItem' => '00010',
                                'PurchaseOrderNumber' => $no_pp,
                                'PurchaseOrderDate' => $tgl_ppPO,
                                'PaymentTerms' => $topsbi,
                                'Items' => $Dmaterial
                            )
                        );
                        $options = array(
                            'http' => array(
                                'header' => "Content-type: application/json\r\n",
                                'method' => 'POST',
                                'content' => json_encode($data),
                            )
                        );



                        $context = stream_context_create($options);
                        $result = file_get_contents($url, false, $context);
                        $response = json_decode($result);
                        if ($ul == 4) {
                            $responseSBI2 = $response;
                        }
                        $status = $response->Status;
                        $Message = $response->Message;

                        $Message_detail = $response->MessageDetail;
                        $param_send = json_encode($data);
                        $param_return = json_encode($response);

                        $field_names = array(
                            'SEND_PARAM', 'RETURN_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN', 'PESAN_DETAIL', 'TGL'
                        );
                        $field_data = array(
                            "$param_send", "$param_return", "$user_name_in", "$no_pp", "$Message", "$Message_detail", "SYSDATE"
                        );
                        $tablename = "ZMD_LOG_SBI";
                        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);
                        //print_r($status);
                        //print_r($Message);
                        if ($ul == 2) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO2 = $response->Data->SAPSalesOrderNumber;
                        } else if ($ul == 4) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO4 = $response->Data->SAPSalesOrderNumber;
                        }
                        if ($status != 1) {
                            $next = 'N';
                            $show_ket .= $ul . ". SO OPCO = " . $Message_detail;
                            $show_ket .= '<br>';
                        } else {
                            $show_ket .= $ul . ". SO OPCO = Sales Order has been made with a number : " . $nomorso;
                            $show_ket .= '<br>';
                        }
                        $Dataarray = json_decode(json_encode($response->Data->Items), true);
                        //print_r($nomorso);
//                        echo json_encode($data);

                        $SOMDNE = 'Y';
                        $jerror += 1;
                    } else if ($ul == $perulangan) { // PROSES PERULANGAN TERAKHIR CREATE PO
                        // GET HARGA PER LINE ITEM 
                        for ($p = 1; $p <= $perulanganPO; $p++) { // perulangan PO MULTI ICS atau TIDAK
                            if ($p == 1) {
                                $incoterm1 = $incotermPO1;
                                $incoterm2 = $incotermPO12;
                                $distr_chan = $distr_chanPO1;
                            } else {
                                $incoterm1 = $incotermPO2;
                                $incoterm2 = $incotermPO22;
                                $distr_chan = $distr_chanPO2;
                            }
                            //perubahan get KD VENDOR
                            $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}' AND DEL = 0";
                            $querykdven = oci_parse($conn, $strkdven);
                            oci_execute($querykdven);
                            $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

                            if ($p == 1) {
                                $SO_PO = $SO2;
                                $vendorFIX = $rowkdven["KET"];
                                $COM = $rowkdven["COM_MD"];
                                $COM_HARGA = $rowkdven["COM_OPCO"];
                                $plantPO = $plant1;
                            } else if ($p == 2) {
                                $SO_PO = ($SO3 != "" ? $SO3 : $SO4);
                                $vendorFIX = $rowkdven["KET_OPCO"];
                                $COM = $rowkdven["COM_OPCO"];
                                $COM_HARGA = $rowkdven["COM_MD_2"];
                                $plantPO = $plant2;
                            } else if ($p == 3) {
                                $SO_PO = $SO4;
                                $vendorFIX = $rowkdven["KET2"];
                                $COM = $rowkdven["COM_MD_2"];
                                $COM_HARGA = $rowkdven["COM_OPCO_2"];
                                $plantPO = $plant3;
                            }

                            if ($COM != "PTSC" && $COM != "ID50") {
                                if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {

//                            print_r($p."");
//                                print_r($SO_PO);
//                                print_r("<br>");
                                    $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
                                    $fce->I_BAPI_VIEW["SDCOND"] = "X";
                                    $fce->SALES_DOCUMENTS->row["VBELN"] = $SO_PO;
                                    $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

                                    $fce->Call();
                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $fce->ORDER_CONDITIONS_OUT->Reset();
                                        $totL = 0;
                                        $builder = array();
                                        $dataH = array();
                                        $dataH["item_number"] = array();
                                        $dataH["nilai_harga"] = array();
                                        $dataH["per"] = array();
                                        $dataH["satuan"] = array();
                                        while ($fce->ORDER_CONDITIONS_OUT->Next()) {
                                            if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
                                                $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
                                                $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
                                                $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
                                                $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
                                                $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
                                                $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];

                                                $builder[] = $dataH;
                                                $totL += 1;
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();

                                        if ($totL != $_POST['jumlah']) {
                                            $next = "N";
                                            $show_ket .= $COM . " SO " . $SO_PO . " Master Harga Belum Ada...!!!";
                                            $show_ket .= '<br>';
                                        }
                                    }
                                }

                                if ($next == "Y") {

//                                print_r($vendorFIX."<br>");
                                    // CREATE PO
                                    $fce2 = $sap->NewFunction("BAPI_PO_CREATE1");
                                    $tgl_sekarang = date("Ymd");

                                    $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$COM}' AND KD_VENDOR = '{$vendorFIX}' AND DEL =0";
                                    $queryven = oci_parse($conn, $strven);
                                    oci_execute($queryven);
                                    $rowven = oci_fetch_array($queryven, OCI_ASSOC);


                                    $fce2->POHEADER["COMP_CODE"] = $COM; // company kedua
                                    $fce2->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
                                    $fce2->POHEADER["VENDOR"] = $vendorFIX; //
                                    $fce2->POHEADER["PMNTTRMS"] = $top;

//                                    if ($COM == "3000") {
//                                        $pcORG = "SP01";
//                                        $pcGRP = "SP1";
//                                    } else if ($COM == "4000") {
//                                        $pcORG = "ST01";
//                                        $pcGRP = "ST1";
//                                    } else {
//                                        $pcORG = "MD01";
//                                        $pcGRP = "MD1";
//                                    } 
                                    $fce2->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
                                    $fce2->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"];
                                    //                        $fce2->POHEADER["CURRENCY"] = "IDR";F
                                    //                        $fce2->POHEADER["EXCH_RATE"] = "1";
                                    $fce2->POHEADER["DOC_DATE"] = $tgl_sekarang;
                                    $fce2->POHEADER["INCOTERMS1"] = $incoterm1;
                                    $fce2->POHEADER["INCOTERMS2"] = $incoterm2;


                                    $fce2->POHEADERX["COMP_CODE"] = "x";
                                    $fce2->POHEADERX["DOC_TYPE"] = "x";
                                    $fce2->POHEADERX["VENDOR"] = "x";
                                    $fce2->POHEADERX["PMNTTRMS"] = "x";
                                    $fce2->POHEADERX["PURCH_ORG"] = "x";
                                    $fce2->POHEADERX["PUR_GROUP"] = "x";
                                    //                        $fce2->POHEADERX["CURRENCY"] = "x";
                                    //                        $fce2->POHEADERX["EXCH_RATE"] = "x";
                                    $fce2->POHEADERX["DOC_DATE"] = "x";
                                    $fce2->POHEADERX["INCOTERMS1"] = "x";
                                    $fce2->POHEADERX["INCOTERMS2"] = "x";

                                    $fce2->POTEXTHEADER->row["TEXT_ID"] = "F01";
                                    $fce2->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce2->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
                                    $fce2->POTEXTHEADER->Append($fce2->POTEXTHEADER->row);

                                    $fce2->POTEXTHEADER->row["TEXT_ID"] = "F14";
                                    $fce2->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce2->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
                                    $fce2->POTEXTHEADER->Append($fce2->POTEXTHEADER->row);

                                    $sampai = $_POST['jumlah'];
                                    for ($j = 1; $j <= $sampai; $j++) {
                                        $idke = "shipto" . $j; // $idke = "idke" . $j; Upd Tham 
                                        //                                    $id_dtl = $_POST['com_iddtl' . $j];
                                        $item_numline = $item_num1 = $j; //$_POST['com_line' . $j];
                                        $item_num = $fungsi->linenum($item_num1);
                                        $item_numline = $item_num * 10; //'000010';
                                        $item_numlinePO = sprintf("%05d", $item_numline);

                                        $material = $_POST['produk' . $j];
                                        $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                        $querymaterial = oci_parse($conn, $strmaterial);
                                        oci_execute($querymaterial);
                                        $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                        if ($p == 1) {
                                            $material = $_POST['produk' . $j];
                                        } else if ($p == 2) {
                                            $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                        } else if ($p == 3) {
                                            $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                        }

                                        $qtyx = $qty = $_POST['com_qty' . $j];
                                        //                                    $qtyx = $_POST['com_qtyx' . $j];
//                                    if($sales_org=="7900"){ 
//                                         $kontrak = $_POST['com_kontrak' . $j];
//                                    }else{
//                                        $kontrak = "";
//                                    }
                                        $kontrak = $_POST['com_kontrak' . $j];

                                        $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                        $distrik = $_POST['kode_distrik' . $j];

                                        $tgl_kirimPO = $_POST['tgl_kirim' . $j];
                                        list($day, $month, $year) = split("-", $tgl_kirimPO);
                                        $tgl_kirim = $year . $month . $day;

                                        $mtr_group = substr($material, 0, 7);


                                        //                                    if (($nomorso != "") and ( $qty1 == $qtyx1))
                                        $status1 = "APPROVE";
                                        //                                    else
                                        //                                        $status1 = "PROCESS";

                                        if ($mtr_group == "121-301") {
                                            $nm_material = "SEMEN ZAK";
                                            $po_unit = "ZAK";
                                        } else if ($mtr_group == "121-302") {
                                            $nm_material = "SEMEN CURAH";
                                            $po_unit = "TO";
                                        } else if ($mtr_group == "121-200") {
                                            $nm_material = "CLINKER";
                                            $po_unit = "TO";
                                        }

//                                    $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$sales_org1}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
//                                    $queryloc = oci_parse($conn, $strsloc);
//                                    oci_execute($queryloc);
//                                    $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
                                        // CEK HARGA DARI BAPI COMMIT HARGA
                                        //                                    echo "<pre>";
                                        //                                    //print_r($builder);

                                        if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {

//                                        print_r("Harga SI");
                                            foreach ($builder as $val) {
                                                if ($item_numline == $val['item_number']) {
                                                    $hargaPO = $val['nilai_harga'];
                                                    $perPO = $val['per'];
                                                    $satuanPO = $val['satuan'];
                                                    $satuan2PO = $val['satuan2'];
                                                    $currencyPO = $val['currency'];
                                                }
                                            }
                                        } else {
                                            if ($p == 1) {
                                                $datas = $response->Data->Items[$j - 1];
                                            } else if ($p == 3) {
                                                $datas = $responseSBI2->Data->Items[$j - 1];
                                            }

                                            $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
                                            $perPO = $datas->SAPSalesOrderPerUnit;
                                            $satuanPO = $datas->SAPSalesOrderUnit;
                                            $satuan2PO = $datas->SAPSalesOrderUnit;
                                            $currencyPO = $datas->SAPSalesOrderCurrency;
                                        }



                                        $fce2->POITEM->row["PO_ITEM"] = $item_numlinePO;
                                        $fce2->POITEM->row["SHORT_TEXT"] = $nm_material;
                                        $fce2->POITEM->row["MATERIAL"] = $material;
                                        $fce2->POITEM->row["PLANT"] = $plantPO;
                                        $fce2->POITEM->row["QUANTITY"] = $qty; // Add Tham
                                        //                                    $fce2->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];
                                        $fce2->POITEM->row["STGE_LOC"] = "D101";
                                        $fce2->POITEM->row["MATL_GROUP "] = $mtr_group;
                                        $fce2->POITEM->row["GR_IND"] = "X";
                                        $fce2->POITEM->row["IR_IND"] = "X";
                                        $fce2->POITEM->row["GR_BASEDIV"] = "X";
//                                    $fce2->POITEM->row["FUNDS_CTR"] = "7902000000";
                                        //                                    echo "</br>".$hargaPO;
                                        //                                    echo "</br>".$hargaNet;
                                        //                                    $fce2->POITEM->row["NET_PRICE"] = $hargaNet; 
                                        $fce2->POITEM->Append($fce2->POITEM->row);

                                        //                                    pr        int_r($fce2->POITEM->row);

                                        $fce2->POITEMX->row["PO_ITEM"] = $item_numlinePO;
                                        $fce2->POITEMX->row["SHORT_TEXT"] = "X";
                                        $fce2->POITEMX->row["MATERIAL"] = "X";
                                        $fce2->POITEMX->row["PLANT"] = "X";
                                        $fce2->POITEMX->row["STGE_LOC"] = "X";
                                        $fce2->POITEMX->row["CONV_DEN1"] = "X";
                                        $fce2->POITEMX->row["QUANTITY"] = "X";
                                        $fce2->POITEMX->row["NET_PRICE"] = "X";
                                        $fce2->POITEMX->row["GR_IND"] = "X";
                                        $fce2->POITEMX->row["IR_IND"] = "X";
                                        $fce2->POITEMX->row["GR_BASEDIV"] = "X";
//                                    $fce2->POITEMX->row["FUNDS_CTR"] = "X";
                                        //                                $fce2->POITEMX->row["NET_WEIGHT"] = "X";
                                        //                                $fce2->POITEMX->row["WEIGHTUNIT"] = "X";
                                        //                                $fce2->POITEMX->row["WEIGHTUNIT_ISO"] = "X";
                                        //                                $fce2->POITEMX->row["FUNDS_CTR"] = "X"; 
                                        $fce2->POITEMX->Append($fce2->POITEMX->row);

                                        $fce2->POTEXTITEM->row["PO_ITEM"] = $item_numlinePO;
                                        $fce2->POTEXTITEM->row["TEXT_ID"] = "F01";
                                        $fce2->POTEXTITEM->row["TEXT_FORM"] = "/";
                                        $fce2->POTEXTITEM->row["TEXT_LINE"] = $nama_produk_in; //"SEMEN PPC";  Upd Tham
                                        $fce2->POTEXTITEM->Append($fce2->POTEXTITEM->row);

                                        $fce2->POSCHEDULE->row["PO_ITEM"] = $item_numlinePO;
                                        $fce2->POSCHEDULE->row["SCHED_LINE"] = "0001";
                                        $fce2->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
                                        $fce2->POSCHEDULE->row["QUANTITY "] = $qtyx;
                                        $fce2->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
                                        $fce2->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
                                        $fce2->POSCHEDULE->Append($fce2->POSCHEDULE->row);

                                        $fce2->POSCHEDULEX->row["PO_ITEM"] = $item_numlinePO;
                                        //                                    $fce2->POSCHEDULEX->row["SCHED_LINE"] = "X";
                                        $fce2->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
                                        $fce2->POSCHEDULEX->row["QUANTITY "] = "X";
                                        $fce2->POSCHEDULEX->row["STAT_DATE"] = "X";
                                        $fce2->POSCHEDULEX->row["PO_DATE"] = "X";
                                        $fce2->POSCHEDULEX->Append($fce2->POSCHEDULEX->row);


                                        $fce2->POCOND->row["ITM_NUMBER"] = $item_numlinePO;
                                        $fce2->POCOND->row["COND_ST_NO"] = '001';
                                        $fce2->POCOND->row["COND_TYPE"] = "PBXX";
                                        $fce2->POCOND->row["COND_VALUE"] = $hargaPO;
                                        $fce2->POCOND->row["COND_P_UNT"] = $perPO;
                                        $fce2->POCOND->row["COND_UNIT"] = $satuanPO;
                                        $fce2->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
                                        $fce2->POCOND->row["CURRENCY"] = $currencyPO;
                                        $fce2->POCOND->row["CURRENCY_ISO"] = $currencyPO;
                                        $fce2->POCOND->row["CHANGE_ID"] = "U";
                                        $fce2->POCOND->Append($fce2->POCOND->row);

                                        $fce2->POCONDX->row["ITM_NUMBER"] = $item_numlinePO;
                                        $fce2->POCONDX->row["COND_ST_NO"] = '001';
                                        $fce2->POCONDX->row["COND_TYPE"] = "x";
                                        $fce2->POCONDX->row["COND_VALUE"] = "x";
                                        $fce2->POCONDX->row["COND_P_UNT"] = "x";
                                        $fce2->POCONDX->row["COND_UNIT"] = "x";
                                        $fce2->POCONDX->row["COND_UNIT_SO"] = "x";
                                        $fce2->POCONDX->row["CURRENCY"] = "x";
                                        $fce2->POCONDX->row["CURRENCY_ISO"] = "x";
                                        $fce2->POCONDX->row["CHANGE_ID"] = "x";
                                        $fce2->POCONDX->Append($fce2->POCONDX->row);
                                    }

                                    //                            echo "<pre>";
                                    //                            //print_r($fce2->POHEADER);
                                    //                            //print_r($fce2->POHEADERX);
                                    //                            //print_r($fce2->POITEM->row);

                                    $fce2->Call();

                                    if ($fce2->GetStatus() == SAPRFC_OK) {
                                        $nopoT = $fce2->EXPPURCHASEORDER;
                                        $fce2->RETURN->Reset();
                                        while ($fce2->RETURN->Next()) {
                                            $tipe = $fce2->RETURN->row["TYPE"];
                                            $msg = $fce2->RETURN->row["MESSAGE"];
                                            $show_ket .= $msg;
                                            $show_ket .= '<br>';
                                            if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                                $next = "N";
                                            }
                                        }
                                        //Commit Transaction
                                        $fce2 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce2->Call();
                                    }
                                    $user_org = $_SESSION['user_org'];

                                    if ($p == 1) {
                                        $PO1 = $nopoT;
                                    } else if ($p == 2) {
                                        $PO2 = $nopoT;
                                    } else if ($p == 3) {
                                        $PO3 = $nopoT;
                                    }
                                    //SIMPAN PP KEDUA KETIGA KEEMPAT

                                    if ($next == "Y" && $p == 1) {
                                        $sampai = $_POST['jumlah'];
                                        for ($j = 1; $j <= $sampai; $j++) {
                                            $idke = "idke" . $j;
                                            $id_dtl = $_POST['com_iddtl' . $j];
                                            //                                        $item_num1 = $_POST['com_line' . $j];
                                            //                                        $item_num = $fungsi->linenum($item_num1);
                                            $item_numline = $j * 10; //'000010'; 
                                            $PO_LINE = sprintf("%05d", $item_numline); //'00010';
                                            if ($j == 1) {
                                                $numline_pertama = sprintf("%05d", $item_numline); //'00010';
                                            }
                                            $alamat1 = $_POST['alamat1' . $j];
                                            $material = $_POST['produk' . $j];


                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                            if ($p == 1) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                            } else if ($p == 2) {
                                                $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                            } else if ($p == 3) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                            }

                                            $qty = $_POST['com_qty' . $j];
                                            $qtyx = $_POST['com_qtyx' . $j];

//                                        if($sales_org=="7900"){ 
//                                            $kontrak = $_POST['com_kontrak' . $j];
//                                        }else{
//                                            $kontrak = "";
//                                        }
                                            $kontrak = $_POST['com_kontrak' . $j];

                                            $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                            $distrik = $_POST['com_distrik' . $j];
                                            $shiptotocek = $_POST['com_shipto' . $j];
                                            
                                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                            $queryshipto = oci_parse($conn, $strshipto);
                                            oci_execute($queryshipto);
                                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                                $queryshipto = oci_parse($conn, $strshipto);
                                                oci_execute($queryshipto);
                                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            }

                                            if ($p == 1) {
                                                $shipto = $rowshipto['SHIP_TO_OPCO'];
                                            } else if ($p == 2) {
                                                $shipto = $rowshipto['SHIP_TO_MD_2'];
                                            } else if ($p == 3) {
                                                $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                            }

                                            $shipto = $fungsi->sapcode($shipto);
                                            $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
                                            $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                            list($day, $month, $year) = split("-", $tgl_kirimPO);
                                            $tgl_kirim = $year . $month . $day;

                                            $mtr_group = substr($material, 0, 7);


                                            if (($nomorso != "") and ( $qty1 == $qtyx1))
                                                $status1 = "APPROVE";
                                            else
                                                $status1 = "PROCESS";


                                            if ($p == 1) {
                                                $SO_ICS = $SO1;
                                            } else if ($p == 2) {
                                                $SO_ICS = $SO2;
                                            } else if ($p == 3) {
                                                $SO_ICS = $SO3;
                                            }

                                            $field_names = array(
                                                'NO_PP',
                                                'NO_PO',
                                                'PO_LINE',
                                                'PLANT_PO',
                                                'NMPLANT_PO',
                                                'KOTA',
                                                'NAMA_KOTA',
                                                'KODE_PRODUK',
                                                'NM_PRODUK',
                                                'HARGA_PO',
                                                'ORG_PO',
                                                'VENDOR',
                                                'NM_VENDOR',
                                                'QTY_PO',
                                                'UOM',
                                                'TGL_PO',
                                                'STATUS',
                                                'NOTE',
                                                'CREATE_DATE',
                                                'CREATED_BY',
                                                'DELETE_MARK',
                                                'BULAN',
                                                'TAHUN',
                                                'QTY_APPROVE',
                                                'TGL_PP',
                                                'ORG_BY',
                                                'VBELN'
                                            );
                                            $kd_vendor = $vendorFIX;
                                            $nopoplus = $nopoT . $PO_LINE;
                                            $field_data = array(
                                                "$no_pp",
                                                "$nopoplus",
                                                "$PO_LINE",
                                                "$plant1",
                                                "$plant1", //belum                   
                                                "$distrik",
                                                "$distrik", //belum
                                                "$material",
                                                "$material", //belum
                                                "$hargaPO",
                                                "$sales_org1",
                                                "$kd_vendor",
                                                "$kd_vendor", //belum
                                                "$qty",
                                                "$po_unit",
                                                "instgl_$tgl_kirimPO",
                                                "$status1",
                                                "$ket",
                                                "SYSDATE",
                                                "$user_name_in",
                                                "0",
                                                "$month",
                                                "$year",
                                                "$qtyx",
                                                "SYSDATE",
                                                "$user_org",
                                                "$SO_ICS"
                                            );
                                            $tablename = "OR_TRANS_HDR_ICS";
                                            $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                            //Oracle Detail
                                            $field_names2 = array(
                                                'NO_PP',
                                                'KODE_PRODUK',
                                                'NAMA_PRODUK',
                                                'QTY_PP',
                                                'QTY_APPROVE',
                                                'TGL_KIRIM_PP',
                                                'TGL_KIRIM_APPROVE',
                                                'TGL_TERIMA',
                                                'SHIP_TO',
                                                'NAMA_SHIP_TO',
                                                'ALAMAT_SHIP_TO',
                                                'DELETE_MARK',
                                                'STATUS_LINE',
                                                'KODE_TUJUAN',
                                                'NAMA_TUJUAN',
                                                'ITEM_NUMBER',
                                                'NO_SO',
                                                'FLAG_KAPAL',
                                                'KETERANGAN',
                                                'NAMA_KAPAL',
                                                'NO_KONTRAK',
                                                'KD_PROV',
                                                'NM_PROV',
                                                'UOM',
                                                'PLANT',
                                                'NM_PLANT',
                                                'PRICE_DATE',
                                                'SOLD_TO',
                                                'INCOTERM',
                                                'CARA_BAYAR',
                                                'TERM_PAYMENT',
                                                'NAMA_SOLD_TO',
                                                'BPLANT',
                                                'CREATED_BY',
                                                'CREATE_DATE',
                                                'NAMA_INCOTERM',
                                                'SO_TYPE',
                                                'NAMA_SO_TYPE',
                                                'ROUTE',
                                                'NAMA_TOP',
                                                'ORG',
                                                'PRICELIST',
                                                'NAMA_PRICELIST',
                                                'NO_KONTRAK_LC',
                                                'KD_REASON',
                                                'NM_REASON',
                                                'ROUTE_TXT',
                                                'CHANNEL',
                                                'DIVISION',
                                                'TIPE_PEMBELIAN',
                                                'NO_POH'
                                            );

                                            $kodedistrik2 = substr($distrik, 0, 2);
                                            $kd_provinsi = "10" . $kodedistrik2;
                                            $itemnumplus = sprintf("%06d", $item_numline); //'000010';
                                            $field_data2 = array(
                                                "$no_pp",
                                                "$material",
                                                "$material",
                                                "$qty",
                                                "$qty",
                                                "instgl_$tgl_kirimPO",
                                                "instgl_$tgl_kirimPO",
                                                "instgl_$tgl_terimaPO",
                                                "$shipto",
                                                "$shipto",
                                                "$alamat1", // belum
                                                "0",
                                                "$status1",
                                                "$distrik",
                                                "$distrik",
                                                "$itemnumplus",
                                                "$SO_ICS",
                                                "0",
                                                "$ket",
                                                " ", //belum
                                                "$kontrak", //belum
                                                "$kd_provinsi", //belum
                                                "$kd_provinsi", //belum
                                                "$po_unit", //belum
                                                "$plant", // plant kedua
                                                "$plant",
                                                "instgl_$tgl_kirimPO",
                                                "$soldto", //kedua
                                                "$incoterm1",
                                                "$ketbayar", //belum
                                                "$top",
                                                "$soldto",
                                                "$plant", //
                                                "$user_name_in",
                                                "SYSDATE",
                                                "$incoterm2",
                                                "$so_type",
                                                "$so_type",
                                                "$route",
                                                "$nama_top",
                                                "$sales_org",
                                                "$pricelist",
                                                "$nama_pricelist",
                                                "$lcnum",
                                                "$reason",
                                                "$nama_reason",
                                                "$ship_cond-$route_desc", //belum
                                                "$distr_chan",
                                                "$division",
                                                "D", //belum
                                                "$nopoT"
                                            );
                                            $tablename2 = "OR_TRANS_DTL_ICS";
                                            $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
                                        }
                                    }
                                }
                            }// IF PO SIG
                            else {
                                return;
                                // header
                                $fce = array();
                                $pcORG = "MD01";
                                $pcGRP = "MD1";
                                $fce->POHEADER = array(
                                    "COMP_CODE" => $sales_org2,
                                    "DOC_TYPE" => "ZIC1",
                                    "VENDOR" => $vendorFIX,
                                    "PMNTTRMS" => $top,
                                    "PURCH_ORG" => $pcORG,
                                    "PUR_GROUP" => $pcGRP,
                                    "DOC_DATE" => $tgl_sekarang,
                                    "INCOTERMS1" => $incoterm1,
                                    "INCOTERMS2" => $incoterm2);

                                $fce->POHEADERX = array("COMP_CODE" => "X",
                                    "DOC_TYPE" => "X",
                                    "VENDOR" => "X",
                                    "PMNTTRMS" => "X",
                                    "PURCH_ORG" => "X",
                                    "PUR_GROUP" => "X",
                                    "DOC_DATE" => "X",
                                    "INCOTERMS1" => "X",
                                    "INCOTERMS2" => "X");

                                $fce->POTEXTHEADER = array("TEXT_ID" => "F01", "TEXT_FORM" => "/", "TEXT_LINE" => $rowven["KETERANGAN"]);

                                // detail

                                $sampai = $_POST['jumlah'];
                                for ($j = 1; $j <= $sampai; $j++) {
                                    $idke = "shipto" . $j; // $idke = "idke" . $j; Upd Tham 
                                    //                                    $id_dtl = $_POST['com_iddtl' . $j];
                                    $item_numline = $item_num1 = $j; //$_POST['com_line' . $j];
                                    $item_num = $fungsi->linenum($item_num1);
                                    $item_numline = $item_num * 10; //'000010';
                                    $item_numlinePO = sprintf("%05d", $item_numline);

                                    $material = $_POST['produk' . $j];
                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                    $querymaterial = oci_parse($conn, $strmaterial);
                                    oci_execute($querymaterial);
                                    $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                    if ($p == 1) {
                                        $material = $_POST['produk' . $j];
                                    } else if ($p == 2) {
                                        $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                    } else if ($p == 3) {
                                        $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                    }

                                    $qtyx = $qty = $_POST['com_qty' . $j];
                                    $kontrak = $_POST['com_kontrak' . $j];
                                    $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                    $distrik = $_POST['kode_distrik' . $j];
                                    $tgl_kirimPO = $_POST['tgl_kirim' . $j];
                                    list($day, $month, $year) = split("-", $tgl_kirimPO);
                                    $tgl_kirim = $year . $month . $day;

                                    $mtr_group = substr($material, 0, 7);
                                    $status1 = "APPROVE";

                                    if ($mtr_group == "121-301") {
                                        $nm_material = "SEMEN ZAK";
                                        $po_unit = "ZAK";
                                    } else if ($mtr_group == "121-302") {
                                        $nm_material = "SEMEN CURAH";
                                        $po_unit = "TO";
                                    } else if ($mtr_group == "121-200") {
                                        $nm_material = "CLINKER";
                                        $po_unit = "TO";
                                    }

                                    if ($p == 1) {
                                        $datas = $response->Data->Items[$j - 1];
                                    } else if ($p == 3) {
                                        $datas = $responseSBI2->Data->Items[$j - 1];
                                    }

                                    $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
                                    $perPO = $datas->SAPSalesOrderPerUnit;
                                    $satuanPO = $datas->SAPSalesOrderUnit;
                                    $satuan2PO = $datas->SAPSalesOrderUnit;
                                    $currencyPO = $datas->SAPSalesOrderCurrency;

                                    $fce->POITEM = array(
                                            "PO_ITEM" => $item_numlinePO,
                                            "SHORT_TEXT" => $nm_material,
                                            "MATERIAL" => $material,
                                            "PLANT" => $plantPO,
                                            "MATL_GROUP" => $mtr_group,
                                            "QUANTITY" => $qty,
                                            "STGE_LOC" => 'D101',
                                            "GR_IND" => 'X',
                                            "IR_IND" => 'X',
                                            "GR_BASEDIV" => 'X',
//                                                    "FUNDS_CTR"=>'7902000000'
                                       );

                                    $fce->POITEMX =array(
                                            "PO_ITEM" => $item_numlinePO,
                                            "SHORT_TEXT" => 'X',
                                            "MATERIAL" => 'X',
                                            "PLANT" => 'X',
                                            "MATL_GROUP" => 'X',
                                            "QUANTITY" => 'X',
                                            "STGE_LOC" => 'X',
                                            "GR_IND" => 'X',
                                            "IR_IND" => 'X',
                                            "GR_BASEDIV" => 'X',
                                            "FUNDS_CTR" => 'X'
                                        );

                                    $fce->POSCHEDULE = array("PO_ITEM" => $item_numlinePO,
                                    "SCHED_LINE" => "0001",
                                    "DELIVERY_DATE" => $tgl_kirim,
                                    "QUANTITY " => $qtyx,
                                    "STAT_DATE" => $tgl_kirim,
                                    "PO_DATE" => $tgl_kirim);

                                    $fce->POSCHEDULEX = array("PO_ITEM" => $item_numlinePO,
                                    "SCHED_LINE" => "X",
                                    "DELIVERY_DATE" => "X",
                                    "QUANTITY " => "X",
                                    "STAT_DATE" => "X",
                                    "PO_DATE" => "X");

                                    $fce->POCOND = array("ITM_NUMBER" => $item_numlinePO,
                                    "COND_ST_NO" => '001',
                                    "COND_TYPE" => "PBXX",
                                    "COND_VALUE" => $hargaPO,
                                    "COND_P_UNT" => $perPO,
                                    "COND_UNIT" => $satuanPO,
                                    "COND_UNIT_SO" => $satuan2PO,
                                    "CURRENCY" => $currencyPO,
                                    "CURRENCY_ISO" => $currencyPO,
                                    "CHANGE_ID" => "U");

                                    $fce->POCONDX = array("ITM_NUMBER" => $item_numlinePO,
                                    "COND_ST_NO" => '001',
                                    "COND_TYPE" => "X",
                                    "COND_VALUE" => "X",
                                    "COND_P_UNT" => "X",
                                    "COND_UNIT" => "X",
                                    "COND_UNIT_SO" => "X",
                                    "CURRENCY" => "X",
                                    "CURRENCY_ISO" => "X",
                                    "CHANGE_ID" => "X");

                                    $send_SBI = insertPOSBI($param);
                                }
                            }
                        }
                    }
                }
            }

            if ($next == 'Y') {
                //  INSERT TABEL MAPPING
                $fceM = $sap->NewFunction("ZCSD_MAP_SO_MD_FM");
                if ($fceM == false) {
                    $sap->PrintStatus();
                    exit;
                }

                for ($ref = 1; $ref <= $perulanganSO; $ref++) {
                    $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
                    if ($fce == false) {
                        $sap->PrintStatus();
                        exit;
                    }
                    if ($ref == 1) {
                        $fce->I_ZVBELN = $SO1;
                        $fce->I_VBELN = $SO2;
                        $SOM = 'SO Mega Distributor 1 : ' . $SO1;
                        $PO_REF = $PO1;
                        $SOMAP = $SO1;
                        $orgMAP = $sales_org1;
                        $plantMAP = $plant1;
                    } else if ($ref == 2) {
                        $fce->I_ZVBELN = $SO2;
                        $fce->I_VBELN = $SO1;
                        $SOM = 'SO OPCO 1 : ' . $SO2;
                        $PO_REF = $PO1;
                        $SOMAP = $SO2;
                        $orgMAP = $sales_org2;
                        $plantMAP = $plant2;
                    } else if ($ref == 3) {
                        $fce->I_ZVBELN = $SO3;
                        $fce->I_VBELN = $SO4;
                        $SOM = 'SO Mega Distributor 2 : ' . $SO3;
                        $PO_REF = ($SO3 != '' ? $PO2 : "");
                        $SOMAP = $SO3;
                        $orgMAP = $sales_org3;
                        $plantMAP = $plant3;
                    } else if ($ref == 4) {
                        if ($SO3 == "") {
                            $fce->I_ZVBELN = $SO3;
                            $fce->I_VBELN = $SO4;
                        } else {
                            $fce->I_ZVBELN = $SO4;
                            $fce->I_VBELN = $SO3;
                        }
                        $SOM = 'SO OPCO 2 : ' . $SO4;
                        $PO_REF = ($SO3 == '' ? $PO2 : $PO3);
                        $SOMAP = $SO4;
                        $orgMAP = $sales_org4;
                        $plantMAP = $plant4;
                    }
                    $fce->I_PO = $PO_REF;
                    $fce->I_LINE_ITEM = $numline_pertama;
                    $fce->Call();
                    if ($fce->GetStatus() == SAPRFC_OK) {
                        //while ( $fce->ZMESSAGE->Next() ){
                        $tipe = $fce->ZMESSAGE["TYPE"];
                        $msg = $fce->ZMESSAGE["MESSAGE"];
                        $show_ket .= $SOM . ' ' . $msg . '<br>';
                        //}
                    }


                    if ($SOMAP != "") {
                        $fceM->T_DATA->row["NO_PP"] = $no_pp;
                        $fceM->T_DATA->row["VKORG"] = $orgMAP;
                        $fceM->T_DATA->row["WERKS"] = $plantMAP;
                        $fceM->T_DATA->row["NO_SO"] = $SOMAP;
                        $fceM->T_DATA->row["SEQ_NO"] = $ref * 10;
                        $fceM->T_DATA->row["NO_PO"] = $PO_REF;
                        $fceM->T_DATA->Append($fceM->T_DATA->row);
                    }
                }


                $fceM->Call();
                if ($fceM->GetStatus() == SAPRFC_OK) {
                    //while ( $fce->ZMESSAGE->Next() ){
//                    $tipe = $fceM->ZMESSAGE["TYPE"];
//                    $msg = $fceM->ZMESSAGE["MESSAGE"];
//                    $show_ket .= $ref . ' ' . $msg . '<br>';
                    //}
                }
            }


            //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
            if ($next == "N") {
                $SOSBI = "N";
                if ($SOMDNE == "Y") {
                    $SOSBIK = "Y";
                } else {
                    $SOSBIK = "N";
                }
                for ($e = 1; $e <= $jerror; $e++) {
                    $return = "Y";

                    // CEK SO SBI ATAU TIDAK
                    $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'";
                    $querykdven = oci_parse($conn, $strkdven);
                    oci_execute($querykdven);
                    $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);
                    if ($e == 1) {
                        $noyo = $SO1;
                        $IDHU = $IDH1;
                        $SOSBICEK = "N";
                    } else if ($e == 2) {
                        $noyo = $SO2;
                        $IDHU = $IDH2;
                        if ($rowkdven["COM_OPCO"] == "PTSC" || $rowkdven["COM_OPCO"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    } else if ($e == 3) {
                        $noyo = $SO3;
                        $IDHU = $IDH3;
                        $SOSBICEK = "N";
                    } else if ($e == 4) {
                        $noyo = $SO4;
                        $IDHU = $IDH4;
                        if ($rowkdven["COM_OPCO_2"] == "PTSC" || $rowkdven["COM_OPCO_2"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    }

                    if ($SOSBICEK == 'Y') {
                        if ($e == 2 || $e == 4) {
                            if ($e == 2) {
                                $TGLend = $tgl_deleteSO2;
                            } else if ($e == 4) {
                                $TGLend = $tgl_deleteSO4;
                            }

                            $url = 'https://sip.solusibangunindonesia.com/APIMD/DeleteSalesOrder';
                            $data = array(
                                'Token' => 'aSsMx7GV0HFGzlufM4DH',
                                'SystemID' => 'PASSO',
                                'SAPSalesOrderNumber' => $noyo,
                                'SAPCreatedDate' => $TGLend,
                            );
                            $options = array(
                                'http' => array(
                                    'header' => "Content-type: application/json\r\n",
                                    'method' => 'POST',
                                    'content' => json_encode($data),
                                )
                            );

                            $context = stream_context_create($options);
                            $result = file_get_contents($url, false, $context);
                            $response = json_decode($result);
                            $status = $response->Status;
                            $Message = $response->Message;
                            if ($status != '1') {
                                $return = 'N';
                            }
                        }
                    } else {
                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }

                        //header entri    
                        $fce->SALESDOCUMENT = $noyo; //"ZOR";
                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";

                        $fce->Call();

                        if ($fce->GetStatus() == SAPRFC_OK) {
                            $fce->RETURN->Reset();
                            while ($fce->RETURN->Next()) {
                                $msg .= '<div align="center">';
                                $error = $fce->RETURN->row["TYPE"];
                                $msg .= $fce->RETURN->row["MESSAGE"];

                                if ($error == 'A' || $error == 'X' || $error == 'E') {
                                    $return = 'N';
                                }
                            }
                            $msg .= '<br></div>';
                            //Commit Transaction
                            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            $fce->Call();
                        } else {
                            $fce->PrintStatus();
                        }
                    }
//                    print_r($return."<br>");
                    if ($return == 'Y') {
                        $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_HDR_ICS SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE VBELN='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL_ICS SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
                    } else {
                        $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
                    }
                }
            }
            $fce->Close();
            $sap->Close();
        } else {
            $show_ket .= $komentarerror;
        }
        
        $field_names = array(
            'SEND_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN_DETAIL', 'TGL'
        );
        $field_data = array(
            "SI", "$user_name_in", "$no_pp", "$show_ket", "SYSDATE"
        );
        $tablename = "ZMD_LOG_SBI";
        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

        if (isset($_POST['lasthalaman'])) {
            $habis = trim($_POST['lasthalaman']);
        } else {
            $habis = "tambahadminmd.php";
        }
        break;

//============================================================================================================================
// buatso direct MD
    case "buatsodirectmd":
        // CEK MAPPING PLANT ADA ATAU TIDAK
        $plantcek = $_POST['plant'];
        $str = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plantcek}' AND  DEL=0 ";
        $query = oci_parse($conn, $str);
        oci_execute($query);
        $row = oci_fetch_array($query, OCI_ASSOC);

        $lanjut = $next = 'Y';
        $SO1 = $SO2 = $IDH1 = $IDH2 = '';
        $jerror = 0;
        if (count($row) > 0) {
            $soldtocek = $_POST['sold_to']; //$_POST['distr_id']; Upd Tham
            $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'  AND DEL = 0";
            $querysoldto = oci_parse($conn, $strsoldto);
            oci_execute($querysoldto);
            $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
            if (count($rowsoldto) < 1) {
                $lanjut = 'N';
                $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
            }
        } else {
            $lanjut = 'N';
            $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
        }
        // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
        if ($lanjut == 'Y') {
            // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
            for ($ul = 1; $ul <= 3; $ul++) {

                if ($next == 'Y') {
                    $user_name = $_SESSION['user_name'];
                    $idh = $_POST['idh'];
                    $iddtl = $_POST['iddtl'];
                    $so_type = $_POST['so_type'];
                    $nama_so_type = $_POST['nama_so_type'];
                    $sales_org = $_POST['org']; //$_POST['org'];
                    $channelnew = $_POST['channels'];
                    if ($so_type == 'ZEX') {
                        $distr_chan = "30";
                    } elseif ($so_type == 'ZPR') {
                        if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000')
                            $distr_chan = "10";
                        else if ($sales_org == '6000')
                            $distr_chan = "10";
                        else
                            $distr_chan = "50";
                    }
                    else {
                        $distr_chan = "10";
                    }
                    $division = "00";
                    $dlv_block = "";
                    $soldto = $_POST['sold_to'];
                    $soldto = $fungsi->sapcode($soldto);
                    $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
                    if ($distr_chancondi != '') {
                        $distr_chan = $distr_chancondi;
                    }
                    if ($channelnew != '') {
                        $distr_chan = $channelnew;
                    }
                    $nama_sold_to = $_POST['nama_sold_to'];
                    $tgl_pp = date("d-m-Y");
                    list($day, $month, $year) = split("-", $tgl_pp);
                    $tgl_pp = $year . $month . $day;
                    $top = $_POST['top'];
                    $nama_top = $_POST['nama_top'];
                    $reason = $_POST['reason'];
                    $nama_reason = $_POST['nama_reason'];
                    $oldso = $_POST['oldso'];
                    $price_datep = $_POST['price_date'];
                    list($dayp, $monthp, $yearp) = split("-", $price_datep);
                    $price_date = $yearp . $monthp . $dayp;

                    $plant = $_POST['plant'];
                    $nama_plant = trim($_POST['nama_plant']);
                    $incoterm1 = $_POST['jenis_kirim'];
                    $incoterm2 = $_POST['nama_kirim'];
                    $route = $_POST['route'];
                    $kd_kapal = $_POST['kd_kapal'];
                    $nm_kapal = $_POST['nm_kapal'];
                    $nama_kapal = $kd_kapal . '-' . $nm_kapal;
                    $pricelist = $_POST['pricelist'];
                    $nama_pricelist = $_POST['nama_pricelist'];
                    $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
                    $no_pp = $fungsi->or_new_pp_number($conn);
                    $valperlcnum = trim($_POST['perslcnum']);
                    $lcnum = $_POST['lcnum'];
                    $lcnum = $fungsi->sapcode($lcnum);
                    $sampai1 = $_POST['jumlah'];
                    $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
                    for ($j = 0; $j <= $sampai1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $kontrakh = $_POST['com_kontrak' . $j];
                        }
                    }

                    if ($ul == 1) {
                        $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $soldto = $_POST['sold_to']; // $_POST['distr_id'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
                        $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2 
                    } else if ($ul == 2 || $ul == 3) {
                        $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2
                        $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                    }

                    //call bapi sales order sap
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        $sap->PrintStatus();
                        exit;
                    }

                    $COM = ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) ? 'MD' : 'SBI';
                    //print_r($sales_org);
                    if ($ul <= 2 && $COM == 'MD') { // PROSES FOR 1 DAN 2 MENYIMPAN SO
                        $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }

                        //header entri
                        if ($so_type == 'ZFC') {
                            $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
                        } else {
                            $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                        }

                        $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
                        $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
                        $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
                        $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00"; 
                        $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
                        $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
                        $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
                        $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
                        $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
                        $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
                        $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
                        $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
                        $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
                        //$fce->ORDER_HEADER_IN["COLLECT_NO"] = $oldso;
                        $fce->ORDER_HEADER_IN["REF_1"] = $oldso;
                        $fce->ORDER_HEADER_IN["PRICE_DATE"] = $price_date;
                        if ($sales_org == "7900" || $sales_org == "7000") {
                                $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
                                $querytax = oci_parse($conn, $strtax);
                                oci_execute($querytax);
                                $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
                                if (ISSET($rowtax["KD_SOLD_TO"])) {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                } else {
                                    if ($so_type == 'ZFC') {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                    }else{
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1";    
                                    }
                                }

//                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
                            }

                        if ($lcnum != '') {
                            $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                            $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
                            //$fce->ORDER_HEADER_IN["DEPARTM_NO"] = 9;
                            $fce->ORDER_HEADER_IN["REC_POINT"] = 2;
                        }
                        if ($kontrakh != '') {
                            $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                            $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
                        }

                        //detail entri item'
                        $sampai = $_POST['jumlah'];

                        for ($j = 1; $j <= $sampai; $j++) {
                            $item_num = $j;
                            $shipto = "shipto" . $j;
                            $kode_distrik = "kode_distrik" . $j;
                            $produk = "produk" . $j;
                            $qty = "com_qty" . $j;
                            $tgl_kirim = "tgl_kirim" . $j;
                            $kontrak = "com_kontrak" . $j;
                            $posnr = "com_posnr" . $j;
                            $shp = "com_shipment" . $j;
                            $tgl_kirim = $_POST['tgl_kirim' . $j];
                            list($day, $month, $year) = split("-", $tgl_kirim);
                            $tgl_kirim = $year . $month . $day;
                            $produk = $_POST[$produk];
                            $kode_distrik = $_POST[$kode_distrik];
                            $qty = $_POST[$qty];
                            $kontrak = $_POST[$kontrak];
                            $posnr = $fungsi->linenum($_POST[$posnr]);
                            $shipment = $_POST[$shp];

                            if ($ul == 1) {
                                $shipto = $_POST[$shipto];     // GANTI BERDASARKAN MAPPING CUSTOMER                                
                                $produk1 = $_POST[$produk];
                            } else if ($ul == 2 || $ul == 3 || $ul == 4) {
                                $shiptotocek = $_POST[$shipto];
                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                $queryshipto = oci_parse($conn, $strshipto);
                                oci_execute($queryshipto);
                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                $shipto = $rowshipto['SHIP_TO_OPCO'];

                                $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                $querymaterial = oci_parse($conn, $strmaterial);
                                oci_execute($querymaterial);
                                $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                $produk = $rowmaterial['KD_MATERIAL_OPCO'];
                            }

                            //$show_ket .= "shipto $shipto / kode_distrik $kode_distrik / produk $produk / qty $qty / route $route / plant $plant<br>";

                            $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                            $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $produk;

                            $fce->ORDER_ITEMS_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                            $fce->ORDER_ITEMS_INX->row["UPDATEFLAG"] = 'I'; //'000010';
                            $fce->ORDER_ITEMS_INX->row["MATERIAL"] = 'X';
                            if ($so_type == 'ZFC') {
                                $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                                if ($sales_org == '6000') {
                                    $ITEM_CATEGvali = 'ZKNN';
                                } else if ($sales_org == '4000' || $sales_org == '3000' || $sales_org == '7000' || $sales_org == '5000' || $sales_org == '7900') {
                                    $ITEM_CATEGvali = 'ZKLN';
                                } else {
                                    $ITEM_CATEGvali = 'ZKNN';
                                }
                                $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;                   
                            }
                            $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                            $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

                            $fce->ORDER_ITEMS_INX->row["PLANT"] = 'X';
                            $fce->ORDER_ITEMS_INX->row["ROUTE"] = 'X';
                            //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $kode_distrik;
                            if ($kontrak != '') {
                                $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                                $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                                $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                                $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";

                                $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
                                $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
                                $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
                            }

                            $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);
                            $fce->ORDER_ITEMS_INX->Append($fce->ORDER_ITEMS_INX->row);

                            //detail entri schedule n qty'
                            $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                            $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                            $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                            $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);
                            //		if ($reason =='Z02') {
                            $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                            $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                            $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                            $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                            $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);
                            //		}
                            //detail entri distributor dan agen
                            //if ($j == 1) $item_num = '000000';
                            //else $item_num = $item_num;

                            $item_num = ($j === 1) ? '000000' : $item_num;
                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                            //}
                        }

                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                        $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
                        $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
                        $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                        $fce->Call();
                        if ($fce->GetStatus() == SAPRFC_OK) {
                            $nomorso = $fce->SALESDOCUMENT;
                            $fce->RETURN->Reset();
                            while ($fce->RETURN->Next()) {
                                $tipe = $fce->RETURN->row["TYPE"];
                                $msg = $fce->RETURN->row["MESSAGE"];
                                if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                    $show_ket .= $msg;
                                    $show_ket .= '<br>';
                                    $next = 'N';

                                   // echo $msg;
                                }
                            }
                            //Commit Transaction
                            $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            $fcecom->Call();
                            $fcecom->Close();

                            //Update SO
                            if ($nomorso != '' && $j > 1) {
                                sleep(5); //seconds to wait..   
                                $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                                $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                                $fce->Call();

                                //Commit Transaction
                                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fce->Call();
                            }

                            if ($sales_org == '6000') {
                                sleep(5); //seconds to wait..
                                //Teks
                                unset($tgl_kirimapp);
                                for ($j = 1; $j <= $sampai; $j++) {
                                    $item_num1 = $j * 10;
                                    $item_num = $fungsi->linenum($item_num1);
                                    $com_nopolisiv = trim($_POST['nopol' . $j]);
                                    $com_drivernamenopolv = trim($_POST['drivernamenopol' . $j]);
                                    $com_simdrivernamenopolv = trim($_POST['simdrivernamenopol' . $j]);
                                    $com_typetruckv = trim($_POST['tipenopol' . $j]);
                                    $com_catatanv = trim($_POST['val_addnote' . $j]);
                                    $com_kodekantong = trim($_POST['ktproduk' . $j]);
                                    $tgl_kirimappT = trim($_POST['tgl_kirim' . $j]);
                                    list($day, $month, $year) = split("-", $tgl_kirimappT);
                                    $tgl_kirimapp .= $year . $month . $day . "!";


                                    $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                    $fce->I_VBELN = $nomorso; //'000010';
                                    $fce->I_POSNR = sprintf("%06d", $item_num); //'000010';
                                    $fce->I_TEXT1 = $com_nopolisiv;
                                    $fce->I_TEXT2 = $com_typetruckv;
                                    $fce->I_TEXT3 = $com_catatanv;
                                    $fce->I_TEXT4 = $com_kodekantong;
                                    $fce->I_TEXT6 = $com_drivernamenopolv;
                                    $fce->I_TEXT7 = $com_simdrivernamenopolv;
                                    $fce->Call();
                                }

                                if ($sales_org == '6000' && $nomorso != '') {
                                    $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                                }
                            }
                        }
                        if ($next == 'Y') {
                            if ($ul == 1 || $ul == 3) {
                                $numbering = " SO MD = ";
                            } else {
                                $numbering = " SO OPCO = ";
                            }
                            $show_ket .= $ul . '' . $numbering . ' Sales Order has been made with a number : ' . $nomorso . '<br>';
                        }

                        //update no shipment ke so
                        if ($reason == 'Z02') {
                            $sap = new SAPConnection();
                            $sap->Connect("../include/sapclasses/logon_data.conf");
                            if ($sap->GetStatus() == SAPRFC_OK)
                                $sap->Open();
                            if ($sap->GetStatus() != SAPRFC_OK) {
                                $sap->PrintStatus();
                                exit;
                            }

                            $fce1 = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                            if ($fce1 == false) {
                                $sap->PrintStatus();
                                exit;
                            }
                            $fce1->SALESDOCUMENT = $nomorso; //"ZOR";
                            $fce1->ORDER_HEADER_INX["UPDATEFLAG"] = 'U'; //"Z1";

                            $sampai = $_POST['jumlah'];
                            for ($j = 1; $j <= $sampai; $j++) {
                                $idke = "idke" . $j;
                                $item_num1 = $j;
                                $id_dtl = $_POST['com_iddtl' . $j];
                                $item_num = $fungsi->linenum($item_num1 * 10);
                                $nospj = $_POST['com_shipment' . $j];

                                //update detail item
                                $fce1->ORDER_ITEM_INX->row["UPDATEFLAG"] = 'U';
                                $fce1->ORDER_ITEM_INX->row["ITM_NUMBER"] = $item_num;
                                $fce1->ORDER_ITEM_INX->row["REF_1_S"] = 'X';
                                $fce1->ORDER_ITEM_INX->Append($fce1->ORDER_ITEM_INX->row);

                                $fce1->ORDER_ITEM_IN->row["ITM_NUMBER"] = $item_num; //'000010';
                                $fce1->ORDER_ITEM_IN->row["REF_1_S"] = $nospj;
                                $fce1->ORDER_ITEM_IN->Append($fce1->ORDER_ITEM_IN->row);
                                //$show_ket.= $nospj.'-'.$nomorso;
                            }
                            $fce1->Call();

                            if ($fce1->GetStatus() == SAPRFC_OK) {
                                $fce1->RETURN->Reset();
                                while ($fce1->RETURN->Next()) {
                                    $error = $fce1->RETURN->row["TYPE"];
                                    $msg = $fce1->RETURN->row["MESSAGE"];
                                    $show_ket .= $msg;
                                    $show_ket .= '<br>';
                                }
                                //Commit Transaction
                                $fce1 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fce1->Call();
                                $fce1->Close();
                            }
                            $sap->Close();
                        }

                        // Setelah SO ter create
                        if ($ul == 1) {
                            $SO1 = $nomorso;
                            $IDH1 = $idh;
                        } else if ($ul == 2) {
                            $SO2 = $nomorso;
                            $IDH2 = $idh;
                        }

                        if ($next == "Y" && $ul == 1) { // 
                            if ($nomorso != "") {
                                $status = "APPROVE";
                                $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'NO_SO_OLD', 'PRICE_DATE', 'KD_REASON', 'NM_REASON', 'TIPEPP');
                                $field_data = array("$soldto", "$nama_sold_to", "$no_pp", "SYSDATE", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "$status", "SYSDATE", "$user_name", "SYSDATE", "$user_name", "0", "$route", "$sales_org", "$pricelist", "$nama_pricelist", "$lcnum", "$oldso", "instgl_$price_datep", "$reason", "$nama_reason", "$tipeCreatePP_isi");
                                $tablename = "OR_TRANS_HDR";
                                $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                $show_ket .= "Order Reservation Success Made with No. $no_pp <br>";

                                $sampai = $_POST['jumlah'];
                                for ($k = 1; $k <= $sampai; $k++) {
                                    $shipto = "shipto" . $k;
                                    $nama_shipto = "nama_shipto" . $k;
                                    $alamat = "alamat" . $k;
                                    $kode_distrik = "kode_distrik" . $k;
                                    $nama_distrik = "nama_distrik" . $k;
                                    $kode_prov = "kode_prov" . $k;
                                    $nama_prov = "nama_prov" . $k;
                                    $produk = "produk" . $k;
                                    $nama_produk = "nama_produk" . $k;
                                    $qty = "com_qty" . $k;
                                    $uom = "uom" . $k;
                                    $tgl_kirim = "tgl_kirim" . $k;
                                    $kontrak = "com_kontrak" . $k;
                                    $shipment = "com_shipment" . $k;
                                    $polisinumber = "nopol" . $k;
                                    $drivernamenopolfg = "drivernamenopol" . $k;
                                    $simdrivernamenopolfg = "simdrivernamenopol" . $k;
                                    $typetruk = "tipetruk" . $k;
                                    $catatnke = "val_addnote" . $k;
                                    $ktprodukke = "ktproduk" . $k;

                                    if (isset($_POST[$shipto])) {
                                        //$tgl_kirim_in = $_POST[$tgl_kirim];
                                        //if ($tgl_kirim_in == "")
                                        $tgl_kirim_in = ($_POST[$tgl_kirim] == "") ? date('d-m-Y') : $_POST[$tgl_kirim];
                                        $nama_shipto_in = $_POST[$nama_shipto];
                                        $alamat_in = $_POST[$alamat];

                                        if ($ul == 1) {
                                            $shipto_in = $_POST[$shipto];    // GANTI BERDASARKAN MAPPING CUSTOMER
                                            $produk_in = $_POST[$produk];
                                            $produk1 = $_POST[$produk];
                                        } else if ($ul == 2 || $ul == 3 || $ul == 4) {
                                            $shiptotocek = $_POST['shipto' . $k];
                                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                            $queryshipto = oci_parse($conn, $strshipto);
                                            oci_execute($queryshipto);
                                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                            $shipto_in = $rowshipto['SHIP_TO_OPCO'];

                                            $materialtocek = $_POST['produk' . $k];
                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                            $produk_in = $rowmaterial['KD_MATERIAL_OPCO'];
                                        }

                                        $kode_distrik_in = $_POST[$kode_distrik];
                                        $nama_distrik_in = $_POST[$nama_distrik];
                                        $kode_prov_in = $_POST[$kode_prov];
                                        $nama_prov_in = $_POST[$nama_prov];
                                        $nama_produk_in = $_POST[$nama_produk];
                                        $qty_in = $_POST[$qty];
                                        $uom = $_POST[$uom];
                                        $kontrak = $_POST[$kontrak];
                                        $shipment = $_POST[$shipment];
                                        $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                                        $drivernamenopolfg_in = trim($_POST[$drivernamenopolfg]);
                                        $simdrivernamenopolfg_in = trim($_POST[$simdrivernamenopolfg]);
                                        $typetruk_in = trim($_POST[$typetruk]);
                                        $catatnke_in = trim($_POST[$catatnke]);
                                        $ktprodukke_in = trim($_POST[$ktprodukke]);

                                        $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                                        $field_data = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep", "$nopolisi_in", "$typetruk_in", "$catatnke_in", "$ktprodukke_in", "$drivernamenopolfg_in", "$simdrivernamenopolfg_in");
                                        $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                                        $field_data1 = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep");

                                        $tablename = "OR_TRANS_DTL";
                                        $tablename1 = "OR_TRANS_APP";
                                        $fungsi->insert($conn, $field_names, $field_data, $tablename);
                                        $fungsi->insert($conn, $field_names1, $field_data1, $tablename1);
                                        $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                                    }
                                }
                            } else {
                                $status = "PROCESS";
                                $show_ket .= "Order Reservation Failed ! <br>";
                            }
                        }


                        $jerror += 1;
                    } else if ($ul == 2 && $COM == 'SBI') {
                        // build array material
                        $Tmaterial = array();
                        $Tmaterial['MaterialCode'] = array();
                        $Tmaterial['PlantCode'] = array();
                        $Tmaterial['Qty'] = array();
                        $Tmaterial['QtyUnit'] = array();
                        $Tmaterial['ScheduleLine'] = array();
                        $Tmaterial['RequestDeliveryDate'] = array();
                        $Tmaterial['RequestDeliveryQty'] = array();
                        $Dmaterial = array();
                        for ($j = 1; $j <= $sampai; $j++) {
                            $Tmaterial['MaterialCode'] = '000000140000003035';
                            $Tmaterial['PlantCode'] = "I300";
                            $Tmaterial['Qty'] = 1200;
                            $Tmaterial['QtyUnit'] = "TO";
                            $Tmaterial['ScheduleLine'] = "0001";
                            $Tmaterial['RequestDeliveryDate'] = "2020-09-16 00:00:00";
                            $Tmaterial['RequestDeliveryQty'] = 1200;
                            $Dmaterial[] = $Tmaterial;
                        }

                        if(empty($ship_condition)){
                        
                            if ($incoterm1 == "FOT") {
                                $shipcond_sbi = "PK";
                            } else if ($incoterm1 == "FRC") {
                                $shipcond_sbi = "D0";
                            } else if ($incoterm1 == "CNF") {
                                $shipcond_sbi = "DV";
                            } else {
                                $shipcond_sbi = "";
                            }
                        
                        }else{
                            $shipcond_sbi = $ship_condition;
                        }

                        $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
                        $data = array(
                            'Token' => 'aSsMx7GV0HFGzlufM4DH',
                            'SystemID' => 'PASSO',
                            'Data' => array(
                                'SalesDocumentType' => 'ZSCH',
                                'SalesOrganization' => 'SCBD',
                                'DistributionChannel' => 'DB',
                                'Division' => 'CM',
                                'SalesDocumentDate' => '20200910',
                                'ShippingCondition' => $shipcond_sbi,
                                'ShippingType' => 'G4',
                                'SoldToCode' => '8100001',
                                'ShipToCode' => '8720126',
                                'MDReferenceSONumber' => '11005975',
                                'MDPurchaseOrderNumber' => '0001011001',
                                'MDPurchaseOrderItem' => '00010',
                                'Items' => $Dmaterial
                            )
                        );
                        /* $options = array(
                          'http' => array(
                          'header' => "Content-type: application/json\r\n",
                          'method' => 'POST',
                          'content' => json_encode($data),
                          )
                          ); */

                        //$context = stream_context_create($options);
                        //$result = file_get_contents($url, false, $context);
                        //$response = json_decode($result);

                        $api = new API();
                        $response = $api->callAPI('POST', $url, $data);
//                        echo "<pre>";
                        //print_r($response);
                        exit;

                        $status = $response->Status;
                        $nomorso = $response->Data->SAPSalesOrderNumber;
                        $SO2 = $response->Data->SAPSalesOrderNumber;
                        if ($status != 1) {
                            $next = 'N';
                        }
                        //print_r($nomorso);
                        $jerror += 1;
                    } else { // PROSES KETIGA CREATE PO
                        // GET HARGA PER LINE ITEM
//                        echo $nomorso;
                        if ($COM == "MD") {
                            $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
                            $fce->I_BAPI_VIEW["SDCOND"] = "X";
                            $fce->SALES_DOCUMENTS->row["VBELN"] = $nomorso;
                            $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

                            $fce->Call();
                            if ($fce->GetStatus() == SAPRFC_OK) {
                                $fce->ORDER_CONDITIONS_OUT->Reset();
                                $totL = 0;
                                $builder = array();
                                $dataH = array();
                                $dataH["item_number"] = array();
                                $dataH["nilai_harga"] = array();
                                $dataH["per"] = array();
                                $dataH["satuan"] = array();
                                while ($fce->ORDER_CONDITIONS_OUT->Next()) {
                                    if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
                                        $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
                                        $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
                                        $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
                                        $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
                                        $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
                                        $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];

                                        $builder[] = $dataH;
                                        $totL += 1;
                                    }
                                }
                                //Commit Transaction
                                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fce->Call();

                                if ($totL != $_POST['jumlah']) {
                                    $next = "N";
                                    $show_ket .= "Master Harga Belum Ada...!!!";
                                    $show_ket .= '<br>';
                                }
                            }
                        }
                        if ($next == "Y") {

                            // CREATE PO
                            $fce2 = $sap->NewFunction("BAPI_PO_CREATE1");
                            $tgl_sekarang = date("Ymd");

                            $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$sales_org1}' AND DEL =0";
                            $queryven = oci_parse($conn, $strven);
                            oci_execute($queryven);
                            $rowven = oci_fetch_array($queryven, OCI_ASSOC);

                            //perubahan get KD VENDOR
                            $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'  AND DEL = 0";
                            $querykdven = oci_parse($conn, $strkdven);
                            oci_execute($querykdven);
                            $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

                            $fce2->POHEADER["COMP_CODE"] = $sales_org1; // company kedua
                            $fce2->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
                            $fce2->POHEADER["VENDOR"] = $rowkdven["KET"]; //
                            $fce2->POHEADER["PMNTTRMS"] = $top;
                            $fce2->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
                            $fce2->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"];
                            //$fce2->POHEADER["CURRENCY"] = "IDR";
                            //$fce2->POHEADER["EXCH_RATE"] = "1";
                            $fce2->POHEADER["DOC_DATE"] = $tgl_sekarang;
                            $fce2->POHEADER["INCOTERMS1"] = $incoterm1;
                            $fce2->POHEADER["INCOTERMS2"] = $incoterm2;


                            $fce2->POHEADERX["COMP_CODE"] = "x";
                            $fce2->POHEADERX["DOC_TYPE"] = "x";
                            $fce2->POHEADERX["VENDOR"] = "x";
                            $fce2->POHEADERX["PMNTTRMS"] = "x";
                            $fce2->POHEADERX["PURCH_ORG"] = "x";
                            $fce2->POHEADERX["PUR_GROUP"] = "x";
                            //$fce2->POHEADERX["CURRENCY"] = "x";
                            //$fce2->POHEADERX["EXCH_RATE"] = "x";
                            $fce2->POHEADERX["DOC_DATE"] = "x";
                            $fce2->POHEADERX["INCOTERMS1"] = "x";
                            $fce2->POHEADERX["INCOTERMS2"] = "x";

                            $fce2->POTEXTHEADER->row["TEXT_ID"] = "F01";
                            $fce2->POTEXTHEADER->row["TEXT_FORM"] = "/";
                            $fce2->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
                            $fce2->POTEXTHEADER->Append($fce2->POTEXTHEADER->row);

                            $fce2->POTEXTHEADER->row["TEXT_ID"] = "F14";
                            $fce2->POTEXTHEADER->row["TEXT_FORM"] = "/";
                            $fce2->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
                            $fce2->POTEXTHEADER->Append($fce2->POTEXTHEADER->row);

                            $sampai = $_POST['jumlah'];
                            for ($j = 1; $j <= $sampai; $j++) {
                                $idke = "shipto" . $j; // $idke = "idke" . $j; Upd Tham 
                                //$id_dtl = $_POST['com_iddtl' . $j];
                                $item_numline = $item_num1 = $j; //$_POST['com_line' . $j];
                                $item_num = $fungsi->linenum($item_num1);
                                $item_numline = $item_num * 10; //'000010';
                                $material = $_POST['produk' . $j];
                                //$material1 = $_POST['produk' . $j];
                                //$strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                //$querymaterial = oci_parse($conn, $strmaterial);
                                //oci_execute($querymaterial);
                                //$rowmaterial  = oci_fetch_array($querymaterial, OCI_ASSOC);
                                //$material = $rowmaterial['KD_MATERIAL_OPCO'];

                                $qtyx = $qty = $_POST['com_qty' . $j];
                                //$qtyx = $_POST['com_qtyx' . $j];
                                $kontrak = $_POST['com_kontrak' . $j];
                                $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                $distrik = $_POST['kode_distrik' . $j];

                                $tgl_kirimPO = $_POST['tgl_kirim' . $j];
                                list($day, $month, $year) = split("-", $tgl_kirimPO);
                                $tgl_kirim = $year . $month . $day;

                                $mtr_group = substr($material, 0, 7);

                                //if (($nomorso != "") and ( $qty1 == $qtyx1))
                                $status1 = "APPROVE";
                                //else $status1 = "PROCESS";

                                if ($mtr_group == "121-301") {
                                    $nm_material = "SEMEN ZAK";
                                    $po_unit = "ZAK";
                                } else if ($mtr_group == "121-302") {
                                    $nm_material = "SEMEN CURAH";
                                    $po_unit = "TO";
                                } else if ($mtr_group == "121-200") {
                                    $nm_material = "CLINKER";
                                    $po_unit = "TO";
                                }

//                                $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$sales_org1}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
//                                $queryloc = oci_parse($conn, $strsloc);
//                                oci_execute($queryloc);
//                                $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
                                // CEK HARGA DARI BAPI COMMIT HARGA
                                // echo "<pre>";
                                // //print_r($builder);
                                if ($COM == 'MD') {
                                    foreach ($builder as $val) {
                                        if ($item_numline == $val['item_number']) {
                                            $hargaPO = $val['nilai_harga'];
                                            $perPO = $val['per'];
                                            $satuanPO = $val['satuan'];
                                            $satuan2PO = $val['satuan2'];
                                            $currencyPO = $val['currency'];
                                        }
                                    }
                                } else {
                                    $hargaPO = "55000";
                                    $perPO = "1";
                                    $satuanPO = "TO";
                                    $satuan2PO = "TO";
                                    $currencyPO = "ZAK";
                                }

                                $fce2->POITEM->row["PO_ITEM"] = $item_numline;
                                $fce2->POITEM->row["SHORT_TEXT"] = $nm_material;
                                $fce2->POITEM->row["MATERIAL"] = $material;
                                $fce2->POITEM->row["PLANT"] = $plant1;
                                $fce2->POITEM->row["QUANTITY"] = $qty; // Add Tham
                                //$fce2->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];
                                $fce2->POITEM->row["STGE_LOC"] = "D101";
                                $fce2->POITEM->row["MATL_GROUP "] = $mtr_group;
                                $fce2->POITEM->row["GR_IND"] = "X";
                                $fce2->POITEM->row["IR_IND"] = "X";
                                $fce2->POITEM->row["GR_BASEDIV"] = "X";
//                                $fce2->POITEM->row["FUNDS_CTR"] = "7902000000";
                                //echo "</br>".$hargaPO;
                                //echo "</br>".$hargaNet;
                                //$fce2->POITEM->row["NET_PRICE"] = $hargaNet; 
                                $fce2->POITEM->Append($fce2->POITEM->row);
                                ////print_r($fce2->POITEM->row);
                                $fce2->POITEMX->row["PO_ITEM"] = $item_numline;
                                $fce2->POITEMX->row["SHORT_TEXT"] = "X";
                                $fce2->POITEMX->row["MATERIAL"] = "X";
                                $fce2->POITEMX->row["PLANT"] = "X";
                                $fce2->POITEMX->row["STGE_LOC"] = "X";
                                $fce2->POITEMX->row["CONV_DEN1"] = "X";
                                $fce2->POITEMX->row["QUANTITY"] = "X";
                                $fce2->POITEMX->row["NET_PRICE"] = "X";
                                $fce2->POITEMX->row["GR_IND"] = "X";
                                $fce2->POITEMX->row["IR_IND"] = "X";
                                $fce2->POITEMX->row["GR_BASEDIV"] = "X";
//                                $fce2->POITEMX->row["FUNDS_CTR"] = "X";
                                //$fce2->POITEMX->row["NET_WEIGHT"] = "X";
                                //$fce2->POITEMX->row["WEIGHTUNIT"] = "X";
                                //$fce2->POITEMX->row["WEIGHTUNIT_ISO"] = "X";
                                //$fce2->POITEMX->row["FUNDS_CTR"] = "X"; 
                                $fce2->POITEMX->Append($fce2->POITEMX->row);

                                $fce2->POTEXTITEM->row["PO_ITEM"] = $item_numline;
                                $fce2->POTEXTITEM->row["TEXT_ID"] = "F01";
                                $fce2->POTEXTITEM->row["TEXT_FORM"] = "/";
                                $fce2->POTEXTITEM->row["TEXT_LINE"] = $nama_produk_in; //"SEMEN PPC";  Upd Tham
                                $fce2->POTEXTITEM->Append($fce2->POTEXTITEM->row);

                                $fce2->POSCHEDULE->row["PO_ITEM"] = $item_numline;
                                $fce2->POSCHEDULE->row["SCHED_LINE"] = "0001";
                                $fce2->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
                                $fce2->POSCHEDULE->row["QUANTITY "] = $qtyx;
                                $fce2->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
                                $fce2->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
                                $fce2->POSCHEDULE->Append($fce2->POSCHEDULE->row);

                                $fce2->POSCHEDULEX->row["PO_ITEM"] = $item_numline;
                                //$fce2->POSCHEDULEX->row["SCHED_LINE"] = "X";
                                $fce2->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
                                $fce2->POSCHEDULEX->row["QUANTITY "] = "X";
                                $fce2->POSCHEDULEX->row["STAT_DATE"] = "X";
                                $fce2->POSCHEDULEX->row["PO_DATE"] = "X";
                                $fce2->POSCHEDULEX->Append($fce2->POSCHEDULEX->row);

                                $fce2->POCOND->row["ITM_NUMBER"] = $item_numline;
                                $fce2->POCOND->row["COND_ST_NO"] = '001';
                                $fce2->POCOND->row["COND_TYPE"] = "PBXX";
                                $fce2->POCOND->row["COND_VALUE"] = $hargaPO;
                                $fce2->POCOND->row["COND_P_UNT"] = $perPO;
                                $fce2->POCOND->row["COND_UNIT"] = $satuanPO;
                                $fce2->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
                                $fce2->POCOND->row["CURRENCY"] = $currencyPO;
                                $fce2->POCOND->row["CURRENCY_ISO"] = $currencyPO;
                                $fce2->POCOND->row["CHANGE_ID"] = "U";
                                $fce2->POCOND->Append($fce2->POCOND->row);

                                $fce2->POCONDX->row["ITM_NUMBER"] = $item_numline;
                                $fce2->POCONDX->row["COND_ST_NO"] = '001';
                                $fce2->POCONDX->row["COND_TYPE"] = "x";
                                $fce2->POCONDX->row["COND_VALUE"] = "x";
                                $fce2->POCONDX->row["COND_P_UNT"] = "x";
                                $fce2->POCONDX->row["COND_UNIT"] = "x";
                                $fce2->POCONDX->row["COND_UNIT_SO"] = "x";
                                $fce2->POCONDX->row["CURRENCY"] = "x";
                                $fce2->POCONDX->row["CURRENCY_ISO"] = "x";
                                $fce2->POCONDX->row["CHANGE_ID"] = "x";
                                $fce2->POCONDX->Append($fce2->POCONDX->row);
                            }

                            //echo "<pre>";
                            ////print_r($fce2->POHEADER);
                            ////print_r($fce2->POHEADERX);
                            ////print_r($fce2->POITEM->row);
                            $fce2->Call();
                            if ($fce2->GetStatus() == SAPRFC_OK) {
                                $nopoT = $fce2->EXPPURCHASEORDER;
                                $fce2->RETURN->Reset();
                                while ($fce2->RETURN->Next()) {
                                    $tipe = $fce2->RETURN->row["TYPE"];
                                    $msg = $fce2->RETURN->row["MESSAGE"];
                                    $show_ket .= $msg;
                                    $show_ket .= '<br>';
                                    if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                        $next = "N";
                                    }
                                }
                                //Commit Transaction
                                $fce2 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fce2->Call();
                            }
                            $user_org = $_SESSION['user_org'];
                            //SIMPAN PP KEDUA

                            if ($next == "Y" && $p == 1) {
                                $sampai = $_POST['jumlah'];
                                for ($j = 0; $j <= $sampai - 1; $j++) {
                                    $idke = "idke" . $j;
                                    $id_dtl = $_POST['com_iddtl' . $j];
                                    //$item_num1 = $_POST['com_line' . $j];
                                    //$item_num = $fungsi->linenum($item_num1);
                                    $item_numline = ($j + 1) * 10; //'000010'; 
                                    $PO_LINE = sprintf("%05d", $item_numline); //'00010';
                                    if ($j == 0) {
                                        $numline_pertama = sprintf("%05d", $item_numline); //'00010';
                                    }
                                    $alamat1 = $_POST['alamat1' . $j];
                                    //$material = $_POST['com_produk' . $j];
                                    //$material1 = $_POST['com_produk' . $j];

                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$produk1}' AND DEL = 0";
                                    $querymaterial = oci_parse($conn, $strmaterial);
                                    oci_execute($querymaterial);
                                    $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);
                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];

                                    $qty = $_POST['com_qty' . $j];
                                    $qtyx = $_POST['com_qtyx' . $j];
                                    $kontrak = $_POST['com_kontrak' . $j];
                                    $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                    $distrik = $_POST['com_distrik' . $j];
                                    $shiptotocek = $_POST['com_shipto' . $j];
                                    $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                    $queryshipto = oci_parse($conn, $strshipto);
                                    oci_execute($queryshipto);
                                    $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                    $shipto = $rowshipto['SHIP_TO_OPCO'];

                                    $shipto = $fungsi->sapcode($shipto);
                                    $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
                                    $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                    list($day, $month, $year) = split("-", $tgl_kirimPO);
                                    $tgl_kirim = $year . $month . $day;

                                    $mtr_group = substr($material, 0, 7);

                                    //if (($nomorso != "") && ( $qty1 == $qtyx1))
                                    //$status1 = "APPROVE";
                                    //else
                                    //$status1 = "PROCESS";

                                    $status1 = (($nomorso != "") && ( $qty1 == $qtyx1)) ? "APPROVE" : "PROCESS";

                                    $field_names = array(
                                        'NO_PP',
                                        'NO_PO',
                                        'PO_LINE',
                                        'PLANT_PO',
                                        'NMPLANT_PO',
                                        'KOTA',
                                        'NAMA_KOTA',
                                        'KODE_PRODUK',
                                        'NM_PRODUK',
                                        'HARGA_PO',
                                        'ORG_PO',
                                        'VENDOR',
                                        'NM_VENDOR',
                                        'QTY_PO',
                                        'UOM',
                                        'TGL_PO',
                                        'STATUS',
                                        'NOTE',
                                        'CREATE_DATE',
                                        'CREATED_BY',
                                        'DELETE_MARK',
                                        'BULAN',
                                        'TAHUN',
                                        'QTY_APPROVE',
                                        'TGL_PP',
                                        'ORG_BY',
                                        'VBELN'
                                    );
                                    $kd_vendor = $rowkdven["KET"];
                                    $nopoplus = $nopoT . $PO_LINE;
                                    $field_data = array(
                                        "$no_pp",
                                        "$nopoplus",
                                        "$PO_LINE",
                                        "$plant1",
                                        "$plant1", //belum                   
                                        "$distrik",
                                        "$distrik", //belum
                                        "$material",
                                        "$material", //belum
                                        "$hargaPO",
                                        "$sales_org1",
                                        "$kd_vendor",
                                        "$kd_vendor", //belum
                                        "$qty",
                                        "$po_unit",
                                        "instgl_$tgl_kirimPO",
                                        "$status1",
                                        "$ket",
                                        "SYSDATE",
                                        "$user_name_in",
                                        "0",
                                        "$month",
                                        "$year",
                                        "$qtyx",
                                        "SYSDATE",
                                        "$user_org",
                                        "$SO1"
                                    );
                                    $tablename = "OR_TRANS_HDR_ICS";
                                    $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                    //Oracle Detail
                                    $field_names2 = array(
                                        'NO_PP',
                                        'KODE_PRODUK',
                                        'NAMA_PRODUK',
                                        'QTY_PP',
                                        'QTY_APPROVE',
                                        'TGL_KIRIM_PP',
                                        'TGL_KIRIM_APPROVE',
                                        'TGL_TERIMA',
                                        'SHIP_TO',
                                        'NAMA_SHIP_TO',
                                        'ALAMAT_SHIP_TO',
                                        'DELETE_MARK',
                                        'STATUS_LINE',
                                        'KODE_TUJUAN',
                                        'NAMA_TUJUAN',
                                        'ITEM_NUMBER',
                                        'NO_SO',
                                        'FLAG_KAPAL',
                                        'KETERANGAN',
                                        'NAMA_KAPAL',
                                        'NO_KONTRAK',
                                        'KD_PROV',
                                        'NM_PROV',
                                        'UOM',
                                        'PLANT',
                                        'NM_PLANT',
                                        'PRICE_DATE',
                                        'SOLD_TO',
                                        'INCOTERM',
                                        'CARA_BAYAR',
                                        'TERM_PAYMENT',
                                        'NAMA_SOLD_TO',
                                        'BPLANT',
                                        'CREATED_BY',
                                        'CREATE_DATE',
                                        'NAMA_INCOTERM',
                                        'SO_TYPE',
                                        'NAMA_SO_TYPE',
                                        'ROUTE',
                                        'NAMA_TOP',
                                        'ORG',
                                        'PRICELIST',
                                        'NAMA_PRICELIST',
                                        'NO_KONTRAK_LC',
                                        'KD_REASON',
                                        'NM_REASON',
                                        'ROUTE_TXT',
                                        'CHANNEL',
                                        'DIVISION',
                                        'TIPE_PEMBELIAN',
                                        'NO_POH'
                                    );
                                    $kodedistrik2 = substr($distrik, 0, 2);
                                    $kd_provinsi = "10" . $kodedistrik2;
                                    $itemnumplus = sprintf("%06d", $item_numline); //'000010';
                                    $field_data2 = array(
                                        "$no_pp",
                                        "$material",
                                        "$material",
                                        "$qty",
                                        "$qtyx",
                                        "instgl_$tgl_kirimPO",
                                        "instgl_$tgl_kirimPO",
                                        "instgl_$tgl_terimaPO",
                                        "$shipto",
                                        "$shipto",
                                        "$alamat1", // belum
                                        "0",
                                        "$status1",
                                        "$distrik",
                                        "$distrik",
                                        "$itemnumplus",
                                        "$SO1",
                                        "0",
                                        "$ket",
                                        " ", //belum
                                        "$kontrak", //belum
                                        "$kd_provinsi", //belum
                                        "$kd_provinsi", //belum
                                        "$po_unit", //belum
                                        "$plant", // plant kedua
                                        "$plant",
                                        "instgl_$tgl_kirimPO",
                                        "$soldto", //kedua
                                        "$incoterm1",
                                        "$ketbayar", //belum
                                        "$top",
                                        "$soldto",
                                        "$plant", //
                                        "$user_name_in",
                                        "SYSDATE",
                                        "$incoterm2",
                                        "$so_type",
                                        "$so_type",
                                        "$route",
                                        "$nama_top",
                                        "$sales_org",
                                        "$pricelist",
                                        "$nama_pricelist",
                                        "$lcnum",
                                        "$reason",
                                        "$nama_reason",
                                        "$ship_cond-$route_desc", //belum
                                        "$distr_chan",
                                        "$division",
                                        "D", //belum
                                        "$nopoT"
                                    );
                                    $tablename2 = "OR_TRANS_DTL_ICS";
                                    $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
                                }
                            }
                        }
                    }
                }
            }

            //PROSES REFERENSI 2 SO, UNTUK MENGHUBUNGKAN 2 SO
            if ($next == 'Y') {
                for ($ref = 1; $ref <= 2; $ref++) {
                    $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
                    if ($fce == false) {
                        $sap->PrintStatus();
                        exit;
                    }
                    if ($ref == 1) {
                        $fce->I_ZVBELN = $SO1;
                        $fce->I_VBELN = $SO2;
                        $SOM = 'SO Mega Distributor : ' . $SO1;
                    } else if ($ref == 2) {
                        $fce->I_ZVBELN = $SO2;
                        $fce->I_VBELN = $SO1;
                        $SOM = 'SO OPCO : ' . $SO2;
                    }
                    $fce->I_PO = $nopoT;
                    $fce->I_LINE_ITEM = $numline_pertama;
                    $fce->Call();
                    if ($fce->GetStatus() == SAPRFC_OK) {
                        //while ( $fce->ZMESSAGE->Next() ){
                        $tipe = $fce->ZMESSAGE["TYPE"];
                        $msg = $fce->ZMESSAGE["MESSAGE"];
                        $show_ket .= $SOM . ' ' . $tipe . ' : ' . $msg . '<br>';
                        //}
                    }
                }
            }

            //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
            if ($next == "N") {
                for ($e = 1; $e <= $jerror; $e++) {
                    if ($e == 1 || $e == 2) {
                        if ($e == 1) {
                            $noyo = $SO1;
                            $IDHU = $IDH1;
                        } else if ($e == 2) {
                            $noyo = $SO2;
                            $IDHU = $IDH2;
                        }

                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }

                        //header entri    
                        $fce->SALESDOCUMENT = $noyo; //"ZOR";
                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";
                        $fce->Call();

                        if ($fce->GetStatus() == SAPRFC_OK) {
                            $fce->RETURN->Reset();
                            while ($fce->RETURN->Next()) {
                                $msg .= '<div align="center">';
                                $error = $fce->RETURN->row["TYPE"];
                                $msg .= $fce->RETURN->row["MESSAGE"];
                            }
                            $msg .= '<br></div>';
                            //Commit Transaction
                            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            $fce->Call();

                            if ($error == 'S') {
                                $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
                                $query = oci_parse($conn, $str);
                                oci_execute($query);
                                $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
                                $query = oci_parse($conn, $str);
                                oci_execute($query);
                                $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                                $query = oci_parse($conn, $str);
                                oci_execute($query);
                                $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
                            } else {
                                $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
                            }
                        } else {
                            $fce->PrintStatus();
                        }
                    }
                }
            }
            $fce->Close();
            $sap->Close();
        } else {
            $show_ket .= $komentarerror;
        }

        if (isset($_POST['lasthalaman'])) {
            $habis = trim($_POST['lasthalaman']);
        } else {
            $habis = "create_direct_so.php";
        }
        break;

//============================================================================================================================
//buatso proyek
    case "buatsopryk":

        //data header so
        $pesan_telegram = "";
        $user_name = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $no_ppvalpryk = trim($_POST['no_pp']);
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        if ($so_type == 'ZEX') {
            $distr_chan = "30";
        } elseif ($so_type == 'ZPR') {
            if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000')
                $distr_chan = "10";
            else
                $distr_chan = "50";
        } else {
            $distr_chan = "10";
        }
        $division = "00";
        $dlv_block = "";
        $soldto = $_POST['sold_to'];
        $soldto = $fungsi->sapcode($soldto);
        $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
        if ($distr_chancondi != '') {
            $distr_chan = $distr_chancondi;
        }
        $nama_sold_to = $_POST['nama_sold_to'];
        $tgl_pp = date("d-m-Y");
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        //$tanggal=gmdate("Ymd",time()+60*60*7);
        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $plant = $_POST['plant'];
        $nama_plant = $_POST['nama_plant'];
        $incoterm1 = $_POST['incoterm'];
        $incoterm2 = $_POST['nama_incoterm'];
        $route = $_POST['route'];
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $no_pp = $fungsi->or_new_pp_number($conn);
        $ket = $_POST['nm_kapal'];
        $kontrakh = $_POST['com_kontrak0'];
        $pesan_telegram .= "PP Proyek $no_ppvalpryk\n";
        //call bapi sales order sap
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }
            // SOCC v2
            $looping_end=1;
            $movetestrun='Z';
            for ($looping = 0; $looping <= $looping_end; $looping++) {
            if($movetestrun!='X'){
            ////////////        
        $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
        if ($fce == false) {
            $sap->PrintStatus();
            exit;
        }


        //detail entri item'
        $sampai = $_POST['jumlah'];
        for ($j = 0; $j <= $sampai - 1; $j++) {
            $idke = "idke" . $j;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $id_dtl = $_POST['com_iddtl' . $j];
                $item_num1 = $_POST['com_line' . $j];
                $item_num = $fungsi->linenum($item_num1);
                $material = $_POST['com_produk' . $j];
                $shipto = $_POST['com_shipto' . $j];
                $shipto = $fungsi->sapcode($shipto);
                $distrik = $_POST['com_distrik' . $j];
                $qty = $_POST['com_qty' . $j];
                $qtyx = $_POST['com_qtyx' . $j];
                $tgl_kirim = $_POST['com_tgl_kirim' . $j];
                list($day, $month, $year) = split("-", $tgl_kirim);
                $tgl_kirim = $year . $month . $day;
                $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                $kontrak = $_POST['com_kontrak' . $j];
                $nomor = $fungsi->sapcode($kontrak);
                                        //////////////////////////////////////////// proyek SOCC v.2
                                        $tgl_terima_leadtime = $_POST['com_tgl_terima' . $j];
                                        list($day, $month, $year) = split("-", $tgl_terima_leadtime);
                                        $tgl_terima_leadtime = $year . $month . $day;

                                        $tgl_fdate_socc=$tgl_kirim;
                                        ///////////////////////////////////////////

                if ($qtyx != $qty) {
                    $ada = $ada + 1;
                }

                //$show_ket .= "item_cat $item_cat / nomor $kontrakh / produk $produk<br>";

                $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                //$fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $item_cat;
                $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
                $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                if ($kontrak != '') {
                    $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                    $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                    $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                }
                $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                //detail entri schedule n qty'
                $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                //////////////////////////////////////////////////////////// proyek SOCC V.2
                // $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_fdate_socc;
                ///////////////////////////////////////////////////////////
                $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                //detail entri distributor dan agen
                if ($j == 1)
                    $item_num = '000000';
                else
                    $item_num = $item_num;
                if ($sales_org == '3000') {
                    if ($sampai == 1) {
                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                    } else {
                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    }
                } else {
                    $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                }
                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
            }
        }

        //header entri
        if ($sales_org == '3000') {
            $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
            if ($fce1 == false) {
                $sap->PrintStatus();
                exit;
            }

            //header entri

            $fce1->ZNMORG = 3000;
            $fce1->ZKUNNR = $shipto;
                        // SOCC V.2
                        if($looping=='0' or $looping==0){
                            $fce->TESTRUN = "X";
                        }
                        //
            $fce1->Call();
            if ($fce1->GetStatus() == SAPRFC_OK) {
                $fce1->RETURN_DATA->Reset();
                while ($fce1->RETURN_DATA->Next()) {
                    $kode = $fce1->RETURN_DATA->row["VKGRP"];
                }
            }
            $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
        }
        $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
        $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
        $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
        $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
        $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_ppvalpryk; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
        $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
        $fce->ORDER_HEADER_IN["NAME"] = $ket;
        $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
        $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
            // SOCC V2
            $fce->ORDER_HEADER_IN["TP_DATE"] = 'D';
            $fce->ORDER_HEADER_IN["REQ_DATE_H"] = $tgl_terima_leadtime;  
            /////        
        if ($lcnum != '') {
            $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
            $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
        }
        if ($kontrakh != '') {
            $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
            $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
        }


        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
        $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
        $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
        $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

        $fce->Call();
        if ($fce->GetStatus() == SAPRFC_OK) {
            $nomorso = $fce->SALESDOCUMENT;
            $fce->RETURN->Reset();
            while ($fce->RETURN->Next()) {
                $tipe = $fce->RETURN->row["TYPE"];
                $msg = $fce->RETURN->row["MESSAGE"];
                if ($tipe != 'S') {
                    // $show_ket .= $msg;
                    // $show_ket .= '<br>';
                    $show_ket .= $msg;
                    $show_ket .= '<br>';

                    //SOCC v2
                    $show_ket .= 'SO long text';
                    $show_ket .= '<br>';
                    $movetestrun='X';
                    $nomorso = '';
                    //
                }
                //tambah pengujian rfc test run SOCC
            }
    
        //SOCC v2
        
            //Commit Transaction
            $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
            $fcecom->Call();
            $fcecom->Close();
        }
        //SOCC v2
        }
        // $looping +=1;
}

        //Update SO
        if ($nomorso != '' && $j > 0) {
            sleep(5); //seconds to wait..   
            $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
            $fce->SALESDOCUMENT = $nomorso; //"ZOR";
            $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
            $fce->Call();

            //Commit Transaction
            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
            $fce->Call();
        }
        $fce->Close();
        $sap->Close();

        $show_ket .= "Sales Order telah dibuat dengan nomor : $nomorso <br>";
        $pesan_telegram .= "Approve dengan no SO $nomorso\n";

        if ($sales_org == 4000) {
            botTelegram('-394888712', $pesan_telegram);
        }


        if (($nomorso != "") and ( $ada == 0))
            $status = "APPROVE";
        else
            $status = "PROCESS";
        //update data header
        $field_names = array('STATUS', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON');
        $field_data = array("$status", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$nomor", "$reason", "$nama_reason");
        $tablename = "OR_TRANS_HDR";
        $field_id = array('ID');
        $value_id = array("$idh");
        $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
        // update data detail
        $sampai1 = $_POST['jumlah'];
        for ($k = 0; $k <= $sampai1; $k++) {
            $idke = "idke" . $k;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $id_dtl1 = $_POST['com_iddtl' . $k];
                $qty1 = $_POST['com_qty' . $k];
                $qtyx1 = $_POST['com_qtyx' . $k];
                $kode_distrik = $_POST['com_distrik' . $k];
                $kontrak = $_POST['com_kontrak' . $k];
                $nomor = $fungsi->sapcode($kontrak);
                                    /////////////////////////////////////////// proyek SOCC V.2
                                    $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                                    $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                                    //old
                                    //-----------------------------------------------------------------------//
                                    //new
                                    $tgl_terima1 = $_POST['com_tgl_terima' . $k];
                                    // $plant_socc = $_POST['plant'];
                                    // $kode_distrik_socc = $_POST['com_distrik' . $k];
                                    // $material_for_socc = substr($_POST['com_produk' . $k],0,7);
                                    // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                                    // if((date('H:i')>='15:00')){
                                    //     $tgl_terima_leadtime = date('d-m-Y', strtotime($tgl_terima_leadtime. ' - 1 days'));
                                    // }
                                    // $tglterimaleadtime = date('d-m-Y', strtotime($tgl_terima_leadtime));
                                    ///////////////////////////////////////////

                if (($nomorso != "") and ( $qty1 == $qtyx1)){
                    $status1 = "APPROVE";
                    $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT');
                    $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name", "$nomor", "$plant", "$nama_plant");
                }
                else{
                    $status1 = "PROCESS";
                    $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT');
                    $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name", "$nomor", "$plant", "$nama_plant");
                }


                $tablename = "OR_TRANS_DTL";
                $field_id = array('ID');
                $value_id = array("$id_dtl1");
                $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                if ($nomorso != "") {
                    $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
                    $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
                    $tablenamefrom = "OR_TRANS_DTL";
                    $tablenameto = "OR_TRANS_APP";
                    $field_id1 = array('ID');
                    $value_id1 = array("$id_dtl1");
                    $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);
                }
            }
        }


        //Khusus Proyek SI                
        if ($so_type == 'ZPR' && $nomorso != "" && ($sales_org == '7000' || $sales_org = '2000' || $sales_org = '5000')) {
            sleep(3);
            list($dayFG, $monthFG, $yearFG) = split("-", $tgl_kirim1);
            $tgl_kirimFormat = $yearFG . $monthFG . $dayFG;
            $sqlproyek = "
                        select ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1,SUM(QTY_PPK) as QTY_PP from(
                        SELECT OR_TRANS_HDR_V.*, to_char(TGL_PP,'DD-MM-YYYY') as TGL_PP1,
                        to_char(TGL_KIRIM_PP,'YYYYMMDD') as TGL_KIRIM_PP1,
                        to_char(TGL_KIRIM_APPROVE,'DD-MM-YYYY') as TGL_KIRIM_APPROVE1,
                        to_char(TGL_TERIMA,'DD-MM-YYYY') as TGL_TERIMA1,
                        case when KODE_PRODUK in ('121-301-0110','121-301-0050') then (QTY_PP*40)/1000
                        when KODE_PRODUK in ( '121-301-0020','121-301-0060','121-301-0056') then (QTY_PP*50)/1000
                        else QTY_PP
                        end as QTY_PPK,
                        substr(KODE_PRODUK,0,7) as TIPE_PRODUK
                        FROM OR_TRANS_HDR_V
                        WHERE DELETE_MARK = '0'
                        AND SO_TYPE='$so_type'
                        AND KD_REASON is null
                        AND PLANT_ASAL is not null
                        AND TIPEPP='NEW PROYEK' 
                        AND ORG='$sales_org'
                        AND SOLD_TO='$soldto'
                        AND PLANT_ASAL='$plant'
                        AND NO_PP='$no_ppvalpryk'
                        AND STATUS_LINE='APPROVE'
                        ORDER BY NO_PP ASC
                        )tb1
                        group by ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1
                    ";
            $query_proyek = oci_parse($conn, $sqlproyek);
            oci_execute($query_proyek);
            while ($row_proyek = oci_fetch_array($query_proyek)) {
                $ORGto = $row_proyek['ORG'];
                $SOLD_TOto = $row_proyek['SOLD_TO'];
                $PLANT_ASALto = $row_proyek['PLANT_ASAL'];
                $TIPE_PRODUKto = $row_proyek['TIPE_PRODUK'];
                $KODE_TUJUANto = $row_proyek['KODE_TUJUAN'];
                $TGL_KIRIM_PP1to = $row_proyek['TGL_KIRIM_PP1'];
                $QTY_PPto = $row_proyek['QTY_PP'];
                $sqlcek = "
                        select * from (
                        select tb1.*,
                        case when PLANT is null then (select PLANT from ZSD_MAPPING_PLANTKOTA where DELETE_MARK=0 and DISTRIK=tb1.DISTRIK and ORG=tb1.ORG and rownum=1)
                        else PLANT
                        end as PLANTSET
                        from ZSD_TARGET_HARIAN tb1 where ORG = '$ORGto' and DISTRIK = '$KODE_TUJUANto' 
                        and DISTRIBUTOR = '$SOLD_TOto' and
                        TIPE = '$TIPE_PRODUKto' and
                        to_char(TANGGAL_TARGET, 'YYYYMMDD') ='$TGL_KIRIM_PP1to'
                        )
                        where PLANTSET='$PLANT_ASALto'
                        ";
                $query_cek = oci_parse($conn, $sqlcek);
                oci_execute($query_cek);
                $row_cek = oci_fetch_array($query_cek);
                if ($row_cek['ID'] == '') {
                    //insert                            
                    $sql2 = "insert into ZSD_TARGET_HARIAN(ORG, TIPE, DISTRIK, DISTRIBUTOR, TANGGAL_TARGET,
                                     PLANT, TARGET, AKTIF_MARK, CREATE_BY, CREATE_DATE) 
                                     values ('" . $ORGto . "','" . $TIPE_PRODUKto . "', '" . $KODE_TUJUANto . "', '" . $SOLD_TOto . "', to_date('" . $TGL_KIRIM_PP1to . "', 'YYYYMMDD') ,
                                    '" . $PLANT_ASALto . "', '" . $QTY_PPto . "','0', '$user_name_in', sysdate)";
                    $query2 = oci_parse($conn, $sql2);
                    $ins = oci_execute($query2);
                } else {
                    //update
                    $sql1 = "update ZSD_TARGET_HARIAN set target = target+'" . $QTY_PPto . "', AKTIF_MARK='0', lastupdate_by = '$user_name_in', 
                                     lastupdate_date = sysdate
                                     where ID = '" . $row_cek['ID'] . "'";
                    $query1 = oci_parse($conn, $sql1);
                    $upd = oci_execute($query1);
                }
            }

            //update SAP	
            $sap = new SAPConnection();
            $sap->Connect("../include/sapclasses/logon_data.conf");
            if ($sap->GetStatus() == SAPRFC_OK)
                $sap->Open();
            if ($sap->GetStatus() != SAPRFC_OK) {
                $sap->PrintStatus();
                exit;
            }

            $fce = $sap->NewFunction("ZAPPSD_INS_TARGET_DAY");
            if ($fce == false) {
                $sap->PrintStatus();
                exit;
            }

            $waktuupdatPry = date("Ymd");
            $sqlproyek2 = "
                        select tbty.*,to_char(TANGGAL_TARGET, 'YYYYMMDD') as TANGGAL_TARGETF from ZSD_TARGET_HARIAN tbty where ORG='$sales_org'
                        and DISTRIBUTOR='$soldto' and AKTIF_MARK=0
                        and (to_char(CREATE_DATE, 'YYYYMMDD') ='$waktuupdatPry' or to_char(LASTUPDATE_DATE, 'YYYYMMDD') ='$waktuupdatPry')
                    ";
            $query_proyek2 = oci_parse($conn, $sqlproyek2);
            oci_execute($query_proyek2);
            $pppp = 0;
            while ($row_proyek2 = oci_fetch_array($query_proyek2)) {

                $pppp++;

                $ORGIto = $row_proyek2['ORG'];
                $DISTRIBUTto = $row_proyek2['DISTRIBUTOR'];
                $PLANTto = $row_proyek2['PLANT'];
                $TIPEto = $row_proyek2['TIPE'];
                $KOTAto = $row_proyek2['DISTRIK'];
                $TGL_TARGETto = $row_proyek2['TANGGAL_TARGETF'];
                $Targetto = $row_proyek2['TARGET'];

                $fce->T_DATA->row["NMORG"] = $ORGIto;
                $fce->T_DATA->row["NMPLAN"] = $PLANTto;
                $fce->T_DATA->row["DISTRIK"] = $KOTAto;
                $fce->T_DATA->row["DISTRIBUTOR"] = $DISTRIBUTto;
                $fce->T_DATA->row["TIPE_SEMEN"] = $TIPEto;
                $fce->T_DATA->row["TARGET_DATE"] = $TGL_TARGETto;
                $fce->T_DATA->row["VOLUME"] = $Targetto;
                $fce->T_DATA->row["ZDELETE"] = '0';
                $fce->T_DATA->row["CREATE_BY"] = $user_name_in;
                $fce->T_DATA->row["CREATE_DATE"] = $waktuupdatPry;
                $fce->T_DATA->row["LAST_UPD_BY"] = $user_name_in;
                $fce->T_DATA->row["LAST_UPD_DATE"] = $waktuupdatPry;
                $fce->T_DATA->Append($fce->T_DATA->row);
            }
            if ($pppp > 0) {
                $fce->Call();
                if ($fce->GetStatus() == SAPRFC_OK) {
                    $fce->T_MESSAGE->Reset();
                    $i = 0;
                    $insert_sap = 0;
                    $gagal = array();
                    while ($fce->T_MESSAGE->Next()) {
                        if ($fce->T_MESSAGE->row["TYPE"] == "W" || $fce->T_MESSAGE->row["TYPE"] == "E") {
                            $gagal[] = $i + 1;
                        } else if ($fce->T_MESSAGE->row["TYPE"] == "S")
                            $insert_sap++;

                        $i++;
                    }
                }
            }
            $fce->Close();
            $sap->Close();
        }
        //================================================================

        $habis = "approve_pryk.php";
        break;


    //===============================================
//     case "buatsoprykmd(BACKUP SOCC)":

//         // CEK MAPPING PLANT ADA ATAU TIDAK
//         $plantcek = $_POST['plant'];
//         $str = "SELECT * FROM ZMD_MAPPING_PLANT
//         WHERE PLANT_MD = '{$plantcek}' AND  DEL=0
//         ";
//         $query = oci_parse($conn, $str);
//         oci_execute($query);
//         $row = oci_fetch_array($query, OCI_ASSOC);
//         $lanjut = 'Y';
//         $next = 'Y';
//         $SO1 = '';
//         $IDH1 = '';
//         $SO2 = '';
//         $IDH2 = '';
//         $SO3 = '';
//         $IDH3 = '';
//         $SO4 = '';
//         $IDH4 = '';
//         $jerror = 0;
//         $SOMDNE = "N";

//         if (count($row) > 0) {
//             // CEK MAPPING CUSTOMER ADA ATAU TIDAK
//             $soldtocek = $_POST['distr_id'];
//             $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'  AND DEL = 0";
//             $querysoldto = oci_parse($conn, $strsoldto);
//             oci_execute($querysoldto);
//             $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
//             if (count($rowsoldto) < 1) {
//                 $lanjut = 'N';
//                 $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
//             }
//         } else {
//             $lanjut = 'N';
//             $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
//             ;
//         }

//         // CEK ICS
//         if ($row["COM_MD_2"] != "" && $row["PLANT_MD_2"] != "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
//             $perulangan = 5;
//             $perulanganSO = 4;
//             $perulanganPO = 3;
//             $ics = "Y";
//             $loncat = "N";
//         } else if ($row["COM_MD_2"] == "" && $row["PLANT_MD_2"] == "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
//             $perulangan = 5;
//             $perulanganSO = 4;
//             $perulanganPO = 2;
//             $ics = "Y";
//             $loncat = "Y"; /// MD @ tidak di pakai
//         } else {
//             $perulangan = 3;
//             $perulanganSO = 2;
//             $perulanganPO = 1;
//             $ics = "N";
//             $loncat = "N";
//         }


//         $no_pp = $fungsi->or_new_pp_number($conn);

//         // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
//         if ($lanjut == 'Y') {
//             // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
//             for ($ul = 1; $ul <= $perulangan; $ul++) {

//                 if ($next == 'Y') {
//                     $incoterm1 = $_POST['incoterm'];
//                     $incoterm2 = $_POST['nama_incoterm'];
//                     $route     = $_POST['route'];
//                     $top       = $_POST['top'];
//                     $nama_top  = $_POST['nama_top'];
//                     if ($ul == 1) {
//                         $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
//                         $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
//                         $soldto = $_POST['sold_to'];   // GANTI BERDASARKAN MAPPING CUSTOMER
//                         $soldto = $fungsi->sapcode($soldto);
//                         $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
//                         $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2
//                     } else if ($ul == 2) {
//                         $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
//                         $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2
//                         $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
//                         $soldto = $fungsi->sapcode($soldto);
//                         $sales_org2 = $row['COM_OPCO'];
//                         $plant2 = $row['PLANT_OPCO'];
//                         $incotermPO1 = $incoterm1;
//                         $incotermPO12 = $incoterm2;
//                     } else if ($ul == 3 && $ics == "Y") {
//                         $sales_org = $row['COM_MD_2'];
//                         $plant = $row['PLANT_MD_2'];
//                         $soldto = $rowsoldto['SOLD_TO_MD_2'];
//                         $soldto = $fungsi->sapcode($soldto);
//                         $sales_org3 = $row['COM_MD_2'];
//                         $plant3 = $row['PLANT_MD_2'];
//                         $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
//                         $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
//                         //penambahan rute dan TOP
//                         $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
//                         if($incoterm1 == 'FOT'){
//                            $route = 'ZR0003'; 
                           
//                         }else if($incoterm1 == 'FRC'){
//                            $route = 'ZR0002';  
                           
//                         }
//                         $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
//                         $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
//                         //penambahan rute top
                        
//                     } else if ($ul == 4 && $ics == "Y") {
//                         $sales_org = $row['COM_OPCO_2'];
//                         $plant = $row['PLANT_OPCO_2'];
//                         $soldto = $rowsoldto['SOLD_TO_OPCO_2'];
//                         $soldto = $fungsi->sapcode($soldto);
//                         $sales_org4 = $row['COM_OPCO_2'];
//                         $plant4 = $row['PLANT_OPCO_2'];
//                         $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
//                         $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
//                         //penambahan rute dan TOP
//                         $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
//                         if($incoterm1 == 'FOT'){
//                            $route = 'ZR0003'; 
                           
//                         }else if($incoterm1 == 'FRC'){
//                            $route = 'ZR0002';  
                           
//                         }
//                         $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
//                         $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
//                         $topPO2    = $top;
//                         //penambahan rute top
                        
//                         $incotermPO2 = $incoterm1;
//                         $incotermPO22 = $incoterm2;
//                     }

//                     //data header so
//                     $pesan_telegram = "";
//                     $user_name_in = $_SESSION['user_name'];
//                     $idh = $_POST['idh'];
//                     $iddtl = $_POST['iddtl'];
//                     $no_ppvalpryk = trim($_POST['no_pp']);
//                     $so_type = $_POST['so_type'];
//                     $nama_so_type = $_POST['nama_so_type'];

//                     if ($so_type == 'ZEX') {
//                         $distr_chan = "30";
//                     } elseif ($so_type == 'ZPR') {
//                         if ($sales_org == '2000') {
//                             $distr_chan = "10";
//                         } else if ($sales_org == '3000' || $sales_org == '5000' || $sales_org == '7000' || $sales_org == '7900' || $sales_org == '4000') { // tambahan pak yusuf untuk bisa memilih dist channel proyek MD
//                             $distr_chan = $_POST['channels'];
//                         } else {
//                             $distr_chan = "50";
//                         }
//                     } else {
//                         $distr_chan = "10";
//                     }
//                     $division = "00";
//                     $dlv_block = "";
//                     $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
//                     if ($distr_chancondi != '') {
//                         $distr_chan = $distr_chancondi;
//                     }

//                     $distr_chanPO1 = $distr_chan;
//                     if ($ul == 3 && $ics == "Y") {
//                         $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
//                     } else if ($ul == 4 && $ics == "Y") {
//                         $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
//                         $distr_chanPO2 = $distr_chan;
//                     }
//                     $nama_sold_to = $_POST['nama_sold_to'];
//                     $tgl_pp = date("d-m-Y");
//                     list($day, $month, $year) = split("-", $tgl_pp);
//                     $tgl_pp = $year . $month . $day;
//                     //$tanggal=gmdate("Ymd",time()+60*60*7);
//                     $top = $_POST['top'];
//                     $nama_top = $_POST['nama_top'];
//                     $reason = $_POST['reason'];
//                     $nama_reason = $_POST['nama_reason'];
//                     $nama_plant = $_POST['nama_plant'];
//                     $route = $_POST['route'];
//                     $pricelist = $_POST['pricelist'];
//                     $nama_pricelist = $_POST['nama_pricelist'];
//                     $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
//                     $ket = $_POST['nm_kapal'];
//                     $kontrakh = $_POST['com_kontrak0'];
//                     $pesan_telegram .= "PP Proyek $no_ppvalpryk\n";
//                     //call bapi sales order sap
//                     $sap = new SAPConnection();
//                     $sap->Connect("../include/sapclasses/logon_data.conf");
//                     if ($sap->GetStatus() == SAPRFC_OK)
//                         $sap->Open();
//                     if ($sap->GetStatus() != SAPRFC_OK) {
//                         $sap->PrintStatus();
//                         exit;
//                     }


//                     if ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) {
//                         $COM = 'MD';
//                     } else {
//                         $COM = 'SBI';
//                     }

//                     if ($ul <= $perulanganSO && $COM == 'MD') {


//                         if ($loncat == "N") {
//                             $gass = "Y";
//                         } else if ($loncat == "Y") {
//                             if ($ul == 3) {
//                                 $gass = "N";
//                             } else {
//                                 $gass = "Y";
//                             }
//                         }

//                         if ($gass == "Y") { // loncat tidak membuat SO MD 2 karena tidak di mammping plant
//                             $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
//                             if ($fce == false) {
//                                 $sap->PrintStatus();
//                                 exit;
//                             }


//                             //detail entri item'
//                             $sampai = $_POST['jumlah'];
//                             $shipto_awal = '';
//                             for ($j = 0; $j <= $sampai - 1; $j++) {
//                                 $idke = "idke" . $j;
//                                 if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                     $shipto_awal = $_POST['com_shipto0'];
//                                     $material = $_POST['com_produk' . $j];
//                                     if ($ul == 1) {
//                                         $shipto = $_POST['com_shipto' . $j];     // GANTI BERDASARKAN MAPPING CUSTOMER 
//                                         $material1 = $_POST['com_produk' . $j];
//                                     } else if ($ul == 2 || $ul == 3 || $ul == 4) {
//                                         $shiptotocek = $_POST['com_shipto' . $j];
                                        
//                                         $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
//                                         $queryshipto = oci_parse($conn, $strshipto);
//                                         oci_execute($queryshipto);
//                                         $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                         if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
//                                             $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
//                                             $queryshipto = oci_parse($conn, $strshipto);
//                                             oci_execute($queryshipto);
//                                             $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                         }

//                                         if ($ul == 2) {
//                                             $shipto = $rowshipto['SHIP_TO_OPCO'];
//                                             $soldto = $rowshipto['SOLD_TO_OPCO'];
//                                         } else if ($ul == 3) {
//                                             $shipto = $rowshipto['SHIP_TO_MD_2'];
//                                             $soldto = $rowshipto['SOLD_TO_MD_2'];
//                                         } else if ($ul == 4) {
//                                             $shipto = $rowshipto['SHIP_TO_OPCO_2'];
//                                             $soldto = $rowshipto['SOLD_TO_OPCO_2'];
//                                         }



//                                         $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
//                                         $querymaterial = oci_parse($conn, $strmaterial);
//                                         oci_execute($querymaterial);
//                                         $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


//                                         if ($ul == 2) {
//                                             $material = $rowmaterial['KD_MATERIAL_OPCO'];
//                                         } else if ($ul == 3) {
//                                             $material = $rowmaterial['KD_MATERIAL_MD_2'];
//                                         } else if ($ul == 4) {
//                                             $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
//                                         }
//                                     }


//                                     $id_dtl = $_POST['com_iddtl' . $j];
//                                     $item_num1 = $_POST['com_line' . $j];
//                                     $item_num = $fungsi->linenum($item_num1);
//                                     $distrik = $_POST['com_distrik' . $j];
//                                     $qty = $_POST['com_qty' . $j];
//                                     $qtyx = $_POST['com_qtyx' . $j];
//                                     $tgl_kirim = $_POST['com_tgl_kirim' . $j];
//                                     list($day, $month, $year) = split("-", $tgl_kirim);
//                                     $tgl_kirim = $year . $month . $day;
//                                     $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
//                                     $kontrak = $_POST['com_kontrak' . $j];
//                                     $nomor = $fungsi->sapcode($kontrak);

//                                     if ($qtyx != $qty) {
//                                         $ada = $ada + 1;
//                                     }

//                                     // $show_ket .= "item_cat $item_cat / nomor_kontrak $kontrakh / produk $produk<br>";
//                                     // $show_ket .= "item_cat $item_cat / nomor_kontrak2 $kontrak / produk $produk<br>";

//                                     if ($so_type == 'ZFC') {
//                                             if($sales_org=='7900' || $sales_org=='7000'){
//                                                 $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";    // Tambahan MD 
//                                             }    
//                                     }
//                                     $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
//                                     //$fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $item_cat;
//                                     $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
//                                     $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
//                                     $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
//                                     $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
//                                     if ($kontrak != '' && $sales_org == "7900") {
//                                         $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
//                                         $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
//                                         $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
//                                     }
// //                                    if ($kontrak != '' ) {
// //                                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
// //                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
// //                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
// //                                    }
//                                     $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

//                                     //detail entri schedule n qty'
//                                     $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
//                                     $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
//                                     $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

//                                     $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
//                                     $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
//                                     $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
//                                     $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

//                                     //detail entri distributor dan agen
//                                     if ($j == 0) {
//                                         $item_num = '000000';
//                                     } else {
//                                         $item_num = $item_num;
//                                     }
// //                                    if ($sales_org == '3000') {
// //                                        if ($sampai == 1) {
// //                                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
// //                                        } else {
// //                                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
// //                                        }
// //                                    } else {
// //                                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
// //                                    }
//                                     $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
//                                     $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
//                                     $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
//                                 }
//                             }

//                             //header entri
//                             if ($sales_org == '3000') {
//                                 $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
//                                 if ($fce1 == false) {
//                                     $sap->PrintStatus();
//                                     exit;
//                                 }

//                                 //header entri

//                                 $fce1->ZNMORG = 3000;
//                                 $fce1->ZKUNNR = $shipto;
//                                 $fce1->Call();
//                                 if ($fce1->GetStatus() == SAPRFC_OK) {
//                                     $fce1->RETURN_DATA->Reset();
//                                     while ($fce1->RETURN_DATA->Next()) {
//                                         $kode = $fce1->RETURN_DATA->row["VKGRP"];
//                                     }
//                                 }
//                                 $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
//                             }

//                             //penambahan sales office
//                             $dt_shipto = "SELECT BZIRK, VKBUR, VKGRP FROM RFC_Z_ZCSD_SHIPTO WHERE KUNN2 = '{$shipto}' AND ROWNUM =1";
// //                            echo $dt_shipto;
//                             $dt_shipto_q = oci_parse($conn, $dt_shipto);
//                             oci_execute($dt_shipto_q);
//                             $row_dt_shipto = oci_fetch_array($dt_shipto_q, OCI_ASSOC);

//                             $fce->ORDER_HEADER_IN["SALES_GRP"] = $row_dt_shipto["VKGRP"];
//                             $fce->ORDER_HEADER_IN["SALES_DIST"] = $row_dt_shipto["BZIRK"];
//                             $fce->ORDER_HEADER_IN["SALES_OFF"] = $row_dt_shipto["VKBUR"];
//                             // end penambahan sales office

//                             if ($so_type == 'ZFC') {
//                                 $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
//                             } else {
//                                 $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
//                             }
//                             $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
//                             $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
//                             $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
//                             $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00"; 
//                             $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_ppvalpryk; //"Z1";
//                             $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
//                             $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
//                             $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
//                             $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
//                             $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
//                             $fce->ORDER_HEADER_IN["NAME"] = $ket;
//                             $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
//                             $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
//                             if ($lcnum != '') {
//                                 $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
//                                 $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
//                             }
                            
//                             if ($kontrakh != '' && $sales_org == "7900") {
//                                 $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
//                                 $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
//                             }
// //                            if ($kontrakh != ''  ) {
// //                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
// //                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
// //                            }


//                             $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
//                             $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
//                             $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
//                             $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

//                             $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
//                             $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
//                             $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto_awal;
//                             $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);


//                             if ($sales_org == "7900" || $sales_org == "7000") {
//                                 $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
//                                 $querytax = oci_parse($conn, $strtax);
//                                 oci_execute($querytax);
//                                 $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
//                                 if (ISSET($rowtax["KD_SOLD_TO"])) {
//                                     $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
//                                 } else {
//                                     if ($so_type == 'ZFC') {
//                                     $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
//                                     }else{
//                                     $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1";    
//                                     }
//                                 }

// //                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
//                             }

//                            echo '<pre>';
//                            print_r($fce);
//                            echo '</pre>';

//                             $fce->Call();
//                             if ($fce->GetStatus() == SAPRFC_OK) {
//                                 $nomorso = $fce->SALESDOCUMENT;
//                                 $fce->RETURN->Reset();
//                                 while ($fce->RETURN->Next()) {
//                                     $tipe = $fce->RETURN->row["TYPE"];
//                                     $msg = $fce->RETURN->row["MESSAGE"];
//                                     if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
//                                         $show_ket .= $msg;
//                                         $show_ket .= '<br>';
//                                         $next = "N";
//                                     }
//                                 }

//                                 //Commit Transaction
//                                 $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                             }

//                             //Update SO
//                             if ($nomorso != '' && $j > 0) {
//                                 sleep(5); //seconds to wait..   
//                                 $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
//                                 $fce->SALESDOCUMENT = $nomorso; //"ZOR";
//                                 $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
//                                 $fce->Call();

//                                 //Commit Transaction
//                                 $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                                 $fce->Call();

//                                 $show_ket .= $ul . "Sales Order telah dibuat dengan nomor : $nomorso <br>";
//                                 $pesan_telegram .= "Approve dengan no SO $nomorso\n";
//                             }




//                             if ($sales_org == 4000) {
//                                 botTelegram('-394888712', $pesan_telegram);
//                             }

//                             // Setelah SO ter create
//                             if ($ul == 1) {
//                                 $SO1 = $nomorso;
//                                 $IDH1 = $idh;
//                             } else if ($ul == 2) {
//                                 $SO2 = $nomorso;
//                                 $IDH2 = $idh;
//                             } else if ($ul == 3) {
//                                 $SO3 = $nomorso;
//                                 $IDH3 = $idh;
//                             } else if ($ul == 4) {
//                                 $SO4 = $nomorso;
//                                 $IDH4 = $idh;
//                             }

//                             if ($next == "Y" && $ul == 1) {

//                                 if (($nomorso != "") and ( $ada == 0))
//                                     $status = "APPROVE";
//                                 else
//                                     $status = "PROCESS";
//                                 //update data header
//                                 $field_names = array('STATUS', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON');
//                                 $field_data = array("$status", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$nomor", "$reason", "$nama_reason");
//                                 $tablename = "OR_TRANS_HDR";
//                                 $field_id = array('ID');
//                                 $value_id = array("$idh");
//                                 $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
//                                 // update data detail
//                                 $sampai1 = $_POST['jumlah'];
//                                 for ($k = 0; $k <= $sampai1; $k++) {
//                                     $idke = "idke" . $k;
//                                     if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                         $id_dtl1 = $_POST['com_iddtl' . $k];
//                                         $qty1 = $_POST['com_qty' . $k];
//                                         $qtyx1 = $_POST['com_qtyx' . $k];
//                                         $kode_distrik = $_POST['com_distrik' . $k];
//                                         $kontrak = $_POST['com_kontrak' . $k];


//                                         if ($sales_org == "7900") {
//                                             $nomor = $fungsi->sapcode($kontrak);
//                                         } else {
//                                             $nomor = "";
//                                         }
// //                                            $nomor = $fungsi->sapcode($kontrak);
//                                         $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
//                                         $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);

//                                         if (($nomorso != "") and ( $qty1 == $qtyx1))
//                                             $status1 = "APPROVE";
//                                         else
//                                             $status1 = "PROCESS";

//                                         $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT');
//                                         $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$nomor", "$plant", "$nama_plant");
//                                         $tablename = "OR_TRANS_DTL";
//                                         $field_id = array('ID');
//                                         $value_id = array("$id_dtl1");
//                                         $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
//                                         if ($nomorso != "") {
//                                             $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
//                                             $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
//                                             $tablenamefrom = "OR_TRANS_DTL";
//                                             $tablenameto = "OR_TRANS_APP";
//                                             $field_id1 = array('ID');
//                                             $value_id1 = array("$id_dtl1");
//                                             $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);
//                                         }
//                                     }
//                                 }
//                             }


//                             //Khusus Proyek SI                
//                             if ($so_type == 'ZPR' && $nomorso != "" && ($sales_org == '7000' || $sales_org = '2000' || $sales_org = '5000' || $sales_org = '7900')) {
//                                 sleep(3);
//                                 list($dayFG, $monthFG, $yearFG) = split("-", $tgl_kirim1);
//                                 $tgl_kirimFormat = $yearFG . $monthFG . $dayFG;
//                                 $sqlproyek = "
//                                 select ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1,SUM(QTY_PPK) as QTY_PP from(
//                                 SELECT OR_TRANS_HDR_V.*, to_char(TGL_PP,'DD-MM-YYYY') as TGL_PP1,
//                                 to_char(TGL_KIRIM_PP,'YYYYMMDD') as TGL_KIRIM_PP1,
//                                 to_char(TGL_KIRIM_APPROVE,'DD-MM-YYYY') as TGL_KIRIM_APPROVE1,
//                                 to_char(TGL_TERIMA,'DD-MM-YYYY') as TGL_TERIMA1,
//                                 case when KODE_PRODUK in ('121-301-0110','121-301-0050') then (QTY_PP*40)/1000
//                                 when KODE_PRODUK in ( '121-301-0020','121-301-0060','121-301-0056') then (QTY_PP*50)/1000
//                                 else QTY_PP
//                                 end as QTY_PPK,
//                                 substr(KODE_PRODUK,0,7) as TIPE_PRODUK
//                                 FROM OR_TRANS_HDR_V
//                                 WHERE DELETE_MARK = '0'
//                                 AND SO_TYPE='$so_type'
//                                 AND KD_REASON is null
//                                 AND PLANT_ASAL is not null
//                                 AND TIPEPP='NEW PROYEK' 
//                                 AND ORG='$sales_org'
//                                 AND SOLD_TO='$soldto'
//                                 AND PLANT_ASAL='$plant'
//                                 AND NO_PP='$no_ppvalpryk'
//                                 AND STATUS_LINE='APPROVE'
//                                 ORDER BY NO_PP ASC
//                                 )tb1
//                                 group by ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1
//                             ";
//                                 $query_proyek = oci_parse($conn, $sqlproyek);
//                                 oci_execute($query_proyek);
//                                 while ($row_proyek = oci_fetch_array($query_proyek)) {
//                                     $ORGto = $row_proyek['ORG'];
//                                     $SOLD_TOto = $row_proyek['SOLD_TO'];
//                                     $PLANT_ASALto = $row_proyek['PLANT_ASAL'];
//                                     $TIPE_PRODUKto = $row_proyek['TIPE_PRODUK'];
//                                     $KODE_TUJUANto = $row_proyek['KODE_TUJUAN'];
//                                     $TGL_KIRIM_PP1to = $row_proyek['TGL_KIRIM_PP1'];
//                                     $QTY_PPto = $row_proyek['QTY_PP'];
//                                     $sqlcek = "
//                                 select * from (
//                                 select tb1.*,
//                                 case when PLANT is null then (select PLANT from ZSD_MAPPING_PLANTKOTA where DELETE_MARK=0 and DISTRIK=tb1.DISTRIK and ORG=tb1.ORG and rownum=1)
//                                 else PLANT
//                                 end as PLANTSET
//                                 from ZSD_TARGET_HARIAN tb1 where ORG = '$ORGto' and DISTRIK = '$KODE_TUJUANto' 
//                                 and DISTRIBUTOR = '$SOLD_TOto' and
//                                 TIPE = '$TIPE_PRODUKto' and
//                                 to_char(TANGGAL_TARGET, 'YYYYMMDD') ='$TGL_KIRIM_PP1to'
//                                 )
//                                 where PLANTSET='$PLANT_ASALto'
//                                 ";
//                                     $query_cek = oci_parse($conn, $sqlcek);
//                                     oci_execute($query_cek);
//                                     $row_cek = oci_fetch_array($query_cek);
//                                     if ($row_cek['ID'] == '') {
//                                         //insert                            
//                                         $sql2 = "insert into ZSD_TARGET_HARIAN(ORG, TIPE, DISTRIK, DISTRIBUTOR, TANGGAL_TARGET,
//                                              PLANT, TARGET, AKTIF_MARK, CREATE_BY, CREATE_DATE) 
//                                              values ('" . $ORGto . "','" . $TIPE_PRODUKto . "', '" . $KODE_TUJUANto . "', '" . $SOLD_TOto . "', to_date('" . $TGL_KIRIM_PP1to . "', 'YYYYMMDD') ,
//                                             '" . $PLANT_ASALto . "', '" . $QTY_PPto . "','0', '$user_name_in', sysdate)";
//                                         $query2 = oci_parse($conn, $sql2);
//                                         $ins = oci_execute($query2);
//                                     } else {
//                                         //update
//                                         $sql1 = "update ZSD_TARGET_HARIAN set target = target+'" . $QTY_PPto . "', AKTIF_MARK='0', lastupdate_by = '$user_name_in', 
//                                              lastupdate_date = sysdate
//                                              where ID = '" . $row_cek['ID'] . "'";
//                                         $query1 = oci_parse($conn, $sql1);
//                                         $upd = oci_execute($query1);
//                                     }
//                                 }

//                                 //update SAP	
//                                 $sap = new SAPConnection();
//                                 $sap->Connect("../include/sapclasses/logon_data.conf");
//                                 if ($sap->GetStatus() == SAPRFC_OK)
//                                     $sap->Open();
//                                 if ($sap->GetStatus() != SAPRFC_OK) {
//                                     $sap->PrintStatus();
//                                     exit;
//                                 }

//                                 $fce = $sap->NewFunction("ZAPPSD_INS_TARGET_DAY");
//                                 if ($fce == false) {
//                                     $sap->PrintStatus();
//                                     exit;
//                                 }

//                                 $waktuupdatPry = date("Ymd");
//                                 $sqlproyek2 = "
//                                 select tbty.*,to_char(TANGGAL_TARGET, 'YYYYMMDD') as TANGGAL_TARGETF from ZSD_TARGET_HARIAN tbty where ORG='$sales_org'
//                                 and DISTRIBUTOR='$soldto' and AKTIF_MARK=0
//                                 and (to_char(CREATE_DATE, 'YYYYMMDD') ='$waktuupdatPry' or to_char(LASTUPDATE_DATE, 'YYYYMMDD') ='$waktuupdatPry')
//                             ";
//                                 $query_proyek2 = oci_parse($conn, $sqlproyek2);
//                                 oci_execute($query_proyek2);
//                                 $pppp = 0;
//                                 while ($row_proyek2 = oci_fetch_array($query_proyek2)) {

//                                     $pppp++;

//                                     $ORGIto = $row_proyek2['ORG'];
//                                     $DISTRIBUTto = $row_proyek2['DISTRIBUTOR'];
//                                     $PLANTto = $row_proyek2['PLANT'];
//                                     $TIPEto = $row_proyek2['TIPE'];
//                                     $KOTAto = $row_proyek2['DISTRIK'];
//                                     $TGL_TARGETto = $row_proyek2['TANGGAL_TARGETF'];
//                                     $Targetto = $row_proyek2['TARGET'];

//                                     $fce->T_DATA->row["NMORG"] = $ORGIto;
//                                     $fce->T_DATA->row["NMPLAN"] = $PLANTto;
//                                     $fce->T_DATA->row["DISTRIK"] = $KOTAto;
//                                     $fce->T_DATA->row["DISTRIBUTOR"] = $DISTRIBUTto;
//                                     $fce->T_DATA->row["TIPE_SEMEN"] = $TIPEto;
//                                     $fce->T_DATA->row["TARGET_DATE"] = $TGL_TARGETto;
//                                     $fce->T_DATA->row["VOLUME"] = $Targetto;
//                                     $fce->T_DATA->row["ZDELETE"] = '0';
//                                     $fce->T_DATA->row["CREATE_BY"] = $user_name_in;
//                                     $fce->T_DATA->row["CREATE_DATE"] = $waktuupdatPry;
//                                     $fce->T_DATA->row["LAST_UPD_BY"] = $user_name_in;
//                                     $fce->T_DATA->row["LAST_UPD_DATE"] = $waktuupdatPry;
//                                     $fce->T_DATA->Append($fce->T_DATA->row);
//                                 }
//                                 if ($pppp > 0) {
//                                     $fce->Call();
//                                     if ($fce->GetStatus() == SAPRFC_OK) {
//                                         $fce->T_MESSAGE->Reset();
//                                         $i = 0;
//                                         $insert_sap = 0;
//                                         $gagal = array();
//                                         while ($fce->T_MESSAGE->Next()) {
//                                             if ($fce->T_MESSAGE->row["TYPE"] == "W" || $fce->T_MESSAGE->row["TYPE"] == "E") {
//                                                 $gagal[] = $i + 1;
//                                             } else if ($fce->T_MESSAGE->row["TYPE"] == "S")
//                                                 $insert_sap++;

//                                             $i++;
//                                         }
//                                     }
//                                 }
//                             }
//                         }
//                         $jerror += 1;
//                     }else if ($ul == 2 || $ul == 4 && $COM == "SBI") {

//                         //print_r($ul);
//                         //print_r("<br />");
//                         // build array material
//                         $Tmaterial = array();
//                         $Tmaterial['MaterialCode'] = array();
//                         $Tmaterial['PlantCode'] = array();
//                         $Tmaterial['Qty'] = array();
//                         $Tmaterial['QtyUnit'] = array();
//                         $Tmaterial['ScheduleLine'] = array();
//                         $Tmaterial['RequestDeliveryDate'] = array();
//                         $Tmaterial['RequestDeliveryQty'] = array();
//                         $Dmaterial = array();
//                         for ($j = 0; $j <= $sampai - 1; $j++) {
//                             $material = $_POST['com_produk' . $j];
//                             $strmat = "SELECT CAST(NTGEW AS float) as BERAT, A.* FROM RFC_Z_ZCSD_LIST_MAT_SALES_2 A WHERE VKORG = '{$sales_org1}' AND MATNR = '{$material}'  AND WERKS = '{$plant1}'";
//                             $querymat = oci_parse($conn, $strmat);
//                             oci_execute($querymat);
//                             $rowmat = oci_fetch_array($querymat, OCI_ASSOC);
//                             if (count($rowmat) > 0 && $rowmat['MEINS'] == "ZAK") {
//                                 $qty = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
//                                 $qtyx = ( intval($_POST['com_qtyx' . $j]) * $rowmat['BERAT'] ) / 1000;
//                             } else {
//                                 $qty = $_POST['com_qty' . $j];
//                                 $qtyx = $_POST['com_qtyx' . $j];
//                             }

//                             $shiptotocek = $_POST['com_shipto' . $j];
//                             $item_numline = sprintf("%04d", $j + 1);
//                             $tanggall = $_POST['com_tgl_kirim' . $j];
//                             list($day, $month, $year) = split("-", $tanggall);
//                             $tgl_kirim = $year . "-" . $month . "-" . $day;

//                             $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
//                             $querymaterial = oci_parse($conn, $strmaterial);
//                             oci_execute($querymaterial);
//                             $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);

//                             if ($ul == 2) {
//                                 $materialsbi = $rowmaterial["KD_MATERIAL_OPCO"];
//                             } else if ($ul == 4) {
//                                 $materialsbi = $rowmaterial["KD_MATERIAL_OPCO_2"];
//                             }
//                             $Tmaterial['MaterialCode'] = $materialsbi;
//                             $Tmaterial['PlantCode'] = $plant;
//                             $Tmaterial['Qty'] = $qty;
//                             $Tmaterial['QtyUnit'] = "TO";
//                             $Tmaterial['ScheduleLine'] = $item_numline;
//                             $Tmaterial['RequestDeliveryDate'] = $tgl_kirim;
//                             $Tmaterial['RequestDeliveryQty'] = $qtyx;
//                             $Dmaterial[] = $Tmaterial;
//                         }

//                         //print_r($so_type."<br />");
//                         //print_r($sales_org."<br />");
//                         $strorder = "SELECT * FROM ZMD_MAPPING_ORDER WHERE ORDER_TYPE_MD = '{$so_type}' AND COMPANY_OPCO = '{$sales_org}' AND DEL = 0";
//                         $queryorder = oci_parse($conn, $strorder);
//                         oci_execute($queryorder);
//                         $roworder = oci_fetch_array($queryorder, OCI_ASSOC);

//                         list($day, $month, $year) = split("-", $tanggall);
//                         $tgl_kirim = $year . $month . $day;

                        
//                         $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
//                         $queryshipto = oci_parse($conn, $strshipto);
//                         oci_execute($queryshipto);
//                         $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                         if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
//                             $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
//                             $queryshipto = oci_parse($conn, $strshipto);
//                             oci_execute($queryshipto);
//                             $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                         }
//                         if ($ul == 2) {
//                             $shipto = $rowshipto['SHIP_TO_OPCO'];
//                             $SOMD = $SO1;
//                             $soldtosbi = $rowshipto['SOLD_TO_OPCO'];
//                         } else if ($ul == 4) {
//                             $shipto = $rowshipto['SHIP_TO_OPCO_2'];
//                             $SOMD = $SO3;
//                             $soldtosbi = $rowshipto['SOLD_TO_OPCO_2'];
//                         }

//                         $tgl_pp = $_POST['tgl_pp'];

//                         list($day, $month, $year) = split("-", $tgl_pp);
//                         $tgl_ppPO = $year . "-" . $month . "-" . $day . " 00:00:00";

//                         list($day, $month, $year) = split("-", $tgl_pp);
//                         $tgl_pp = $year . $month . $day;


//                         if ($sales_org == "PTSC") {
//                             $sales_organization = "SCBD";
//                         } else if ($sales_org == "ID50") {
//                             $sales_organization = "ID11";
//                         }

//                         if(empty($ship_condition)){
                        
//                             if ($incoterm1 == "FOT") {
//                                 $shipcond_sbi = "PK";
//                             } else if ($incoterm1 == "FRC") {
//                                 $shipcond_sbi = "D0";
//                             } else if ($incoterm1 == "CNF") {
//                                 $shipcond_sbi = "DV";
//                             } else {
//                                 $shipcond_sbi = "";
//                             }
                        
//                         }else{
//                             $shipcond_sbi = $ship_condition;
//                         }
                        
//                         $strtop = "SELECT * FROM ZMD_MAPPING_TOP WHERE COM_SMI = '{$sales_org1}' AND TOP_SMI = '{$top}' AND (COM_SB = '{$sales_org}' or COM_SB = 'ALL')  AND DEL = 0 order by COM_SB DESC";
//                         $querytop = oci_parse($conn, $strtop);
//                         oci_execute($querytop);
//                         $rowtop = oci_fetch_array($querytop, OCI_ASSOC);
//                         if (ISSET($rowtop['TOP_SB'])) {
//                             $topsbi = $rowtop['TOP_SB'];
//                         }else{
//                             $topsbi = null;
//                         }    
//                         $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
//                         $data = array('Token' => 'aSsMx7GV0HFGzlufM4DH',
//                             'SystemID' => 'PASSO',
//                             'Data' => array('SalesDocumentType' => $roworder["ORDER_TYPE_OPCO"],
//                                 'SalesOrganization' => $sales_organization,
//                                 'DistributionChannel' => 'DB',
//                                 'Division' => 'CM',
//                                 'SalesDocumentDate' => $tgl_pp,
//                                 'ShippingCondition' => $shipcond_sbi,
//                                 'ShippingType' => 'G4',
//                                 'SoldToCode' => $soldtosbi,
//                                 'ShipToCode' => $shipto,
//                                 'MDReferenceSONumber' => $SOMD,
//                                 'MDPurchaseOrderNumber' => $no_pp,
//                                 'MDPurchaseOrderItem' => '00010',
//                                 'PurchaseOrderNumber' => $no_pp,
//                                 'PurchaseOrderDate' => $tgl_ppPO,
//                                 'PaymentTerms' => $topsbi,
//                                 'Items' => $Dmaterial
//                             )
//                         );
//                         $options = array(
//                             'http' => array(
//                                 'header' => "Content-type: application/json\r\n",
//                                 'method' => 'POST',
//                                 'content' => json_encode($data),
//                             )
//                         );



//                         $context = stream_context_create($options);
//                         $result = file_get_contents($url, false, $context);
//                         $response = json_decode($result);
//                         if ($ul == 4) {
//                             $responseSBI2 = $response;
//                         }
//                         $status = $response->Status;
//                         $Message = $response->Message;


//                         $Message_detail = $response->MessageDetail;
//                         $param_send = json_encode($data);
//                         $param_return = json_encode($response);

//                         $field_names = array(
//                             'SEND_PARAM', 'RETURN_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN', 'PESAN_DETAIL', 'TGL'
//                         );
//                         $field_data = array(
//                             "$param_send", "$param_return", "$user_name_in", "$no_pp", "$Message", "$Message_detail", "SYSDATE"
//                         );
//                         $tablename = "ZMD_LOG_SBI";
//                         $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);
//                         //print_r($status);
//                         //print_r($Message);
//                         if ($ul == 2) {
//                             $nomorso = $response->Data->SAPSalesOrderNumber;
//                             $SO2 = $response->Data->SAPSalesOrderNumber;
//                             $tgl_deleteSO2 = $response->Data->SAPCreatedDateStr;
//                         } else if ($ul == 4) {
//                             $nomorso = $response->Data->SAPSalesOrderNumber;
//                             $SO4 = $response->Data->SAPSalesOrderNumber;
//                             $tgl_deleteSO4 = $response->Data->SAPCreatedDateStr;
//                         }

//                         if ($status != 1) {
//                             $next = 'N';
//                             $show_ket .= $ul . ". SO OPCO = " . $Message_detail;
//                             $show_ket .= '<br>';
//                         } else {
//                             $show_ket .= $ul . ". SO OPCO = Sales Order has been made with a number : " . $nomorso;
//                             $show_ket .= '<br>';
//                         }
//                         $Dataarray = json_decode(json_encode($response->Data->Items), true);
//                         //print_r($nomorso);
//                         //echo json_encode($data);

//                         $SOMDNE = 'Y';
//                         $jerror += 1;
//                     } else if ($ul == $perulangan) { // PROSES PERULANGAN TERAKHIR CREATE PO
//                         // GET HARGA PER LINE ITEM
//                         for ($p = 1; $p <= $perulanganPO; $p++) { // perulangan PO MULTI ICS atau TIDAK
//                             if ($p == 1) {
//                                 $incoterm1 = $incotermPO1;
//                                 $incoterm2 = $incotermPO12;
//                                 $distr_chan = $distr_chanPO1;
//                             } else {
//                                 $incoterm1 = $incotermPO2;
//                                 $incoterm2 = $incotermPO22;
//                                 $distr_chan = $distr_chanPO2;
//                             }
//                             //perubahan get KD VENDOR
//                             $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'  AND DEL = 0";
//                             $querykdven = oci_parse($conn, $strkdven);
//                             oci_execute($querykdven);
//                             $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

//                             if ($p == 1) {
//                                 $SO_PO = $SO2;
//                                 $vendorFIX = $rowkdven["KET"];
//                                 $COM = $rowkdven["COM_MD"];
//                                 $COM_HARGA = $rowkdven["COM_OPCO"];
//                                 $plantPO = $plant1;
//                             } else if ($p == 2) {
//                                 $SO_PO = ($SO3 != "" ? $SO3 : $SO4);
//                                 $vendorFIX = $rowkdven["KET_OPCO"];
//                                 $COM = $rowkdven["COM_OPCO"];
//                                 $COM_HARGA = $rowkdven["COM_MD_2"];
//                                 $plantPO = $plant2;
//                             } else if ($p == 3) {
//                                 $SO_PO = $SO4;
//                                 $vendorFIX = $rowkdven["KET2"];
//                                 $COM = $rowkdven["COM_MD_2"];
//                                 $COM_HARGA = $rowkdven["COM_OPCO_2"];
//                                 $plantPO = $plant3;
//                             }
//                             if ($COM != "PTSC" && $COM != "ID50") {
//                                 if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
//                                     $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
//                                     $fce->I_BAPI_VIEW["SDCOND"] = "X";
//                                     $fce->SALES_DOCUMENTS->row["VBELN"] = $SO_PO;
//                                     $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

//                                     $fce->Call();
//                                     if ($fce->GetStatus() == SAPRFC_OK) {
//                                         $fce->ORDER_CONDITIONS_OUT->Reset();
//                                         $totL = 0;
//                                         $builder = array();
//                                         $dataH = array();
//                                         $dataH["item_number"] = array();
//                                         $dataH["nilai_harga"] = array();
//                                         $dataH["per"] = array();
//                                         $dataH["satuan"] = array();
//                                         while ($fce->ORDER_CONDITIONS_OUT->Next()) {
//                                             if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
//                                                 $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
//                                                 $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
//                                                 $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
//                                                 $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
//                                                 $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
//                                                 $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];
//                                                 $builder[] = $dataH;
//                                                 $totL += 1;
//                                             }
//                                         }
//                                         //Commit Transaction
//                                         $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                                         $fce->Call();

//                                         if ($totL != $_POST['jumlah']) {
//                                             $next = "N";
//                                             $show_ket .= "Master Harga Belum Ada...!!!";
//                                             $show_ket .= '<br>';
//                                         }
//                                     }
//                                 }

//                                 if ($next == "Y") {

//                                     // CREATE PO
//                                     $fce = $sap->NewFunction("BAPI_PO_CREATE1");
//                                     $tgl_sekarang = date("Ymd");

//                                    $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$COM}' AND KD_VENDOR = '{$vendorFIX}' AND DEL =0";
//                                     $queryven = oci_parse($conn, $strven);
//                                     oci_execute($queryven);
//                                     $rowven = oci_fetch_array($queryven, OCI_ASSOC);


//                                     $fce->POHEADER["COMP_CODE"] = $COM; // company kedua
//                                     $fce->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
//                                     $fce->POHEADER["VENDOR"] = $vendorFIX; //
//                                     $fce->POHEADER["PMNTTRMS"] = $top;
//                                     $fce->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
//                                     $fce->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"];
//                                     //                        $fce->POHEADER["CURRENCY"] = "IDR";
//                                     //                        $fce->POHEADER["EXCH_RATE"] = "1";
//                                     $fce->POHEADER["DOC_DATE"] = $tgl_sekarang;
//                                     $fce->POHEADER["INCOTERMS1"] = $incoterm1;
//                                     $fce->POHEADER["INCOTERMS2"] = $incoterm2;


//                                     $fce->POHEADERX["COMP_CODE"] = "x";
//                                     $fce->POHEADERX["DOC_TYPE"] = "x";
//                                     $fce->POHEADERX["VENDOR"] = "x";
//                                     $fce->POHEADERX["PMNTTRMS"] = "x";
//                                     $fce->POHEADERX["PURCH_ORG"] = "x";
//                                     $fce->POHEADERX["PUR_GROUP"] = "x";
//                                     //                        $fce->POHEADERX["CURRENCY"] = "x";
//                                     //                        $fce->POHEADERX["EXCH_RATE"] = "x";
//                                     $fce->POHEADERX["DOC_DATE"] = "x";
//                                     $fce->POHEADERX["INCOTERMS1"] = "x";
//                                     $fce->POHEADERX["INCOTERMS2"] = "x";

//                                     $fce->POTEXTHEADER->row["TEXT_ID"] = "F01";
//                                     $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
//                                     $fce->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
//                                     $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

//                                     $fce->POTEXTHEADER->row["TEXT_ID"] = "F14";
//                                     $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
//                                     $fce->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
//                                     $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

//                                     $sampai = $_POST['jumlah'];
//                                     for ($j = 0; $j <= $sampai - 1; $j++) {
//                                         $idke = "idke" . $j;
//                                         if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                             $id_dtl = $_POST['com_iddtl' . $j];
//                                             $item_num1 = $_POST['com_line' . $j];
//                                             $item_num = $fungsi->linenum($item_num1);
//                                             $item_numli = $item_num * 10;
//                                             $item_numline = sprintf("%06d", $item_numli);

//                                             $item_numlinePO = sprintf("%05d", $item_numli);
//                                             $material = $_POST['com_produk' . $j];
// //                                    $material1 = $_POST['com_produk' . $j];
// //                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
// //                                    $querymaterial = oci_parse($conn, $strmaterial);
// //                                    oci_execute($querymaterial);
// //                                    $rowmaterial  = oci_fetch_array($querymaterial, OCI_ASSOC);
// //                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];

//                                             $qty = $_POST['com_qty' . $j];
//                                             $qtyx = $_POST['com_qtyx' . $j];

//                                             if ($sales_org == "7900") {
//                                                 $kontrak = $_POST['com_kontrak' . $j];
//                                             } else {
//                                                 $kontrak = "";
//                                             }
// //                                            $kontrak = $_POST['com_kontrak' . $j];

//                                             $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
//                                             $distrik = $_POST['com_distrik' . $j];

//                                             $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
//                                             list($day, $month, $year) = split("-", $tgl_kirimPO);
//                                             $tgl_kirim = $year . $month . $day;


//                                             $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
//                                             $querymaterial = oci_parse($conn, $strmaterial);
//                                             oci_execute($querymaterial);
//                                             $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


//                                             if ($p == 1) {
//                                                 $material = $_POST['com_produk' . $j];
//                                             } else if ($p == 2) {
//                                                 $material = $rowmaterial['KD_MATERIAL_OPCO'];
//                                             } else if ($p == 3) {
//                                                 $material = $rowmaterial['KD_MATERIAL_MD_2'];
//                                             }

//                                             $mtr_group = substr($material, 0, 7);


//                                             if (($nomorso != "") and ( $qty1 == $qtyx1))
//                                                 $status1 = "APPROVE";
//                                             else
//                                                 $status1 = "PROCESS";

//                                             if ($mtr_group == "121-301") {
//                                                 $nm_material = "SEMEN ZAK";
//                                                 $po_unit = "ZAK";
//                                             } else if ($mtr_group == "121-302") {
//                                                 $nm_material = "SEMEN CURAH";
//                                                 $po_unit = "TO";
//                                             } else if ($mtr_group == "121-200") {
//                                                 $nm_material = "CLINKER";
//                                                 $po_unit = "TO";
//                                             }

// //                                        $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$sales_org1}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
// //                                        $queryloc = oci_parse($conn, $strsloc);
// //                                        oci_execute($queryloc);
// //                                        $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
//                                             // CEK HARGA DARI BAPI COMMIT HARGA
//                                             if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
//                                                 foreach ($builder as $val) {
//                                                     if ($item_numline == $val['item_number']) {
//                                                         $hargaPO = $val['nilai_harga'];
//                                                         $perPO = $val['per'];
//                                                         $satuanPO = $val['satuan'];
//                                                         $satuan2PO = $val['satuan2'];
//                                                         $currencyPO = $val['currency'];
//                                                     }
//                                                 }
//                                             } else {
//                                                 if ($p == 1) {
//                                                     $datas = $response->Data->Items[$j];
//                                                 } else if ($p == 3) {
//                                                     $datas = $responseSBI2->Data->Items[$j];
//                                                 }
//                                                 $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
//                                                 $perPO = $datas->SAPSalesOrderPerUnit;
//                                                 $satuanPO = $datas->SAPSalesOrderUnit;
//                                                 $satuan2PO = $datas->SAPSalesOrderUnit;
//                                                 $currencyPO = $datas->SAPSalesOrderCurrency;
//                                             }
// //                                    //print_r($builder);
// //                                    //print_r($hargaPO);
// //                                    //print_r($item_numline);

//                                             $fce->POITEM->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POITEM->row["SHORT_TEXT"] = $nm_material;
//                                             $fce->POITEM->row["MATERIAL"] = $material;
//                                             $fce->POITEM->row["PLANT"] = $plantPO;
// //                                    $fce->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];
//                                             $fce->POITEM->row["MATL_GROUP "] = $mtr_group;
//                                             $fce->POITEM->row["QUANTITY"] = $qtyx;
//                                             $fce->POITEM->row["STGE_LOC"] = "D101";
//                                             $fce->POITEM->row["GR_IND"] = "X";
//                                             $fce->POITEM->row["IR_IND"] = "X";
//                                             $fce->POITEM->row["GR_BASEDIV"] = "X";
// //                                        $fce->POITEM->row["FUNDS_CTR"] = "7902000000";
//                                             $fce->POITEM->Append($fce->POITEM->row);

//                                             $fce->POITEMX->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POITEMX->row["SHORT_TEXT"] = "X";
//                                             $fce->POITEMX->row["MATERIAL"] = "X";
//                                             $fce->POITEMX->row["PLANT"] = "X";
// //                                    $fce->POITEMX->row["STGE_LOC"] = "X"; 
//                                             $fce->POITEMX->row["MATL_GROUP "] = "X";
//                                             $fce->POITEMX->row["QUANTITY"] = "X";
//                                             $fce->POITEMX->row["STGE_LOC"] = "X";
//                                             $fce->POITEMX->row["GR_IND"] = "X";
//                                             $fce->POITEMX->row["IR_IND"] = "X";
//                                             $fce->POITEMX->row["GR_BASEDIV"] = "X";
// //                                        $fce->POITEMX->row["FUNDS_CTR"] = "X";
//                                             $fce->POITEMX->Append($fce->POITEMX->row);

//                                             $fce->POTEXTITEM->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POTEXTITEM->row["TEXT_ID"] = "F01";
//                                             $fce->POTEXTITEM->row["TEXT_FORM"] = "/";
//                                             $fce->POTEXTITEM->row["TEXT_LINE"] = "SEMEN PPC";
//                                             $fce->POTEXTITEM->Append($fce->POTEXTITEM->row);

//                                             $fce->POSCHEDULE->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POSCHEDULE->row["SCHED_LINE"] = "0001";
//                                             $fce->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
//                                             $fce->POSCHEDULE->row["QUANTITY "] = $qtyx;
//                                             $fce->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
//                                             $fce->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
//                                             $fce->POSCHEDULE->Append($fce->POSCHEDULE->row);

//                                             $fce->POSCHEDULEX->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POSCHEDULEX->row["SCHED_LINE"] = "X";
//                                             $fce->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
//                                             $fce->POSCHEDULEX->row["QUANTITY "] = "X";
//                                             $fce->POSCHEDULEX->row["STAT_DATE"] = "X";
//                                             $fce->POSCHEDULEX->row["PO_DATE"] = "X";
//                                             $fce->POSCHEDULEX->Append($fce->POSCHEDULEX->row);



//                                             $fce->POCOND->row["ITM_NUMBER"] = $item_numlinePO;
//                                             $fce->POCOND->row["COND_ST_NO"] = '001';
//                                             $fce->POCOND->row["COND_TYPE"] = "PBXX";
//                                             $fce->POCOND->row["COND_VALUE"] = $hargaPO;
//                                             $fce->POCOND->row["COND_P_UNT"] = $perPO;
//                                             $fce->POCOND->row["COND_UNIT"] = $satuanPO;
//                                             $fce->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
//                                             $fce->POCOND->row["CURRENCY"] = $currencyPO;
//                                             $fce->POCOND->row["CURRENCY_ISO"] = $currencyPO;
//                                             $fce->POCOND->row["CHANGE_ID"] = "U";
//                                             $fce->POCOND->Append($fce->POCOND->row);

//                                             $fce->POCONDX->row["ITM_NUMBER"] = $item_numlinePO;
//                                             $fce->POCONDX->row["COND_ST_NO"] = '001';
//                                             $fce->POCONDX->row["COND_TYPE"] = "x";
//                                             $fce->POCONDX->row["COND_VALUE"] = "x";
//                                             $fce->POCONDX->row["COND_P_UNT"] = "x";
//                                             $fce->POCONDX->row["COND_UNIT"] = "x";
//                                             $fce->POCONDX->row["COND_UNIT_SO"] = "x";
//                                             $fce->POCONDX->row["CURRENCY"] = "x";
//                                             $fce->POCONDX->row["CURRENCY_ISO"] = "x";
//                                             $fce->POCONDX->row["CHANGE_ID"] = "x";
//                                             $fce->POCONDX->Append($fce->POCONDX->row);
//                                         }
//                                     }


//                                     $fce->Call();

//                                     if ($fce->GetStatus() == SAPRFC_OK) {
//                                         $nopoT = $fce->EXPPURCHASEORDER;
//                                         $fce->RETURN->Reset();
//                                         while ($fce->RETURN->Next()) {
//                                             $tipe = $fce->RETURN->row["TYPE"];
//                                             $msg = $fce->RETURN->row["MESSAGE"];
//                                             $show_ket .= $msg;
//                                             $show_ket .= '<br>';
//                                             if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
//                                                 $next = "N";
//                                             }
//                                         }
//                                         //Commit Transaction
//                                         $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                                         $fce->Call();
//                                     }
//                                     $user_org = $_SESSION['user_org'];

//                                     if ($p == 1) {
//                                         $PO1 = $nopoT;
//                                     } else if ($p == 2) {
//                                         $PO2 = $nopoT;
//                                     } else if ($p == 3) {
//                                         $PO3 = $nopoT;
//                                     }
//                                     //SIMPAN PP ICS KEDUA

//                                     if ($next == "Y" && $p == 1) {
//                                         $sampai = $_POST['jumlah'];
//                                         for ($j = 0; $j <= $sampai - 1; $j++) {
//                                             $idke = "idke" . $j;
//                                             if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                                 $id_dtl = $_POST['com_iddtl' . $j];
//                                                 $item_num1 = $_POST['com_line' . $j];
//                                                 $item_num = $fungsi->linenum($item_num1);
//                                                 $item_numline = $item_num * 10; //'000010'; 
//                                                 $PO_LINE = sprintf("%05d", $item_numline); //'00010';
//                                                 if ($j == 0) {
//                                                     $numline_pertama = sprintf("%06d", $item_numline * 10); //'000010';
//                                                 }
//                                                 $alamat1 = $_POST['com_alamat' . $j];
// //                                        $material = $_POST['com_produk' . $j];
// //                                        $material1 = $_POST['com_produk' . $j];
//                                                 $material = $_POST['com_produk' . $j];
//                                                 $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
//                                                 $querymaterial = oci_parse($conn, $strmaterial);
//                                                 oci_execute($querymaterial);
//                                                 $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


//                                                 if ($p == 1) {
//                                                     $material = $rowmaterial['KD_MATERIAL_OPCO'];
//                                                 } else if ($p == 2) {
//                                                     $material = $rowmaterial['KD_MATERIAL_MD_2'];
//                                                 } else if ($p == 3) {
//                                                     $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
//                                                 }


//                                                 $qty = $_POST['com_qty' . $j];
//                                                 $qtyx = $_POST['com_qtyx' . $j];
//                                                 if ($sales_org == "7900") {
//                                                     $kontrak = $_POST['com_kontrak' . $j];
//                                                 } else {
//                                                     $kontrak = "";
//                                                 }
// //                                                $kontrak = $_POST['com_kontrak' . $j];

//                                                 $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
//                                                 $distrik = $_POST['com_distrik' . $j];
//                                                 $shiptotocek = $_POST['com_shipto' . $j];
                                                
//                                                 $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
//                                                 $queryshipto = oci_parse($conn, $strshipto);
//                                                 oci_execute($queryshipto);
//                                                 $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                                 if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
//                                                     $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
//                                                     $queryshipto = oci_parse($conn, $strshipto);
//                                                     oci_execute($queryshipto);
//                                                     $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                                 }

//                                                 if ($p == 1) {
//                                                     $shipto = $rowshipto['SHIP_TO_OPCO'];
//                                                 } else if ($p == 2) {
//                                                     $shipto = $rowshipto['SHIP_TO_MD_2'];
//                                                 } else if ($p == 3) {
//                                                     $shipto = $rowshipto['SHIP_TO_OPCO_2'];
//                                                 }

//                                                 $shipto = $fungsi->sapcode($shipto);
//                                                 $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
//                                                 $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
//                                                 list($day, $month, $year) = split("-", $tgl_kirimPO);
//                                                 $tgl_kirim = $year . $month . $day;

//                                                 $mtr_group = substr($material, 0, 7);


//                                                 if (($nomorso != "") and ( $qty1 == $qtyx1))
//                                                     $status1 = "APPROVE";
//                                                 else
//                                                     $status1 = "PROCESS";

//                                                 if ($p == 1) {
//                                                     $SO_ICS = $SO1;
//                                                 } else if ($p == 2) {
//                                                     $SO_ICS = $SO2;
//                                                 } else if ($p == 3) {
//                                                     $SO_ICS = $SO3;
//                                                 }

//                                                 $field_names = array(
//                                                     'NO_PP',
//                                                     'NO_PO',
//                                                     'PO_LINE',
//                                                     'PLANT_PO',
//                                                     'NMPLANT_PO',
//                                                     'KOTA',
//                                                     'NAMA_KOTA',
//                                                     'KODE_PRODUK',
//                                                     'NM_PRODUK',
//                                                     'HARGA_PO',
//                                                     'ORG_PO',
//                                                     'VENDOR',
//                                                     'NM_VENDOR',
//                                                     'QTY_PO',
//                                                     'UOM',
//                                                     'TGL_PO',
//                                                     'STATUS',
//                                                     'NOTE',
//                                                     'CREATE_DATE',
//                                                     'CREATED_BY',
//                                                     'DELETE_MARK',
//                                                     'BULAN',
//                                                     'TAHUN',
//                                                     'QTY_APPROVE',
//                                                     'TGL_PP',
//                                                     'ORG_BY',
//                                                     'VBELN'
//                                                 );
//                                                 $kd_vendor = $vendorFIX;
//                                                 $nopoplus = $nopoT . $PO_LINE;
//                                                 $field_data = array(
//                                                     "$no_pp",
//                                                     "$nopoplus",
//                                                     "$PO_LINE",
//                                                     "$plant1",
//                                                     "$plant1", //belum                   
//                                                     "$distrik",
//                                                     "$distrik", //belum
//                                                     "$material",
//                                                     "$material", //belum
//                                                     "$hargaPO",
//                                                     "$sales_org1",
//                                                     "$kd_vendor",
//                                                     "$kd_vendor", //belum
//                                                     "$qty",
//                                                     "$po_unit",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "$status1",
//                                                     "$ket",
//                                                     "SYSDATE",
//                                                     "$user_name_in",
//                                                     "0",
//                                                     "$month",
//                                                     "$year",
//                                                     "$qtyx",
//                                                     "SYSDATE",
//                                                     "$user_org",
//                                                     "$SO_ICS"
//                                                 );
//                                                 $tablename = "OR_TRANS_HDR_ICS";
//                                                 $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

//                                                 //Oracle Detail
//                                                 $field_names2 = array(
//                                                     'NO_PP',
//                                                     'KODE_PRODUK',
//                                                     'NAMA_PRODUK',
//                                                     'QTY_PP',
//                                                     'QTY_APPROVE',
//                                                     'TGL_KIRIM_PP',
//                                                     'TGL_KIRIM_APPROVE',
//                                                     'TGL_TERIMA',
//                                                     'SHIP_TO',
//                                                     'NAMA_SHIP_TO',
//                                                     'ALAMAT_SHIP_TO',
//                                                     'DELETE_MARK',
//                                                     'STATUS_LINE',
//                                                     'KODE_TUJUAN',
//                                                     'NAMA_TUJUAN',
//                                                     'ITEM_NUMBER',
//                                                     'NO_SO',
//                                                     'FLAG_KAPAL',
//                                                     'KETERANGAN',
//                                                     'NAMA_KAPAL',
//                                                     'NO_KONTRAK',
//                                                     'KD_PROV',
//                                                     'NM_PROV',
//                                                     'UOM',
//                                                     'PLANT',
//                                                     'NM_PLANT',
//                                                     'PRICE_DATE',
//                                                     'SOLD_TO',
//                                                     'INCOTERM',
//                                                     'CARA_BAYAR',
//                                                     'TERM_PAYMENT',
//                                                     'NAMA_SOLD_TO',
//                                                     'BPLANT',
//                                                     'CREATED_BY',
//                                                     'CREATE_DATE',
//                                                     'NAMA_INCOTERM',
//                                                     'SO_TYPE',
//                                                     'NAMA_SO_TYPE',
//                                                     'ROUTE',
//                                                     'NAMA_TOP',
//                                                     'ORG',
//                                                     'PRICELIST',
//                                                     'NAMA_PRICELIST',
//                                                     'NO_KONTRAK_LC',
//                                                     'KD_REASON',
//                                                     'NM_REASON',
//                                                     'ROUTE_TXT',
//                                                     'CHANNEL',
//                                                     'DIVISION',
//                                                     'TIPE_PEMBELIAN',
//                                                     'NO_POH'
//                                                 );

//                                                 $kodedistrik2 = substr($distrik, 0, 2);
//                                                 $kd_provinsi = "10" . $kodedistrik2;
//                                                 $itemnumplus = sprintf("%06d", $item_numline); //'000010';
//                                                 $field_data2 = array(
//                                                     "$no_pp",
//                                                     "$material",
//                                                     "$material",
//                                                     "$qty",
//                                                     "$qtyx",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "instgl_$tgl_terimaPO",
//                                                     "$shipto",
//                                                     "$shipto",
//                                                     "$alamat1", // belum
//                                                     "0",
//                                                     "$status1",
//                                                     "$distrik",
//                                                     "$distrik",
//                                                     "$itemnumplus",
//                                                     "$SO_ICS",
//                                                     "0",
//                                                     "$ket",
//                                                     " ", //belum
//                                                     "$kontrak", //belum
//                                                     "$kd_provinsi", //belum
//                                                     "$kd_provinsi", //belum
//                                                     "$po_unit", //belum
//                                                     "$plant", // plant kedua
//                                                     "$plant",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "$soldto", //kedua
//                                                     "$incoterm1",
//                                                     "$ketbayar", //belum
//                                                     "$top",
//                                                     "$soldto",
//                                                     "$plant", //
//                                                     "$user_name_in",
//                                                     "SYSDATE",
//                                                     "$incoterm2",
//                                                     "$so_type",
//                                                     "$so_type",
//                                                     "$route",
//                                                     "$nama_top",
//                                                     "$sales_org",
//                                                     "$pricelist",
//                                                     "$nama_pricelist",
//                                                     "$lcnum",
//                                                     "$reason",
//                                                     "$nama_reason",
//                                                     "$ship_cond-$route_desc", //belum
//                                                     "$distr_chan",
//                                                     "$division",
//                                                     "D", //belum
//                                                     "$nopoT"
//                                                 );
//                                                 $tablename2 = "OR_TRANS_DTL_ICS";
//                                                 $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
//                                             }
//                                         }
//                                     }
//                                 }
//                             }// bukan sbi
//                         } // IF
//                     }
//                 }
//             }


//             if ($next == 'Y') {
//                 //  INSERT TABEL MAPPING
//                 $fceM = $sap->NewFunction("ZCSD_MAP_SO_MD_FM");
//                 if ($fceM == false) {
//                     $sap->PrintStatus();
//                     exit;
//                 }

//                 for ($ref = 1; $ref <= $perulanganSO; $ref++) {
//                     $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
//                     if ($fce == false) {
//                         $sap->PrintStatus();
//                         exit;
//                     }
//                     if ($ref == 1) {
//                         $fce->I_ZVBELN = $SO1;
//                         $fce->I_VBELN = $SO2;
//                         $SOM = 'SO Mega Distributor 1 : ' . $SO1;
//                         $PO_REF = $PO1;
//                         $SOMAP = $SO1;
//                         $orgMAP = $sales_org1;
//                         $plantMAP = $plant1;
//                     } else if ($ref == 2) {
//                         $fce->I_ZVBELN = $SO2;
//                         $fce->I_VBELN = $SO1;
//                         $SOM = 'SO OPCO 1 : ' . $SO2;
//                         $PO_REF = $PO1;
//                         $SOMAP = $SO2;
//                         $orgMAP = $sales_org2;
//                         $plantMAP = $plant2;
//                     } else if ($ref == 3) {
//                         $fce->I_ZVBELN = $SO3;
//                         $fce->I_VBELN = $SO4;
//                         $SOM = 'SO Mega Distributor 2 : ' . $SO3;
//                         $PO_REF = ($SO3 != '' ? $PO2 : "");
//                         $SOMAP = $SO3;
//                         $orgMAP = $sales_org3;
//                         $plantMAP = $plant3;
//                     } else if ($ref == 4) {
//                         if ($SO3 == "") {
//                             $fce->I_ZVBELN = $SO3;
//                             $fce->I_VBELN = $SO4;
//                         } else {
//                             $fce->I_ZVBELN = $SO4;
//                             $fce->I_VBELN = $SO3;
//                         }
//                         $SOM = 'SO OPCO 2 : ' . $SO4;
//                         $PO_REF = ($SO3 == '' ? $PO2 : $PO3);
//                         $SOMAP = $SO4;
//                         $orgMAP = $sales_org4;
//                         $plantMAP = $plant4;
//                     }
//                     $fce->I_PO = $PO_REF;
//                     $fce->I_LINE_ITEM = $numline_pertama;
//                     $fce->Call();
//                     if ($fce->GetStatus() == SAPRFC_OK) {
//                         //while ( $fce->ZMESSAGE->Next() ){
//                         $tipe = $fce->ZMESSAGE["TYPE"];
//                         $msg = $fce->ZMESSAGE["MESSAGE"];
//                         $show_ket .= $SOM . ' ' . $msg . '<br>';
//                         //}
//                     }


//                     if ($SOMAP != "") {
//                         $fceM->T_DATA->row["NO_PP"] = $no_pp;
//                         $fceM->T_DATA->row["VKORG"] = $orgMAP;
//                         $fceM->T_DATA->row["WERKS"] = $plantMAP;
//                         $fceM->T_DATA->row["NO_SO"] = $SOMAP;
//                         $fceM->T_DATA->row["SEQ_NO"] = $ref * 10;
//                         $fceM->T_DATA->row["NO_PO"] = $PO_REF;
//                         $fceM->T_DATA->Append($fceM->T_DATA->row);
//                     }
//                 }


//                 $fceM->Call();
//                 if ($fceM->GetStatus() == SAPRFC_OK) {
//                     //while ( $fce->ZMESSAGE->Next() ){
// //                    $tipe = $fceM->ZMESSAGE["TYPE"];
// //                    $msg = $fceM->ZMESSAGE["MESSAGE"];
// //                    $show_ket .= $ref . ' ' . $msg . '<br>';
//                     //}
//                 }
//             }

//             //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
//             if ($next == "N") {
//                 $SOSBI = "N";
//                 if ($SOMDNE == "Y") {
//                     $SOSBIK = "Y";
//                 } else {
//                     $SOSBIK = "N";
//                 }
//                 for ($e = 1; $e <= $jerror; $e++) {
//                     $return = "Y";

//                     // CEK SO SBI ATAU TIDAK
//                     $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'";
//                     $querykdven = oci_parse($conn, $strkdven);
//                     oci_execute($querykdven);
//                     $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);
//                     if ($e == 1) {
//                         $noyo = $SO1;
//                         $IDHU = $IDH1;
//                         $SOSBICEK = "N";
//                     } else if ($e == 2) {
//                         $noyo = $SO2;
//                         $IDHU = $IDH2;
//                         if ($rowkdven["COM_OPCO"] == "PTSC" || $rowkdven["COM_OPCO"] == "ID50") {
//                             $SOSBICEK = "Y";
//                         } else {
//                             $SOSBICEK = "N";
//                         }
//                     } else if ($e == 3) {
//                         $noyo = $SO3;
//                         $IDHU = $IDH3;
//                         $SOSBICEK = "N";
//                     } else if ($e == 4) {
//                         $noyo = $SO4;
//                         $IDHU = $IDH4;
//                         if ($rowkdven["COM_OPCO_2"] == "PTSC" || $rowkdven["COM_OPCO_2"] == "ID50") {
//                             $SOSBICEK = "Y";
//                         } else {
//                             $SOSBICEK = "N";
//                         }
//                     }

//                     if ($SOSBICEK == 'Y') {
//                         if ($e == 2 || $e == 4) {
//                             if ($e == 2) {
//                                 $TGLend = $tgl_deleteSO2;
//                             } else if ($e == 4) {
//                                 $TGLend = $tgl_deleteSO4;
//                             }

//                             $url = 'https://sip.solusibangunindonesia.com/APIMD/DeleteSalesOrder';
//                             $data = array(
//                                 'Token' => 'aSsMx7GV0HFGzlufM4DH',
//                                 'SystemID' => 'PASSO',
//                                 'SAPSalesOrderNumber' => $noyo,
//                                 'SAPCreatedDate' => $TGLend,
//                             );
//                             $options = array(
//                                 'http' => array(
//                                     'header' => "Content-type: application/json\r\n",
//                                     'method' => 'POST',
//                                     'content' => json_encode($data),
//                                 )
//                             );

//                             $context = stream_context_create($options);
//                             $result = file_get_contents($url, false, $context);
//                             $response = json_decode($result);
//                             $status = $response->Status;
//                             $Message = $response->Message;
//                             if ($status != '1') {
//                                 $return = 'N';
//                             }
//                         }
//                     } else {
//                         $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
//                         if ($fce == false) {
//                             $sap->PrintStatus();
//                             exit;
//                         }

//                         //header entri    
//                         $fce->SALESDOCUMENT = $noyo; //"ZOR";
//                         $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";

//                         $fce->Call();

//                         if ($fce->GetStatus() == SAPRFC_OK) {
//                             $fce->RETURN->Reset();
//                             while ($fce->RETURN->Next()) {
//                                 $msg .= '<div align="center">';
//                                 $error = $fce->RETURN->row["TYPE"];
//                                 $msg .= $fce->RETURN->row["MESSAGE"];

//                                 if ($error == 'A' || $error == 'X' || $error == 'E') {
//                                     $return = 'N';
//                                 }
//                             }
//                             $msg .= '<br></div>';
//                             //Commit Transaction
//                             $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                             $fce->Call();
//                         } else {
//                             $fce->PrintStatus();
//                         }
//                     }

//                     if ($return == 'Y') {
//                         $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_HDR_ICS SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE VBELN='$noyo'";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_DTL_ICS SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
//                     } else {
//                         $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
//                     }
//                 }
//             }

//             $field_names = array(
//                 'SEND_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN_DETAIL', 'TGL'
//             );
//             $field_data = array(
//                 "SI", "$user_name_in", "$no_pp", "$show_ket", "SYSDATE"
//             );
//             $tablename = "ZMD_LOG_SBI";
//             $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

//             $fce->Close();
//             $sap->Close();
//         }

//         //================================================================

//         $habis = "approve_pryk.php";
//         break;



    //
    //===============================================
    case "buatsoprykmd":

        // CEK MAPPING PLANT ADA ATAU TIDAK
        $plantcek = $_POST['plant'];
        $str = "SELECT * FROM ZMD_MAPPING_PLANT
        WHERE PLANT_MD = '{$plantcek}' AND  DEL=0
        ";
        $query = oci_parse($conn, $str);
        oci_execute($query);
        $row = oci_fetch_array($query, OCI_ASSOC);
        $lanjut = 'Y';
        $next = 'Y';
        $SO1 = '';
        $IDH1 = '';
        $SO2 = '';
        $IDH2 = '';
        $SO3 = '';
        $IDH3 = '';
        $SO4 = '';
        $IDH4 = '';
        $jerror = 0;
        $SOMDNE = "N";

        if (count($row) > 0) {
            // CEK MAPPING CUSTOMER ADA ATAU TIDAK
            $soldtocek = $_POST['distr_id'];
            $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'  AND DEL = 0";
            $querysoldto = oci_parse($conn, $strsoldto);
            oci_execute($querysoldto);
            $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
            if (count($rowsoldto) < 1) {
                $lanjut = 'N';
                $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
            }
        } else {
            $lanjut = 'N';
            $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
            ;
        }

        // CEK ICS
        if ($row["COM_MD_2"] != "" && $row["PLANT_MD_2"] != "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 3;
            $ics = "Y";
            $loncat = "N";
        } else if ($row["COM_MD_2"] == "" && $row["PLANT_MD_2"] == "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
            $perulangan = 5;
            $perulanganSO = 4;
            $perulanganPO = 2;
            $ics = "Y";
            $loncat = "Y"; /// MD @ tidak di pakai
        } else {
            $perulangan = 3;
            $perulanganSO = 2;
            $perulanganPO = 1;
            $ics = "N";
            $loncat = "N";
        }


        $no_pp = $fungsi->or_new_pp_number($conn);

        // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
        if ($lanjut == 'Y') {
            // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
            for ($ul = 1; $ul <= $perulangan; $ul++) {

                if ($next == 'Y') {
                    $incoterm1 = $_POST['incoterm'];
                    $incoterm2 = $_POST['nama_incoterm'];
                    $route     = $_POST['route'];
                    $top       = $_POST['top'];
                    $nama_top  = $_POST['nama_top'];
                    if ($ul == 1) {
                        $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $soldto = $_POST['sold_to'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
                        $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2
                    } else if ($ul == 2) {
                        $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
                        $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2
                        $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org2 = $row['COM_OPCO'];
                        $plant2 = $row['PLANT_OPCO'];
                        $incotermPO1 = $incoterm1;
                        $incotermPO12 = $incoterm2;
                    } else if ($ul == 3 && $ics == "Y") {
                        $sales_org = $row['COM_MD_2'];
                        $plant = $row['PLANT_MD_2'];
                        $soldto = $rowsoldto['SOLD_TO_MD_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org3 = $row['COM_MD_2'];
                        $plant3 = $row['PLANT_MD_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
                        //penambahan rute dan TOP
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        //penambahan rute top
                        
                    } else if ($ul == 4 && $ics == "Y") {
                        $sales_org = $row['COM_OPCO_2'];
                        $plant = $row['PLANT_OPCO_2'];
                        $soldto = $rowsoldto['SOLD_TO_OPCO_2'];
                        $soldto = $fungsi->sapcode($soldto);
                        $sales_org4 = $row['COM_OPCO_2'];
                        $plant4 = $row['PLANT_OPCO_2'];
                        $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
                        $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
                        //penambahan rute dan TOP
                        $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
                        if($incoterm1 == 'FOT'){
                           $route = 'ZR0003'; 
                           
                        }else if($incoterm1 == 'FRC'){
                           $route = 'ZR0002';  
                           
                        }
                        $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
                        $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
                        $topPO2    = $top;
                        //penambahan rute top
                        
                        $incotermPO2 = $incoterm1;
                        $incotermPO22 = $incoterm2;
                    }

                    //data header so
                    $pesan_telegram = "";
                    $user_name_in = $_SESSION['user_name'];
                    $idh = $_POST['idh'];
                    $iddtl = $_POST['iddtl'];
                    $no_ppvalpryk = trim($_POST['no_pp']);
                    $so_type = $_POST['so_type'];
                    $nama_so_type = $_POST['nama_so_type'];

                    if ($so_type == 'ZEX') {
                        $distr_chan = "30";
                    } elseif ($so_type == 'ZPR') {
                        if ($sales_org == '2000') {
                            $distr_chan = "10";
                        } else if ($sales_org == '3000' || $sales_org == '5000' || $sales_org == '7000' || $sales_org == '7900' || $sales_org == '4000') { // tambahan pak yusuf untuk bisa memilih dist channel proyek MD
                            $distr_chan = $_POST['channels'];
                        } else {
                            $distr_chan = "50";
                        }
                    } else {
                        $distr_chan = "10";
                    }
                    $division = "00";
                    $dlv_block = "";
                    $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
                    if ($distr_chancondi != '') {
                        $distr_chan = $distr_chancondi;
                    }

                    $distr_chanPO1 = $distr_chan;
                    if ($ul == 3 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                    } else if ($ul == 4 && $ics == "Y") {
                        $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
                        $distr_chanPO2 = $distr_chan;
                    }
                    $nama_sold_to = $_POST['nama_sold_to'];
                    $tgl_pp = date("d-m-Y");
                    list($day, $month, $year) = split("-", $tgl_pp);
                    $tgl_pp = $year . $month . $day;
                    //$tanggal=gmdate("Ymd",time()+60*60*7);
                    $top = $_POST['top'];
                    $nama_top = $_POST['nama_top'];
                    $reason = $_POST['reason'];
                    $nama_reason = $_POST['nama_reason'];
                    $nama_plant = $_POST['nama_plant'];
                    $route = $_POST['route'];
                    $pricelist = $_POST['pricelist'];
                    $nama_pricelist = $_POST['nama_pricelist'];
                    $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
                    $ket = $_POST['nm_kapal'];
                    $kontrakh = $_POST['com_kontrak0'];
                    $pesan_telegram .= "PP Proyek $no_ppvalpryk\n";
                    //call bapi sales order sap
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        $sap->PrintStatus();
                        exit;
                    }


                    if ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) {
                        $COM = 'MD';
                    } else {
                        $COM = 'SBI';
                    }

                    if ($ul <= $perulanganSO && $COM == 'MD') {


                        if ($loncat == "N") {
                            $gass = "Y";
                        } else if ($loncat == "Y") {
                            if ($ul == 3) {
                                $gass = "N";
                            } else {
                                $gass = "Y";
                            }
                        }

                        if ($gass == "Y") { // loncat tidak membuat SO MD 2 karena tidak di mammping plant

                                // SOCC v2
                                $looping_end=1;
                                $movetestrun='Z';
                                for ($looping = 0; $looping <= $looping_end; $looping++) {
                                if($movetestrun!='X'){
                                ////////////                            

                            $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
                            if ($fce == false) {
                                $sap->PrintStatus();
                                exit;
                            }


                            //detail entri item'
                            $sampai = $_POST['jumlah'];
                            $shipto_awal = '';
                            for ($j = 0; $j <= $sampai - 1; $j++) {
                                $idke = "idke" . $j;
                                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                    $shipto_awal = $_POST['com_shipto0'];
                                    $material = $_POST['com_produk' . $j];
                                    if ($ul == 1) {
                                        $shipto = $_POST['com_shipto' . $j];     // GANTI BERDASARKAN MAPPING CUSTOMER 
                                        $material1 = $_POST['com_produk' . $j];
                                    } else if ($ul == 2 || $ul == 3 || $ul == 4) {
                                        $shiptotocek = $_POST['com_shipto' . $j];
                                        
                                        $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                        $queryshipto = oci_parse($conn, $strshipto);
                                        oci_execute($queryshipto);
                                        $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                        if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                            $queryshipto = oci_parse($conn, $strshipto);
                                            oci_execute($queryshipto);
                                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                        }

                                        if ($ul == 2) {
                                            $shipto = $rowshipto['SHIP_TO_OPCO'];
                                            $soldto = $rowshipto['SOLD_TO_OPCO'];
                                        } else if ($ul == 3) {
                                            $shipto = $rowshipto['SHIP_TO_MD_2'];
                                            $soldto = $rowshipto['SOLD_TO_MD_2'];
                                        } else if ($ul == 4) {
                                            $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                            $soldto = $rowshipto['SOLD_TO_OPCO_2'];
                                        }



                                        $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
                                        $querymaterial = oci_parse($conn, $strmaterial);
                                        oci_execute($querymaterial);
                                        $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                        if ($ul == 2) {
                                            $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                        } else if ($ul == 3) {
                                            $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                        } else if ($ul == 4) {
                                            $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                        }
                                    }


                                    $id_dtl = $_POST['com_iddtl' . $j];
                                    $item_num1 = $_POST['com_line' . $j];
                                    $item_num = $fungsi->linenum($item_num1);
                                    $distrik = $_POST['com_distrik' . $j];
                                    $qty = $_POST['com_qty' . $j];
                                    $qtyx = $_POST['com_qtyx' . $j];
                                    $tgl_kirim = $_POST['com_tgl_kirim' . $j];
                                    list($day, $month, $year) = split("-", $tgl_kirim);
                                    $tgl_kirim = $year . $month . $day;
                                    $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                    $kontrak = $_POST['com_kontrak' . $j];
                                    $nomor = $fungsi->sapcode($kontrak);
                                        //////////////////////////////////////////// proyek SOCC v.2
                                        // $plant_socc = $_POST['plant'];
                                        // $kode_distrik_socc = $_POST['com_distrik' . $j];
                                        // $material_for_socc = substr($_POST['com_produk' . $j],0,7);
                                        // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                                        // $tgl_terima_leadtime=$tgl_terima_leadtime;
                                        // list($day, $month, $year) = split("-", $tgl_terima_leadtime);
                                        // $tgl_terima_leadtime = $year . $month . $day;

                                        // $tgl_fdate_socc=Date('d-m-Y');
                                        // list($day, $month, $year) = split("-", $tgl_fdate_socc);
                                        // $tgl_fdate_socc = $year . $month . $day;
                    
                                        $tgl_terima_leadtime = $_POST['com_tgl_terima' . $j];
                                        list($day, $month, $year) = split("-", $tgl_terima_leadtime);
                                        $tgl_terima_leadtime = $year . $month . $day;
                    
                                        $tgl_fdate_socc=$tgl_kirim;

                                        ///////////////////////////////////////////                                    

                                    if ($qtyx != $qty) {
                                        $ada = $ada + 1;
                                    }

                                    if ($so_type == 'ZFC') {
                                            if($sales_org=='7900' || $sales_org=='7000'){
                                                $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";    // Tambahan MD 
                                            }    
                                    }
                                    $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                    $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                                    //$fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $item_cat;
                                    $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                                    $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
                                    $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                                    $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                                    if ($kontrak != '' && $sales_org == "7900") {
                                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                                    }
//                                    if ($kontrak != '' ) {
//                                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
//                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
//                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
//                                    }
                                    $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                                    //detail entri schedule n qty'
                                    $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                    $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                                    // $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                                        //////////////////////////////////////////////////////////// proyek SOCC V.2
                                        $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_fdate_socc;
                                        ///////////////////////////////////////////////////////////                                    
                                    $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                                    $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                    $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                                    $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                                    $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                                    $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                                    //detail entri distributor dan agen
                                    if ($j == 0) {
                                        $item_num = '000000';
                                    } else {
                                        $item_num = $item_num;
                                    }
//                                    if ($sales_org == '3000') {
//                                        if ($sampai == 1) {
//                                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
//                                        } else {
//                                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                        }
//                                    } else {
//                                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                    }
                                    $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                                    $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                                    $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                                    $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                                }
                            }

                            //header entri
                            if ($sales_org == '3000') {
                                $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
                                if ($fce1 == false) {
                                    $sap->PrintStatus();
                                    exit;
                                }

                                //header entri

                                $fce1->ZNMORG = 3000;
                                $fce1->ZKUNNR = $shipto;
                                $fce1->Call();
                                if ($fce1->GetStatus() == SAPRFC_OK) {
                                    $fce1->RETURN_DATA->Reset();
                                    while ($fce1->RETURN_DATA->Next()) {
                                        $kode = $fce1->RETURN_DATA->row["VKGRP"];
                                    }
                                }
                                $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
                            }

                            //penambahan sales office
                            $dt_shipto = "SELECT BZIRK, VKBUR, VKGRP FROM RFC_Z_ZCSD_SHIPTO WHERE KUNN2 = '{$shipto}' AND ROWNUM =1";
//                            echo $dt_shipto;
                            $dt_shipto_q = oci_parse($conn, $dt_shipto);
                            oci_execute($dt_shipto_q);
                            $row_dt_shipto = oci_fetch_array($dt_shipto_q, OCI_ASSOC);

                            $fce->ORDER_HEADER_IN["SALES_GRP"] = $row_dt_shipto["VKGRP"];
                            $fce->ORDER_HEADER_IN["SALES_DIST"] = $row_dt_shipto["BZIRK"];
                            $fce->ORDER_HEADER_IN["SALES_OFF"] = $row_dt_shipto["VKBUR"];
                            // end penambahan sales office

                            if ($so_type == 'ZFC') {
                                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
                            } else {
                                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                            }
                            $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
                            $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
                            $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
                            $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00"; 
                            $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_ppvalpryk; //"Z1";
                            $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
                            $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
                            $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
                            $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
                            $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
                            $fce->ORDER_HEADER_IN["NAME"] = $ket;
                            $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
                            $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
                                // SOCC V2
                                $fce->ORDER_HEADER_IN["TP_DATE"] = 'D';
                                $fce->ORDER_HEADER_IN["REQ_DATE_H"] = $tgl_terima_leadtime;  
                                /////                            
                            if ($lcnum != '') {
                                $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                                $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
                            }
                            
                            if ($kontrakh != '' && $sales_org == "7900") {
                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
                            }
//                            if ($kontrakh != ''  ) {
//                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
//                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
//                            }


                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto_awal;
                            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);


                            if ($sales_org == "7900" || $sales_org == "7000") {
                                $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
                                $querytax = oci_parse($conn, $strtax);
                                oci_execute($querytax);
                                $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
                                if (ISSET($rowtax["KD_SOLD_TO"])) {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                } else {
                                    if ($so_type == 'ZFC') {
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
                                    }else{
                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1";    
                                    }
                                }

//                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
                            }

                        //    echo '<pre>';
                        //    print_r($fce);
                        //    echo '</pre>';
                                // SOCC V.2
                                if($looping=='0' or $looping==0){
                                    // $show_ket .= "item_cat $item_cat / nomor_kontrak $kontrakh / produk $produk<br>";
                                    // $show_ket .= "item_cat $item_cat / nomor_kontrak2 $kontrak / produk $produk<br>";
                                    $fce->TESTRUN = "X";
                                }
                                //
                            $fce->Call();
                            if ($fce->GetStatus() == SAPRFC_OK) {
                                $nomorso = $fce->SALESDOCUMENT;
                                $fce->RETURN->Reset();
                                while ($fce->RETURN->Next()) {
                                    $tipe = $fce->RETURN->row["TYPE"];
                                    $msg = $fce->RETURN->row["MESSAGE"];
                                    // if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                    //     $show_ket .= $msg;
                                    //     $show_ket .= '<br>';
                                    //     $next = "N";
                                    // }
                                        //SOCC V.2
                                        if ($tipe != 'S') {
                                            // if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                                $show_ket .= $msg;
                                                $show_ket .= '<br>';
                                                $next = "N";
                                                $show_ket .= 'SO long text';
                                                $show_ket .= '<br>';
                                                $movetestrun='X';
                                                $nomorso = '';
                                            }
                                            ///////////////                                    
                                }

                                //Commit Transaction
                                $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            }
                        }   
                        // $looping +=1;
                        }                            

                            //Update SO
                            if ($nomorso != '' && $j > 0) {
                                sleep(5); //seconds to wait..   
                                $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                                $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                                $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                                $fce->Call();

                                //Commit Transaction
                                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                $fce->Call();

                                $show_ket .= $ul . "Sales Order telah dibuat dengan nomor : $nomorso <br>";
                                $pesan_telegram .= "Approve dengan no SO $nomorso\n";
                            }




                            if ($sales_org == 4000) {
                                botTelegram('-394888712', $pesan_telegram);
                            }

                            // Setelah SO ter create
                            if ($ul == 1) {
                                $SO1 = $nomorso;
                                $IDH1 = $idh;
                            } else if ($ul == 2) {
                                $SO2 = $nomorso;
                                $IDH2 = $idh;
                            } else if ($ul == 3) {
                                $SO3 = $nomorso;
                                $IDH3 = $idh;
                            } else if ($ul == 4) {
                                $SO4 = $nomorso;
                                $IDH4 = $idh;
                            }

                            if ($next == "Y" && $ul == 1) {

                                if (($nomorso != "") and ( $ada == 0))
                                    $status = "APPROVE";
                                else
                                    $status = "PROCESS";
                                //update data header
                                $field_names = array('STATUS', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON');
                                $field_data = array("$status", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$nomor", "$reason", "$nama_reason");
                                $tablename = "OR_TRANS_HDR";
                                $field_id = array('ID');
                                $value_id = array("$idh");
                                $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                                // update data detail
                                $sampai1 = $_POST['jumlah'];
                                for ($k = 0; $k <= $sampai1; $k++) {
                                    $idke = "idke" . $k;
                                    if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                        $id_dtl1 = $_POST['com_iddtl' . $k];
                                        $qty1 = $_POST['com_qty' . $k];
                                        $qtyx1 = $_POST['com_qtyx' . $k];
                                        $kode_distrik = $_POST['com_distrik' . $k];
                                        $kontrak = $_POST['com_kontrak' . $k];


                                        if ($sales_org == "7900") {
                                            $nomor = $fungsi->sapcode($kontrak);
                                        } else {
                                            $nomor = "";
                                        }
//                                            $nomor = $fungsi->sapcode($kontrak);
                                            /////////////////////////////////////////// proyek SOCC V.2
                                        $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                                        $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                                            //old
                                            //-----------------------------------------------------------------------//
                                            //new
                                            // $tgl_terima1 = $_POST['com_tgl_terima' . $k];
                                            // if((date('H:i')>='15:00')){
                                            //     $tgl_terima_leadtime = date('d-m-Y', strtotime($tgl_terima_leadtime. ' - 1 days'));
                                            // }
                                            // $tglterimaleadtime = date('d-m-Y', strtotime($tgl_terima_leadtime));
                                            // $plant_socc = $_POST['plant'];
                                            // $kode_distrik_socc = $_POST['com_distrik' . $k];
                                            // $material_for_socc = substr($_POST['com_produk' . $k],0,7);
                                            // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
                                            ///////////////////////////////////////////
                                        if (($nomorso != "") and ( $qty1 == $qtyx1)){
                                            $status1 = "APPROVE";
                                            $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT');
                                            $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$nomor", "$plant", "$nama_plant");
                                        }
                                        else{
                                            $status1 = "PROCESS";
                                            $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT');
                                            $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$nomor", "$plant", "$nama_plant");
                                        }


                                        $tablename = "OR_TRANS_DTL";
                                        $field_id = array('ID');
                                        $value_id = array("$id_dtl1");
                                        $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                                        if ($nomorso != "") {
                                            $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
                                            $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
                                            $tablenamefrom = "OR_TRANS_DTL";
                                            $tablenameto = "OR_TRANS_APP";
                                            $field_id1 = array('ID');
                                            $value_id1 = array("$id_dtl1");
                                            $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);
                                        }
                                    }
                                }
                            }


                            //Khusus Proyek SI                
                            if ($so_type == 'ZPR' && $nomorso != "" && ($sales_org == '7000' || $sales_org = '2000' || $sales_org = '5000' || $sales_org = '7900')) {
                                sleep(3);
                                list($dayFG, $monthFG, $yearFG) = split("-", $tgl_kirim1);
                                $tgl_kirimFormat = $yearFG . $monthFG . $dayFG;
                                $sqlproyek = "
                                select ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1,SUM(QTY_PPK) as QTY_PP from(
                                SELECT OR_TRANS_HDR_V.*, to_char(TGL_PP,'DD-MM-YYYY') as TGL_PP1,
                                to_char(TGL_KIRIM_PP,'YYYYMMDD') as TGL_KIRIM_PP1,
                                to_char(TGL_KIRIM_APPROVE,'DD-MM-YYYY') as TGL_KIRIM_APPROVE1,
                                to_char(TGL_TERIMA,'DD-MM-YYYY') as TGL_TERIMA1,
                                case when KODE_PRODUK in ('121-301-0110','121-301-0050') then (QTY_PP*40)/1000
                                when KODE_PRODUK in ( '121-301-0020','121-301-0060','121-301-0056') then (QTY_PP*50)/1000
                                else QTY_PP
                                end as QTY_PPK,
                                substr(KODE_PRODUK,0,7) as TIPE_PRODUK
                                FROM OR_TRANS_HDR_V
                                WHERE DELETE_MARK = '0'
                                AND SO_TYPE='$so_type'
                                AND KD_REASON is null
                                AND PLANT_ASAL is not null
                                AND TIPEPP='NEW PROYEK' 
                                AND ORG='$sales_org'
                                AND SOLD_TO='$soldto'
                                AND PLANT_ASAL='$plant'
                                AND NO_PP='$no_ppvalpryk'
                                AND STATUS_LINE='APPROVE'
                                ORDER BY NO_PP ASC
                                )tb1
                                group by ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1
                            ";
                                $query_proyek = oci_parse($conn, $sqlproyek);
                                oci_execute($query_proyek);
                                while ($row_proyek = oci_fetch_array($query_proyek)) {
                                    $ORGto = $row_proyek['ORG'];
                                    $SOLD_TOto = $row_proyek['SOLD_TO'];
                                    $PLANT_ASALto = $row_proyek['PLANT_ASAL'];
                                    $TIPE_PRODUKto = $row_proyek['TIPE_PRODUK'];
                                    $KODE_TUJUANto = $row_proyek['KODE_TUJUAN'];
                                    $TGL_KIRIM_PP1to = $row_proyek['TGL_KIRIM_PP1'];
                                    $QTY_PPto = $row_proyek['QTY_PP'];
                                    $sqlcek = "
                                select * from (
                                select tb1.*,
                                case when PLANT is null then (select PLANT from ZSD_MAPPING_PLANTKOTA where DELETE_MARK=0 and DISTRIK=tb1.DISTRIK and ORG=tb1.ORG and rownum=1)
                                else PLANT
                                end as PLANTSET
                                from ZSD_TARGET_HARIAN tb1 where ORG = '$ORGto' and DISTRIK = '$KODE_TUJUANto' 
                                and DISTRIBUTOR = '$SOLD_TOto' and
                                TIPE = '$TIPE_PRODUKto' and
                                to_char(TANGGAL_TARGET, 'YYYYMMDD') ='$TGL_KIRIM_PP1to'
                                )
                                where PLANTSET='$PLANT_ASALto'
                                ";
                                    $query_cek = oci_parse($conn, $sqlcek);
                                    oci_execute($query_cek);
                                    $row_cek = oci_fetch_array($query_cek);
                                    if ($row_cek['ID'] == '') {
                                        //insert                            
                                        $sql2 = "insert into ZSD_TARGET_HARIAN(ORG, TIPE, DISTRIK, DISTRIBUTOR, TANGGAL_TARGET,
                                             PLANT, TARGET, AKTIF_MARK, CREATE_BY, CREATE_DATE) 
                                             values ('" . $ORGto . "','" . $TIPE_PRODUKto . "', '" . $KODE_TUJUANto . "', '" . $SOLD_TOto . "', to_date('" . $TGL_KIRIM_PP1to . "', 'YYYYMMDD') ,
                                            '" . $PLANT_ASALto . "', '" . $QTY_PPto . "','0', '$user_name_in', sysdate)";
                                        $query2 = oci_parse($conn, $sql2);
                                        $ins = oci_execute($query2);
                                    } else {
                                        //update
                                        $sql1 = "update ZSD_TARGET_HARIAN set target = target+'" . $QTY_PPto . "', AKTIF_MARK='0', lastupdate_by = '$user_name_in', 
                                             lastupdate_date = sysdate
                                             where ID = '" . $row_cek['ID'] . "'";
                                        $query1 = oci_parse($conn, $sql1);
                                        $upd = oci_execute($query1);
                                    }
                                }

                                //update SAP	
                                $sap = new SAPConnection();
                                $sap->Connect("../include/sapclasses/logon_data.conf");
                                if ($sap->GetStatus() == SAPRFC_OK)
                                    $sap->Open();
                                if ($sap->GetStatus() != SAPRFC_OK) {
                                    $sap->PrintStatus();
                                    exit;
                                }

                                $fce = $sap->NewFunction("ZAPPSD_INS_TARGET_DAY");
                                if ($fce == false) {
                                    $sap->PrintStatus();
                                    exit;
                                }

                                $waktuupdatPry = date("Ymd");
                                $sqlproyek2 = "
                                select tbty.*,to_char(TANGGAL_TARGET, 'YYYYMMDD') as TANGGAL_TARGETF from ZSD_TARGET_HARIAN tbty where ORG='$sales_org'
                                and DISTRIBUTOR='$soldto' and AKTIF_MARK=0
                                and (to_char(CREATE_DATE, 'YYYYMMDD') ='$waktuupdatPry' or to_char(LASTUPDATE_DATE, 'YYYYMMDD') ='$waktuupdatPry')
                            ";
                                $query_proyek2 = oci_parse($conn, $sqlproyek2);
                                oci_execute($query_proyek2);
                                $pppp = 0;
                                while ($row_proyek2 = oci_fetch_array($query_proyek2)) {

                                    $pppp++;

                                    $ORGIto = $row_proyek2['ORG'];
                                    $DISTRIBUTto = $row_proyek2['DISTRIBUTOR'];
                                    $PLANTto = $row_proyek2['PLANT'];
                                    $TIPEto = $row_proyek2['TIPE'];
                                    $KOTAto = $row_proyek2['DISTRIK'];
                                    $TGL_TARGETto = $row_proyek2['TANGGAL_TARGETF'];
                                    $Targetto = $row_proyek2['TARGET'];

                                    $fce->T_DATA->row["NMORG"] = $ORGIto;
                                    $fce->T_DATA->row["NMPLAN"] = $PLANTto;
                                    $fce->T_DATA->row["DISTRIK"] = $KOTAto;
                                    $fce->T_DATA->row["DISTRIBUTOR"] = $DISTRIBUTto;
                                    $fce->T_DATA->row["TIPE_SEMEN"] = $TIPEto;
                                    $fce->T_DATA->row["TARGET_DATE"] = $TGL_TARGETto;
                                    $fce->T_DATA->row["VOLUME"] = $Targetto;
                                    $fce->T_DATA->row["ZDELETE"] = '0';
                                    $fce->T_DATA->row["CREATE_BY"] = $user_name_in;
                                    $fce->T_DATA->row["CREATE_DATE"] = $waktuupdatPry;
                                    $fce->T_DATA->row["LAST_UPD_BY"] = $user_name_in;
                                    $fce->T_DATA->row["LAST_UPD_DATE"] = $waktuupdatPry;
                                    $fce->T_DATA->Append($fce->T_DATA->row);
                                }
                                if ($pppp > 0) {
                                    $fce->Call();
                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $fce->T_MESSAGE->Reset();
                                        $i = 0;
                                        $insert_sap = 0;
                                        $gagal = array();
                                        while ($fce->T_MESSAGE->Next()) {
                                            if ($fce->T_MESSAGE->row["TYPE"] == "W" || $fce->T_MESSAGE->row["TYPE"] == "E") {
                                                $gagal[] = $i + 1;
                                            } else if ($fce->T_MESSAGE->row["TYPE"] == "S")
                                                $insert_sap++;

                                            $i++;
                                        }
                                    }
                                }
                            }
                        }
                        $jerror += 1;
                    }else if ($ul == 2 || $ul == 4 && $COM == "SBI") {

                        //print_r($ul);
                        //print_r("<br />");
                        // build array material
                        $Tmaterial = array();
                        $Tmaterial['MaterialCode'] = array();
                        $Tmaterial['PlantCode'] = array();
                        $Tmaterial['Qty'] = array();
                        $Tmaterial['QtyUnit'] = array();
                        $Tmaterial['ScheduleLine'] = array();
                        $Tmaterial['RequestDeliveryDate'] = array();
                        $Tmaterial['RequestDeliveryQty'] = array();
                        $Dmaterial = array();
                        for ($j = 0; $j <= $sampai - 1; $j++) {
                            $material = $_POST['com_produk' . $j];
                            $strmat = "SELECT CAST(NTGEW AS float) as BERAT, A.* FROM RFC_Z_ZCSD_LIST_MAT_SALES_2 A WHERE VKORG = '{$sales_org1}' AND MATNR = '{$material}'  AND WERKS = '{$plant1}'";
                            $querymat = oci_parse($conn, $strmat);
                            oci_execute($querymat);
                            $rowmat = oci_fetch_array($querymat, OCI_ASSOC);
                            if (count($rowmat) > 0 && $rowmat['MEINS'] == "ZAK") {
                                $qty = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
                                $qtyx = ( intval($_POST['com_qtyx' . $j]) * $rowmat['BERAT'] ) / 1000;
                            } else {
                                $qty = $_POST['com_qty' . $j];
                                $qtyx = $_POST['com_qtyx' . $j];
                            }

                            $shiptotocek = $_POST['com_shipto' . $j];
                            $item_numline = sprintf("%04d", $j + 1);
                            $tanggall = $_POST['com_tgl_kirim' . $j];
                            list($day, $month, $year) = split("-", $tanggall);
                            $tgl_kirim = $year . "-" . $month . "-" . $day;

                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                            $querymaterial = oci_parse($conn, $strmaterial);
                            oci_execute($querymaterial);
                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);

                            if ($ul == 2) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO"];
                            } else if ($ul == 4) {
                                $materialsbi = $rowmaterial["KD_MATERIAL_OPCO_2"];
                            }
                            $Tmaterial['MaterialCode'] = $materialsbi;
                            $Tmaterial['PlantCode'] = $plant;
                            $Tmaterial['Qty'] = $qty;
                            $Tmaterial['QtyUnit'] = "TO";
                            $Tmaterial['ScheduleLine'] = $item_numline;
                            $Tmaterial['RequestDeliveryDate'] = $tgl_kirim;
                            $Tmaterial['RequestDeliveryQty'] = $qtyx;
                            $Dmaterial[] = $Tmaterial;
                        }

                        //print_r($so_type."<br />");
                        //print_r($sales_org."<br />");
                        $strorder = "SELECT * FROM ZMD_MAPPING_ORDER WHERE ORDER_TYPE_MD = '{$so_type}' AND COMPANY_OPCO = '{$sales_org}' AND DEL = 0";
                        $queryorder = oci_parse($conn, $strorder);
                        oci_execute($queryorder);
                        $roworder = oci_fetch_array($queryorder, OCI_ASSOC);

                        list($day, $month, $year) = split("-", $tanggall);
                        $tgl_kirim = $year . $month . $day;

                        
                        $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                        $queryshipto = oci_parse($conn, $strshipto);
                        oci_execute($queryshipto);
                        $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                        if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                            $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                            $queryshipto = oci_parse($conn, $strshipto);
                            oci_execute($queryshipto);
                            $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                        }
                        if ($ul == 2) {
                            $shipto = $rowshipto['SHIP_TO_OPCO'];
                            $SOMD = $SO1;
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO'];
                        } else if ($ul == 4) {
                            $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                            $SOMD = $SO3;
                            $soldtosbi = $rowshipto['SOLD_TO_OPCO_2'];
                        }

                        $tgl_pp = $_POST['tgl_pp'];

                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_ppPO = $year . "-" . $month . "-" . $day . " 00:00:00";
                        $tgl_pp = $tgl_fdate_socc;
                        list($day, $month, $year) = split("-", $tgl_pp);
                        $tgl_pp = $year . $month . $day;


                        if ($sales_org == "PTSC") {
                            $sales_organization = "SCBD";
                        } else if ($sales_org == "ID50") {
                            $sales_organization = "ID11";
                        }

                        if(empty($ship_condition)){
                        
                            if ($incoterm1 == "FOT") {
                                $shipcond_sbi = "PK";
                            } else if ($incoterm1 == "FRC") {
                                $shipcond_sbi = "D0";
                            } else if ($incoterm1 == "CNF") {
                                $shipcond_sbi = "DV";
                            } else {
                                $shipcond_sbi = "";
                            }
                        
                        }else{
                            $shipcond_sbi = $ship_condition;
                        }
                        
                        $strtop = "SELECT * FROM ZMD_MAPPING_TOP WHERE COM_SMI = '{$sales_org1}' AND TOP_SMI = '{$top}' AND (COM_SB = '{$sales_org}' or COM_SB = 'ALL')  AND DEL = 0 order by COM_SB DESC";
                        $querytop = oci_parse($conn, $strtop);
                        oci_execute($querytop);
                        $rowtop = oci_fetch_array($querytop, OCI_ASSOC);
                        if (ISSET($rowtop['TOP_SB'])) {
                            $topsbi = $rowtop['TOP_SB'];
                        }else{
                            $topsbi = null;
                        }    
                        $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
                        $data = array('Token' => 'aSsMx7GV0HFGzlufM4DH',
                            'SystemID' => 'PASSO',
                            'Data' => array('SalesDocumentType' => $roworder["ORDER_TYPE_OPCO"],
                                'SalesOrganization' => $sales_organization,
                                'DistributionChannel' => 'DB',
                                'Division' => 'CM',
                                'SalesDocumentDate' => $tgl_pp,
                                'ShippingCondition' => $shipcond_sbi,
                                'ShippingType' => 'G4',
                                'SoldToCode' => $soldtosbi,
                                'ShipToCode' => $shipto,
                                'MDReferenceSONumber' => $SOMD,
                                'MDPurchaseOrderNumber' => $no_pp,
                                'MDPurchaseOrderItem' => '00010',
                                'PurchaseOrderNumber' => $no_pp,
                                'PurchaseOrderDate' => $tgl_ppPO,
                                'PaymentTerms' => $topsbi,
                                'Items' => $Dmaterial
                            )
                        );
                        $options = array(
                            'http' => array(
                                'header' => "Content-type: application/json\r\n",
                                'method' => 'POST',
                                'content' => json_encode($data),
                            )
                        );



                        $context = stream_context_create($options);
                        $result = file_get_contents($url, false, $context);
                        $response = json_decode($result);
                        if ($ul == 4) {
                            $responseSBI2 = $response;
                        }
                        $status = $response->Status;
                        $Message = $response->Message;


                        $Message_detail = $response->MessageDetail;
                        $param_send = json_encode($data);
                        $param_return = json_encode($response);

                        $field_names = array(
                            'SEND_PARAM', 'RETURN_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN', 'PESAN_DETAIL', 'TGL'
                        );
                        $field_data = array(
                            "$param_send", "$param_return", "$user_name_in", "$no_pp", "$Message", "$Message_detail", "SYSDATE"
                        );
                        $tablename = "ZMD_LOG_SBI";
                        $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);
                        //print_r($status);
                        //print_r($Message);
                        if ($ul == 2) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO2 = $response->Data->SAPSalesOrderNumber;
                            $tgl_deleteSO2 = $response->Data->SAPCreatedDateStr;
                        } else if ($ul == 4) {
                            $nomorso = $response->Data->SAPSalesOrderNumber;
                            $SO4 = $response->Data->SAPSalesOrderNumber;
                            $tgl_deleteSO4 = $response->Data->SAPCreatedDateStr;
                        }

                        if ($status != 1) {
                            $next = 'N';
                            $show_ket .= $ul . ". SO OPCO = " . $Message_detail;
                            $show_ket .= '<br>';
                        } else {
                            $show_ket .= $ul . ". SO OPCO = Sales Order has been made with a number : " . $nomorso;
                            $show_ket .= '<br>';
                        }
                        $Dataarray = json_decode(json_encode($response->Data->Items), true);
                        //print_r($nomorso);
                        //echo json_encode($data);

                        $SOMDNE = 'Y';
                        $jerror += 1;
                    } else if ($ul == $perulangan) { // PROSES PERULANGAN TERAKHIR CREATE PO
                        // GET HARGA PER LINE ITEM
                        for ($p = 1; $p <= $perulanganPO; $p++) { // perulangan PO MULTI ICS atau TIDAK
                            if ($p == 1) {
                                $incoterm1 = $incotermPO1;
                                $incoterm2 = $incotermPO12;
                                $distr_chan = $distr_chanPO1;
                            } else {
                                $incoterm1 = $incotermPO2;
                                $incoterm2 = $incotermPO22;
                                $distr_chan = $distr_chanPO2;
                            }
                            //perubahan get KD VENDOR
                            $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'  AND DEL = 0";
                            $querykdven = oci_parse($conn, $strkdven);
                            oci_execute($querykdven);
                            $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

                            if ($p == 1) {
                                $SO_PO = $SO2;
                                $vendorFIX = $rowkdven["KET"];
                                $COM = $rowkdven["COM_MD"];
                                $COM_HARGA = $rowkdven["COM_OPCO"];
                                $plantPO = $plant1;
                            } else if ($p == 2) {
                                $SO_PO = ($SO3 != "" ? $SO3 : $SO4);
                                $vendorFIX = $rowkdven["KET_OPCO"];
                                $COM = $rowkdven["COM_OPCO"];
                                $COM_HARGA = $rowkdven["COM_MD_2"];
                                $plantPO = $plant2;
                            } else if ($p == 3) {
                                $SO_PO = $SO4;
                                $vendorFIX = $rowkdven["KET2"];
                                $COM = $rowkdven["COM_MD_2"];
                                $COM_HARGA = $rowkdven["COM_OPCO_2"];
                                $plantPO = $plant3;
                            }
                            if ($COM != "PTSC" && $COM != "ID50") {
                                if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
                                    $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
                                    $fce->I_BAPI_VIEW["SDCOND"] = "X";
                                    $fce->SALES_DOCUMENTS->row["VBELN"] = $SO_PO;
                                    $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

                                    $fce->Call();
                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $fce->ORDER_CONDITIONS_OUT->Reset();
                                        $totL = 0;
                                        $builder = array();
                                        $dataH = array();
                                        $dataH["item_number"] = array();
                                        $dataH["nilai_harga"] = array();
                                        $dataH["per"] = array();
                                        $dataH["satuan"] = array();
                                        while ($fce->ORDER_CONDITIONS_OUT->Next()) {
                                            if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
                                                $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
                                                $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
                                                $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
                                                $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
                                                $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
                                                $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];
                                                $builder[] = $dataH;
                                                $totL += 1;
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();

                                        if ($totL != $_POST['jumlah']) {
                                            $next = "N";
                                            $show_ket .= "Master Harga Belum Ada...!!!";
                                            $show_ket .= '<br>';
                                        }
                                    }
                                }

                                if ($next == "Y") {

                                    // CREATE PO
                                    $fce = $sap->NewFunction("BAPI_PO_CREATE1");
                                    $tgl_sekarang = date("Ymd");

                                   $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$COM}' AND KD_VENDOR = '{$vendorFIX}' AND DEL =0";
                                    $queryven = oci_parse($conn, $strven);
                                    oci_execute($queryven);
                                    $rowven = oci_fetch_array($queryven, OCI_ASSOC);


                                    $fce->POHEADER["COMP_CODE"] = $COM; // company kedua
                                    $fce->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
                                    $fce->POHEADER["VENDOR"] = $vendorFIX; //
                                    $fce->POHEADER["PMNTTRMS"] = $top;
                                    $fce->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
                                    $fce->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"];
                                    //                        $fce->POHEADER["CURRENCY"] = "IDR";
                                    //                        $fce->POHEADER["EXCH_RATE"] = "1";
                                    $fce->POHEADER["DOC_DATE"] = $tgl_sekarang;
                                    $fce->POHEADER["INCOTERMS1"] = $incoterm1;
                                    $fce->POHEADER["INCOTERMS2"] = $incoterm2;


                                    $fce->POHEADERX["COMP_CODE"] = "x";
                                    $fce->POHEADERX["DOC_TYPE"] = "x";
                                    $fce->POHEADERX["VENDOR"] = "x";
                                    $fce->POHEADERX["PMNTTRMS"] = "x";
                                    $fce->POHEADERX["PURCH_ORG"] = "x";
                                    $fce->POHEADERX["PUR_GROUP"] = "x";
                                    //                        $fce->POHEADERX["CURRENCY"] = "x";
                                    //                        $fce->POHEADERX["EXCH_RATE"] = "x";
                                    $fce->POHEADERX["DOC_DATE"] = "x";
                                    $fce->POHEADERX["INCOTERMS1"] = "x";
                                    $fce->POHEADERX["INCOTERMS2"] = "x";

                                    $fce->POTEXTHEADER->row["TEXT_ID"] = "F01";
                                    $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
                                    $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

                                    $fce->POTEXTHEADER->row["TEXT_ID"] = "F14";
                                    $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
                                    $fce->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
                                    $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

                                    $sampai = $_POST['jumlah'];
                                    for ($j = 0; $j <= $sampai - 1; $j++) {
                                        $idke = "idke" . $j;
                                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                            $id_dtl = $_POST['com_iddtl' . $j];
                                            $item_num1 = $_POST['com_line' . $j];
                                            $item_num = $fungsi->linenum($item_num1);
                                            $item_numli = $item_num * 10;
                                            $item_numline = sprintf("%06d", $item_numli);

                                            $item_numlinePO = sprintf("%05d", $item_numli);
                                            $material = $_POST['com_produk' . $j];
//                                    $material1 = $_POST['com_produk' . $j];
//                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
//                                    $querymaterial = oci_parse($conn, $strmaterial);
//                                    oci_execute($querymaterial);
//                                    $rowmaterial  = oci_fetch_array($querymaterial, OCI_ASSOC);
//                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];

                                            $qty = $_POST['com_qty' . $j];
                                            $qtyx = $_POST['com_qtyx' . $j];

                                            if ($sales_org == "7900") {
                                                $kontrak = $_POST['com_kontrak' . $j];
                                            } else {
                                                $kontrak = "";
                                            }
//                                            $kontrak = $_POST['com_kontrak' . $j];

                                            $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                            $distrik = $_POST['com_distrik' . $j];

                                            $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                            list($day, $month, $year) = split("-", $tgl_kirimPO);
                                            $tgl_kirim = $year . $month . $day;


                                            $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                            $querymaterial = oci_parse($conn, $strmaterial);
                                            oci_execute($querymaterial);
                                            $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                            if ($p == 1) {
                                                $material = $_POST['com_produk' . $j];
                                            } else if ($p == 2) {
                                                $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                            } else if ($p == 3) {
                                                $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                            }

                                            $mtr_group = substr($material, 0, 7);


                                            if (($nomorso != "") and ( $qty1 == $qtyx1))
                                                $status1 = "APPROVE";
                                            else
                                                $status1 = "PROCESS";

                                            if ($mtr_group == "121-301") {
                                                $nm_material = "SEMEN ZAK";
                                                $po_unit = "ZAK";
                                            } else if ($mtr_group == "121-302") {
                                                $nm_material = "SEMEN CURAH";
                                                $po_unit = "TO";
                                            } else if ($mtr_group == "121-200") {
                                                $nm_material = "CLINKER";
                                                $po_unit = "TO";
                                            }

//                                        $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$sales_org1}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
//                                        $queryloc = oci_parse($conn, $strsloc);
//                                        oci_execute($queryloc);
//                                        $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
                                            // CEK HARGA DARI BAPI COMMIT HARGA
                                            if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
                                                foreach ($builder as $val) {
                                                    if ($item_numline == $val['item_number']) {
                                                        $hargaPO = $val['nilai_harga'];
                                                        $perPO = $val['per'];
                                                        $satuanPO = $val['satuan'];
                                                        $satuan2PO = $val['satuan2'];
                                                        $currencyPO = $val['currency'];
                                                    }
                                                }
                                            } else {
                                                if ($p == 1) {
                                                    $datas = $response->Data->Items[$j];
                                                } else if ($p == 3) {
                                                    $datas = $responseSBI2->Data->Items[$j];
                                                }
                                                $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
                                                $perPO = $datas->SAPSalesOrderPerUnit;
                                                $satuanPO = $datas->SAPSalesOrderUnit;
                                                $satuan2PO = $datas->SAPSalesOrderUnit;
                                                $currencyPO = $datas->SAPSalesOrderCurrency;
                                            }
//                                    //print_r($builder);
//                                    //print_r($hargaPO);
//                                    //print_r($item_numline);

                                            $fce->POITEM->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POITEM->row["SHORT_TEXT"] = $nm_material;
                                            $fce->POITEM->row["MATERIAL"] = $material;
                                            $fce->POITEM->row["PLANT"] = $plantPO;
//                                    $fce->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];
                                            $fce->POITEM->row["MATL_GROUP "] = $mtr_group;
                                            $fce->POITEM->row["QUANTITY"] = $qtyx;
                                            $fce->POITEM->row["STGE_LOC"] = "D101";
                                            $fce->POITEM->row["GR_IND"] = "X";
                                            $fce->POITEM->row["IR_IND"] = "X";
                                            $fce->POITEM->row["GR_BASEDIV"] = "X";
//                                        $fce->POITEM->row["FUNDS_CTR"] = "7902000000";
                                            $fce->POITEM->Append($fce->POITEM->row);

                                            $fce->POITEMX->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POITEMX->row["SHORT_TEXT"] = "X";
                                            $fce->POITEMX->row["MATERIAL"] = "X";
                                            $fce->POITEMX->row["PLANT"] = "X";
//                                    $fce->POITEMX->row["STGE_LOC"] = "X"; 
                                            $fce->POITEMX->row["MATL_GROUP "] = "X";
                                            $fce->POITEMX->row["QUANTITY"] = "X";
                                            $fce->POITEMX->row["STGE_LOC"] = "X";
                                            $fce->POITEMX->row["GR_IND"] = "X";
                                            $fce->POITEMX->row["IR_IND"] = "X";
                                            $fce->POITEMX->row["GR_BASEDIV"] = "X";
//                                        $fce->POITEMX->row["FUNDS_CTR"] = "X";
                                            $fce->POITEMX->Append($fce->POITEMX->row);

                                            $fce->POTEXTITEM->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POTEXTITEM->row["TEXT_ID"] = "F01";
                                            $fce->POTEXTITEM->row["TEXT_FORM"] = "/";
                                            $fce->POTEXTITEM->row["TEXT_LINE"] = "SEMEN PPC";
                                            $fce->POTEXTITEM->Append($fce->POTEXTITEM->row);

                                            $fce->POSCHEDULE->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POSCHEDULE->row["SCHED_LINE"] = "0001";
                                            $fce->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
                                            $fce->POSCHEDULE->row["QUANTITY "] = $qtyx;
                                            $fce->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
                                            $fce->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
                                            $fce->POSCHEDULE->Append($fce->POSCHEDULE->row);

                                            $fce->POSCHEDULEX->row["PO_ITEM"] = $item_numlinePO;
                                            $fce->POSCHEDULEX->row["SCHED_LINE"] = "X";
                                            $fce->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
                                            $fce->POSCHEDULEX->row["QUANTITY "] = "X";
                                            $fce->POSCHEDULEX->row["STAT_DATE"] = "X";
                                            $fce->POSCHEDULEX->row["PO_DATE"] = "X";
                                            $fce->POSCHEDULEX->Append($fce->POSCHEDULEX->row);



                                            $fce->POCOND->row["ITM_NUMBER"] = $item_numlinePO;
                                            $fce->POCOND->row["COND_ST_NO"] = '001';
                                            $fce->POCOND->row["COND_TYPE"] = "PBXX";
                                            $fce->POCOND->row["COND_VALUE"] = $hargaPO;
                                            $fce->POCOND->row["COND_P_UNT"] = $perPO;
                                            $fce->POCOND->row["COND_UNIT"] = $satuanPO;
                                            $fce->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
                                            $fce->POCOND->row["CURRENCY"] = $currencyPO;
                                            $fce->POCOND->row["CURRENCY_ISO"] = $currencyPO;
                                            $fce->POCOND->row["CHANGE_ID"] = "U";
                                            $fce->POCOND->Append($fce->POCOND->row);

                                            $fce->POCONDX->row["ITM_NUMBER"] = $item_numlinePO;
                                            $fce->POCONDX->row["COND_ST_NO"] = '001';
                                            $fce->POCONDX->row["COND_TYPE"] = "x";
                                            $fce->POCONDX->row["COND_VALUE"] = "x";
                                            $fce->POCONDX->row["COND_P_UNT"] = "x";
                                            $fce->POCONDX->row["COND_UNIT"] = "x";
                                            $fce->POCONDX->row["COND_UNIT_SO"] = "x";
                                            $fce->POCONDX->row["CURRENCY"] = "x";
                                            $fce->POCONDX->row["CURRENCY_ISO"] = "x";
                                            $fce->POCONDX->row["CHANGE_ID"] = "x";
                                            $fce->POCONDX->Append($fce->POCONDX->row);
                                        }
                                    }


                                    $fce->Call();

                                    if ($fce->GetStatus() == SAPRFC_OK) {
                                        $nopoT = $fce->EXPPURCHASEORDER;
                                        $fce->RETURN->Reset();
                                        while ($fce->RETURN->Next()) {
                                            $tipe = $fce->RETURN->row["TYPE"];
                                            $msg = $fce->RETURN->row["MESSAGE"];
                                            $show_ket .= $msg;
                                            $show_ket .= '<br>';
                                            if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
                                                $next = "N";
                                            }
                                        }
                                        //Commit Transaction
                                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                                        $fce->Call();
                                    }
                                    $user_org = $_SESSION['user_org'];

                                    if ($p == 1) {
                                        $PO1 = $nopoT;
                                    } else if ($p == 2) {
                                        $PO2 = $nopoT;
                                    } else if ($p == 3) {
                                        $PO3 = $nopoT;
                                    }
                                    //SIMPAN PP ICS KEDUA

                                    if ($next == "Y" && $p == 1) {
                                        $sampai = $_POST['jumlah'];
                                        for ($j = 0; $j <= $sampai - 1; $j++) {
                                            $idke = "idke" . $j;
                                            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                                                $id_dtl = $_POST['com_iddtl' . $j];
                                                $item_num1 = $_POST['com_line' . $j];
                                                $item_num = $fungsi->linenum($item_num1);
                                                $item_numline = $item_num * 10; //'000010'; 
                                                $PO_LINE = sprintf("%05d", $item_numline); //'00010';
                                                if ($j == 0) {
                                                    $numline_pertama = sprintf("%06d", $item_numline * 10); //'000010';
                                                }
                                                $alamat1 = $_POST['com_alamat' . $j];
//                                        $material = $_POST['com_produk' . $j];
//                                        $material1 = $_POST['com_produk' . $j];
                                                $material = $_POST['com_produk' . $j];
                                                $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
                                                $querymaterial = oci_parse($conn, $strmaterial);
                                                oci_execute($querymaterial);
                                                $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


                                                if ($p == 1) {
                                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];
                                                } else if ($p == 2) {
                                                    $material = $rowmaterial['KD_MATERIAL_MD_2'];
                                                } else if ($p == 3) {
                                                    $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
                                                }


                                                $qty = $_POST['com_qty' . $j];
                                                $qtyx = $_POST['com_qtyx' . $j];
                                                if ($sales_org == "7900") {
                                                    $kontrak = $_POST['com_kontrak' . $j];
                                                } else {
                                                    $kontrak = "";
                                                }
//                                                $kontrak = $_POST['com_kontrak' . $j];

                                                $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
                                                $distrik = $_POST['com_distrik' . $j];
                                                $shiptotocek = $_POST['com_shipto' . $j];
                                                
                                                $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
                                                $queryshipto = oci_parse($conn, $strshipto);
                                                oci_execute($queryshipto);
                                                $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                                if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
                                                    $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
                                                    $queryshipto = oci_parse($conn, $strshipto);
                                                    oci_execute($queryshipto);
                                                    $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
                                                }

                                                if ($p == 1) {
                                                    $shipto = $rowshipto['SHIP_TO_OPCO'];
                                                } else if ($p == 2) {
                                                    $shipto = $rowshipto['SHIP_TO_MD_2'];
                                                } else if ($p == 3) {
                                                    $shipto = $rowshipto['SHIP_TO_OPCO_2'];
                                                }

                                                $shipto = $fungsi->sapcode($shipto);
                                                $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
                                                $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
                                                list($day, $month, $year) = split("-", $tgl_kirimPO);
                                                $tgl_kirim = $year . $month . $day;

                                                $mtr_group = substr($material, 0, 7);


                                                if (($nomorso != "") and ( $qty1 == $qtyx1))
                                                    $status1 = "APPROVE";
                                                else
                                                    $status1 = "PROCESS";

                                                if ($p == 1) {
                                                    $SO_ICS = $SO1;
                                                } else if ($p == 2) {
                                                    $SO_ICS = $SO2;
                                                } else if ($p == 3) {
                                                    $SO_ICS = $SO3;
                                                }

                                                $field_names = array(
                                                    'NO_PP',
                                                    'NO_PO',
                                                    'PO_LINE',
                                                    'PLANT_PO',
                                                    'NMPLANT_PO',
                                                    'KOTA',
                                                    'NAMA_KOTA',
                                                    'KODE_PRODUK',
                                                    'NM_PRODUK',
                                                    'HARGA_PO',
                                                    'ORG_PO',
                                                    'VENDOR',
                                                    'NM_VENDOR',
                                                    'QTY_PO',
                                                    'UOM',
                                                    'TGL_PO',
                                                    'STATUS',
                                                    'NOTE',
                                                    'CREATE_DATE',
                                                    'CREATED_BY',
                                                    'DELETE_MARK',
                                                    'BULAN',
                                                    'TAHUN',
                                                    'QTY_APPROVE',
                                                    'TGL_PP',
                                                    'ORG_BY',
                                                    'VBELN'
                                                );
                                                $kd_vendor = $vendorFIX;
                                                $nopoplus = $nopoT . $PO_LINE;
                                                $field_data = array(
                                                    "$no_pp",
                                                    "$nopoplus",
                                                    "$PO_LINE",
                                                    "$plant1",
                                                    "$plant1", //belum                   
                                                    "$distrik",
                                                    "$distrik", //belum
                                                    "$material",
                                                    "$material", //belum
                                                    "$hargaPO",
                                                    "$sales_org1",
                                                    "$kd_vendor",
                                                    "$kd_vendor", //belum
                                                    "$qty",
                                                    "$po_unit",
                                                    "instgl_$tgl_kirimPO",
                                                    "$status1",
                                                    "$ket",
                                                    "SYSDATE",
                                                    "$user_name_in",
                                                    "0",
                                                    "$month",
                                                    "$year",
                                                    "$qtyx",
                                                    "SYSDATE",
                                                    "$user_org",
                                                    "$SO_ICS"
                                                );
                                                $tablename = "OR_TRANS_HDR_ICS";
                                                $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

                                                //Oracle Detail
                                                $field_names2 = array(
                                                    'NO_PP',
                                                    'KODE_PRODUK',
                                                    'NAMA_PRODUK',
                                                    'QTY_PP',
                                                    'QTY_APPROVE',
                                                    'TGL_KIRIM_PP',
                                                    'TGL_KIRIM_APPROVE',
                                                    'TGL_TERIMA',
                                                    'SHIP_TO',
                                                    'NAMA_SHIP_TO',
                                                    'ALAMAT_SHIP_TO',
                                                    'DELETE_MARK',
                                                    'STATUS_LINE',
                                                    'KODE_TUJUAN',
                                                    'NAMA_TUJUAN',
                                                    'ITEM_NUMBER',
                                                    'NO_SO',
                                                    'FLAG_KAPAL',
                                                    'KETERANGAN',
                                                    'NAMA_KAPAL',
                                                    'NO_KONTRAK',
                                                    'KD_PROV',
                                                    'NM_PROV',
                                                    'UOM',
                                                    'PLANT',
                                                    'NM_PLANT',
                                                    'PRICE_DATE',
                                                    'SOLD_TO',
                                                    'INCOTERM',
                                                    'CARA_BAYAR',
                                                    'TERM_PAYMENT',
                                                    'NAMA_SOLD_TO',
                                                    'BPLANT',
                                                    'CREATED_BY',
                                                    'CREATE_DATE',
                                                    'NAMA_INCOTERM',
                                                    'SO_TYPE',
                                                    'NAMA_SO_TYPE',
                                                    'ROUTE',
                                                    'NAMA_TOP',
                                                    'ORG',
                                                    'PRICELIST',
                                                    'NAMA_PRICELIST',
                                                    'NO_KONTRAK_LC',
                                                    'KD_REASON',
                                                    'NM_REASON',
                                                    'ROUTE_TXT',
                                                    'CHANNEL',
                                                    'DIVISION',
                                                    'TIPE_PEMBELIAN',
                                                    'NO_POH'
                                                );

                                                $kodedistrik2 = substr($distrik, 0, 2);
                                                $kd_provinsi = "10" . $kodedistrik2;
                                                $itemnumplus = sprintf("%06d", $item_numline); //'000010';
                                                $field_data2 = array(
                                                    "$no_pp",
                                                    "$material",
                                                    "$material",
                                                    "$qty",
                                                    "$qtyx",
                                                    "instgl_$tgl_kirimPO",
                                                    "instgl_$tgl_kirimPO",
                                                    "instgl_$tgl_terimaPO",
                                                    "$shipto",
                                                    "$shipto",
                                                    "$alamat1", // belum
                                                    "0",
                                                    "$status1",
                                                    "$distrik",
                                                    "$distrik",
                                                    "$itemnumplus",
                                                    "$SO_ICS",
                                                    "0",
                                                    "$ket",
                                                    " ", //belum
                                                    "$kontrak", //belum
                                                    "$kd_provinsi", //belum
                                                    "$kd_provinsi", //belum
                                                    "$po_unit", //belum
                                                    "$plant", // plant kedua
                                                    "$plant",
                                                    "instgl_$tgl_kirimPO",
                                                    "$soldto", //kedua
                                                    "$incoterm1",
                                                    "$ketbayar", //belum
                                                    "$top",
                                                    "$soldto",
                                                    "$plant", //
                                                    "$user_name_in",
                                                    "SYSDATE",
                                                    "$incoterm2",
                                                    "$so_type",
                                                    "$so_type",
                                                    "$route",
                                                    "$nama_top",
                                                    "$sales_org",
                                                    "$pricelist",
                                                    "$nama_pricelist",
                                                    "$lcnum",
                                                    "$reason",
                                                    "$nama_reason",
                                                    "$ship_cond-$route_desc", //belum
                                                    "$distr_chan",
                                                    "$division",
                                                    "D", //belum
                                                    "$nopoT"
                                                );
                                                $tablename2 = "OR_TRANS_DTL_ICS";
                                                $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
                                            }
                                        }
                                    }
                                }
                            }// bukan sbi
                        } // IF
                    }
                }
            }


            if ($next == 'Y') {
                //  INSERT TABEL MAPPING
                $fceM = $sap->NewFunction("ZCSD_MAP_SO_MD_FM");
                if ($fceM == false) {
                    $sap->PrintStatus();
                    exit;
                }

                for ($ref = 1; $ref <= $perulanganSO; $ref++) {
                    $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
                    if ($fce == false) {
                        $sap->PrintStatus();
                        exit;
                    }
                    if ($ref == 1) {
                        $fce->I_ZVBELN = $SO1;
                        $fce->I_VBELN = $SO2;
                        $SOM = 'SO Mega Distributor 1 : ' . $SO1;
                        $PO_REF = $PO1;
                        $SOMAP = $SO1;
                        $orgMAP = $sales_org1;
                        $plantMAP = $plant1;
                    } else if ($ref == 2) {
                        $fce->I_ZVBELN = $SO2;
                        $fce->I_VBELN = $SO1;
                        $SOM = 'SO OPCO 1 : ' . $SO2;
                        $PO_REF = $PO1;
                        $SOMAP = $SO2;
                        $orgMAP = $sales_org2;
                        $plantMAP = $plant2;
                    } else if ($ref == 3) {
                        $fce->I_ZVBELN = $SO3;
                        $fce->I_VBELN = $SO4;
                        $SOM = 'SO Mega Distributor 2 : ' . $SO3;
                        $PO_REF = ($SO3 != '' ? $PO2 : "");
                        $SOMAP = $SO3;
                        $orgMAP = $sales_org3;
                        $plantMAP = $plant3;
                    } else if ($ref == 4) {
                        if ($SO3 == "") {
                            $fce->I_ZVBELN = $SO3;
                            $fce->I_VBELN = $SO4;
                        } else {
                            $fce->I_ZVBELN = $SO4;
                            $fce->I_VBELN = $SO3;
                        }
                        $SOM = 'SO OPCO 2 : ' . $SO4;
                        $PO_REF = ($SO3 == '' ? $PO2 : $PO3);
                        $SOMAP = $SO4;
                        $orgMAP = $sales_org4;
                        $plantMAP = $plant4;
                    }
                    $fce->I_PO = $PO_REF;
                    $fce->I_LINE_ITEM = $numline_pertama;
                    $fce->Call();
                    if ($fce->GetStatus() == SAPRFC_OK) {
                        //while ( $fce->ZMESSAGE->Next() ){
                        $tipe = $fce->ZMESSAGE["TYPE"];
                        $msg = $fce->ZMESSAGE["MESSAGE"];
                        $show_ket .= $SOM . ' ' . $msg . '<br>';
                        //}
                    }


                    if ($SOMAP != "") {
                        $fceM->T_DATA->row["NO_PP"] = $no_pp;
                        $fceM->T_DATA->row["VKORG"] = $orgMAP;
                        $fceM->T_DATA->row["WERKS"] = $plantMAP;
                        $fceM->T_DATA->row["NO_SO"] = $SOMAP;
                        $fceM->T_DATA->row["SEQ_NO"] = $ref * 10;
                        $fceM->T_DATA->row["NO_PO"] = $PO_REF;
                        $fceM->T_DATA->Append($fceM->T_DATA->row);
                    }
                }


                $fceM->Call();
                if ($fceM->GetStatus() == SAPRFC_OK) {
                    //while ( $fce->ZMESSAGE->Next() ){
//                    $tipe = $fceM->ZMESSAGE["TYPE"];
//                    $msg = $fceM->ZMESSAGE["MESSAGE"];
//                    $show_ket .= $ref . ' ' . $msg . '<br>';
                    //}
                }
            }

            //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
            if ($next == "N") {
                $SOSBI = "N";
                if ($SOMDNE == "Y") {
                    $SOSBIK = "Y";
                } else {
                    $SOSBIK = "N";
                }
                for ($e = 1; $e <= $jerror; $e++) {
                    $return = "Y";

                    // CEK SO SBI ATAU TIDAK
                    $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'";
                    $querykdven = oci_parse($conn, $strkdven);
                    oci_execute($querykdven);
                    $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);
                    if ($e == 1) {
                        $noyo = $SO1;
                        $IDHU = $IDH1;
                        $SOSBICEK = "N";
                    } else if ($e == 2) {
                        $noyo = $SO2;
                        $IDHU = $IDH2;
                        if ($rowkdven["COM_OPCO"] == "PTSC" || $rowkdven["COM_OPCO"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    } else if ($e == 3) {
                        $noyo = $SO3;
                        $IDHU = $IDH3;
                        $SOSBICEK = "N";
                    } else if ($e == 4) {
                        $noyo = $SO4;
                        $IDHU = $IDH4;
                        if ($rowkdven["COM_OPCO_2"] == "PTSC" || $rowkdven["COM_OPCO_2"] == "ID50") {
                            $SOSBICEK = "Y";
                        } else {
                            $SOSBICEK = "N";
                        }
                    }

                    if ($SOSBICEK == 'Y') {
                        if ($e == 2 || $e == 4) {
                            if ($e == 2) {
                                $TGLend = $tgl_deleteSO2;
                            } else if ($e == 4) {
                                $TGLend = $tgl_deleteSO4;
                            }

                            $url = 'https://sip.solusibangunindonesia.com/APIMD/DeleteSalesOrder';
                            $data = array(
                                'Token' => 'aSsMx7GV0HFGzlufM4DH',
                                'SystemID' => 'PASSO',
                                'SAPSalesOrderNumber' => $noyo,
                                'SAPCreatedDate' => $TGLend,
                            );
                            $options = array(
                                'http' => array(
                                    'header' => "Content-type: application/json\r\n",
                                    'method' => 'POST',
                                    'content' => json_encode($data),
                                )
                            );

                            $context = stream_context_create($options);
                            $result = file_get_contents($url, false, $context);
                            $response = json_decode($result);
                            $status = $response->Status;
                            $Message = $response->Message;
                            if ($status != '1') {
                                $return = 'N';
                            }
                        }
                    } else {
                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                        if ($fce == false) {
                            $sap->PrintStatus();
                            exit;
                        }

                        //header entri    
                        $fce->SALESDOCUMENT = $noyo; //"ZOR";
                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";

                        $fce->Call();

                        if ($fce->GetStatus() == SAPRFC_OK) {
                            $fce->RETURN->Reset();
                            while ($fce->RETURN->Next()) {
                                $msg .= '<div align="center">';
                                $error = $fce->RETURN->row["TYPE"];
                                $msg .= $fce->RETURN->row["MESSAGE"];

                                if ($error == 'A' || $error == 'X' || $error == 'E') {
                                    $return = 'N';
                                }
                            }
                            $msg .= '<br></div>';
                            //Commit Transaction
                            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                            $fce->Call();
                        } else {
                            $fce->PrintStatus();
                        }
                    }

                    if ($return == 'Y') {
                        $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_HDR_ICS SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE VBELN='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $str = "UPDATE OR_TRANS_DTL_ICS SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
                        $query = oci_parse($conn, $str);
                        oci_execute($query);
                        $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
                    } else {
                        $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
                    }
                }
            }

            $field_names = array(
                'SEND_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN_DETAIL', 'TGL'
            );
            $field_data = array(
                "SI", "$user_name_in", "$no_pp", "$show_ket", "SYSDATE"
            );
            $tablename = "ZMD_LOG_SBI";
            $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

            $fce->Close();
            $sap->Close();
        }

        //================================================================

        $habis = "approve_pryk.php";
        break;



    //
    //===============================================
    //
        
//     case "buatsoprykmd2":

//         // CEK MAPPING PLANT ADA ATAU TIDAK
//         $plantcek = $_POST['plant'];
//         $str = "SELECT * FROM ZMD_MAPPING_PLANT
//         WHERE PLANT_MD = '{$plantcek}' AND  DEL=0
//         ";
//         $query = oci_parse($conn, $str);
//         oci_execute($query);
//         $row = oci_fetch_array($query, OCI_ASSOC);
//         $lanjut = 'Y';
//         $next = 'Y';
//         $SO1 = '';
//         $IDH1 = '';
//         $SO2 = '';
//         $IDH2 = '';
//         $SO3 = '';
//         $IDH3 = '';
//         $SO4 = '';
//         $IDH4 = '';
//         $jerror = 0;
//         $SOMDNE = "N";

//         if (count($row) > 0) {
//             // CEK MAPPING CUSTOMER ADA ATAU TIDAK
//             $soldtocek = $_POST['distr_id'];
//             $strsoldto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}'  AND DEL = 0";
//             $querysoldto = oci_parse($conn, $strsoldto);
//             oci_execute($querysoldto);
//             $rowsoldto = oci_fetch_array($querysoldto, OCI_ASSOC);
//             if (count($rowsoldto) < 1) {
//                 $lanjut = 'N';
//                 $komentarerror = 'SOLD TO belum Termapping : ' . $soldtocek;
//             }
//         } else {
//             $lanjut = 'N';
//             $komentarerror = 'Plant MD belum ada : ' . $_POST['plant'];
//             ;
//         }

//         // CEK ICS
//         if ($row["COM_MD_2"] != "" && $row["PLANT_MD_2"] != "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
//             $perulangan = 5;
//             $perulanganSO = 4;
//             $perulanganPO = 3;
//             $ics = "Y";
//             $loncat = "N";
//         } else if ($row["COM_MD_2"] == "" && $row["PLANT_MD_2"] == "" && $row["COM_OPCO_2"] != "" && $row["PLANT_OPCO_2"] != "") {
//             $perulangan = 5;
//             $perulanganSO = 4;
//             $perulanganPO = 2;
//             $ics = "Y";
//             $loncat = "Y"; /// MD @ tidak di pakai
//         } else {
//             $perulangan = 3;
//             $perulanganSO = 2;
//             $perulanganPO = 1;
//             $ics = "N";
//             $loncat = "N";
//         }


//         $no_pp = $fungsi->or_new_pp_number($conn);

//         // JIKA LOLOS PENGECEKAN MAPPING PLANT DAN CUSTOMER
//         if ($lanjut == 'Y') {
//             // PERULANGAN 3 KALI (1.parameter normal,2.ada beberapa parameter berubah, 3. create PO otomatis )
//             for ($ul = 1; $ul <= $perulangan; $ul++) {

//                 if ($next == 'Y') {
//                     $incoterm1 = $_POST['incoterm'];
//                     $incoterm2 = $_POST['nama_incoterm'];
//                     $route     = $_POST['route'];
//                     $top       = $_POST['top'];
//                     $nama_top  = $_POST['nama_top'];
//                     if ($ul == 1) {
//                         $sales_org = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
//                         $sales_org1 = $_POST['org']; //$_POST['org']; // GANTI ORG MAPPING 2
//                         $soldto = $_POST['sold_to'];   // GANTI BERDASARKAN MAPPING CUSTOMER
//                         $soldto = $fungsi->sapcode($soldto);
//                         $plant = $_POST['plant'];             // GANTI ORG MAPPING 2
//                         $plant1 = $_POST['plant'];             // GANTI ORG MAPPING 2
//                     } else if ($ul == 2) {
//                         $sales_org = $row['COM_OPCO']; //$_POST['org']; // GANTI ORG MAPPING 2
//                         $plant = $row['PLANT_OPCO'];             // GANTI ORG MAPPING 2
//                         $soldto = $rowsoldto['SOLD_TO_OPCO'];   // GANTI BERDASARKAN MAPPING CUSTOMER
//                         $soldto = $fungsi->sapcode($soldto);
//                         $sales_org2 = $row['COM_OPCO'];
//                         $plant2 = $row['PLANT_OPCO'];
//                         $incotermPO1 = $incoterm1;
//                         $incotermPO12 = $incoterm2;
//                     } else if ($ul == 3 && $ics == "Y") {
//                         $sales_org = $row['COM_MD_2'];
//                         $plant = $row['PLANT_MD_2'];
//                         $soldto = $rowsoldto['SOLD_TO_MD_2'];
//                         $soldto = $fungsi->sapcode($soldto);
//                         $sales_org3 = $row['COM_MD_2'];
//                         $plant3 = $row['PLANT_MD_2'];
//                         $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
//                         $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
//                         //penambahan rute dan TOP
//                         $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
//                         if($incoterm1 == 'FOT'){
//                            $route = 'ZR0003'; 
                           
//                         }else if($incoterm1 == 'FRC'){
//                            $route = 'ZR0002';  
                           
//                         }
//                         $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
//                         $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
//                         //penambahan rute top
                        
//                     } else if ($ul == 4 && $ics == "Y") {
//                         $sales_org = $row['COM_OPCO_2'];
//                         $plant = $row['PLANT_OPCO_2'];
//                         $soldto = $rowsoldto['SOLD_TO_OPCO_2'];
//                         $soldto = $fungsi->sapcode($soldto);
//                         $sales_org4 = $row['COM_OPCO_2'];
//                         $plant4 = $row['PLANT_OPCO_2'];
//                         $incoterm1 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['incoterm'];
//                         $incoterm2 = ISSET($row['INCOTERM_SOURCE']) ? $row['INCOTERM_SOURCE'] : $_POST['nama_incoterm'];
                        
//                         //penambahan rute dan TOP
//                         $route     = ISSET($row['ROUTE_SOURCE']) ? $row['ROUTE_SOURCE'] : $_POST['nama_incoterm'];
//                         if($incoterm1 == 'FOT'){
//                            $route = 'ZR0003'; 
                           
//                         }else if($incoterm1 == 'FRC'){
//                            $route = 'ZR0002';  
                           
//                         }
//                         $top       = ISSET($row['TOP_SOURCE']) ? $row['TOP_SOURCE'] : $_POST['top'];
//                         $nama_top  = ISSET($row['DESC_TOP_SOURCE']) ? $row['DESC_TOP_SOURCE'] : $_POST['nama_top'];
//                         $topPO2    = $top;
//                         //penambahan rute top
                        
//                         $incotermPO2 = $incoterm1;
//                         $incotermPO22 = $incoterm2;
//                     }

//                     //data header so
//                     $pesan_telegram = "";
//                     $user_name_in = $_SESSION['user_name'];
//                     $idh = $_POST['idh'];
//                     $iddtl = $_POST['iddtl'];
//                     $no_ppvalpryk = trim($_POST['no_pp']);
//                     $so_type = $_POST['so_type'];
//                     $nama_so_type = $_POST['nama_so_type'];

//                     if ($so_type == 'ZEX') {
//                         $distr_chan = "30";
//                     } elseif ($so_type == 'ZPR') {
//                         if ($sales_org == '2000') {
//                             $distr_chan = "10";
//                         } else if ($sales_org == '3000' || $sales_org == '5000' || $sales_org == '7000' || $sales_org == '7900' || $sales_org == '4000') { // tambahan pak yusuf untuk bisa memilih dist channel proyek MD
//                             $distr_chan = $_POST['channels'];
//                         } else {
//                             $distr_chan = "50";
//                         }
//                     } else {
//                         $distr_chan = "10";
//                     }
//                     $division = "00";
//                     $dlv_block = "";
//                     $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
//                     if ($distr_chancondi != '') {
//                         $distr_chan = $distr_chancondi;
//                     }

//                     $distr_chanPO1 = $distr_chan;
//                     if ($ul == 3 && $ics == "Y") {
//                         $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
//                     } else if ($ul == 4 && $ics == "Y") {
//                         $distr_chan = ISSET($row['DIST_CHANNEL_SOURCE']) ? $row['DIST_CHANNEL_SOURCE'] : $distr_chan;
//                         $distr_chanPO2 = $distr_chan;
//                     }
//                     $nama_sold_to = $_POST['nama_sold_to'];
//                     $tgl_pp = date("d-m-Y");
//                     list($day, $month, $year) = split("-", $tgl_pp);
//                     $tgl_pp = $year . $month . $day;
//                     //$tanggal=gmdate("Ymd",time()+60*60*7);
//                     $top = $_POST['top'];
//                     $nama_top = $_POST['nama_top'];
//                     $reason = $_POST['reason'];
//                     $nama_reason = $_POST['nama_reason'];
//                     $nama_plant = $_POST['nama_plant'];
//                     $route = $_POST['route'];
//                     $pricelist = $_POST['pricelist'];
//                     $nama_pricelist = $_POST['nama_pricelist'];
//                     $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
//                     $ket = $_POST['nm_kapal'];
//                     $kontrakh = $_POST['com_kontrak0'];
//                     $pesan_telegram .= "PP Proyek $no_ppvalpryk\n";
//                     //call bapi sales order sap
//                     $sap = new SAPConnection();
//                     $sap->Connect("../include/sapclasses/logon_data.conf");
//                     if ($sap->GetStatus() == SAPRFC_OK)
//                         $sap->Open();
//                     if ($sap->GetStatus() != SAPRFC_OK) {
//                         $sap->PrintStatus();
//                         exit;
//                     }


//                     if ($sales_org == 3000 || $sales_org == 4000 || $sales_org == 5000 || $sales_org == 7000 || $sales_org == 7900) {
//                         $COM = 'MD';
//                     } else {
//                         $COM = 'SBI';
//                     }

//                     if ($ul <= $perulanganSO && $COM == 'MD') {


//                         if ($loncat == "N") {
//                             $gass = "Y";
//                         } else if ($loncat == "Y") {
//                             if ($ul == 3) {
//                                 $gass = "N";
//                             } else {
//                                 $gass = "Y";
//                             }
//                         }

//                         if ($gass == "Y") { // loncat tidak membuat SO MD 2 karena tidak di mammping plant
//                                 // SOCC v2
//                                 $looping_end=1;
//                                 $movetestrun='Z';
//                                 for ($looping = 0; $looping <= $looping_end; $looping++) {
//                                 if($movetestrun!='X'){
//                                 ////////////                            
//                             $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
//                             if ($fce == false) {
//                                 $sap->PrintStatus();
//                                 exit;
//                             }


//                             //detail entri item'
//                             $sampai = $_POST['jumlah'];
//                             $shipto_awal = '';
//                             for ($j = 0; $j <= $sampai - 1; $j++) {
//                                 $idke = "idke" . $j;
//                                 if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                     $shipto_awal = $_POST['com_shipto0'];
//                                     $material = $_POST['com_produk' . $j];
//                                     if ($ul == 1) {
//                                         $shipto = $_POST['com_shipto' . $j];     // GANTI BERDASARKAN MAPPING CUSTOMER 
//                                         $material1 = $_POST['com_produk' . $j];
//                                     } else if ($ul == 2 || $ul == 3 || $ul == 4) {
//                                         $shiptotocek = $_POST['com_shipto' . $j];
                                        
//                                         $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
//                                         $queryshipto = oci_parse($conn, $strshipto);
//                                         oci_execute($queryshipto);
//                                         $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                         if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
//                                             $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
//                                             $queryshipto = oci_parse($conn, $strshipto);
//                                             oci_execute($queryshipto);
//                                             $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                         }

//                                         if ($ul == 2) {
//                                             $shipto = $rowshipto['SHIP_TO_OPCO'];
//                                             $soldto = $rowshipto['SOLD_TO_OPCO'];
//                                         } else if ($ul == 3) {
//                                             $shipto = $rowshipto['SHIP_TO_MD_2'];
//                                             $soldto = $rowshipto['SOLD_TO_MD_2'];
//                                         } else if ($ul == 4) {
//                                             $shipto = $rowshipto['SHIP_TO_OPCO_2'];
//                                             $soldto = $rowshipto['SOLD_TO_OPCO_2'];
//                                         }



//                                         $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
//                                         $querymaterial = oci_parse($conn, $strmaterial);
//                                         oci_execute($querymaterial);
//                                         $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


//                                         if ($ul == 2) {
//                                             $material = $rowmaterial['KD_MATERIAL_OPCO'];
//                                         } else if ($ul == 3) {
//                                             $material = $rowmaterial['KD_MATERIAL_MD_2'];
//                                         } else if ($ul == 4) {
//                                             $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
//                                         }
//                                     }


//                                     $id_dtl = $_POST['com_iddtl' . $j];
//                                     $item_num1 = $_POST['com_line' . $j];
//                                     $item_num = $fungsi->linenum($item_num1);
//                                     $distrik = $_POST['com_distrik' . $j];
//                                     $qty = $_POST['com_qty' . $j];
//                                     $qtyx = $_POST['com_qtyx' . $j];
//                                     $tgl_kirim = $_POST['com_tgl_kirim' . $j];
//                                     list($day, $month, $year) = split("-", $tgl_kirim);
//                                     $tgl_kirim = $year . $month . $day;
//                                     $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
//                                     $kontrak = $_POST['com_kontrak' . $j];
//                                     $nomor = $fungsi->sapcode($kontrak);
//                                         //////////////////////////////////////////// proyek SOCC v.2
//                                         // $plant_socc = $_POST['plant'];
//                                         // $kode_distrik_socc = $_POST['com_distrik' . $j];
//                                         // $material_for_socc = substr($_POST['com_produk' . $j],0,7);
//                                         // $tgl_terima_leadtime = $fungsi->tgl_leadtime($plant_socc, $kode_distrik_socc, $material_for_socc);
//                                         // $tgl_terima_leadtime=$tgl_terima_leadtime;
//                                         // list($day, $month, $year) = split("-", $tgl_terima_leadtime);
//                                         // $tgl_terima_leadtime = $year . $month . $day;

//                                         // $tgl_fdate_socc=Date('d-m-Y');
//                                         // list($day, $month, $year) = split("-", $tgl_fdate_socc);
//                                         // $tgl_fdate_socc = $year . $month . $day;
                    
//                                         $tgl_terima_leadtime = $_POST['com_tgl_terima' . $j];
//                                         list($day, $month, $year) = split("-", $tgl_terima_leadtime);
//                                         $tgl_terima_leadtime = $year . $month . $day;
                    
//                                         $tgl_fdate_socc=$tgl_kirim;

//                                         ///////////////////////////////////////////
//                                     if ($qtyx != $qty) {
//                                         $ada = $ada + 1;
//                                     }

//                                     // $show_ket .= "item_cat $item_cat / nomor_kontrak $kontrakh / produk $produk<br>";

//                                     if ($so_type == 'ZFC') {
//                                             if($sales_org=='7900' || $sales_org=='7000'){
//                                                 $fce->ORDER_ITEMS_IN->row["TAX_CLASS1"] = "0";    // Tambahan MD 
//                                             }    
//                                     }
//                                     $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
//                                     //$fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $item_cat;
//                                     $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
//                                     $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
//                                     $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
//                                     $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
//                                     if ($kontrak != '' && $sales_org == "7900") {
//                                         $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
//                                         $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
//                                         $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
//                                     }
// //                                    if ($kontrak != '' ) {
// //                                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
// //                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
// //                                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
// //                                    }
//                                     $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

//                                     //detail entri schedule n qty'
//                                     $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
//                                         //////////////////////////////////////////////////////////// proyek SOCC V.2
//                                         // $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
//                                         $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_fdate_socc;
//                                         ///////////////////////////////////////////////////////////                                    
//                                     $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

//                                     $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
//                                     $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
//                                     $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
//                                     $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

//                                     //detail entri distributor dan agen
//                                     if ($j == 0) {
//                                         $item_num = '000000';
//                                     } else {
//                                         $item_num = $item_num;
//                                     }
// //                                    if ($sales_org == '3000') {
// //                                        if ($sampai == 1) {
// //                                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
// //                                        } else {
// //                                            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
// //                                        }
// //                                    } else {
// //                                        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
// //                                    }
//                                     $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
//                                     $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
//                                     $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
//                                     $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
//                                 }
//                             }

//                             //header entri
//                             if ($sales_org == '3000') {
//                                 $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
//                                 if ($fce1 == false) {
//                                     $sap->PrintStatus();
//                                     exit;
//                                 }

//                                 //header entri

//                                 $fce1->ZNMORG = 3000;
//                                 $fce1->ZKUNNR = $shipto;
//                                 $fce1->Call();
//                                 if ($fce1->GetStatus() == SAPRFC_OK) {
//                                     $fce1->RETURN_DATA->Reset();
//                                     while ($fce1->RETURN_DATA->Next()) {
//                                         $kode = $fce1->RETURN_DATA->row["VKGRP"];
//                                     }
//                                 }
//                                 $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
//                             }

//                             //penambahan sales office
//                             $dt_shipto = "SELECT BZIRK, VKBUR, VKGRP FROM RFC_Z_ZCSD_SHIPTO WHERE KUNN2 = '{$shipto}' AND ROWNUM =1";
// //                            echo $dt_shipto;
//                             $dt_shipto_q = oci_parse($conn, $dt_shipto);
//                             oci_execute($dt_shipto_q);
//                             $row_dt_shipto = oci_fetch_array($dt_shipto_q, OCI_ASSOC);

//                             $fce->ORDER_HEADER_IN["SALES_GRP"] = $row_dt_shipto["VKGRP"];
//                             $fce->ORDER_HEADER_IN["SALES_DIST"] = $row_dt_shipto["BZIRK"];
//                             $fce->ORDER_HEADER_IN["SALES_OFF"] = $row_dt_shipto["VKBUR"];
//                             // end penambahan sales office

//                             if ($so_type == 'ZFC') {
//                                 $fce->ORDER_HEADER_IN["DLV_BLOCK"] = "Z1";
//                             } else {
//                                 $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
//                             }
//                             $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
//                             $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
//                             $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
//                             $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00"; 
//                             $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_ppvalpryk; //"Z1";
//                             $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
//                             $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
//                             $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
//                             $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
//                             $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
//                             $fce->ORDER_HEADER_IN["NAME"] = $ket;
//                             $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
//                             $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
//                                 // SOCC V2
//                                 $fce->ORDER_HEADER_IN["TP_DATE"] = 'D';
//                                 $fce->ORDER_HEADER_IN["REQ_DATE_H"] = $tgl_terima_leadtime;  
//                                 /////                            
//                             if ($lcnum != '') {
//                                 $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
//                                 $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
//                             }
                            
//                             if ($kontrakh != '' && $sales_org == "7900") {
//                                 $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
//                                 $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
//                             }
// //                            if ($kontrakh != ''  ) {
// //                                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
// //                                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
// //                            }


//                             $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
//                             $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
//                             $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
//                             $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

//                             $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
//                             $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
//                             $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto_awal;
//                             $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);


//                             if ($sales_org == "7900" || $sales_org == "7000") {
//                                 $strtax = "SELECT * FROM ZMD_CUSTOMER_NOTAX WHERE KD_SOLD_TO = '{$soldto}'  AND DEL = 0";
//                                 $querytax = oci_parse($conn, $strtax);
//                                 oci_execute($querytax);
//                                 $rowtax = oci_fetch_array($querytax, OCI_ASSOC);
//                                 if (ISSET($rowtax["KD_SOLD_TO"])) {
//                                     $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
//                                 } else {
//                                     if ($so_type == 'ZFC') {
//                                     $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "0";
//                                     }else{
//                                     $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1";    
//                                     }
//                                 }

// //                                    $fce->ORDER_HEADER_IN["ALTTAX_CLS"] = "1"; 
//                             }

//                         //    echo '<pre>';
//                         //    print_r($fce);
//                         //    echo '</pre>';
//                                 // SOCC V.2
//                                 if($looping=='0' or $looping==0){
//                                     // echo '<pre>';
//                                     // print_r($fce);
//                                     // echo '</pre>';
//                                     $fce->TESTRUN = "X";
//                                 }
//                                 //
//                             $fce->Call();
//                             if ($fce->GetStatus() == SAPRFC_OK) {
//                                 $nomorso = $fce->SALESDOCUMENT;
//                                 $fce->RETURN->Reset();
//                                 while ($fce->RETURN->Next()) {
//                                     $tipe = $fce->RETURN->row["TYPE"];
//                                     $msg = $fce->RETURN->row["MESSAGE"];
//                                     // if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
//                                     //     $show_ket .= $msg;
//                                     //     $show_ket .= '<br>';
//                                     //     $next = "N";
//                                     // }
//                                         //SOCC V.2
//                                         if ($tipe != 'S') {
//                                             // if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
//                                                 $show_ket .= $msg;
//                                                 $show_ket .= '<br>';
//                                                 $next = "N";
//                                                 $show_ket .= 'SO long text';
//                                                 $show_ket .= '<br>';
//                                                 $movetestrun='X';
//                                                 $nomorso = '';
//                                             }
//                                             ///////////////                                    
//                                 }

//                                 //Commit Transaction
//                                 $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                             }
//                         }   
//                         // $looping +=1;
//                         }

//                             //Update SO
//                             if ($nomorso != '' && $j > 0) {
//                                 sleep(5); //seconds to wait..   
//                                 $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
//                                 $fce->SALESDOCUMENT = $nomorso; //"ZOR";
//                                 $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
//                                 $fce->Call();

//                                 //Commit Transaction
//                                 $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                                 $fce->Call();

//                                 $show_ket .= $ul . "Sales Order telah dibuat dengan nomor : $nomorso <br>";
//                                 $pesan_telegram .= "Approve dengan no SO $nomorso\n";
//                             }




//                             if ($sales_org == 4000) {
//                                 botTelegram('-394888712', $pesan_telegram);
//                             }

//                             // Setelah SO ter create
//                             if ($ul == 1) {
//                                 $SO1 = $nomorso;
//                                 $IDH1 = $idh;
//                             } else if ($ul == 2) {
//                                 $SO2 = $nomorso;
//                                 $IDH2 = $idh;
//                             } else if ($ul == 3) {
//                                 $SO3 = $nomorso;
//                                 $IDH3 = $idh;
//                             } else if ($ul == 4) {
//                                 $SO4 = $nomorso;
//                                 $IDH4 = $idh;
//                             }

//                             if ($next == "Y" && $ul == 1) {

//                                 if (($nomorso != "") and ( $ada == 0))
//                                     $status = "APPROVE";
//                                 else
//                                     $status = "PROCESS";
//                                 //update data header
//                                 $field_names = array('STATUS', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON');
//                                 $field_data = array("$status", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$nomor", "$reason", "$nama_reason");
//                                 $tablename = "OR_TRANS_HDR";
//                                 $field_id = array('ID');
//                                 $value_id = array("$idh");
//                                 $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
//                                 // update data detail
//                                 $sampai1 = $_POST['jumlah'];
//                                 for ($k = 0; $k <= $sampai1; $k++) {
//                                     $idke = "idke" . $k;
//                                     if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                         $id_dtl1 = $_POST['com_iddtl' . $k];
//                                         $qty1 = $_POST['com_qty' . $k];
//                                         $qtyx1 = $_POST['com_qtyx' . $k];
//                                         $kode_distrik = $_POST['com_distrik' . $k];
//                                         $kontrak = $_POST['com_kontrak' . $k];


//                                         if ($sales_org == "7900") {
//                                             $nomor = $fungsi->sapcode($kontrak);
//                                         } else {
//                                             $nomor = "";
//                                         }
// //                                            $nomor = $fungsi->sapcode($kontrak);
//                                         $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
//                                         $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);

//                                         if (($nomorso != "") and ( $qty1 == $qtyx1))
//                                             $status1 = "APPROVE";
//                                         else
//                                             $status1 = "PROCESS";

//                                         $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT');
//                                         $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$nomor", "$plant", "$nama_plant");
//                                         $tablename = "OR_TRANS_DTL";
//                                         $field_id = array('ID');
//                                         $value_id = array("$id_dtl1");
//                                         $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
//                                         if ($nomorso != "") {
//                                             $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
//                                             $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'KD_PROV', 'NM_PROV', 'PLANT', 'NM_PLANT', 'UOM');
//                                             $tablenamefrom = "OR_TRANS_DTL";
//                                             $tablenameto = "OR_TRANS_APP";
//                                             $field_id1 = array('ID');
//                                             $value_id1 = array("$id_dtl1");
//                                             $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);
//                                         }
//                                     }
//                                 }
//                             }


//                             //Khusus Proyek SI                
//                             if ($so_type == 'ZPR' && $nomorso != "" && ($sales_org == '7000' || $sales_org = '2000' || $sales_org = '5000' || $sales_org = '7900')) {
//                                 sleep(3);
//                                 list($dayFG, $monthFG, $yearFG) = split("-", $tgl_kirim1);
//                                 $tgl_kirimFormat = $yearFG . $monthFG . $dayFG;
//                                 $sqlproyek = "
//                                 select ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1,SUM(QTY_PPK) as QTY_PP from(
//                                 SELECT OR_TRANS_HDR_V.*, to_char(TGL_PP,'DD-MM-YYYY') as TGL_PP1,
//                                 to_char(TGL_KIRIM_PP,'YYYYMMDD') as TGL_KIRIM_PP1,
//                                 to_char(TGL_KIRIM_APPROVE,'DD-MM-YYYY') as TGL_KIRIM_APPROVE1,
//                                 to_char(TGL_TERIMA,'DD-MM-YYYY') as TGL_TERIMA1,
//                                 case when KODE_PRODUK in ('121-301-0110','121-301-0050') then (QTY_PP*40)/1000
//                                 when KODE_PRODUK in ( '121-301-0020','121-301-0060','121-301-0056') then (QTY_PP*50)/1000
//                                 else QTY_PP
//                                 end as QTY_PPK,
//                                 substr(KODE_PRODUK,0,7) as TIPE_PRODUK
//                                 FROM OR_TRANS_HDR_V
//                                 WHERE DELETE_MARK = '0'
//                                 AND SO_TYPE='$so_type'
//                                 AND KD_REASON is null
//                                 AND PLANT_ASAL is not null
//                                 AND TIPEPP='NEW PROYEK' 
//                                 AND ORG='$sales_org'
//                                 AND SOLD_TO='$soldto'
//                                 AND PLANT_ASAL='$plant'
//                                 AND NO_PP='$no_ppvalpryk'
//                                 AND STATUS_LINE='APPROVE'
//                                 ORDER BY NO_PP ASC
//                                 )tb1
//                                 group by ORG,SOLD_TO,PLANT_ASAL,TIPE_PRODUK,KODE_TUJUAN,TGL_KIRIM_PP1
//                             ";
//                                 $query_proyek = oci_parse($conn, $sqlproyek);
//                                 oci_execute($query_proyek);
//                                 while ($row_proyek = oci_fetch_array($query_proyek)) {
//                                     $ORGto = $row_proyek['ORG'];
//                                     $SOLD_TOto = $row_proyek['SOLD_TO'];
//                                     $PLANT_ASALto = $row_proyek['PLANT_ASAL'];
//                                     $TIPE_PRODUKto = $row_proyek['TIPE_PRODUK'];
//                                     $KODE_TUJUANto = $row_proyek['KODE_TUJUAN'];
//                                     $TGL_KIRIM_PP1to = $row_proyek['TGL_KIRIM_PP1'];
//                                     $QTY_PPto = $row_proyek['QTY_PP'];
//                                     $sqlcek = "
//                                 select * from (
//                                 select tb1.*,
//                                 case when PLANT is null then (select PLANT from ZSD_MAPPING_PLANTKOTA where DELETE_MARK=0 and DISTRIK=tb1.DISTRIK and ORG=tb1.ORG and rownum=1)
//                                 else PLANT
//                                 end as PLANTSET
//                                 from ZSD_TARGET_HARIAN tb1 where ORG = '$ORGto' and DISTRIK = '$KODE_TUJUANto' 
//                                 and DISTRIBUTOR = '$SOLD_TOto' and
//                                 TIPE = '$TIPE_PRODUKto' and
//                                 to_char(TANGGAL_TARGET, 'YYYYMMDD') ='$TGL_KIRIM_PP1to'
//                                 )
//                                 where PLANTSET='$PLANT_ASALto'
//                                 ";
//                                     $query_cek = oci_parse($conn, $sqlcek);
//                                     oci_execute($query_cek);
//                                     $row_cek = oci_fetch_array($query_cek);
//                                     if ($row_cek['ID'] == '') {
//                                         //insert                            
//                                         $sql2 = "insert into ZSD_TARGET_HARIAN(ORG, TIPE, DISTRIK, DISTRIBUTOR, TANGGAL_TARGET,
//                                              PLANT, TARGET, AKTIF_MARK, CREATE_BY, CREATE_DATE) 
//                                              values ('" . $ORGto . "','" . $TIPE_PRODUKto . "', '" . $KODE_TUJUANto . "', '" . $SOLD_TOto . "', to_date('" . $TGL_KIRIM_PP1to . "', 'YYYYMMDD') ,
//                                             '" . $PLANT_ASALto . "', '" . $QTY_PPto . "','0', '$user_name_in', sysdate)";
//                                         $query2 = oci_parse($conn, $sql2);
//                                         $ins = oci_execute($query2);
//                                     } else {
//                                         //update
//                                         $sql1 = "update ZSD_TARGET_HARIAN set target = target+'" . $QTY_PPto . "', AKTIF_MARK='0', lastupdate_by = '$user_name_in', 
//                                              lastupdate_date = sysdate
//                                              where ID = '" . $row_cek['ID'] . "'";
//                                         $query1 = oci_parse($conn, $sql1);
//                                         $upd = oci_execute($query1);
//                                     }
//                                 }

//                                 //update SAP	
//                                 $sap = new SAPConnection();
//                                 $sap->Connect("../include/sapclasses/logon_data.conf");
//                                 if ($sap->GetStatus() == SAPRFC_OK)
//                                     $sap->Open();
//                                 if ($sap->GetStatus() != SAPRFC_OK) {
//                                     $sap->PrintStatus();
//                                     exit;
//                                 }

//                                 $fce = $sap->NewFunction("ZAPPSD_INS_TARGET_DAY");
//                                 if ($fce == false) {
//                                     $sap->PrintStatus();
//                                     exit;
//                                 }

//                                 $waktuupdatPry = date("Ymd");
//                                 $sqlproyek2 = "
//                                 select tbty.*,to_char(TANGGAL_TARGET, 'YYYYMMDD') as TANGGAL_TARGETF from ZSD_TARGET_HARIAN tbty where ORG='$sales_org'
//                                 and DISTRIBUTOR='$soldto' and AKTIF_MARK=0
//                                 and (to_char(CREATE_DATE, 'YYYYMMDD') ='$waktuupdatPry' or to_char(LASTUPDATE_DATE, 'YYYYMMDD') ='$waktuupdatPry')
//                             ";
//                                 $query_proyek2 = oci_parse($conn, $sqlproyek2);
//                                 oci_execute($query_proyek2);
//                                 $pppp = 0;
//                                 while ($row_proyek2 = oci_fetch_array($query_proyek2)) {

//                                     $pppp++;

//                                     $ORGIto = $row_proyek2['ORG'];
//                                     $DISTRIBUTto = $row_proyek2['DISTRIBUTOR'];
//                                     $PLANTto = $row_proyek2['PLANT'];
//                                     $TIPEto = $row_proyek2['TIPE'];
//                                     $KOTAto = $row_proyek2['DISTRIK'];
//                                     $TGL_TARGETto = $row_proyek2['TANGGAL_TARGETF'];
//                                     $Targetto = $row_proyek2['TARGET'];

//                                     $fce->T_DATA->row["NMORG"] = $ORGIto;
//                                     $fce->T_DATA->row["NMPLAN"] = $PLANTto;
//                                     $fce->T_DATA->row["DISTRIK"] = $KOTAto;
//                                     $fce->T_DATA->row["DISTRIBUTOR"] = $DISTRIBUTto;
//                                     $fce->T_DATA->row["TIPE_SEMEN"] = $TIPEto;
//                                     $fce->T_DATA->row["TARGET_DATE"] = $TGL_TARGETto;
//                                     $fce->T_DATA->row["VOLUME"] = $Targetto;
//                                     $fce->T_DATA->row["ZDELETE"] = '0';
//                                     $fce->T_DATA->row["CREATE_BY"] = $user_name_in;
//                                     $fce->T_DATA->row["CREATE_DATE"] = $waktuupdatPry;
//                                     $fce->T_DATA->row["LAST_UPD_BY"] = $user_name_in;
//                                     $fce->T_DATA->row["LAST_UPD_DATE"] = $waktuupdatPry;
//                                     $fce->T_DATA->Append($fce->T_DATA->row);
//                                 }
//                                 if ($pppp > 0) {
//                                     $fce->Call();
//                                     if ($fce->GetStatus() == SAPRFC_OK) {
//                                         $fce->T_MESSAGE->Reset();
//                                         $i = 0;
//                                         $insert_sap = 0;
//                                         $gagal = array();
//                                         while ($fce->T_MESSAGE->Next()) {
//                                             if ($fce->T_MESSAGE->row["TYPE"] == "W" || $fce->T_MESSAGE->row["TYPE"] == "E") {
//                                                 $gagal[] = $i + 1;
//                                             } else if ($fce->T_MESSAGE->row["TYPE"] == "S")
//                                                 $insert_sap++;

//                                             $i++;
//                                         }
//                                     }
//                                 }
//                             }
//                         }
//                         $jerror += 1;
//                     }else if ($ul == 2 || $ul == 4 && $COM == "SBI") {

//                         //print_r($ul);
//                         //print_r("<br />");
//                         // build array material
//                         $Tmaterial = array();
//                         $Tmaterial['MaterialCode'] = array();
//                         $Tmaterial['PlantCode'] = array();
//                         $Tmaterial['Qty'] = array();
//                         $Tmaterial['QtyUnit'] = array();
//                         $Tmaterial['ScheduleLine'] = array();
//                         $Tmaterial['RequestDeliveryDate'] = array();
//                         $Tmaterial['RequestDeliveryQty'] = array();
//                         $Dmaterial = array();
//                         for ($j = 0; $j <= $sampai - 1; $j++) {
//                             $material = $_POST['com_produk' . $j];
//                             $strmat = "SELECT CAST(NTGEW AS float) as BERAT, A.* FROM RFC_Z_ZCSD_LIST_MAT_SALES_2 A WHERE VKORG = '{$sales_org1}' AND MATNR = '{$material}'  AND WERKS = '{$plant1}'";
//                             $querymat = oci_parse($conn, $strmat);
//                             oci_execute($querymat);
//                             $rowmat = oci_fetch_array($querymat, OCI_ASSOC);
//                             if (count($rowmat) > 0 && $rowmat['MEINS'] == "ZAK") {
//                                 $qty = ( intval($_POST['com_qty' . $j]) * $rowmat['BERAT'] ) / 1000;
//                                 $qtyx = ( intval($_POST['com_qtyx' . $j]) * $rowmat['BERAT'] ) / 1000;
//                             } else {
//                                 $qty = $_POST['com_qty' . $j];
//                                 $qtyx = $_POST['com_qtyx' . $j];
//                             }

//                             $shiptotocek = $_POST['com_shipto' . $j];
//                             $item_numline = sprintf("%04d", $j + 1);
//                             $tanggall = $_POST['com_tgl_kirim' . $j];
//                             list($day, $month, $year) = split("-", $tanggall);
//                             $tgl_kirim = $year . "-" . $month . "-" . $day;

//                             $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
//                             $querymaterial = oci_parse($conn, $strmaterial);
//                             oci_execute($querymaterial);
//                             $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);

//                             if ($ul == 2) {
//                                 $materialsbi = $rowmaterial["KD_MATERIAL_OPCO"];
//                             } else if ($ul == 4) {
//                                 $materialsbi = $rowmaterial["KD_MATERIAL_OPCO_2"];
//                             }
//                             $Tmaterial['MaterialCode'] = $materialsbi;
//                             $Tmaterial['PlantCode'] = $plant;
//                             $Tmaterial['Qty'] = $qty;
//                             $Tmaterial['QtyUnit'] = "TO";
//                             $Tmaterial['ScheduleLine'] = $item_numline;
//                             $Tmaterial['RequestDeliveryDate'] = $tgl_kirim;
//                             $Tmaterial['RequestDeliveryQty'] = $qtyx;
//                             $Dmaterial[] = $Tmaterial;
//                         }

//                         //print_r($so_type."<br />");
//                         //print_r($sales_org."<br />");
//                         $strorder = "SELECT * FROM ZMD_MAPPING_ORDER WHERE ORDER_TYPE_MD = '{$so_type}' AND COMPANY_OPCO = '{$sales_org}' AND DEL = 0";
//                         $queryorder = oci_parse($conn, $strorder);
//                         oci_execute($queryorder);
//                         $roworder = oci_fetch_array($queryorder, OCI_ASSOC);

//                         list($day, $month, $year) = split("-", $tanggall);
//                         $tgl_kirim = $year . $month . $day;

                        
//                         $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
//                         $queryshipto = oci_parse($conn, $strshipto);
//                         oci_execute($queryshipto);
//                         $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                         if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
//                             $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
//                             $queryshipto = oci_parse($conn, $strshipto);
//                             oci_execute($queryshipto);
//                             $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                         }
//                         if ($ul == 2) {
//                             $shipto = $rowshipto['SHIP_TO_OPCO'];
//                             $SOMD = $SO1;
//                             $soldtosbi = $rowshipto['SOLD_TO_OPCO'];
//                         } else if ($ul == 4) {
//                             $shipto = $rowshipto['SHIP_TO_OPCO_2'];
//                             $SOMD = $SO3;
//                             $soldtosbi = $rowshipto['SOLD_TO_OPCO_2'];
//                         }

//                         $tgl_pp = $_POST['tgl_pp'];

//                         list($day, $month, $year) = split("-", $tgl_pp);
//                         $tgl_ppPO = $year . "-" . $month . "-" . $day . " 00:00:00";
//                         $tgl_pp = $tgl_fdate_socc;
//                         list($day, $month, $year) = split("-", $tgl_pp);
//                         $tgl_pp = $year . $month . $day;


//                         if ($sales_org == "PTSC") {
//                             $sales_organization = "SCBD";
//                         } else if ($sales_org == "ID50") {
//                             $sales_organization = "ID11";
//                         }

//                         if(empty($ship_condition)){
                        
//                             if ($incoterm1 == "FOT") {
//                                 $shipcond_sbi = "PK";
//                             } else if ($incoterm1 == "FRC") {
//                                 $shipcond_sbi = "D0";
//                             } else if ($incoterm1 == "CNF") {
//                                 $shipcond_sbi = "DV";
//                             } else {
//                                 $shipcond_sbi = "";
//                             }
                        
//                         }else{
//                             $shipcond_sbi = $ship_condition;
//                         }
                        
//                         $strtop = "SELECT * FROM ZMD_MAPPING_TOP WHERE COM_SMI = '{$sales_org1}' AND TOP_SMI = '{$top}' AND (COM_SB = '{$sales_org}' or COM_SB = 'ALL')  AND DEL = 0 order by COM_SB DESC";
//                         $querytop = oci_parse($conn, $strtop);
//                         oci_execute($querytop);
//                         $rowtop = oci_fetch_array($querytop, OCI_ASSOC);
//                         if (ISSET($rowtop['TOP_SB'])) {
//                             $topsbi = $rowtop['TOP_SB'];
//                         }else{
//                             $topsbi = null;
//                         }    
//                         $url = 'https://sip.solusibangunindonesia.com/APIMD/CreateSalesOrder';
//                         $data = array('Token' => 'aSsMx7GV0HFGzlufM4DH',
//                             'SystemID' => 'PASSO',
//                             'Data' => array('SalesDocumentType' => $roworder["ORDER_TYPE_OPCO"],
//                                 'SalesOrganization' => $sales_organization,
//                                 'DistributionChannel' => 'DB',
//                                 'Division' => 'CM',
//                                 'SalesDocumentDate' => $tgl_pp,
//                                 'ShippingCondition' => $shipcond_sbi,
//                                 'ShippingType' => 'G4',
//                                 'SoldToCode' => $soldtosbi,
//                                 'ShipToCode' => $shipto,
//                                 'MDReferenceSONumber' => $SOMD,
//                                 'MDPurchaseOrderNumber' => $no_pp,
//                                 'MDPurchaseOrderItem' => '00010',
//                                 'PurchaseOrderNumber' => $no_pp,
//                                 'PurchaseOrderDate' => $tgl_ppPO,
//                                 'PaymentTerms' => $topsbi,
//                                 'Items' => $Dmaterial
//                             )
//                         );
//                         $options = array(
//                             'http' => array(
//                                 'header' => "Content-type: application/json\r\n",
//                                 'method' => 'POST',
//                                 'content' => json_encode($data),
//                             )
//                         );



//                         $context = stream_context_create($options);
//                         $result = file_get_contents($url, false, $context);
//                         $response = json_decode($result);
//                         if ($ul == 4) {
//                             $responseSBI2 = $response;
//                         }
//                         $status = $response->Status;
//                         $Message = $response->Message;


//                         $Message_detail = $response->MessageDetail;
//                         $param_send = json_encode($data);
//                         $param_return = json_encode($response);

//                         $field_names = array(
//                             'SEND_PARAM', 'RETURN_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN', 'PESAN_DETAIL', 'TGL'
//                         );
//                         $field_data = array(
//                             "$param_send", "$param_return", "$user_name_in", "$no_pp", "$Message", "$Message_detail", "SYSDATE"
//                         );
//                         $tablename = "ZMD_LOG_SBI";
//                         $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);
//                         //print_r($status);
//                         //print_r($Message);
//                         if ($ul == 2) {
//                             $nomorso = $response->Data->SAPSalesOrderNumber;
//                             $SO2 = $response->Data->SAPSalesOrderNumber;
//                             $tgl_deleteSO2 = $response->Data->SAPCreatedDateStr;
//                         } else if ($ul == 4) {
//                             $nomorso = $response->Data->SAPSalesOrderNumber;
//                             $SO4 = $response->Data->SAPSalesOrderNumber;
//                             $tgl_deleteSO4 = $response->Data->SAPCreatedDateStr;
//                         }

//                         if ($status != 1) {
//                             $next = 'N';
//                             $show_ket .= $ul . ". SO OPCO = " . $Message_detail;
//                             $show_ket .= '<br>';
//                         } else {
//                             $show_ket .= $ul . ". SO OPCO = Sales Order has been made with a number : " . $nomorso;
//                             $show_ket .= '<br>';
//                         }
//                         $Dataarray = json_decode(json_encode($response->Data->Items), true);
//                         //print_r($nomorso);
//                         //echo json_encode($data);

//                         $SOMDNE = 'Y';
//                         $jerror += 1;
//                     } else if ($ul == $perulangan) { // PROSES PERULANGAN TERAKHIR CREATE PO
//                         // GET HARGA PER LINE ITEM
//                         for ($p = 1; $p <= $perulanganPO; $p++) { // perulangan PO MULTI ICS atau TIDAK
//                             if ($p == 1) {
//                                 $incoterm1 = $incotermPO1;
//                                 $incoterm2 = $incotermPO12;
//                                 $distr_chan = $distr_chanPO1;
//                             } else {
//                                 $incoterm1 = $incotermPO2;
//                                 $incoterm2 = $incotermPO22;
//                                 $distr_chan = $distr_chanPO2;
//                             }
//                             //perubahan get KD VENDOR
//                             $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'  AND DEL = 0";
//                             $querykdven = oci_parse($conn, $strkdven);
//                             oci_execute($querykdven);
//                             $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);

//                             if ($p == 1) {
//                                 $SO_PO = $SO2;
//                                 $vendorFIX = $rowkdven["KET"];
//                                 $COM = $rowkdven["COM_MD"];
//                                 $COM_HARGA = $rowkdven["COM_OPCO"];
//                                 $plantPO = $plant1;
//                             } else if ($p == 2) {
//                                 $SO_PO = ($SO3 != "" ? $SO3 : $SO4);
//                                 $vendorFIX = $rowkdven["KET_OPCO"];
//                                 $COM = $rowkdven["COM_OPCO"];
//                                 $COM_HARGA = $rowkdven["COM_MD_2"];
//                                 $plantPO = $plant2;
//                             } else if ($p == 3) {
//                                 $SO_PO = $SO4;
//                                 $vendorFIX = $rowkdven["KET2"];
//                                 $COM = $rowkdven["COM_MD_2"];
//                                 $COM_HARGA = $rowkdven["COM_OPCO_2"];
//                                 $plantPO = $plant3;
//                             }
//                             if ($COM != "PTSC" && $COM != "ID50") {
//                                 if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
//                                     $fce = $sap->NewFunction("BAPISDORDER_GETDETAILEDLIST");
//                                     $fce->I_BAPI_VIEW["SDCOND"] = "X";
//                                     $fce->SALES_DOCUMENTS->row["VBELN"] = $SO_PO;
//                                     $fce->SALES_DOCUMENTS->Append($fce->SALES_DOCUMENTS->row);

//                                     $fce->Call();
//                                     if ($fce->GetStatus() == SAPRFC_OK) {
//                                         $fce->ORDER_CONDITIONS_OUT->Reset();
//                                         $totL = 0;
//                                         $builder = array();
//                                         $dataH = array();
//                                         $dataH["item_number"] = array();
//                                         $dataH["nilai_harga"] = array();
//                                         $dataH["per"] = array();
//                                         $dataH["satuan"] = array();
//                                         while ($fce->ORDER_CONDITIONS_OUT->Next()) {
//                                             if ($fce->ORDER_CONDITIONS_OUT->row["COND_TYPE"] == "ZPR0") {
//                                                 $dataH["item_number"] = $fce->ORDER_CONDITIONS_OUT->row["ITM_NUMBER"];
//                                                 $dataH["nilai_harga"] = $fce->ORDER_CONDITIONS_OUT->row["COND_VALUE"];
//                                                 $dataH["per"] = $fce->ORDER_CONDITIONS_OUT->row["COND_P_UNT"];
//                                                 $dataH["satuan"] = $fce->ORDER_CONDITIONS_OUT->row["COND_D_UNT"];
//                                                 $dataH["satuan2"] = $fce->ORDER_CONDITIONS_OUT->row["T_UNIT_ISO"];
//                                                 $dataH["currency"] = $fce->ORDER_CONDITIONS_OUT->row["CURRENCY"];
//                                                 $builder[] = $dataH;
//                                                 $totL += 1;
//                                             }
//                                         }
//                                         //Commit Transaction
//                                         $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                                         $fce->Call();

//                                         if ($totL != $_POST['jumlah']) {
//                                             $next = "N";
//                                             $show_ket .= "Master Harga Belum Ada...!!!";
//                                             $show_ket .= '<br>';
//                                         }
//                                     }
//                                 }

//                                 if ($next == "Y") {

//                                     // CREATE PO
//                                     $fce = $sap->NewFunction("BAPI_PO_CREATE1");
//                                     $tgl_sekarang = date("Ymd");

//                                    $strven = "SELECT * FROM ZMD_MAPPING_VENDOR_MD WHERE COMPANY_CODE = '{$COM}' AND KD_VENDOR = '{$vendorFIX}' AND DEL =0";
//                                     $queryven = oci_parse($conn, $strven);
//                                     oci_execute($queryven);
//                                     $rowven = oci_fetch_array($queryven, OCI_ASSOC);


//                                     $fce->POHEADER["COMP_CODE"] = $COM; // company kedua
//                                     $fce->POHEADER["DOC_TYPE"] = "ZIC1"; // hardcode
//                                     $fce->POHEADER["VENDOR"] = $vendorFIX; //
//                                     $fce->POHEADER["PMNTTRMS"] = $top;
//                                     $fce->POHEADER["PURCH_ORG"] = $rowven["PURCHASE_ORGANIZATION"];
//                                     $fce->POHEADER["PUR_GROUP"] = $rowven["PURCHASE_GROUP"];
//                                     //                        $fce->POHEADER["CURRENCY"] = "IDR";
//                                     //                        $fce->POHEADER["EXCH_RATE"] = "1";
//                                     $fce->POHEADER["DOC_DATE"] = $tgl_sekarang;
//                                     $fce->POHEADER["INCOTERMS1"] = $incoterm1;
//                                     $fce->POHEADER["INCOTERMS2"] = $incoterm2;


//                                     $fce->POHEADERX["COMP_CODE"] = "x";
//                                     $fce->POHEADERX["DOC_TYPE"] = "x";
//                                     $fce->POHEADERX["VENDOR"] = "x";
//                                     $fce->POHEADERX["PMNTTRMS"] = "x";
//                                     $fce->POHEADERX["PURCH_ORG"] = "x";
//                                     $fce->POHEADERX["PUR_GROUP"] = "x";
//                                     //                        $fce->POHEADERX["CURRENCY"] = "x";
//                                     //                        $fce->POHEADERX["EXCH_RATE"] = "x";
//                                     $fce->POHEADERX["DOC_DATE"] = "x";
//                                     $fce->POHEADERX["INCOTERMS1"] = "x";
//                                     $fce->POHEADERX["INCOTERMS2"] = "x";

//                                     $fce->POTEXTHEADER->row["TEXT_ID"] = "F01";
//                                     $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
//                                     $fce->POTEXTHEADER->row["TEXT_LINE"] = $rowven["KETERANGAN"];
//                                     $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

//                                     $fce->POTEXTHEADER->row["TEXT_ID"] = "F14";
//                                     $fce->POTEXTHEADER->row["TEXT_FORM"] = "/";
//                                     $fce->POTEXTHEADER->row["TEXT_LINE"] = "AUTO GR";
//                                     $fce->POTEXTHEADER->Append($fce->POTEXTHEADER->row);

//                                     $sampai = $_POST['jumlah'];
//                                     for ($j = 0; $j <= $sampai - 1; $j++) {
//                                         $idke = "idke" . $j;
//                                         if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                             $id_dtl = $_POST['com_iddtl' . $j];
//                                             $item_num1 = $_POST['com_line' . $j];
//                                             $item_num = $fungsi->linenum($item_num1);
//                                             $item_numli = $item_num * 10;
//                                             $item_numline = sprintf("%06d", $item_numli);

//                                             $item_numlinePO = sprintf("%05d", $item_numli);
//                                             $material = $_POST['com_produk' . $j];
// //                                    $material1 = $_POST['com_produk' . $j];
// //                                    $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material1}' AND DEL = 0";
// //                                    $querymaterial = oci_parse($conn, $strmaterial);
// //                                    oci_execute($querymaterial);
// //                                    $rowmaterial  = oci_fetch_array($querymaterial, OCI_ASSOC);
// //                                    $material = $rowmaterial['KD_MATERIAL_OPCO'];

//                                             $qty = $_POST['com_qty' . $j];
//                                             $qtyx = $_POST['com_qtyx' . $j];

//                                             if ($sales_org == "7900") {
//                                                 $kontrak = $_POST['com_kontrak' . $j];
//                                             } else {
//                                                 $kontrak = "";
//                                             }
// //                                            $kontrak = $_POST['com_kontrak' . $j];

//                                             $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
//                                             $distrik = $_POST['com_distrik' . $j];

//                                             $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
//                                             list($day, $month, $year) = split("-", $tgl_kirimPO);
//                                             $tgl_kirim = $year . $month . $day;


//                                             $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
//                                             $querymaterial = oci_parse($conn, $strmaterial);
//                                             oci_execute($querymaterial);
//                                             $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


//                                             if ($p == 1) {
//                                                 $material = $_POST['com_produk' . $j];
//                                             } else if ($p == 2) {
//                                                 $material = $rowmaterial['KD_MATERIAL_OPCO'];
//                                             } else if ($p == 3) {
//                                                 $material = $rowmaterial['KD_MATERIAL_MD_2'];
//                                             }

//                                             $mtr_group = substr($material, 0, 7);


//                                             if (($nomorso != "") and ( $qty1 == $qtyx1))
//                                                 $status1 = "APPROVE";
//                                             else
//                                                 $status1 = "PROCESS";

//                                             if ($mtr_group == "121-301") {
//                                                 $nm_material = "SEMEN ZAK";
//                                                 $po_unit = "ZAK";
//                                             } else if ($mtr_group == "121-302") {
//                                                 $nm_material = "SEMEN CURAH";
//                                                 $po_unit = "TO";
//                                             } else if ($mtr_group == "121-200") {
//                                                 $nm_material = "CLINKER";
//                                                 $po_unit = "TO";
//                                             }

// //                                        $strsloc = "SELECT * FROM ZERP_MAP_SLOC WHERE ORG = '{$sales_org1}' AND PLANT = '$plant1' AND KD_MATERIAL = '{$mtr_group}' AND DEL = 0";
// //                                        $queryloc = oci_parse($conn, $strsloc);
// //                                        oci_execute($queryloc);
// //                                        $rowloc = oci_fetch_array($queryloc, OCI_ASSOC);
//                                             // CEK HARGA DARI BAPI COMMIT HARGA
//                                             if ($COM_HARGA != "PTSC" && $COM_HARGA != "ID50") {
//                                                 foreach ($builder as $val) {
//                                                     if ($item_numline == $val['item_number']) {
//                                                         $hargaPO = $val['nilai_harga'];
//                                                         $perPO = $val['per'];
//                                                         $satuanPO = $val['satuan'];
//                                                         $satuan2PO = $val['satuan2'];
//                                                         $currencyPO = $val['currency'];
//                                                     }
//                                                 }
//                                             } else {
//                                                 if ($p == 1) {
//                                                     $datas = $response->Data->Items[$j];
//                                                 } else if ($p == 3) {
//                                                     $datas = $responseSBI2->Data->Items[$j];
//                                                 }
//                                                 $hargaPO = $datas->SAPSalesOrderNetPriceUnit;
//                                                 $perPO = $datas->SAPSalesOrderPerUnit;
//                                                 $satuanPO = $datas->SAPSalesOrderUnit;
//                                                 $satuan2PO = $datas->SAPSalesOrderUnit;
//                                                 $currencyPO = $datas->SAPSalesOrderCurrency;
//                                             }
// //                                    //print_r($builder);
// //                                    //print_r($hargaPO);
// //                                    //print_r($item_numline);

//                                             $fce->POITEM->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POITEM->row["SHORT_TEXT"] = $nm_material;
//                                             $fce->POITEM->row["MATERIAL"] = $material;
//                                             $fce->POITEM->row["PLANT"] = $plantPO;
// //                                    $fce->POITEM->row["STGE_LOC"] = $rowloc['KD_SLOC'];
//                                             $fce->POITEM->row["MATL_GROUP "] = $mtr_group;
//                                             $fce->POITEM->row["QUANTITY"] = $qtyx;
//                                             $fce->POITEM->row["STGE_LOC"] = "D101";
//                                             $fce->POITEM->row["GR_IND"] = "X";
//                                             $fce->POITEM->row["IR_IND"] = "X";
//                                             $fce->POITEM->row["GR_BASEDIV"] = "X";
// //                                        $fce->POITEM->row["FUNDS_CTR"] = "7902000000";
//                                             $fce->POITEM->Append($fce->POITEM->row);

//                                             $fce->POITEMX->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POITEMX->row["SHORT_TEXT"] = "X";
//                                             $fce->POITEMX->row["MATERIAL"] = "X";
//                                             $fce->POITEMX->row["PLANT"] = "X";
// //                                    $fce->POITEMX->row["STGE_LOC"] = "X"; 
//                                             $fce->POITEMX->row["MATL_GROUP "] = "X";
//                                             $fce->POITEMX->row["QUANTITY"] = "X";
//                                             $fce->POITEMX->row["STGE_LOC"] = "X";
//                                             $fce->POITEMX->row["GR_IND"] = "X";
//                                             $fce->POITEMX->row["IR_IND"] = "X";
//                                             $fce->POITEMX->row["GR_BASEDIV"] = "X";
// //                                        $fce->POITEMX->row["FUNDS_CTR"] = "X";
//                                             $fce->POITEMX->Append($fce->POITEMX->row);

//                                             $fce->POTEXTITEM->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POTEXTITEM->row["TEXT_ID"] = "F01";
//                                             $fce->POTEXTITEM->row["TEXT_FORM"] = "/";
//                                             $fce->POTEXTITEM->row["TEXT_LINE"] = "SEMEN PPC";
//                                             $fce->POTEXTITEM->Append($fce->POTEXTITEM->row);

//                                             $fce->POSCHEDULE->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POSCHEDULE->row["SCHED_LINE"] = "0001";
//                                             $fce->POSCHEDULE->row["DELIVERY_DATE"] = $tgl_kirim;
//                                             $fce->POSCHEDULE->row["QUANTITY "] = $qtyx;
//                                             $fce->POSCHEDULE->row["STAT_DATE"] = $tgl_kirim;
//                                             $fce->POSCHEDULE->row["PO_DATE"] = $tgl_kirim;
//                                             $fce->POSCHEDULE->Append($fce->POSCHEDULE->row);

//                                             $fce->POSCHEDULEX->row["PO_ITEM"] = $item_numlinePO;
//                                             $fce->POSCHEDULEX->row["SCHED_LINE"] = "X";
//                                             $fce->POSCHEDULEX->row["DELIVERY_DATE"] = "X";
//                                             $fce->POSCHEDULEX->row["QUANTITY "] = "X";
//                                             $fce->POSCHEDULEX->row["STAT_DATE"] = "X";
//                                             $fce->POSCHEDULEX->row["PO_DATE"] = "X";
//                                             $fce->POSCHEDULEX->Append($fce->POSCHEDULEX->row);



//                                             $fce->POCOND->row["ITM_NUMBER"] = $item_numlinePO;
//                                             $fce->POCOND->row["COND_ST_NO"] = '001';
//                                             $fce->POCOND->row["COND_TYPE"] = "PBXX";
//                                             $fce->POCOND->row["COND_VALUE"] = $hargaPO;
//                                             $fce->POCOND->row["COND_P_UNT"] = $perPO;
//                                             $fce->POCOND->row["COND_UNIT"] = $satuanPO;
//                                             $fce->POCOND->row["COND_UNIT_SO"] = $satuan2PO;
//                                             $fce->POCOND->row["CURRENCY"] = $currencyPO;
//                                             $fce->POCOND->row["CURRENCY_ISO"] = $currencyPO;
//                                             $fce->POCOND->row["CHANGE_ID"] = "U";
//                                             $fce->POCOND->Append($fce->POCOND->row);

//                                             $fce->POCONDX->row["ITM_NUMBER"] = $item_numlinePO;
//                                             $fce->POCONDX->row["COND_ST_NO"] = '001';
//                                             $fce->POCONDX->row["COND_TYPE"] = "x";
//                                             $fce->POCONDX->row["COND_VALUE"] = "x";
//                                             $fce->POCONDX->row["COND_P_UNT"] = "x";
//                                             $fce->POCONDX->row["COND_UNIT"] = "x";
//                                             $fce->POCONDX->row["COND_UNIT_SO"] = "x";
//                                             $fce->POCONDX->row["CURRENCY"] = "x";
//                                             $fce->POCONDX->row["CURRENCY_ISO"] = "x";
//                                             $fce->POCONDX->row["CHANGE_ID"] = "x";
//                                             $fce->POCONDX->Append($fce->POCONDX->row);
//                                         }
//                                     }


//                                     $fce->Call();

//                                     if ($fce->GetStatus() == SAPRFC_OK) {
//                                         $nopoT = $fce->EXPPURCHASEORDER;
//                                         $fce->RETURN->Reset();
//                                         while ($fce->RETURN->Next()) {
//                                             $tipe = $fce->RETURN->row["TYPE"];
//                                             $msg = $fce->RETURN->row["MESSAGE"];
//                                             $show_ket .= $msg;
//                                             $show_ket .= '<br>';
//                                             if ($tipe == 'A' || $tipe == 'X' || $tipe == 'E') {
//                                                 $next = "N";
//                                             }
//                                         }
//                                         //Commit Transaction
//                                         $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                                         $fce->Call();
//                                     }
//                                     $user_org = $_SESSION['user_org'];

//                                     if ($p == 1) {
//                                         $PO1 = $nopoT;
//                                     } else if ($p == 2) {
//                                         $PO2 = $nopoT;
//                                     } else if ($p == 3) {
//                                         $PO3 = $nopoT;
//                                     }
//                                     //SIMPAN PP ICS KEDUA

//                                     if ($next == "Y" && $p == 1) {
//                                         $sampai = $_POST['jumlah'];
//                                         for ($j = 0; $j <= $sampai - 1; $j++) {
//                                             $idke = "idke" . $j;
//                                             if (isset($_POST[$idke]) and $_POST[$idke] != "") {
//                                                 $id_dtl = $_POST['com_iddtl' . $j];
//                                                 $item_num1 = $_POST['com_line' . $j];
//                                                 $item_num = $fungsi->linenum($item_num1);
//                                                 $item_numline = $item_num * 10; //'000010'; 
//                                                 $PO_LINE = sprintf("%05d", $item_numline); //'00010';
//                                                 if ($j == 0) {
//                                                     $numline_pertama = sprintf("%06d", $item_numline * 10); //'000010';
//                                                 }
//                                                 $alamat1 = $_POST['com_alamat' . $j];
// //                                        $material = $_POST['com_produk' . $j];
// //                                        $material1 = $_POST['com_produk' . $j];
//                                                 $material = $_POST['com_produk' . $j];
//                                                 $strmaterial = "SELECT * FROM ZMD_MAPPING_MATERIAL WHERE ORG_MD = '{$sales_org1}' AND PLANT_MD = '{$plant1}' AND KD_MATERIAL_MD = '{$material}' AND DEL = 0";
//                                                 $querymaterial = oci_parse($conn, $strmaterial);
//                                                 oci_execute($querymaterial);
//                                                 $rowmaterial = oci_fetch_array($querymaterial, OCI_ASSOC);


//                                                 if ($p == 1) {
//                                                     $material = $rowmaterial['KD_MATERIAL_OPCO'];
//                                                 } else if ($p == 2) {
//                                                     $material = $rowmaterial['KD_MATERIAL_MD_2'];
//                                                 } else if ($p == 3) {
//                                                     $material = $rowmaterial['KD_MATERIAL_OPCO_2'];
//                                                 }


//                                                 $qty = $_POST['com_qty' . $j];
//                                                 $qtyx = $_POST['com_qtyx' . $j];
//                                                 if ($sales_org == "7900") {
//                                                     $kontrak = $_POST['com_kontrak' . $j];
//                                                 } else {
//                                                     $kontrak = "";
//                                                 }
// //                                                $kontrak = $_POST['com_kontrak' . $j];

//                                                 $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);
//                                                 $distrik = $_POST['com_distrik' . $j];
//                                                 $shiptotocek = $_POST['com_shipto' . $j];
                                                
//                                                 $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0 AND ORG_OPCO = '{$row['COM_OPCO']}'";
//                                                 $queryshipto = oci_parse($conn, $strshipto);
//                                                 oci_execute($queryshipto);
//                                                 $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                                 if(!ISSET($rowshipto['SHIP_TO_OPCO'])){ 
//                                                     $strshipto = "SELECT * FROM ZMD_MAPPING_CUSTOMER WHERE SOLD_TO_MD = '{$soldtocek}' AND SHIP_TO_MD = '{$shiptotocek}'  AND DEL = 0";
//                                                     $queryshipto = oci_parse($conn, $strshipto);
//                                                     oci_execute($queryshipto);
//                                                     $rowshipto = oci_fetch_array($queryshipto, OCI_ASSOC);
//                                                 }

//                                                 if ($p == 1) {
//                                                     $shipto = $rowshipto['SHIP_TO_OPCO'];
//                                                 } else if ($p == 2) {
//                                                     $shipto = $rowshipto['SHIP_TO_MD_2'];
//                                                 } else if ($p == 3) {
//                                                     $shipto = $rowshipto['SHIP_TO_OPCO_2'];
//                                                 }

//                                                 $shipto = $fungsi->sapcode($shipto);
//                                                 $tgl_terimaPO = $_POST['com_tgl_terima' . $j];
//                                                 $tgl_kirimPO = $_POST['com_tgl_kirim' . $j];
//                                                 list($day, $month, $year) = split("-", $tgl_kirimPO);
//                                                 $tgl_kirim = $year . $month . $day;

//                                                 $mtr_group = substr($material, 0, 7);


//                                                 if (($nomorso != "") and ( $qty1 == $qtyx1))
//                                                     $status1 = "APPROVE";
//                                                 else
//                                                     $status1 = "PROCESS";

//                                                 if ($p == 1) {
//                                                     $SO_ICS = $SO1;
//                                                 } else if ($p == 2) {
//                                                     $SO_ICS = $SO2;
//                                                 } else if ($p == 3) {
//                                                     $SO_ICS = $SO3;
//                                                 }

//                                                 $field_names = array(
//                                                     'NO_PP',
//                                                     'NO_PO',
//                                                     'PO_LINE',
//                                                     'PLANT_PO',
//                                                     'NMPLANT_PO',
//                                                     'KOTA',
//                                                     'NAMA_KOTA',
//                                                     'KODE_PRODUK',
//                                                     'NM_PRODUK',
//                                                     'HARGA_PO',
//                                                     'ORG_PO',
//                                                     'VENDOR',
//                                                     'NM_VENDOR',
//                                                     'QTY_PO',
//                                                     'UOM',
//                                                     'TGL_PO',
//                                                     'STATUS',
//                                                     'NOTE',
//                                                     'CREATE_DATE',
//                                                     'CREATED_BY',
//                                                     'DELETE_MARK',
//                                                     'BULAN',
//                                                     'TAHUN',
//                                                     'QTY_APPROVE',
//                                                     'TGL_PP',
//                                                     'ORG_BY',
//                                                     'VBELN'
//                                                 );
//                                                 $kd_vendor = $vendorFIX;
//                                                 $nopoplus = $nopoT . $PO_LINE;
//                                                 $field_data = array(
//                                                     "$no_pp",
//                                                     "$nopoplus",
//                                                     "$PO_LINE",
//                                                     "$plant1",
//                                                     "$plant1", //belum                   
//                                                     "$distrik",
//                                                     "$distrik", //belum
//                                                     "$material",
//                                                     "$material", //belum
//                                                     "$hargaPO",
//                                                     "$sales_org1",
//                                                     "$kd_vendor",
//                                                     "$kd_vendor", //belum
//                                                     "$qty",
//                                                     "$po_unit",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "$status1",
//                                                     "$ket",
//                                                     "SYSDATE",
//                                                     "$user_name_in",
//                                                     "0",
//                                                     "$month",
//                                                     "$year",
//                                                     "$qtyx",
//                                                     "SYSDATE",
//                                                     "$user_org",
//                                                     "$SO_ICS"
//                                                 );
//                                                 $tablename = "OR_TRANS_HDR_ICS";
//                                                 $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

//                                                 //Oracle Detail
//                                                 $field_names2 = array(
//                                                     'NO_PP',
//                                                     'KODE_PRODUK',
//                                                     'NAMA_PRODUK',
//                                                     'QTY_PP',
//                                                     'QTY_APPROVE',
//                                                     'TGL_KIRIM_PP',
//                                                     'TGL_KIRIM_APPROVE',
//                                                     'TGL_TERIMA',
//                                                     'SHIP_TO',
//                                                     'NAMA_SHIP_TO',
//                                                     'ALAMAT_SHIP_TO',
//                                                     'DELETE_MARK',
//                                                     'STATUS_LINE',
//                                                     'KODE_TUJUAN',
//                                                     'NAMA_TUJUAN',
//                                                     'ITEM_NUMBER',
//                                                     'NO_SO',
//                                                     'FLAG_KAPAL',
//                                                     'KETERANGAN',
//                                                     'NAMA_KAPAL',
//                                                     'NO_KONTRAK',
//                                                     'KD_PROV',
//                                                     'NM_PROV',
//                                                     'UOM',
//                                                     'PLANT',
//                                                     'NM_PLANT',
//                                                     'PRICE_DATE',
//                                                     'SOLD_TO',
//                                                     'INCOTERM',
//                                                     'CARA_BAYAR',
//                                                     'TERM_PAYMENT',
//                                                     'NAMA_SOLD_TO',
//                                                     'BPLANT',
//                                                     'CREATED_BY',
//                                                     'CREATE_DATE',
//                                                     'NAMA_INCOTERM',
//                                                     'SO_TYPE',
//                                                     'NAMA_SO_TYPE',
//                                                     'ROUTE',
//                                                     'NAMA_TOP',
//                                                     'ORG',
//                                                     'PRICELIST',
//                                                     'NAMA_PRICELIST',
//                                                     'NO_KONTRAK_LC',
//                                                     'KD_REASON',
//                                                     'NM_REASON',
//                                                     'ROUTE_TXT',
//                                                     'CHANNEL',
//                                                     'DIVISION',
//                                                     'TIPE_PEMBELIAN',
//                                                     'NO_POH'
//                                                 );

//                                                 $kodedistrik2 = substr($distrik, 0, 2);
//                                                 $kd_provinsi = "10" . $kodedistrik2;
//                                                 $itemnumplus = sprintf("%06d", $item_numline); //'000010';
//                                                 $field_data2 = array(
//                                                     "$no_pp",
//                                                     "$material",
//                                                     "$material",
//                                                     "$qty",
//                                                     "$qtyx",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "instgl_$tgl_terimaPO",
//                                                     "$shipto",
//                                                     "$shipto",
//                                                     "$alamat1", // belum
//                                                     "0",
//                                                     "$status1",
//                                                     "$distrik",
//                                                     "$distrik",
//                                                     "$itemnumplus",
//                                                     "$SO_ICS",
//                                                     "0",
//                                                     "$ket",
//                                                     " ", //belum
//                                                     "$kontrak", //belum
//                                                     "$kd_provinsi", //belum
//                                                     "$kd_provinsi", //belum
//                                                     "$po_unit", //belum
//                                                     "$plant", // plant kedua
//                                                     "$plant",
//                                                     "instgl_$tgl_kirimPO",
//                                                     "$soldto", //kedua
//                                                     "$incoterm1",
//                                                     "$ketbayar", //belum
//                                                     "$top",
//                                                     "$soldto",
//                                                     "$plant", //
//                                                     "$user_name_in",
//                                                     "SYSDATE",
//                                                     "$incoterm2",
//                                                     "$so_type",
//                                                     "$so_type",
//                                                     "$route",
//                                                     "$nama_top",
//                                                     "$sales_org",
//                                                     "$pricelist",
//                                                     "$nama_pricelist",
//                                                     "$lcnum",
//                                                     "$reason",
//                                                     "$nama_reason",
//                                                     "$ship_cond-$route_desc", //belum
//                                                     "$distr_chan",
//                                                     "$division",
//                                                     "D", //belum
//                                                     "$nopoT"
//                                                 );
//                                                 $tablename2 = "OR_TRANS_DTL_ICS";
//                                                 $fungsi->insert($conn, $field_names2, $field_data2, $tablename2);
//                                             }
//                                         }
//                                     }
//                                 }
//                             }// bukan sbi
//                         } // IF
//                     }
//                 }
//             }


//             if ($next == 'Y') {
//                 //  INSERT TABEL MAPPING
//                 $fceM = $sap->NewFunction("ZCSD_MAP_SO_MD_FM");
//                 if ($fceM == false) {
//                     $sap->PrintStatus();
//                     exit;
//                 }

//                 for ($ref = 1; $ref <= $perulanganSO; $ref++) {
//                     $fce = $sap->NewFunction("Z_ZCSD_UPDATE_REF_SO");
//                     if ($fce == false) {
//                         $sap->PrintStatus();
//                         exit;
//                     }
//                     if ($ref == 1) {
//                         $fce->I_ZVBELN = $SO1;
//                         $fce->I_VBELN = $SO2;
//                         $SOM = 'SO Mega Distributor 1 : ' . $SO1;
//                         $PO_REF = $PO1;
//                         $SOMAP = $SO1;
//                         $orgMAP = $sales_org1;
//                         $plantMAP = $plant1;
//                     } else if ($ref == 2) {
//                         $fce->I_ZVBELN = $SO2;
//                         $fce->I_VBELN = $SO1;
//                         $SOM = 'SO OPCO 1 : ' . $SO2;
//                         $PO_REF = $PO1;
//                         $SOMAP = $SO2;
//                         $orgMAP = $sales_org2;
//                         $plantMAP = $plant2;
//                     } else if ($ref == 3) {
//                         $fce->I_ZVBELN = $SO3;
//                         $fce->I_VBELN = $SO4;
//                         $SOM = 'SO Mega Distributor 2 : ' . $SO3;
//                         $PO_REF = ($SO3 != '' ? $PO2 : "");
//                         $SOMAP = $SO3;
//                         $orgMAP = $sales_org3;
//                         $plantMAP = $plant3;
//                     } else if ($ref == 4) {
//                         if ($SO3 == "") {
//                             $fce->I_ZVBELN = $SO3;
//                             $fce->I_VBELN = $SO4;
//                         } else {
//                             $fce->I_ZVBELN = $SO4;
//                             $fce->I_VBELN = $SO3;
//                         }
//                         $SOM = 'SO OPCO 2 : ' . $SO4;
//                         $PO_REF = ($SO3 == '' ? $PO2 : $PO3);
//                         $SOMAP = $SO4;
//                         $orgMAP = $sales_org4;
//                         $plantMAP = $plant4;
//                     }
//                     $fce->I_PO = $PO_REF;
//                     $fce->I_LINE_ITEM = $numline_pertama;
//                     $fce->Call();
//                     if ($fce->GetStatus() == SAPRFC_OK) {
//                         //while ( $fce->ZMESSAGE->Next() ){
//                         $tipe = $fce->ZMESSAGE["TYPE"];
//                         $msg = $fce->ZMESSAGE["MESSAGE"];
//                         $show_ket .= $SOM . ' ' . $msg . '<br>';
//                         //}
//                     }


//                     if ($SOMAP != "") {
//                         $fceM->T_DATA->row["NO_PP"] = $no_pp;
//                         $fceM->T_DATA->row["VKORG"] = $orgMAP;
//                         $fceM->T_DATA->row["WERKS"] = $plantMAP;
//                         $fceM->T_DATA->row["NO_SO"] = $SOMAP;
//                         $fceM->T_DATA->row["SEQ_NO"] = $ref * 10;
//                         $fceM->T_DATA->row["NO_PO"] = $PO_REF;
//                         $fceM->T_DATA->Append($fceM->T_DATA->row);
//                     }
//                 }


//                 $fceM->Call();
//                 if ($fceM->GetStatus() == SAPRFC_OK) {
//                     //while ( $fce->ZMESSAGE->Next() ){
// //                    $tipe = $fceM->ZMESSAGE["TYPE"];
// //                    $msg = $fceM->ZMESSAGE["MESSAGE"];
// //                    $show_ket .= $ref . ' ' . $msg . '<br>';
//                     //}
//                 }
//             }

//             //PROSES DELETE SO JIKA PROSES SIMPAN SO ERROR KONDISI 'N'
//             if ($next == "N") {
//                 $SOSBI = "N";
//                 if ($SOMDNE == "Y") {
//                     $SOSBIK = "Y";
//                 } else {
//                     $SOSBIK = "N";
//                 }
//                 for ($e = 1; $e <= $jerror; $e++) {
//                     $return = "Y";

//                     // CEK SO SBI ATAU TIDAK
//                     $strkdven = "SELECT * FROM ZMD_MAPPING_PLANT WHERE PLANT_MD = '{$plant1}'";
//                     $querykdven = oci_parse($conn, $strkdven);
//                     oci_execute($querykdven);
//                     $rowkdven = oci_fetch_array($querykdven, OCI_ASSOC);
//                     if ($e == 1) {
//                         $noyo = $SO1;
//                         $IDHU = $IDH1;
//                         $SOSBICEK = "N";
//                     } else if ($e == 2) {
//                         $noyo = $SO2;
//                         $IDHU = $IDH2;
//                         if ($rowkdven["COM_OPCO"] == "PTSC" || $rowkdven["COM_OPCO"] == "ID50") {
//                             $SOSBICEK = "Y";
//                         } else {
//                             $SOSBICEK = "N";
//                         }
//                     } else if ($e == 3) {
//                         $noyo = $SO3;
//                         $IDHU = $IDH3;
//                         $SOSBICEK = "N";
//                     } else if ($e == 4) {
//                         $noyo = $SO4;
//                         $IDHU = $IDH4;
//                         if ($rowkdven["COM_OPCO_2"] == "PTSC" || $rowkdven["COM_OPCO_2"] == "ID50") {
//                             $SOSBICEK = "Y";
//                         } else {
//                             $SOSBICEK = "N";
//                         }
//                     }

//                     if ($SOSBICEK == 'Y') {
//                         if ($e == 2 || $e == 4) {
//                             if ($e == 2) {
//                                 $TGLend = $tgl_deleteSO2;
//                             } else if ($e == 4) {
//                                 $TGLend = $tgl_deleteSO4;
//                             }

//                             $url = 'https://sip.solusibangunindonesia.com/APIMD/DeleteSalesOrder';
//                             $data = array(
//                                 'Token' => 'aSsMx7GV0HFGzlufM4DH',
//                                 'SystemID' => 'PASSO',
//                                 'SAPSalesOrderNumber' => $noyo,
//                                 'SAPCreatedDate' => $TGLend,
//                             );
//                             $options = array(
//                                 'http' => array(
//                                     'header' => "Content-type: application/json\r\n",
//                                     'method' => 'POST',
//                                     'content' => json_encode($data),
//                                 )
//                             );

//                             $context = stream_context_create($options);
//                             $result = file_get_contents($url, false, $context);
//                             $response = json_decode($result);
//                             $status = $response->Status;
//                             $Message = $response->Message;
//                             if ($status != '1') {
//                                 $return = 'N';
//                             }
//                         }
//                     } else {
//                         $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
//                         if ($fce == false) {
//                             $sap->PrintStatus();
//                             exit;
//                         }

//                         //header entri    
//                         $fce->SALESDOCUMENT = $noyo; //"ZOR";
//                         $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'D'; //"Z1";

//                         $fce->Call();

//                         if ($fce->GetStatus() == SAPRFC_OK) {
//                             $fce->RETURN->Reset();
//                             while ($fce->RETURN->Next()) {
//                                 $msg .= '<div align="center">';
//                                 $error = $fce->RETURN->row["TYPE"];
//                                 $msg .= $fce->RETURN->row["MESSAGE"];

//                                 if ($error == 'A' || $error == 'X' || $error == 'E') {
//                                     $return = 'N';
//                                 }
//                             }
//                             $msg .= '<br></div>';
//                             //Commit Transaction
//                             $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
//                             $fce->Call();
//                         } else {
//                             $fce->PrintStatus();
//                         }
//                     }

//                     if ($return == 'Y') {
//                         $str = "UPDATE OR_TRANS_HDR SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE ID='$IDHU' ";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_APP SET NO_SO = '', QTY_APPROVE=0, STATUS_LINE='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE NO_SO='$noyo' ";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_DTL SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_HDR_ICS SET STATUS='OPEN',LAST_UPDATE_DATE=SYSDATE,LAST_UPDATED_BY='$user_name_in' WHERE VBELN='$noyo'";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $str = "UPDATE OR_TRANS_DTL_ICS SET NO_SO = '',  STATUS_LINE='OPEN',LAST_UPDATED_BY='$user_name_in',LAST_UPDATE_DATE=SYSDATE WHERE NO_SO='$noyo'";
//                         $query = oci_parse($conn, $str);
//                         oci_execute($query);
//                         $show_ket .= 'Sales Order ' . $noyo . ' has been success roolback ';
//                     } else {
//                         $show_ket .= 'Sales Order ' . $noyo . ' has been failed roolback';
//                     }
//                 }
//             }

//             $field_names = array(
//                 'SEND_PARAM', 'USER_SAVE', 'NO_PP', 'PESAN_DETAIL', 'TGL'
//             );
//             $field_data = array(
//                 "SI", "$user_name_in", "$no_pp", "$show_ket", "SYSDATE"
//             );
//             $tablename = "ZMD_LOG_SBI";
//             $sukses = $fungsi->insert($conn, $field_names, $field_data, $tablename);

//             $fce->Close();
//             $sap->Close();
//         }

//         //================================================================

//         $habis = "approve_pryk.php";
//         break;



    //
    //===============================================
//============================================================================================================================

    case "sales_return":
        $user_id = $_SESSION['user_id'];
        if (trim($_POST['org']) != '') {
            $user_org_in = trim($_POST['org']);
        } else {
            $user_org_in = $_SESSION['user_org'];
        }
        $user_name_in = $_SESSION['user_name'];
        $cara_bayar_in = $_POST['pricelist'];
        $jenis_kirim_in = $_POST['incoterm'];
        $nama_kirim_in = $_POST['incoterm_desc'];
        $sold_to_in = $_POST['sold_to'];
        $sold_to_in = $fungsi->sapcode($sold_to_in);
        $nama_sold_to_in = $_POST['nama_sold_to'];
        $route_in = $_POST['route'];
        $plant = $_POST['plant'];
        $nama_plant = $_POST['nama_plant'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $ket = $_POST['keterangan'];
        $kd_kapal = $_POST['kd_kapal'];
        $nm_kapal = $_POST['nm_kapal'];
        $nama_kapal = $kd_kapal . '-' . $nm_kapal;
        $no_pp_in = $fungsi->or_new_pp_number($conn);
        $kdreason = $_POST['kd_reason'];
        $nmreason = $_POST['nama_reason'];
        $no_so = $_POST['noso'];
        $no_spj = $_POST['no_spj'];
        $pricedate = $_POST['pricedate'];

        //@liyantanto
        $pricelist = $_POST['pricelist'];
        $nodo = $_POST['nodo'];
        $route_txt = $_POST['route_txt'];
        $kdpricelist = $_POST['kdpricelist'];
        $kd_eksp = $_POST['kd_eksp'];
        $nm_eksp = $_POST['nm_eksp'];

//		echo "Reason: " .$nmreason. "<br />";
//	echo "sold_to: " . $sold_to_in . "<br />";

        $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'KD_REASON', 'NM_REASON', 'NO_SO_OLD', 'NO_SHP_OLD', 'NO_DO', 'NO_EXPEDITUR', 'NAMA_EXPEDITUR', 'ROUTE_TXT', 'PRICELIST', 'NAMA_PRICELIST', 'PRICE_DATE');
        $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$jenis_kirim_in", "$nama_kirim_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", "$kdreason", "$nmreason", "$no_so", "$no_spj", "$nodo", "$kd_eksp", "$nm_eksp", "$route_txt", "$kdpricelist", "$pricelist", "instgl_$pricedate");
        $tablename = "OR_TRANS_HDR";
        $fungsi->insert($conn, $field_names, $field_data, $tablename);

        //mengubah spj lama 
        $field_names = array('DELETE_MARK');
        $field_data = array("1");
        $tablename = "EX_TRANS_HDR";
        $field_id = array('NO_SHP_TRN');
        $value_id = array("$no_spj");
        $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);

        $show_ket .= "Sales return sukses dibuat dengan no $no_pp_in <br>";

        $sampai = $_POST['jumlah'];
        for ($k = 1; $k <= $sampai; $k++) {
            $shipto = "shipto" . $k;
            $nama_shipto = "nama_shipto" . $k;
            $alamat = "alamat" . $k;
            $kode_distrik = "kode_distrik" . $k;
            $nama_distrik = "nama_distrik" . $k;
            $kode_prov = "kode_prov" . $k;
            $nama_prov = "nama_prov" . $k;
            $produk = "kd_produk" . $k;
            $nama_produk = "nm_produk" . $k;
            $qty = "jml" . $k;
            $uom = "zak" . $k;
            $tgl_kirim = "tgl_kirim" . $k;
            if (isset($_POST[$shipto])) {
                $tgl_kirim_in = $_POST[$tgl_kirim];
                if ($tgl_kirim_in == "")
                    $tgl_kirim_in = date('d-m-Y');
                $shipto_in = $_POST[$shipto];
                $nama_shipto_in = $_POST[$nama_shipto];
                $alamat_in = $_POST[$alamat];
                $produk_in = $_POST[$produk];
                $kode_distrik_in = $_POST[$kode_distrik];
                $nama_distrik_in = $_POST[$nama_distrik];
                $kode_prov_in = $_POST[$kode_prov];
                $nama_prov_in = $_POST[$nama_prov];
                $nama_produk_in = $_POST[$nama_produk];
                $qty_in = $_POST[$qty];
                $uom_in = $_POST[$uom];

                $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$no_so", "$no_spj", "instgl_$pricedate");
                $tablename = "OR_TRANS_DTL";
                $fungsi->insert($conn, $field_names, $field_data, $tablename);

                $show_ket .= "Item $produk_in dengan jumlah $qty_in sukses ditambahkan <br>";
            }
        }
//                
        //@liyantanto penambahan mail pemberitahuan
        //$no_pp_in='0000005473'; 
        if ($user_org_in == '7000' && $no_pp_in != '') {
//                    require_once 'mailsalesreturn.php';
        }
//                
//	}
        $habis = "sales_return.php";
        break;
//=========================================
    case "buatsokonfirm":

        //data header so
        $user_name_in = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        if ($so_type == 'ZEX') {
            $distr_chan = "30";
        } elseif ($so_type == 'ZPR') {
            if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000')
                $distr_chan = "10";
            else
                $distr_chan = "50";
        } else {
            $distr_chan = "10";
        }
        $division = "00";
        $dlv_block = "";
        $distr_chanoo = trim($_POST['distcahnelin']);
        if ($distr_chanoo != '') {
            $distr_chan = $distr_chanoo;
        }
        $soldto = $_POST['distr_id'];
        $soldto = $fungsi->sapcode($soldto);
        $no_pp = $_POST['no_pp'];
        $so_old = $_POST['oldso'];
        $tgl_pp = $_POST['tgl_pp'];
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        $price_datep = $_POST['price_date'];
        list($dayp, $monthp, $yearp) = split("-", $price_datep);
        $price_date = $yearp . $monthp . $dayp;

        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $plant = $_POST['plant'];
        $nama_plant = $_POST['nama_plant'];
        $nm_kapal = $_POST['nm_kapal'];
        $incoterm1 = $_POST['incoterm'];
        $incoterm2 = $_POST['nama_incoterm'];
        $route = $_POST['route'];
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $lcnum = $_POST['lcnum'];
        $lcnum = $fungsi->sapcode($lcnum);
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $ket = "";
        $sampai1 = $_POST['jumlah'];
        for ($j = 0; $j <= $sampai1; $j++) {
            $idke = "idke" . $j;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $kontrakh = $_POST['com_kontrak' . $j];
            }
        }
        $kontrakh = $_POST['com_kontrak0'];

        // jalankan bapi create so sap	
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
        if ($fce == false) {
            $sap->PrintStatus();
            exit;
        }

        //header entri
        $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
        $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
        $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
        $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
        $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
        $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
        $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
        $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
        $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
        $fce->ORDER_HEADER_IN["REF_1"] = $so_old;
        $fce->ORDER_HEADER_IN["PRICE_DATE"] = $price_date;

        if ($kontrakh != '') {
            $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
            $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
        }
        //detail entri item'
        //$zak=$fungsi->qtyso($totalzak*1000);
        $sampai = $_POST['jumlah'];
        $ada = 0;
        for ($j = 0; $j <= $sampai - 1; $j++) {
            $idke = "idke" . $j;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $id_dtl = $_POST['com_iddtl' . $j];
                $item_num1 = $_POST['com_line' . $j];
                $item_num = $fungsi->linenum($item_num1);
                $material = $_POST['com_produk' . $j];
                $shipto = $_POST['com_shipto' . $j];
                $shipto = $fungsi->sapcode($shipto);
                $distrik = $_POST['com_distrik' . $j];
                $qty = $_POST['com_qty' . $j];
                $qtyx = $_POST['com_qtyx' . $j];
                $nospj = $_POST['com_spj' . $j];
                $tgl_kirim = $_POST['com_tgl_kirim' . $j];
                $kontrak = $_POST['com_kontrak' . $j];
                $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);

                list($day, $month, $year) = split("-", $tgl_kirim);
                $tgl_kirim = $year . $month . $day;

                if ($qtyx != $qty) {
                    $ada = $ada + 1;
                }

                $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                //$fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $item_cat;
                $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
                $fce->ORDER_ITEMS_IN->row["REF_1_S"] = $nospj;
                $fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                $fce->ORDER_ITEMS_IN->row["SALES_OFF"] = '10' . substr($distrik, 0, 2);
                if ($kontrak != '') {
                    $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                    $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                    $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                }
                $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                //detail entri schedule n qty'
                $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                //detail entri distributor dan agen
                if ($j == 0)
                    $item_num = '000000';
                else
                    $item_num = $item_num;
                $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
            }
        }

        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
        $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
        $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
        $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

        $fce->Call();
        if ($fce->GetStatus() == SAPRFC_OK) {
            $nomorso = $fce->SALESDOCUMENT;
            $fce->RETURN->Reset();
            while ($fce->RETURN->Next()) {
                $tipe = $fce->RETURN->row["TYPE"];
                $msg = $fce->RETURN->row["MESSAGE"];
                if ($tipe != 'S') {
                    $show_ket .= $msg;
                    $show_ket .= '<br>';
                }
            }

            //Commit Transaction
            $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
            $fce->Call();
        }
        $fce->Close();
        $sap->Close();

        // update no shipment di so
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        $fce1 = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
        if ($fce1 == false) {
            $sap->PrintStatus();
            exit;
        }
        $fce1->SALESDOCUMENT = $nomorso; //"ZOR";
        $fce1->ORDER_HEADER_INX["UPDATEFLAG"] = 'U'; //"Z1";

        $sampai = $_POST['jumlah'];
        for ($j = 0; $j <= $sampai - 1; $j++) {
            $idke = "idke" . $j;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $id_dtl = $_POST['com_iddtl' . $j];
                $item_num1 = $_POST['com_line' . $j];
                $item_num = $fungsi->linenum($item_num1 * 10);
                $nospj = $_POST['com_spj' . $j];

                //update detail item
                $fce1->ORDER_ITEM_INX->row["UPDATEFLAG"] = 'U';
                $fce1->ORDER_ITEM_INX->row["ITM_NUMBER"] = $item_num;
                $fce1->ORDER_ITEM_INX->row["REF_1_S"] = 'X';
                $fce1->ORDER_ITEM_INX->Append($fce1->ORDER_ITEM_INX->row);

                $fce1->ORDER_ITEM_IN->row["ITM_NUMBER"] = $item_num; //'000010';
                $fce1->ORDER_ITEM_IN->row["REF_1_S"] = $nospj;
                $fce1->ORDER_ITEM_IN->Append($fce1->ORDER_ITEM_IN->row);
                //$show_ket.= $nospj.'-'.$nomorso;
            }
        }
        $fce1->Call();

        if ($fce1->GetStatus() == SAPRFC_OK) {
            $fce1->RETURN->Reset();
            while ($fce1->RETURN->Next()) {
                $error = $fce1->RETURN->row["TYPE"];
                $msg = $fce1->RETURN->row["MESSAGE"];
                $show_ket .= $msg;
                $show_ket .= '<br>';
            }
            //Commit Transaction
            $fce1 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
            $fce1->Call();
            $fce1->Close();
        }
        $sap->Close();

        if (($nomorso != "") and ( $ada == 0))
            $status = "APPROVE";
        else
            $status = "PROCESS";
        //update data header
        $field_names = array('PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'STATUS', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON', 'ORG');
        $field_data = array("$plant", "$nama_plant", "$top", "$status", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$lcnum", "$reason", "$nama_reason", "$sales_org");
        $tablename = "OR_TRANS_HDR";
        $field_id = array('ID');
        $value_id = array("$idh");
        $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
        // update data detail
        $sampai1 = $_POST['jumlah'];
        for ($k = 0; $k <= $sampai1; $k++) {
            $idke = "idke" . $k;
            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $id_dtl1 = $_POST['com_iddtl' . $k];
                $qty1 = $_POST['com_qty' . $k];
                $qtyx1 = $_POST['com_qtyx' . $k];
                $nospj = $_POST['com_spj' . $k];
                $posnr = $_POST['com_posnr' . $k];
                $kode_distrik = $_POST['com_distrik' . $k];
                $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                // $show_ket.=$nospj; 
                if (($nomorso != "") and ( $qty1 == $qtyx1))
                    $status1 = "APPROVE";
                else
                    $status1 = "PROCESS";

                $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$plant", "$nama_plant", "$so_old", "$nospj", "updtgl_$price_datep");
                $tablename = "OR_TRANS_DTL";
                $field_id = array('ID');
                $value_id = array("$id_dtl1");
                $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                if ($nomorso != "") {
                    $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD');
                    $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', "SYSDATE", 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD');
                    $tablenamefrom = "OR_TRANS_DTL";
                    $tablenameto = "OR_TRANS_APP";
                    $field_id1 = array('ID');
                    $value_id1 = array("$id_dtl1");
                    $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);
                }
            }
        }

        $show_ket .= 'Sales Order telah dibuat dengan nomor : ' . $nomorso;
        $aksicetak = "cetak_saleretur.php?nospjold=$nospj";
        $habis = "list_app_sales_return.php";
        break;
//============================================================================================================================
// buatso admin intercompany sales
    case "buatsointer":

        $user_name = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        $distr_chan = "20";
        $division = "00";
        $dlv_block = "";
        $soldto = $_POST['sold_to'];
        $soldto = $fungsi->sapcode($soldto);
        $nama_sold_to = $_POST['nama_sold_to'];
        $tgl_pp = date("d-m-Y");
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        //$tanggal=gmdate("Ymd",time()+60*60*7);
        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $plant = $_POST['plant'];
        $nama_plant = $_POST['nama_plant'];
        $incoterm1 = $_POST['jenis_kirim'];
        $incoterm2 = $_POST['nama_kirim'];
        $route = $_POST['route'];
        $kd_kapal = $_POST['kd_kapal'];
        $nm_kapal = $_POST['nm_kapal'];
        $nama_kapal = $kd_kapal . '-' . $nm_kapal;
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $no_pp = $fungsi->or_new_pp_number($conn);
        $sampai1 = $_POST['jumlah'];

        //call bapi sales order sap
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
        if ($fce == false) {
            $sap->PrintStatus();
            exit;
        }

        //header entri
        $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
        $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
        $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
        $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
        $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
        $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
        $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
        $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
        $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
        $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
        $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;

        //detail entri item'
        $sampai = $_POST['jumlah'];
        for ($j = 1; $j <= $sampai; $j++) {
            $item_num = $j;
            $shipto = "shipto" . $j;
            $kode_distrik = "kode_distrik" . $j;
            $produk = "produk" . $j;
            $qty = "com_qty" . $j;
            $tgl_kirim = "tgl_kirim" . $j;
            $kontrak = "com_kontrak" . $j;
            $posnr = "com_posnr" . $j;
            $shp = "com_shipment" . $j;
            //if(isset($_POST[$shipto])){
            $tgl_kirim = $_POST['tgl_kirim' . $j];
            list($day, $month, $year) = split("-", $tgl_kirim);
            $tgl_kirim = $year . $month . $day;
            $shipto = $_POST[$shipto];
            $produk = $_POST[$produk];
            $kode_distrik = $_POST[$kode_distrik];
            $qty = $_POST[$qty];
            $kontrak = $_POST[$kontrak];
            $posnr = $fungsi->linenum($_POST[$posnr]);
            $shipment = $_POST[$shp];

            //$show_ket .= "shipto $shipto / kode_distrik $kode_distrik / produk $produk / qty $qty / route $route / plant $plant<br>";

            $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $produk;

            $fce->ORDER_ITEMS_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_ITEMS_INX->row["UPDATEFLAG"] = 'I'; //'000010';
            $fce->ORDER_ITEMS_INX->row["MATERIAL"] = 'X';
            //$fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $item_cat;
            $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
            $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;

            $fce->ORDER_ITEMS_INX->row["PLANT"] = 'X';
            $fce->ORDER_ITEMS_INX->row["ROUTE"] = 'X';

            $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);
            $fce->ORDER_ITEMS_INX->Append($fce->ORDER_ITEMS_INX->row);

            //detail entri schedule n qty'
            $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
            $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
            $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);
//		if ($reason =='Z02') {
            $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
            $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
            $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
            $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);
//		}
            //detail entri distributor dan agen
            if ($j == 1)
                $item_num = '000000';
            else
                $item_num = $item_num;
            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
            //}
        }

        $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
        $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
        $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
        $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

        $fce->Call();
        if ($fce->GetStatus() == SAPRFC_OK) {
            $nomorso = $fce->SALESDOCUMENT;
            $fce->RETURN->Reset();
            while ($fce->RETURN->Next()) {
                $tipe = $fce->RETURN->row["TYPE"];
                $msg = $fce->RETURN->row["MESSAGE"];
                if ($tipe != 'S') {
                    $show_ket .= $msg;
                    $show_ket .= '<br>';
                }
            }
            //Commit Transaction
            $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
            $fcecom->Call();
            $fcecom->Close();
        }
        $fce->Close();
        $sap->Close();

        $show_ket .= "Sales Order telah dibuat dengan nomor : $nomorso <br>";

        if ($nomorso != "") {
            $status = "APPROVE";
            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'NO_SO_OLD', 'PRICE_DATE', 'KD_REASON', 'NM_REASON');
            $field_data = array("$soldto", "$nama_sold_to", "$no_pp", "SYSDATE", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "$status", "SYSDATE", "$user_name", "SYSDATE", "$user_name", "0", "$route", "$sales_org", "$pricelist", "$nama_pricelist", "$lcnum", "$oldso", "instgl_$price_datep", "$reason", "$nama_reason");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);

            $show_ket .= "Permintaan Pembelian Sukses Dibuat Dengan No $no_pp <br>";

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "com_qty" . $k;
                $uom = "uom" . $k;
                $tgl_kirim = "tgl_kirim" . $k;
                $kontrak = "com_kontrak" . $j;
                $shipment = "com_shipment" . $j;

                if (isset($_POST[$shipto])) {
                    $tgl_kirim_in = $_POST[$tgl_kirim];
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $shipto_in = $_POST[$shipto];
                    $nama_shipto_in = $_POST[$nama_shipto];
                    $alamat_in = $_POST[$alamat];
                    $produk_in = $_POST[$produk];
                    $kode_distrik_in = $_POST[$kode_distrik];
                    $nama_distrik_in = $_POST[$nama_distrik];
                    $kode_prov_in = $_POST[$kode_prov];
                    $nama_prov_in = $_POST[$nama_prov];
                    $nama_produk_in = $_POST[$nama_produk];
                    $qty_in = $_POST[$qty];
                    $uom = $_POST[$uom];
                    $kontrak = $_POST[$kontrak];
                    $shipment = $_POST[$shipment];

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                    $field_data = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$soldto", "$nama_sold_to", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep");
                    $tablename = "OR_TRANS_DTL";
                    $tablename1 = "OR_TRANS_APP";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);
                    $fungsi->insert($conn, $field_names, $field_data, $tablename1);
                    $show_ket .= "Item $produk_in Dengan Qty $qty_in Sukses Di Tambahkan <br>";
                }
            }
        } else {
            $status = "PROCESS";
            $show_ket .= "Permintaan Pembelian Gagal Dibuat ! <br>";
        }
        $habis = "ics_tambah.php";
        break;
    //============================================================================================================================
    case "tambah_khusus":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            $user_org_in = $_SESSION['user_org'];
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = $_POST['cara_bayar'];
            $branch_plant_in = $_POST['branch_plant'];
            $nama_plant_in = trim($_POST['nama_plant']);
            $jenis_kirim_in = $_POST['jenis_kirim'];
            $nama_kirim_in = $_POST['jenis_kirim'];
            $nama_kirim_in = $_POST['nama_kirim'];
            $sold_to_in = $_POST['sold_to'];
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = $_POST['nama_sold_to'];
            $route_in = $_POST['route'];
            $plant = $_POST['plant'];
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = $_POST['so_type'];
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = $_POST['kd_kapal'];
            $nm_kapal = $_POST['nm_kapal'];
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
            $no_pp_in = $fungsi->or_new_pp_number($conn);
            $top = $_POST['top'];
            $nama_top = $_POST['nama_top'];
            $pricelist = $_POST['pricelist'];
            $nama_pricelist = $_POST['nama_pricelist'];
            $posnr = $_POST['com_posnr'];

            $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'TIPEPP', 'PRICELIST', 'NAMA_PRICELIST', 'TERM_PAYMENT', 'NAMA_TOP');
            $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", "$tipeCreatePP_isi", "$pricelist", "$nama_pricelist", "$top", "$nama_top");
            $tablename = "OR_TRANS_HDR";
            $fungsi->insert($conn, $field_names, $field_data, $tablename);

            $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

            if ($user_org_in == '6000' && $no_pp_in != '') {
                $aksicetak = "../or_laporan/cetak_hargatebus.php?pporder=$no_pp_in";
            }

            $sampai = $_POST['jumlah'];
            for ($k = 1; $k <= $sampai; $k++) {
                $shipto = "shipto" . $k;
                $nama_shipto = "nama_shipto" . $k;
                $alamat = "alamat" . $k;
                $kode_distrik = "kode_distrik" . $k;
                $nama_distrik = "nama_distrik" . $k;
                $kode_prov = "kode_prov" . $k;
                $nama_prov = "nama_prov" . $k;
                $produk = "produk" . $k;
                $nama_produk = "nama_produk" . $k;
                $qty = "qty" . $k;
                $uom = "uom" . $k;
                $tgl_kirim = "tgl_kirim" . $k;
                $polisinumber = "nopol" . $k;
                $driverlicen = "drivernamenopol" . $k;
                $simdriverlicen = "simdrivernamenopol" . $k;
                $typetruk = "tipetruk" . $k;
                $catatk = "val_addnote" . $k;
                $ktprodukff = "ktproduk" . $k;
                $kontrak = "com_kontrak" . $k;

                if (isset($_POST[$shipto])) {
                    $tgl_kirim_in = $_POST[$tgl_kirim];
                    if ($tgl_kirim_in == "")
                        $tgl_kirim_in = date('d-m-Y');
                    $shipto_in = $_POST[$shipto];
                    $nama_shipto_in = $_POST[$nama_shipto];
                    $alamat_in = $_POST[$alamat];
                    $produk_in = $_POST[$produk];
                    $kode_distrik_in = $_POST[$kode_distrik];
                    $nama_distrik_in = $_POST[$nama_distrik];
                    $kode_prov_in = $_POST[$kode_prov];
                    $nama_prov_in = $_POST[$nama_prov];
                    $nama_produk_in = $_POST[$nama_produk];
                    $qty_in = $_POST[$qty];
                    $uom_in = $_POST[$uom];
                    $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                    $drivernamenopol_in = trim($_POST[$driverlicen]);
                    $simdrivernamenopol_in = trim($_POST[$simdriverlicen]);
                    $typetruk_in = $_POST[$typetruk];
                    $catatkval = trim($_POST[$catatk]);
                    $ktprodukffval = trim($_POST[$ktprodukff]);
                    $kontrakval = $_POST[$kontrak];

                    //                                $catatkval=$drivernamenopol_in."|".$simdrivernamenopol_in."|".$catatkval;

                    $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER', 'NO_KONTRAK', 'NO_KONTRAK_POSNR');
                    $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$nopolisi_in", "$typetruk_in", "$catatkval", "$ktprodukffval", "$drivernamenopol_in", "$simdrivernamenopol_in", "$kontrakval", "$posnr");
                    $tablename = "OR_TRANS_DTL";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);

                    $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                }
            }
        }
        if (isset($_POST['lasthalaman'])) {
            $habis = "tambah2.php";
        } else {
            $habis = "tambah.php";
        }
        break;

    //========================================= Tambah Distblok ==============================================================            

    case "tambahdistblok":

        $shipto = $_POST['shipto'];
        $plant = $_POST['plant'];
//                $createdate = date();
        $createby = $_SESSION['user_name'];
        $field = array('KODE_SHIP_TO', 'PLANT');
        $findby = array("$shipto", "$plant");
        $ada = $fungsi->isThere($conn, 'OR_DISTBLOCK', $field, $findby, 'ID');
        if ($ada > 0) {
            ?>
            <SCRIPT LANGUAGE="javascript">
                <!--
                alert("Duplication!! \n Distributor block has been registered in the database...!")
                //-->
            </SCRIPT>";
            <?php
        } else if ($ada == 0) {
            $field_names = array('KODE_SHIP_TO', 'PLANT', 'CREATE_DATE', 'DELETE_MARK', 'CREATED_BY', 'UPDATE_DATE', 'UPDATED_BY');
            $field_data = array($shipto, $plant, 'SYSDATE', '0', $createby, '', '');
            $tablename = 'OR_DISTBLOCK';
            $fungsi->insert($conn, $field_names, $field_data, $tablename);

            $ket = "Distblok $shipto Success Add <br>";
        }

        $habis = "tambah_distblok.php";

        $fungsi->close($conn);

        break;

//========================================= Inaktif Distblok ==============================================================

    case "ActiveDistblok":

        $id_aktif = $_REQUEST['id_aktif'];
        $status_upd = $_REQUEST['status_upd'];
        $updateby = $_SESSION['user_name'];
        $field_id = array('ID');
        $value_id = array("$id_aktif");
        $field_names = array('DELETE_MARK', 'UPDATE_DATE', 'UPDATED_BY');
        $field_data = array("$status_upd", "SYSDATE", "$updateby");
        $tablename = "OR_DISTBLOCK";
        $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);

        break;

//========================================= Update Distblok ==============================================================

    case "UpdateDistblok":

        $user_id = trim($_SESSION['user_id']);
        $id = trim($_POST['id_update']);
        $kode_ship_to = trim($_POST['shipto1']);
        $plant = trim($_POST['plant']);

//        echo $kode_ship_to. ' tes ' .$plant;

        $field_id = array('ID');
        $value_id = array("$id");

        if (($kode_ship_to != '') && ($plant != '')) {
            $sqlcek = "select count(*) as JML from OR_DISTBLOCK where PLANT = '$plant' and KODE_SHIP_TO = '$kode_ship_to'";
            $querycek = oci_parse($conn, $sqlcek);
            oci_execute($querycek);
            $rowYY = oci_fetch_array($querycek);
            $nodata = trim($rowYY['JML']);
            if ($nodata == 0) {
                $field_names = array('KODE_SHIP_TO', 'PLANT', 'UPDATE_DATE', 'UPDATED_BY');
                $field_data = array($kode_ship_to, $plant, 'SYSDATE', $user_id);
                $tablename = "OR_DISTBLOCK";
                $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
            } else {
                ?>
                <SCRIPT LANGUAGE="javascript">
                <!--
                    alert("Duplication Distblock!! \n Distblock has been registered in the database...!")
                //-->
                </SCRIPT>";
                <?php
            }
        } else {
//            $field_names=array('NAMA','NAMA_LENGKAP','USER_TYPE','LAST_UPDATE_DATE','LAST_UPDATED_BY','DISTRIBUTOR_ID','NAMA_DISTRIBUTOR','VENDOR','VENDOR_NAME','TOKEN','ALAMAT_EMAIL','CHANNEL');
//            $field_data=array("$nama","$nama_lengkap","$tipe","SYSDATE","$user_id","$distributor_id","$nama_distr","$vendor","$nama_vendor","$token","$email_tt","$channel_tt");
//            $tablename="TB_USER_BOOKING";
//            $fungsi->update($conn,$field_names,$field_data,$tablename,$field_id,$value_id); 
            ?>
            <SCRIPT LANGUAGE="javascript">
                <!--
                alert("Cek Data Input!")
                //-->
            </SCRIPT>";
            <?php
        }
        break;


############################################### CREATE PP MANUAL ###########################
    case "smitambah":
        $user_id = $_SESSION['user_id'];
        if ($user_id == "") {
            ?>
            <SCRIPT LANGUAGE="JavaScript">
                <!--
                alert("You are not authorized to access this page.... \n Login Please...");
                //-->
            </SCRIPT>

            <a href="../index.php">Login....</a>
            <?php
        } else {
            $user_org_in = $_SESSION['user_org'];
            $user_name_in = $_SESSION['user_name'];
            $cara_bayar_in = $_POST['cara_bayar'];
            $branch_plant_in = $_POST['branch_plant'];
            $nama_plant_in = trim($_POST['nama_plant']);
            $jenis_kirim_in = $_POST['jenis_kirim'];
            $nama_kirim_in = $_POST['jenis_kirim'];
            $nama_kirim_in = $_POST['nama_kirim'];
            $sold_to_in = $_POST['sold_to'];
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = $_POST['nama_sold_to'];
            $route_in = $_POST['route'];
            $plant = $_POST['plant'];
            $nama_plant = trim($_POST['nama_plant']);
            $so_type = $_POST['so_type'];
            $nama_so_type = trim($_POST['nama_so_type']);
            $ket = trim($_POST['keterangan']);
            $kd_kapal = $_POST['kd_kapal'];
            $nm_kapal = $_POST['nm_kapal'];
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $no_pp_in = $fungsi->or_new_pp_number($conn);

            IF ($user_org_in == '3000') {
                /* ------------------Tambahan Index Distributor ----------
                  Penambahan Index Distributor
                  Permintaan : Oslani Erwal
                  Tiket Change : 3059
                  /* GET data Detail PP */

                $tgl_kirim1 = date("d-M-Y", strtotime($_POST['tgl_kirim1']));
                $shipto1 = $_POST['shipto1'];
                $nama_shipto1 = $_POST['nama_shipto1'];
                $alamat1 = $_POST['alamat1'];
                $produk1 = $_POST['produk1'];
                $kode_distrik1 = $_POST['kode_distrik1'];
                $nama_distrik1 = $_POST['nama_distrik1'];
                $kode_prov1 = $_POST['kode_prov1'];
                $nama_prov1 = $_POST['nama_prov1'];
                $nama_produk1 = $_POST['nama_produk1'];
                $qty1 = $_POST['qty1'];
                $uom1 = $_POST['uom1'];
                $nopol = strtoupper(trim($_POST['nopol']));
                $drivernamenopol = trim($_POST['drivernamenopol']);
                $simdrivernamenopol = trim($_POST['simdrivernamenopol']);
                $tipetruk = $_POST['tipetruk'];
                $val_addnote = trim($_POST['val_addnote']);
                $ktproduk = trim($_POST['ktproduk']);
                /* Konversi */
                $ZAK50KG = stristr($nama_produk1, "ZAK 50");
                $ZAK40KG = stristr($nama_produk1, "ZAK 40");
                $ZAK42KG = stristr($nama_produk1, "ZAK 42.5");
                IF ($ZAK50KG != '') {
                    $tonase = round(($qty1 / 20), 3);
                } ELSEIF ($ZAK40KG != '') {
                    $tonase = round(($qty1 / 25), 3);
                } ELSEIF ($ZAK42KG != '') {
                    $tonase = round(($qty1 / 23.5), 3);
                } ELSE {
                    $tonase = round(($qty1), 3);
                }
                /* End Konversi */

                ### PENGECEKAN TANGGAL KIRIM
                $tanggal_sekarang = date('d-M-y');
                $date_1 = date('Y-m-d', strtotime($tanggal_sekarang));
                $date_2 = date('Y-m-d', strtotime($tgl_kirim1));
                list($year, $month, $day) = explode('-', $date_1);
                $new_date_1 = sprintf('%04d%02d%02d', $year, $month, $day);
                list($year, $month, $day) = explode('-', $date_2);
                $new_date_2 = sprintf('%04d%02d%02d', $year, $month, $day);
                ### END PENGECEKAN TANGGAL KIRIM

                $bulantahun = date('m-Y');
                $INDEX_DIST = $fungsi->findOneByOne_Boconn($bo_conn, 'TB_PLANT', 'KODE_PLANT', $plant, 'INDEX_DIST');
                IF ($INDEX_DIST == '1') {
                    IF ($so_type == 'ZOR') {
                        IF ($tgl_kirim1 != '' OR $new_date_2 >= $new_date_1) {
                            /// Cek Group ///
                            $KODE_TIPE = $fungsi->findOneByOne_Boconn($bo_conn, 'TB_MASTER_INDEX_GMATERIAL', 'KODE_MATERIAL', $produk1, 'KODE_TIPE');
                            IF ($KODE_TIPE != '') {
                                //Cek Shipto//
                                $field = array('ID_INDEX_PROP', 'ID_INDEX_DISTRIK', 'ID_INDEX_SOLDTO', 'ID_SHIPTO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')", 'TIPE_MATERIAL');
                                $findby = array($kode_prov1, $kode_distrik1, $sold_to_in, $shipto1, $bulantahun, $KODE_TIPE);
                                $SHIPTO_ADA = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_SHIPTO_V', $field, $findby, 'ID_SHIPTO');
                                IF ($SHIPTO_ADA != '') {
                                    //Cek Sisa Kuota Shipto//
                                    $field = array('ID_SOLD_TO', 'ID_DISTRIK', 'ID_SHIPTO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')", 'TIPE_MATERIAL');
                                    $findby = array($sold_to_in, $kode_distrik1, $shipto1, $bulantahun, $KODE_TIPE);
                                    $SISA_SHIPTO = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_SHIPTO_V', $field, $findby, 'SISA_SHIPTO');
                                    //ambil kuota shipto//
                                    $field = array('ID_SOLD_TO', 'ID_DISTRIK', 'ID_SHIPTO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')", 'TIPE_MATERIAL');
                                    $findby = array($sold_to_in, $kode_distrik1, $shipto1, $bulantahun, $KODE_TIPE);
                                    $KUOTA_SHIPTO = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_SHIPTO_V', $field, $findby, 'KUOTA_SHIPTO');
                                    IF ($SISA_SHIPTO == "") {
                                        $SISA_SHIPTO = round($KUOTA_SHIPTO, 3);
                                    } else {
                                        $SISA_SHIPTO = round($SISA_SHIPTO, 3);
                                    }

                                    IF ($tonase <= $SISA_SHIPTO) {
                                        //SIMPAN HEADER PP
                                        $masuk_manual = 1;
                                        $show_ket .= "Item <b>$produk1</b> with Qty <b>$qty1</b> Success<br>";
                                    } ELSE {
                                        $show_ket = "Tonase anda <b>$tonase TON</b> melebihi Sisa Kuota <b>$SISA_SHIPTO TON</b> pada Distrik <b>$nama_distrik1</b><br>";
                                    }
                                } ELSE {
                                    //Ambil Sisa Kuota Sold to Party
                                    $field = array('TIPE_MATERIAL', 'ID_DISTRIK', 'ID_SOLD_TO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')");
                                    $findby = array($KODE_TIPE, $kode_distrik1, $sold_to_in, $bulantahun);
                                    $SISA_PP = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_DISTRIBUTOR_V', $field, $findby, 'SISA_PP');
                                    IF ($SISA_PP > '0') {
                                        $SISA_PP = round($SISA_PP, 3);
                                        IF ($tonase <= $SISA_PP) {
                                            //SIMPAN HEADER PP
                                            $masuk_manual = 1;
                                            $show_ket .= "Item <b>$produk1</b> with Qty <b>$qty1</b> Success<br>";
                                        } ELSE {
                                            $show_ket = "Tonase anda <b>$tonase TON</b> melebihi Sisa Kuota <b>$SISA_PP TON</b> pada Sold to Party <b>$nama_sold_to_in</b> <br>";
                                        }
                                    } ELSEIF ($SISA_PP == '0') {
                                        $show_ket = "Kuota Distributor <b>$nama_sold_to_in</b> pada Distrik <b>$nama_distrik1</b> sudah $SISA_PP<br>";
                                    } ELSE {
                                        $show_ket = "Sold to Party <b>$nama_sold_to_in</b> belum terdaftar pada Index distributor Untuk Bulan " . date('M-Y') . "<br>";
                                    }
                                }
                            } ELSE {
                                $show_ket = "Kode Material <b>$produk1</b> Belum Terdaftar, Silahkan Hubungan Penjualan Semen Padang<br>";
                            }
                        } ELSE {
                            $show_ket = "Tanggal Pengiriman Pada saat create PP tidak boleh kosong / Tanggal Kirim Kecil dari tanggal Sekarang " . $tanggal_sekarang;
                        }
                    } ELSE {
                        /* Hanya untuk Direct Selling Tidak melakukan pengecekan Index Distributor */
                        $masuk_manual = 1;
                    }
                } ELSEIF ($INDEX_DIST == '0') {
                    $masuk_manual = 1;
                } ELSE {
                    $show_ket = "Pada Plant Ini tidak bisa melakukan create PP";
                }
            } ELSE {
                $masuk_manual = 1;
            }

            IF ($masuk_manual == '1') {
                $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'SO_TYPE', 'NAMA_SO_TYPE', 'CARA_BAYAR', 'INCOTERM', 'NAMA_INCOTERM', 'BPLANT', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'NOTE', 'FLAG_INDEX');
                $field_data = array("$sold_to_in", "$nama_sold_to_in", "$no_pp_in", "SYSDATE", "$plant", "$nama_plant", "$so_type", "$nama_so_type", "$cara_bayar_in", "$jenis_kirim_in", "$nama_kirim_in", "$branch_plant_in", "OPEN", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "0", "$route_in", "$user_org_in", "$ket", '1');
                $tablename = "OR_TRANS_HDR";
                $fungsi->insert($conn, $field_names, $field_data, $tablename);

                $show_ket .= "Order Reservation Success Made with No. $no_pp_in <br>";

                if ($user_org_in == '6000' && $no_pp_in != '') {
                    $aksicetak = "../or_laporan/cetak_hargatebus.php?pporder=$no_pp_in";
                }

                $pesan_telegram = "";
                $sampai = $_POST['jumlah'];
                for ($k = 1; $k <= $sampai; $k++) {
                    $shipto = "shipto" . $k;
                    $nama_shipto = "nama_shipto" . $k;
                    $alamat = "alamat" . $k;
                    $kode_distrik = "kode_distrik" . $k;
                    $nama_distrik = "nama_distrik" . $k;
                    $kode_prov = "kode_prov" . $k;
                    $nama_prov = "nama_prov" . $k;
                    $produk = "produk" . $k;
                    $nama_produk = "nama_produk" . $k;
                    $qty = "qty" . $k;
                    $uom = "uom" . $k;
                    $tgl_kirim = "tgl_kirim" . $k;
                    $polisinumber = "nopol" . $k;
                    $driverlicen = "drivernamenopol" . $k;
                    $simdriverlicen = "simdrivernamenopol" . $k;
                    $typetruk = "tipetruk" . $k;
                    $catatk = "val_addnote" . $k;
                    $ktprodukff = "ktproduk" . $k;

                    if (isset($_POST[$shipto])) {
                        $tgl_kirim_in = $_POST[$tgl_kirim];
                        if ($tgl_kirim_in == "")
                            $tgl_kirim_in = date('d-m-Y');
                        $shipto_in = $_POST[$shipto];
                        $nama_shipto_in = $_POST[$nama_shipto];
                        $alamat_in = $_POST[$alamat];
                        $produk_in = $_POST[$produk];
                        $kode_distrik_in = $_POST[$kode_distrik];
                        $nama_distrik_in = $_POST[$nama_distrik];
                        $kode_prov_in = $_POST[$kode_prov];
                        $nama_prov_in = $_POST[$nama_prov];
                        $nama_produk_in = $_POST[$nama_produk];
                        $qty_in = $_POST[$qty];
                        $uom_in = $_POST[$uom];
                        $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                        $drivernamenopol_in = trim($_POST[$driverlicen]);
                        $simdrivernamenopol_in = trim($_POST[$simdriverlicen]);
                        $typetruk_in = $_POST[$typetruk];
                        $catatkval = trim($_POST[$catatk]);
                        $ktprodukffval = trim($_POST[$ktprodukff]);

                        // $catatkval=$drivernamenopol_in."|".$simdrivernamenopol_in."|".$catatkval;

                        $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'UOM', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                        $field_data = array("$no_pp_in", "$produk_in", "$nama_produk_in", "$qty_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name_in", "0", "$kode_distrik_in", "$nama_distrik_in", "OPEN", "$k", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$uom_in", "$nopolisi_in", "$typetruk_in", "$catatkval", "$ktprodukffval", "$drivernamenopol_in", "$simdrivernamenopol_in");
                        $tablename = "OR_TRANS_DTL";
                        $fungsi->insert($conn, $field_names, $field_data, $tablename);

                        $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";

                        $pesan_telegram .= "PP Baru OPEN (PP $no_pp_in)\nDistributor : $nama_sold_to_in \nShipto : $nama_shipto_in \nTipe Order : $nama_so_type \nMaterial : $nama_produk_in \nQty : $qty_in $uom_in \nKet : $ket";
                    }

                    if ($user_org_in == 4000) {
                        botTelegram('-394888712', $pesan_telegram);
                    }
                }
            }
        }
        if (isset($_POST['lasthalaman'])) {
            $habis = "smi_tambahsp.php";
        } else {
            $habis = "smi_tambahsp.php";
        }
        break;
###################################################### CREATE PP OTOMATIS SO ########################
    case "smibuatsoadmin_oto":

        $user_name = $_SESSION['user_name'];
        $user_org_in = $_SESSION['user_org'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $toko = $_POST['shipto1'];
        $plant = $_POST['plant'];

        IF ($user_org_in == '3000') {
            /* ------------------Tambahan Index Distributor ----------
              Penambahan Index Distributor
              Permintaan : Oslani Erwal
              Tiket Change : 3059
              /* GET data Detail PP */
            /* Konversi */

            $nama_produk20 = $_POST['nama_produk1'];
            $produk1 = $_POST['produk1'];
            $qty20 = $_POST['com_qty1'];
            $kode_prov1 = $_POST['kode_prov1'];
            $nama_prov1 = $_POST['nama_prov1'];
            $kode_distrik1 = $_POST['kode_distrik1'];
            $nama_distrik1 = $_POST['nama_distrik1'];
            $sold_to_in = $_POST['sold_to'];
            $sold_to_in = $fungsi->sapcode($sold_to_in);
            $nama_sold_to_in = $_POST['nama_sold_to'];
            $tgl_kirim1 = $_POST['tgl_kirim1'];
            /* Konversi */
            $ZAK50KG = stristr($nama_produk20, "ZAK 50");
            $ZAK40KG = stristr($nama_produk20, "ZAK 40");
            $ZAK42KG = stristr($nama_produk20, "ZAK 42.5");
            IF ($ZAK50KG != '') {
                $tonase = round(($qty20 / 20), 3);
            } ELSEIF ($ZAK40KG != '') {
                $tonase = round(($qty20 / 25), 3);
            } ELSEIF ($ZAK42KG != '') {
                $tonase = round(($qty20 / 23.5), 3);
            } ELSE {
                $tonase = round(($qty20), 3);
            }
            /* End Konversi */

            ### PENGECEKAN TANGGAL KIRIM
            $tanggal_sekarang = date('d-M-y');
            $date_1 = date('Y-m-d', strtotime($tanggal_sekarang));
            $date_2 = date('Y-m-d', strtotime($tgl_kirim1));
            list($year, $month, $day) = explode('-', $date_1);
            $new_date_1 = sprintf('%04d%02d%02d', $year, $month, $day);
            list($year, $month, $day) = explode('-', $date_2);
            $new_date_2 = sprintf('%04d%02d%02d', $year, $month, $day);
            ### END PENGECEKAN TANGGAL KIRIM

            $bulantahun = date('m-Y');
            $INDEX_DIST = $fungsi->findOneByOne_Boconn($bo_conn, 'TB_PLANT', 'KODE_PLANT', $plant, 'INDEX_DIST');
            IF ($INDEX_DIST == '1') {
                IF ($so_type == 'ZOR') {
                    IF ($tgl_kirim1 != '' OR $new_date_2 >= $new_date_1) {
                        /// Cek Group ///
                        $KODE_TIPE = $fungsi->findOneByOne_Boconn($bo_conn, 'TB_MASTER_INDEX_GMATERIAL', 'KODE_MATERIAL', $produk1, 'KODE_TIPE');
                        IF ($KODE_TIPE != '') {
                            //Cek Shipto//
                            $field = array('ID_INDEX_PROP', 'ID_INDEX_DISTRIK', 'ID_INDEX_SOLDTO', 'ID_SHIPTO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')", 'TIPE_MATERIAL');
                            $findby = array($kode_prov1, $kode_distrik1, $sold_to_in, $shipto1, $bulantahun, $KODE_TIPE);
                            $SHIPTO_ADA = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_SHIPTO_V', $field, $findby, 'ID_SHIPTO');
                            IF ($SHIPTO_ADA != '') {
                                //Cek Sisa Kuota Shipto//
                                $field = array('ID_SOLD_TO', 'ID_DISTRIK', 'ID_SHIPTO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')", 'TIPE_MATERIAL');
                                $findby = array($sold_to_in, $kode_distrik1, $shipto1, $bulantahun, $KODE_TIPE);
                                $SISA_SHIPTO = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_SHIPTO_V', $field, $findby, 'SISA_SHIPTO');
                                //ambil kuota shipto//
                                $field = array('ID_SOLD_TO', 'ID_DISTRIK', 'ID_SHIPTO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')", 'TIPE_MATERIAL');
                                $findby = array($sold_to_in, $kode_distrik1, $shipto1, $bulantahun, $KODE_TIPE);
                                $KUOTA_SHIPTO = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_SHIPTO_V', $field, $findby, 'KUOTA_SHIPTO');
                                IF ($SISA_SHIPTO == "") {
                                    $SISA_SHIPTO = round($KUOTA_SHIPTO, 3);
                                } else {
                                    $SISA_SHIPTO = round($SISA_SHIPTO, 3);
                                }

                                IF ($tonase <= $SISA_SHIPTO) {
                                    $masuk_oto = 1;
                                } ELSE {
                                    $show_ket = "Tonase anda <b>$tonase TON</b> melebihi Sisa Kuota <b>$SISA_SHIPTO TON</b> pada Distrik <b>$nama_distrik1</b><br>";
                                }
                            } ELSE {
                                //Ambil Sisa Kuota Sold to Party
                                $field = array('TIPE_MATERIAL', 'ID_DISTRIK', 'ID_SOLD_TO', "TO_CHAR(TO_DATE(AKTIF_DATE, 'DD-MM-YYYY'),'MM-YYYY')");
                                $findby = array($KODE_TIPE, $kode_distrik1, $sold_to_in, $bulantahun);
                                $SISA_PP = $fungsi->findOneByMany_Boconn($bo_conn, 'TB_INDEX_DISTRIBUTOR_V', $field, $findby, 'SISA_PP');
                                IF ($SISA_PP > '0') {
                                    $SISA_PP = round($SISA_PP, 3);
                                    IF ($tonase <= $SISA_PP) {
                                        $masuk_oto = 1;
                                    } ELSE {
                                        $show_ket = "Tonase anda <b>$tonase TON</b> melebihi Sisa Kuota <b>$SISA_PP TON</b> pada Sold to Party <b>$nama_sold_to_in</b><br>";
                                    }
                                } ELSEIF ($SISA_PP == '0') {
                                    $show_ket = "Kuota Distributor <b>$nama_sold_to_in</b> pada Distrik <b>$nama_distrik1</b> sudah $SISA_PP <br>";
                                } ELSE {
                                    $show_ket = "Sold to Party <b>$nama_sold_to_in</b> belum terdaftar pada Index distributor Untuk Bulan " . date('M-Y') . "<br>";
                                }
                            }
                        } ELSE {
                            $show_ket = "Kode Material <b>$produk1</b> Belum Terdaftar, Silahkan Hubungan Penjualan Semen Padang<br>";
                        }
                    } ELSE {
                        $show_ket = "Tanggal Pengiriman Pada saat create PP tidak boleh kosong / Tanggal Kirim Kecil dari tanggal Sekarang " . $tanggal_sekarang;
                    }
                } ELSE {
                    /* Hanya untuk Direct Selling Tidak melakukan pengecekan Index Distributor */
                    $masuk_oto = 1;
                }
            } ELSEIF ($INDEX_DIST == '0') {
                /* Untuk Transaksi pada plant 3201 */
                $masuk_oto = 1;
            } ELSE {
                $show_ket = "Pada Plant Ini tidak bisa melakukan create PP";
            }
        } ELSE {
            /* Untuk Transaksi pada company code selain 3000 */
            $masuk_oto = 1;
        }

        IF ($masuk_oto == '1') {
            //XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
            $sap = new SAPConnection();
            $sap->Connect("../include/sapclasses/logon_data.conf");
            if ($sap->GetStatus() == SAPRFC_OK)
                $sap->Open();
            if ($sap->GetStatus() != SAPRFC_OK) {
                echo $sap->PrintStatus();
                exit;
            }

            $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
            if ($fce1 == false) {
                $sap->PrintStatus();
                exit;
            }

            //header entri		
            $fce1->ZNMORG = 3000;
            $fce1->ZKUNNR = $toko;
            $fce1->Call();
            if ($fce1->GetStatus() == SAPRFC_OK) {
                $fce1->RETURN_DATA->Reset();
                while ($fce1->RETURN_DATA->Next()) {
                    $sales_grp = $fce1->RETURN_DATA->row["VKGRP"];
                }
            }
            //xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
            $nama_so_type = $_POST['nama_so_type'];
            $ket = trim($_POST['keterangan']);
            $sales_org = $_POST['org'];
            $channelnew = $_POST['channels'];
            if ($so_type == 'ZEX') {
                $distr_chan = "30";
            } elseif ($so_type == 'ZPR') {
                $distr_chan = "10";
            } elseif ($so_type == 'ZPR1') {
                $distr_chan = "50";
                $so_type == 'ZPR';
            } else {
                $distr_chan = "10";
            }
            $division = "00";
            $dlv_block = "";
            $soldto = $_POST['sold_to'];
            $soldto = $fungsi->sapcode($soldto);
            $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
            if ($distr_chancondi != '') {
                $distr_chan = $distr_chancondi;
            }
            if ($channelnew != '') {
                $distr_chan = $channelnew;
            }
            $nama_sold_to = $_POST['nama_sold_to']; ## SOLDTO
            $tgl_pp = date("d-m-Y"); ## TGL PP
            list($day, $month, $year) = split("-", $tgl_pp); ## TGL PP
            $tgl_pp = $year . $month . $day; ## TGL PP
            $top = $_POST['top']; ## JENIS PEMBAYARAN
            $nama_top = $_POST['nama_top']; ## JENIS PEMBAYARAN
            $reason = $_POST['reason']; ## ALASAN PEMESANAN
            $nama_reason = $_POST['nama_reason']; ## NAMA PEMESANAN
            $oldso = $_POST['oldso']; ## OLD SO
            $price_datep = $_POST['price_date']; ## PRICE DATE
            list($dayp, $monthp, $yearp) = split("-", $price_datep);
            $price_date = $yearp . $monthp . $dayp;

            $plant = $_POST['plant']; ## PLAN PENGAMBILAN SEMEN
            $nama_plant = trim($_POST['nama_plant']); ## NAMA PLANT PENGAMBILAN SEMEN
            $incoterm1 = $_POST['jenis_kirim']; ## JENIS PENGIRIMAN
            $incoterm2 = $_POST['nama_kirim']; ## JENIS PENGIRIMAN
            $route = $_POST['route']; ## ROUTE PENGIRIMAN
            $kd_kapal = $_POST['kd_kapal']; ## KODE KAPAL
            $nm_kapal = $_POST['nm_kapal']; ## NAMA KAPAL 
            $nama_kapal = $kd_kapal . '-' . $nm_kapal;
            $pricelist = $_POST['pricelist']; ## PRICE LIST
            $nama_pricelist = $_POST['nama_pricelist']; ## NAMA PRICE LIST
            $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
            $no_pp = $fungsi->or_new_pp_number($conn); ## GENERATE NO PP
            $valperlcnum = trim($_POST['perslcnum']);
            $lcnum = $_POST['lcnum'];
            $lcnum = $fungsi->sapcode($lcnum);
            $sampai1 = $_POST['jumlah'];
            $tipeCreatePP_isi = trim($_POST['tipeCreatePP']);
            for ($j = 0; $j <= $sampai1; $j++) {
                $idke = "idke" . $j;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $kontrakh = $_POST['com_kontrak' . $j];
                }
                $nilai_kontrak = $_POST['com_kontrak' . $j];
            }

            $sisa_kredit_limit = $_POST['sisa_cl']; ## SISA CREDIT LIMITS
            $hutang_jt = $_POST['hutang_jt']; ## HUTANG JATUH TEMPO
            $umur_jt = $_POST['umur_hutang_jt']; ## UMUR HUTANG JATUH TEMPO
            ###cek sisa QTY kontrak
            if ($nilai_kontrak <> '') {
                $sap = new SAPConnection();
                $sap->Connect("../include/sapclasses/logon_data.conf");
                if ($sap->GetStatus() == SAPRFC_OK)
                    $sap->Open();
                if ($sap->GetStatus() != SAPRFC_OK) {
                    $sap->PrintStatus();
                    exit;
                }

                $fce = $sap->NewFunction("Z_ZAPPSD_KONTRAK_SI ");
                if ($fce == false) {
                    $sap->PrintStatus();
                    exit;
                }
                $fce->XVKORG = '3000';
                $fce->XVBELN = $nilai_kontrak; //"kontrak";
                $fce->XKUNNR = $soldto; //"dist";
                $fce->XFLAG = 'O'; //open
                $fce->Call();

                $fce->RETURN_DATA->Reset();
                while ($fce->RETURN_DATA->Next()) {
                    $qty = $fce->RETURN_DATA->row["KWMENG"];
                    $real = $fce->RETURN_DATA->row["RFMNG"];
                    $sisa = $qty - $real;
                }
                $fce->Close();
                $sap->Close();
            }

            //$show_ket .= "Melebihi sisa kontrak = ".$sisa."Qty=".$qty."REAL".$real;		
            if ($sisa < $_POST['com_qty1'] and $nilai_kontrak <> '') {
                $show_ket .= "Melebihi sisa kontrak = " . $sisa . " dan Qty So = " . $_POST['com_qty1'];
            } else {
                ### END cek sisa QTY kontrak
                ### GENERATE SO call bapi sales order sap
                $sap = new SAPConnection();
                $sap->Connect("../include/sapclasses/logon_data.conf");
                if ($sap->GetStatus() == SAPRFC_OK)
                    $sap->Open();
                if ($sap->GetStatus() != SAPRFC_OK) {
                    $sap->PrintStatus();
                    exit;
                }

                $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
                if ($fce == false) {
                    $sap->PrintStatus();
                    exit;
                }

                //header entri
                $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
                $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
                $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
                $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
                $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
                $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
                $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp; //"Z1";
                $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
                $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
                $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
                $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
                $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
                $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
                $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
                //$fce->ORDER_HEADER_IN["COLLECT_NO"] = $oldso;
                $fce->ORDER_HEADER_IN["REF_1"] = $oldso;
                $fce->ORDER_HEADER_IN["PRICE_DATE"] = $price_date;
                $fce->ORDER_HEADER_IN["SALES_GRP"] = $sales_grp;

                if ($lcnum != '') {
                    $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                    $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
                    //$fce->ORDER_HEADER_IN["DEPARTM_NO"] = 9;
                    $fce->ORDER_HEADER_IN["REC_POINT"] = 2;
                }
                if ($kontrakh != '') {
                    $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                    $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
                }

                //detail entri item'
                $sampai = $_POST['jumlah'];
                for ($j = 1; $j <= $sampai; $j++) {
                    $item_num = $j;
                    $shipto = "shipto" . $j;
                    $kode_distrik = "kode_distrik" . $j;
                    $produk = "produk" . $j;
                    $qty = "com_qty" . $j;
                    $tgl_kirim = "tgl_kirim" . $j;
                    $kontrak = "com_kontrak" . $j;
                    $posnr = "com_posnr" . $j;
                    $shp = "com_shipment" . $j;
                    //if(isset($_POST[$shipto])){
                    $tgl_kirim = $_POST['tgl_kirim' . $j];
                    list($day, $month, $year) = split("-", $tgl_kirim);
                    $tgl_kirim = $year . $month . $day;
                    $shipto = $_POST[$shipto];
                    $produk = $_POST[$produk];
                    $kode_distrik = $_POST[$kode_distrik];
                    $qty = $_POST[$qty];
                    $kontrak = $_POST[$kontrak];
                    //$posnr=$fungsi->linenum($_POST[$posnr]);
                    $posnr = "10";
                    $shipment = $_POST[$shp];

                    //$show_ket .= "shipto $shipto / kode_distrik $kode_distrik / produk $produk / qty $qty / route $route / plant $plant<br>";

                    $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $produk;

                    $fce->ORDER_ITEMS_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_ITEMS_INX->row["UPDATEFLAG"] = 'I'; //'000010';
                    $fce->ORDER_ITEMS_INX->row["MATERIAL"] = 'X';
                    if ($so_type == 'ZFC') {
                        $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                        if ($sales_org == '6000') {
                            $ITEM_CATEGvali = 'ZKNN';
                        } else if ($sales_org == '4000' || $sales_org == '3000') {
                            $ITEM_CATEGvali = 'ZKLN';
                        } else {
                            $ITEM_CATEGvali = 'ZKNN';
                        }
                        $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;                   
                    }
                    $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                    $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
                    $fce->ORDER_ITEMS_INX->row["PLANT"] = 'X';
                    $fce->ORDER_ITEMS_INX->row["ROUTE"] = 'X';
                    //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $kode_distrik;
                    if ($kontrak != '') {
                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';

                        $fce->ORDER_ITEMS_INX->row["REF_DOC"] = 'X';
                        $fce->ORDER_ITEMS_INX->row["REF_DOC_IT"] = 'X';
                        $fce->ORDER_ITEMS_INX->row["REF_DOC_CA"] = 'X';
                    }

                    // @liyantanto buat tlcc
                    // if ($lcnum!='') {
                    // $fce->ORDER_ITEMS_IN->row["DEPREC_PER"] = $valperlcnum;
                    // $fce->ORDER_ITEMS_INX->row["DEPREC_PER"] = 'X';
                    // } 
                    // if ($reason =='Z02') {
                    // $show_ket .= " shp nya euii ". $shipment;
                    // $fce->ORDER_ITEMS_IN->row["REF_1_S"] = $shipment;
                    // $fce->ORDER_ITEMS_INX->row["REF_1_S"] ='X';
                    // }		

                    $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);
                    $fce->ORDER_ITEMS_INX->Append($fce->ORDER_ITEMS_INX->row);

                    ### DETAIL ENTRI SCHEDULE DAN QTY
                    $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                    $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim;
                    $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);
                    $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                    ### DETAIL ENTRI SOLDTO DAN SHIPTO
                    if ($j == 1)
                        $item_num = '000000';
                    else
                        $item_num = $item_num;
                    $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                    $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                    $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                    // }
                }

                $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
                $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
                $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
                $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

                $fce->Call();
                if ($fce->GetStatus() == SAPRFC_OK) {
                    $nomorso = $fce->SALESDOCUMENT;
                    $fce->RETURN->Reset();
                    while ($fce->RETURN->Next()) {
                        $tipe = $fce->RETURN->row["TYPE"];
                        $msg = $fce->RETURN->row["MESSAGE"];
                        if ($tipe != 'S') {
                            $show_ket .= $msg;
                            $show_ket .= '<br>';
                        }
                    }

                    ## COMMIT TRANSASCTION
                    $fcecom = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                    $fcecom->Call();
                    $fcecom->Close();

                    ## UPDATE SO
                    if ($nomorso != '' && $j > 1) {
                        sleep(5); //seconds to wait..   
                        $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                        $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                        $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                        $fce->Call();

                        ## COMMIT TRANSASCTION
                        $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                        $fce->Call();
                    }

                    if ($sales_org == '6000') {
                        sleep(5); //seconds to wait..			   
                        //Teks
                        unset($tgl_kirimapp);
                        for ($j = 1; $j <= $sampai; $j++) {
                            $item_num1 = $j * 10;
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopolisiv = trim($_POST['nopol' . $j]);
                            $com_drivernamenopolv = trim($_POST['drivernamenopol' . $j]);
                            $com_simdrivernamenopolv = trim($_POST['simdrivernamenopol' . $j]);
                            $com_typetruckv = trim($_POST['tipenopol' . $j]);
                            $com_catatanv = trim($_POST['val_addnote' . $j]);
                            $com_kodekantong = trim($_POST['ktproduk' . $j]);
                            $tgl_kirimappT = trim($_POST['tgl_kirim' . $j]);
                            list($day, $month, $year) = split("-", $tgl_kirimappT);
                            $tgl_kirimapp .= $year . $month . $day . "!";


                            $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                            $fce->I_VBELN = $nomorso; //'000010';
                            $fce->I_POSNR = sprintf("%06d", $item_num); //'000010';
                            $fce->I_TEXT1 = $com_nopolisiv;
                            $fce->I_TEXT2 = $com_typetruckv;
                            $fce->I_TEXT3 = $com_catatanv;
                            $fce->I_TEXT4 = $com_kodekantong;
                            $fce->I_TEXT6 = $com_drivernamenopolv;
                            $fce->I_TEXT7 = $com_simdrivernamenopolv;
                            $fce->Call();
                        }

                        if ($sales_org == '6000' && $nomorso != '') {
                            $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                        }
                    }
                }
                $fce->Close();
                $sap->Close();

                $show_ket .= 'Sales Order has been made with a number : ' . $nomorso . '<br>';

                ## UPDATE NO SHIPMENT KE SO
                if ($reason == 'Z02') {
                    $sap = new SAPConnection();
                    $sap->Connect("../include/sapclasses/logon_data.conf");
                    if ($sap->GetStatus() == SAPRFC_OK)
                        $sap->Open();
                    if ($sap->GetStatus() != SAPRFC_OK) {
                        $sap->PrintStatus();
                        exit;
                    }

                    $fce1 = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                    if ($fce1 == false) {
                        $sap->PrintStatus();
                        exit;
                    }
                    $fce1->SALESDOCUMENT = $nomorso; //"ZOR";
                    $fce1->ORDER_HEADER_INX["UPDATEFLAG"] = 'U'; //"Z1";

                    $sampai = $_POST['jumlah'];
                    for ($j = 1; $j <= $sampai; $j++) {
                        $idke = "idke" . $j;
                        $item_num1 = $j;
                        $id_dtl = $_POST['com_iddtl' . $j];
                        $item_num = $fungsi->linenum($item_num1 * 10);
                        $nospj = $_POST['com_shipment' . $j];

                        //update detail item
                        $fce1->ORDER_ITEM_INX->row["UPDATEFLAG"] = 'U';
                        $fce1->ORDER_ITEM_INX->row["ITM_NUMBER"] = $item_num;
                        $fce1->ORDER_ITEM_INX->row["REF_1_S"] = 'X';
                        $fce1->ORDER_ITEM_INX->Append($fce1->ORDER_ITEM_INX->row);

                        $fce1->ORDER_ITEM_IN->row["ITM_NUMBER"] = $item_num; //'000010';
                        $fce1->ORDER_ITEM_IN->row["REF_1_S"] = $nospj;
                        $fce1->ORDER_ITEM_IN->Append($fce1->ORDER_ITEM_IN->row);
                        //$show_ket.= $nospj.'-'.$nomorso;
                    }
                    $fce1->Call();

                    if ($fce1->GetStatus() == SAPRFC_OK) {
                        $fce1->RETURN->Reset();
                        while ($fce1->RETURN->Next()) {
                            $error = $fce1->RETURN->row["TYPE"];
                            $msg = $fce1->RETURN->row["MESSAGE"];
                            $show_ket .= $msg;
                            $show_ket .= '<br>';
                        }
                        //Commit Transaction
                        $fce1 = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                        $fce1->Call();
                        $fce1->Close();
                    }
                    $sap->Close();
                }


                if ($nomorso != "") {
                    $status = "APPROVE";
                    $field_names = array('SOLD_TO', 'NAMA_SOLD_TO', 'NO_PP', 'TGL_PP', 'PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'STATUS', 'CREATE_DATE', 'CREATED_BY', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'ROUTE', 'ORG', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'NO_SO_OLD', 'PRICE_DATE', 'KD_REASON', 'NM_REASON', 'TIPEPP', 'SISA_KREDIT_LIMIT', 'HUTANG_JATUH_TEMPO', 'UMUR_HUTANG_JT', 'FLAG_INDEX');
                    $field_data = array("$soldto", "$nama_sold_to", "$no_pp", "SYSDATE", "$plant", "$nama_plant", "$top", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "$status", "SYSDATE", "$user_name", "SYSDATE", "$user_name", "0", "$route", "$sales_org", "$pricelist", "$nama_pricelist", "$lcnum", "$oldso", "instgl_$price_datep", "$reason", "$nama_reason", "$tipeCreatePP_isi", "$sisa_kredit_limit", "$hutang_jt", "$umur_jt", "1");
                    $tablename = "OR_TRANS_HDR";
                    $fungsi->insert($conn, $field_names, $field_data, $tablename);

                    $show_ket .= "Order Reservation Success Made with No. $no_pp <br>";

                    $sampai = $_POST['jumlah'];
                    for ($k = 1; $k <= $sampai; $k++) {
                        $shipto = "shipto" . $k;
                        $nama_shipto = "nama_shipto" . $k;
                        $alamat = "alamat" . $k;
                        $kode_distrik = "kode_distrik" . $k;
                        $nama_distrik = "nama_distrik" . $k;
                        $kode_prov = "kode_prov" . $k;
                        $nama_prov = "nama_prov" . $k;
                        $produk = "produk" . $k;
                        $nama_produk = "nama_produk" . $k;
                        $qty = "com_qty" . $k;
                        $uom = "uom" . $k;
                        $tgl_kirim = "tgl_kirim" . $k;
                        $kontrak = "com_kontrak" . $k;
                        $shipment = "com_shipment" . $k;
                        $polisinumber = "nopol" . $k;
                        $drivernamenopolfg = "drivernamenopol" . $k;
                        $simdrivernamenopolfg = "simdrivernamenopol" . $k;
                        $typetruk = "tipetruk" . $k;
                        $catatnke = "val_addnote" . $k;
                        $ktprodukke = "ktproduk" . $k;


                        if (isset($_POST[$shipto])) {
                            $tgl_kirim_in = $_POST[$tgl_kirim];
                            if ($tgl_kirim_in == "")
                                $tgl_kirim_in = date('d-m-Y');
                            $shipto_in = $_POST[$shipto];
                            $nama_shipto_in = $_POST[$nama_shipto];
                            $alamat_in = $_POST[$alamat];
                            $produk_in = $_POST[$produk];
                            $kode_distrik_in = $_POST[$kode_distrik];
                            $nama_distrik_in = $_POST[$nama_distrik];
                            $kode_prov_in = $_POST[$kode_prov];
                            $nama_prov_in = $_POST[$nama_prov];
                            $nama_produk_in = $_POST[$nama_produk];
                            $qty_in = $_POST[$qty];
                            $uom = $_POST[$uom];
                            $kontrak = $_POST[$kontrak];
                            $shipment = $_POST[$shipment];
                            $nopolisi_in = strtoupper(trim($_POST[$polisinumber]));
                            $drivernamenopolfg_in = trim($_POST[$drivernamenopolfg]);
                            $simdrivernamenopolfg_in = trim($_POST[$simdrivernamenopolfg]);
                            $typetruk_in = trim($_POST[$typetruk]);
                            $catatnke_in = trim($_POST[$catatnke]);
                            $ktprodukke_in = trim($_POST[$ktprodukke]);

                            $field_names = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE', 'NO_POLISI', 'TYPE_TRUCK', 'CATATAN', 'KODE_BAG', 'DRIVERN', 'SIMDRIVER');
                            $field_data = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep", "$nopolisi_in", "$typetruk_in", "$catatnke_in", "$ktprodukke_in", "$drivernamenopolfg_in", "$simdrivernamenopolfg_in");
                            $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_PP', 'TGL_KIRIM_APPROVE', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'KD_PROV', 'NM_PROV', 'NO_KONTRAK', 'UOM', 'APPROVE_DATE', 'APPROVE_BY', 'PLANT', 'NM_PLANT', 'NO_SO_OLD', 'NO_SHP_OLD', 'PRICE_DATE');
                            $field_data1 = array("$no_pp", "$produk_in", "$nama_produk_in", "$qty_in", "$qty_in", "instgl_$tgl_kirim_in", "instgl_$tgl_kirim_in", "$shipto_in", "$nama_shipto_in", "$alamat_in", "SYSDATE", "$user_name", "0", "$kode_distrik_in", "$nama_distrik_in", "$status", "$k", "$nomorso", "$nama_kapal", "$kode_prov_in", "$nama_prov_in", "$kontrak", "$uom", "SYSDATE", "$user_name", "$plant", "$nama_plant", "$oldso", "$shipment", "instgl_$price_datep");

                            $tablename = "OR_TRANS_DTL";
                            $tablename1 = "OR_TRANS_APP";
                            $fungsi->insert($conn, $field_names, $field_data, $tablename);
                            $fungsi->insert($conn, $field_names1, $field_data1, $tablename1);
                            $show_ket .= "Item $produk_in with Qty $qty_in Success<br>";
                        }
                    }
                } else {
                    $status = "PROCESS";
                    $show_ket .= "Order Reservation Failed ! <br>";
                }

                if (isset($_POST['lasthalaman'])) {
                    $habis = trim($_POST['lasthalaman']);
                } else {
                    $habis = "tambahadmin.php";
                }
            }
        }
        break;
############################################### APPROVE PP - CREATE SO ###########
    case "smibuatso":

        $pesan_telegram = "";

        ## HEADER SO
        $user_name_in = $_SESSION['user_name'];
        $idh = $_POST['idh'];
        $iddtl = $_POST['iddtl'];
        $so_type = $_POST['so_type'];
        $nama_so_type = $_POST['nama_so_type'];
        $sales_org = $_POST['org']; //$_POST['org'];
        $channelnew = $_POST['channels'];
        if ($so_type == 'ZEX') {
            $distr_chan = "30";
        } elseif ($so_type == 'ZPR') {
            if ($sales_org == '2000' || $sales_org == '7000' || $sales_org == '5000')
                $distr_chan = "10";
            else if ($sales_org == '6000')
                $distr_chan = "10";
            else
                $distr_chan = "50";
        } else {
            $distr_chan = "10";
        }
        $division = "00";
        $dlv_block = "";
        $soldto = $_POST['distr_id'];
        $soldto = $fungsi->sapcode($soldto);
        $distr_chancondi = trim($fungsi->findOneByOne($conn, "TB_USER_BOOKING", "DISTRIBUTOR_ID", $soldto, "CHANNEL"));
        if ($distr_chancondi != '') {
            $distr_chan = $distr_chancondi;
        }
        if ($channelnew != '') {
            $distr_chan = $channelnew;
        }
        $no_pp = $_POST['no_pp'];
        $tgl_pp = $_POST['tgl_pp'];
        list($day, $month, $year) = split("-", $tgl_pp);
        $tgl_pp = $year . $month . $day;
        //$tanggal=gmdate("Ymd",time()+60*60*7);
        $top = $_POST['top'];
        $nama_top = $_POST['nama_top'];
        $reason = $_POST['reason'];
        $nama_reason = $_POST['nama_reason'];
        $plant = $_POST['plant'];
        $nama_plant = trim($_POST['nama_plant']);
        $nm_kapal = $_POST['nm_kapal'];
        $incoterm1 = $_POST['incoterm'];
        $incoterm2 = $_POST['nama_incoterm'];
        $route = $_POST['route'];
        $pricelist = $_POST['pricelist'];
        $nama_pricelist = $_POST['nama_pricelist'];
        $lcnum = $_POST['lcnum'];
        $lcnum = $fungsi->sapcode($lcnum);
        $ship_cond = $fungsi->findOneByOne($conn, "TB_ROUTE", "ROUTE", $route, "SHIP_COND");
        $ket = "";
        $sampai1 = $_POST['jumlah'];
        for ($j = 0; $j <= $sampai1; $j++) {
            $idke = "idke" . $j;
            $pesan_telegram .= "PP $no_pp";

            if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                $kontrakh = $_POST['com_kontrak' . $j];
            }
        }

        ### GENERATE SO
        $sap = new SAPConnection();
        $sap->Connect("../include/sapclasses/logon_data.conf");
        if ($sap->GetStatus() == SAPRFC_OK)
            $sap->Open();
        if ($sap->GetStatus() != SAPRFC_OK) {
            $sap->PrintStatus();
            exit;
        }

        unset($ex_so);
        $ex_so = true;

        if ($ex_so == true) {
            $fce = $sap->NewFunction("BAPI_SALESORDER_CREATEFROMDAT2");
            if ($fce == false) {
                $sap->PrintStatus();
                exit;
            }
            $sampai = $_POST['jumlah'];
            $ada = 0;
            for ($j = 0; $j <= $sampai - 1; $j++) {
                $idke = "idke" . $j;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $id_dtl = $_POST['com_iddtl' . $j];
                    $item_num1 = $_POST['com_line' . $j];
                    $item_num = $fungsi->linenum($item_num1);
                    $material = $_POST['com_produk' . $j];
                    $shipto = $_POST['com_shipto' . $j];
                    $shipto = $fungsi->sapcode($shipto);
                    $distrik = $_POST['com_distrik' . $j];
                    $qty = $_POST['com_qty' . $j];
                    $qtyx = $_POST['com_qtyx' . $j];
                    $tgl_kirim = $_POST['com_tgl_kirim' . $j];
                    $kontrak = $_POST['com_kontrak' . $j];
                    $posnr = $fungsi->linenum($_POST['com_posnr' . $j]);

                    list($day, $month, $year) = split("-", $tgl_kirim);
                    $tgl_kirim = $year . $month . $day;

                    if ($qtyx != $qty) {
                        $ada = $ada + 1;
                    }

                    $fce->ORDER_ITEMS_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_ITEMS_IN->row["MATERIAL"] = $material;
                    if ($so_type == 'ZFC') {
                        //$fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'ZKNN';//$item_cat;///salah revisi dibawah ini   
                        $fce->ORDER_ITEMS_INX->row["ITEM_CATEG"] = 'X'; //$item_cat;  
                        if ($sales_org == '6000') {
                            $ITEM_CATEGvali = 'ZKNN';
                        } else if ($sales_org == '4000' || $sales_org == '3000') {
                            $ITEM_CATEGvali = 'ZKLN';
                        } else {
                            $ITEM_CATEGvali = 'ZKNN';
                        }
                        $fce->ORDER_ITEMS_IN->row["ITEM_CATEG"] = $ITEM_CATEGvali; //$item_cat;
                    }
                    $fce->ORDER_ITEMS_IN->row["PLANT"] = $plant;
                    $fce->ORDER_ITEMS_IN->row["ROUTE"] = $route;
                    //$fce->ORDER_ITEMS_IN->row["SALES_DIST"] = $distrik;
                    if ($kontrak != '') {
                        $fce->ORDER_ITEMS_IN->row["REF_DOC"] = $kontrak;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_IT"] = $posnr;
                        $fce->ORDER_ITEMS_IN->row["REF_DOC_CA"] = 'G';
                    }
                    $fce->ORDER_ITEMS_IN->Append($fce->ORDER_ITEMS_IN->row);

                    ## DETAIL ENTRI TGL SCHEDULE DAN QTY
                    $fce->ORDER_SCHEDULES_IN->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_IN->row["REQ_QTY"] = $qty;
                    $fce->ORDER_SCHEDULES_IN->row["REQ_DATE"] = $tgl_kirim; #### ORDER DATE
                    $fce->ORDER_SCHEDULES_IN->Append($fce->ORDER_SCHEDULES_IN->row);

                    $fce->ORDER_SCHEDULES_INX->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_SCHEDULES_INX->row["UPDATEFLAG"] = 'U';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_QTY"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->row["REQ_DATE"] = 'X';
                    $fce->ORDER_SCHEDULES_INX->Append($fce->ORDER_SCHEDULES_INX->row);

                    ## DETAIL ENTRI SOLDTO DAN SHIPTO
                    if ($j == 0)
                        $item_num = '000000';
                    else
                        $item_num = $item_num;
                    $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = $item_num * 10; //'000010';
                    $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'WE';
                    $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $shipto;
                    $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);
                }
            }

            if ($sales_org == '3000') {
                $fce1 = $sap->NewFunction("Z_ZCSD_SHIPTO");
                if ($fce1 == false) {
                    $sap->PrintStatus();
                    exit;
                }

                //header entri			
                $fce1->ZNMORG = 3000;
                $fce1->ZKUNNR = $shipto;
                $fce1->Call();
                if ($fce1->GetStatus() == SAPRFC_OK) {
                    $fce1->RETURN_DATA->Reset();
                    while ($fce1->RETURN_DATA->Next()) {
                        $kode = $fce1->RETURN_DATA->row["VKGRP"];
                    }
                }
                $fce->ORDER_HEADER_IN["SALES_GRP"] = $kode;
            }

            $fce->ORDER_HEADER_IN["DOC_TYPE"] = $so_type; //"ZOR";
            $fce->ORDER_HEADER_IN["SALES_ORG"] = $sales_org; //"3000";
            $fce->ORDER_HEADER_IN["DISTR_CHAN"] = $distr_chan; //"10";
            $fce->ORDER_HEADER_IN["DIVISION"] = $division; //"00";
            $fce->ORDER_HEADER_IN["DLV_BLOCK"] = $dlv_block; //"Z1";
            $fce->ORDER_HEADER_IN["PURCH_NO_C"] = $no_pp; //"Z1";
            $fce->ORDER_HEADER_IN["PURCH_DATE"] = $tgl_pp;
            $fce->ORDER_HEADER_IN["PMNTTRMS"] = $top; //"Z1";
            $fce->ORDER_HEADER_IN["INCOTERMS1"] = $incoterm1; //"Z1";
            $fce->ORDER_HEADER_IN["INCOTERMS2"] = $incoterm2;
            $fce->ORDER_HEADER_IN["SHIP_COND"] = $ship_cond;
            $fce->ORDER_HEADER_IN["NAME"] = $nm_kapal;
            $fce->ORDER_HEADER_IN["PRICE_LIST"] = $pricelist;
            $fce->ORDER_HEADER_IN["ORD_REASON"] = $reason;
            if ($lcnum != '') {
                $fce->ORDER_HEADER_IN["PMTGAR_PRO"] = 'Z00001';
                $fce->ORDER_HEADER_IN["DOC_NUM_FI"] = $lcnum;
            }
            if ($kontrakh != '') {
                $fce->ORDER_HEADER_IN["REFDOC_CAT"] = 'G';
                $fce->ORDER_HEADER_IN["REF_DOC"] = $kontrakh;
            }

            $fce->ORDER_PARTNERS->row["ITM_NUMBER"] = '000000';
            $fce->ORDER_PARTNERS->row["PARTN_ROLE"] = 'AG';
            $fce->ORDER_PARTNERS->row["PARTN_NUMB"] = $soldto;
            $fce->ORDER_PARTNERS->Append($fce->ORDER_PARTNERS->row);

            $fce->Call();
            if ($fce->GetStatus() == SAPRFC_OK) {
                $nomorso = $fce->SALESDOCUMENT;
                $fce->RETURN->Reset();
                while ($fce->RETURN->Next()) {
                    $tipe = $fce->RETURN->row["TYPE"];
                    $msg = $fce->RETURN->row["MESSAGE"];
                    if ($tipe != 'S') {
                        $show_ket .= $msg;
                        $show_ket .= '<br>';
                    }
                }

                //Commit Transaction
                $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                $fce->Call();

                //Update SO
                if ($nomorso != '' && $j > 0) {
                    sleep(5); //seconds to wait..    
                    $fce = $sap->NewFunction("BAPI_SALESORDER_CHANGE");
                    $fce->SALESDOCUMENT = $nomorso; //"ZOR";
                    $fce->ORDER_HEADER_INX["UPDATEFLAG"] = 'U';
                    $fce->Call();

                    //Commit Transaction
                    $fce = $sap->NewFunction("BAPI_TRANSACTION_COMMIT");
                    $fce->Call();
                }

                if ($sales_org == '6000') {
                    sleep(5); //seconds to wait..
                    //Teks
                    unset($tgl_kirimapp);
                    for ($j = 0; $j <= $sampai - 1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $item_num1 = $_POST['com_line' . $j];
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopolisiv = $_POST['com_nopolisi' . $j];
                            $com_typetruckv = $_POST['com_typetruck' . $j];
                            $com_catatanv = $_POST['com_catatan' . $j];
                            $com_kodekantong = $_POST['com_viewkodebag' . $j];
                            $tgl_kirimappT = $_POST['com_tgl_kirim' . $j];
                            $com_viewdrivern = $_POST['com_viewdrivern' . $j];
                            $com_viewsimv = $_POST['com_viewsim' . $j];
                            list($day, $month, $year) = split("-", $tgl_kirimappT);
                            $tgl_kirimapp .= $year . $month . $day . "!";

                            $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                            $fce->I_VBELN = $nomorso; //'000010';
                            $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                            $fce->I_TEXT1 = $com_nopolisiv;
                            $fce->I_TEXT2 = $com_typetruckv;
                            $fce->I_TEXT3 = $com_catatanv;
                            $fce->I_TEXT4 = $com_kodekantong;
                            $fce->I_TEXT6 = $com_viewdrivern;
                            $fce->I_TEXT7 = $com_viewsimv;
                            $fce->Call();
                            // echo "<pre>";
                            // //print_r($fce);
                            // echo "</pre>";
                        }
                    }

                    if ($sales_org == '6000' && $nomorso != '') {
                        $aksicetak = "../or_laporan/cetak_so.php?noso=$nomorso&tgleq=$tgl_kirimapp";
                    }
                }

                //@liyantanto penambahan no ref pp
                if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000') {
                    sleep(5); //s
                    for ($j = 0; $j <= $sampai - 1; $j++) {
                        $idke = "idke" . $j;
                        if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                            $item_num1 = $_POST['com_line' . $j];
                            $item_num = $fungsi->linenum($item_num1);
                            $com_nopppref = trim($_POST['com_ppref' . $j]);

                            if ($com_nopppref != '' && $nomorso != '') {
                                $pputam = substr($com_nopppref, 0, 10);
                                $itempputam = @(substr($com_nopppref, 10, 6) / 10);
                                $sql_ppref = "
									select ID,NO_SO,ITEM_NUMBER,NO_PPREF from OR_TRANS_DTL where DELETE_MARK=0 
									and NO_PP='$pputam' 
									and ITEM_NUMBER='$itempputam'
									";
                                $query_ppref = oci_parse($conn, $sql_ppref);
                                oci_execute($query_ppref);
                                while ($row_ref = oci_fetch_array($query_ppref)) {
                                    $idPPREF = $row_ref[ID];
                                    $no_soref = $row_ref[NO_SO];
                                    $item_soref = $row_ref[ITEM_NUMBER];
                                }
                                $com_noppputam = $no_pp . sprintf("%06d", $item_num * 10);
                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                $fce->I_VBELN = $no_soref; //'000010';
                                $fce->I_POSNR = sprintf("%06d", $item_soref * 10); //'000010';
                                $fce->I_TEXT5 = $nomorso . sprintf("%06d", $item_num * 10); //pp ref
                                $fce->Call();

                                //update so pp ref
                                $field_namesppru = array('NO_PPREF');
                                $field_datapput = array("$com_noppputam");
                                $tablenamepput = "OR_TRANS_DTL";
                                $field_idpput = array('ID');
                                $value_idpput = array("$idPPREF");
                                $fungsi->update($conn, $field_namesppru, $field_datapput, $tablenamepput, $field_idpput, $value_idpput);

                                $nosoref = $no_soref . sprintf("%06d", $item_soref * 10);
                                $fce = $sap->NewFunction("Z_ZAPPSD_UPD_TEXT_VBAP");
                                $fce->I_VBELN = $nomorso; //'000010';
                                $fce->I_POSNR = sprintf("%06d", $item_num * 10); //'000010';
                                $fce->I_TEXT5 = $nosoref; //pp ref
                                $fce->Call();
                                // echo "<pre>";
                                // //print_r($fce);
                                // echo "</pre>";
                            }
                        }
                    }
                }
            }
            $fce->Close();
            $sap->Close();

            if (($nomorso != "") and ( $ada == 0))
                $status = "APPROVE";
            else
                $status = "PROCESS";
            //update data header
            $field_names = array('PLANT_ASAL', 'NAMA_PLANT', 'TERM_PAYMENT', 'STATUS', 'NAMA_TOP', 'SO_TYPE', 'NAMA_SO_TYPE', 'INCOTERM', 'NAMA_INCOTERM', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'ROUTE', 'PRICELIST', 'NAMA_PRICELIST', 'NO_KONTRAK_LC', 'KD_REASON', 'NM_REASON', 'ORG');
            $field_data = array("$plant", "$nama_plant", "$top", "$status", "$nama_top", "$so_type", "$nama_so_type", "$incoterm1", "$incoterm2", "SYSDATE", "$user_name_in", "$route", "$pricelist", "$nama_pricelist", "$lcnum", "$reason", "$nama_reason", "$sales_org");
            $tablename = "OR_TRANS_HDR";
            $field_id = array('ID');
            $value_id = array("$idh");
            $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
            // update data detail
            $sampai1 = $_POST['jumlah'];
            for ($k = 0; $k <= $sampai1; $k++) {
                $idke = "idke" . $k;
                if (isset($_POST[$idke]) and $_POST[$idke] != "") {
                    $id_dtl1 = $_POST['com_iddtl' . $k];
                    $qty1 = $_POST['com_qty' . $k];
                    $qtyx1 = $_POST['com_qtyx' . $k];
                    $kontrak = $_POST['com_kontrak' . $k];
                    $posnr = $_POST['com_posnr' . $k];
                    $kode_distrik = $_POST['com_distrik' . $k];
                    $tgl_kirim1 = $_POST['com_tgl_kirim' . $k];
                    $tgl_terima = $fungsi->tgl_terima($tgl_kirim1, $plant, $kode_distrik);
                    $item_numline1 = trim($_POST['com_line' . $k]);
                    $item_numline = $fungsi->linenum($item_numline1);
                    $com_kodekantong = $_POST['com_viewkodebag' . $k];

                    if (($nomorso != "") and ( $qty1 == $qtyx1))
                        $status1 = "APPROVE";
                    else
                        $status1 = "PROCESS";

                    $field_names = array('QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_TERIMA', 'NO_SO', 'STATUS_LINE', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'APPROVE_DATE', 'APPROVE_BY', 'NO_KONTRAK', 'PLANT', 'NM_PLANT', 'KODE_BAG');
                    $field_data = array("$qty1", "updtgl_$tgl_kirim1", "updtgl_$tgl_terima", "$nomorso", "$status1", "SYSDATE", "$user_name_in", "SYSDATE", "$user_name_in", "$kontrak", "$plant", "$nama_plant", "$com_kodekantong");
                    $tablename = "OR_TRANS_DTL";
                    $field_id = array('ID');
                    $value_id = array("$id_dtl1");
                    $fungsi->update($conn, $field_names, $field_data, $tablename, $field_id, $value_id);
                    if ($nomorso != "") {
                        $field_names1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', 'QTY_APPROVE', 'TGL_KIRIM_APPROVE', 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', 'STATUS_LINE', 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', 'APPROVE_DATE', 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                        $field_data1 = array('NO_PP', 'KODE_PRODUK', 'NAMA_PRODUK', 'QTY_PP', "$qty1", "instgl_$tgl_kirim1", 'TGL_KIRIM_PP', 'SHIP_TO', 'NAMA_SHIP_TO', 'ALAMAT_SHIP_TO', 'LAST_UPDATE_DATE', 'LAST_UPDATED_BY', 'DELETE_MARK', 'KODE_TUJUAN', 'NAMA_TUJUAN', "'APPROVE'", 'ITEM_NUMBER', 'NO_SO', 'NAMA_KAPAL', "SYSDATE", 'APPROVE_BY', 'KD_PROV', 'NM_PROV', 'UOM', 'PLANT', 'NM_PLANT');
                        $tablenamefrom = "OR_TRANS_DTL";
                        $tablenameto = "OR_TRANS_APP";
                        $field_id1 = array('ID');
                        $value_id1 = array("$id_dtl1");
                        $fungsi->insertinto($conn, $field_names1, $field_data1, $tablenameto, $tablenamefrom, $field_id1, $value_id1);

                        //@liyantanto update qty approve
                        if ($sales_org == '7000' || $sales_org == '2000' || $sales_org == '5000') {
                            $sql_qtya = "
								update OR_TRANS_DTL set QTY_APPROVE=(
										select sum(nvl(QTY_APPROVE,0)) as QTY from OR_TRANS_APP where NO_PP='$no_pp' and ITEM_NUMBER='$item_numline1'
										and DELETE_MARK=0 and STATUS_LINE='APPROVE'
								) where ID='$id_dtl1'
							";
                            $query_qtya = oci_parse($conn, $sql_qtya);
                            oci_execute($query_qtya);
                        }
                    }
                }
            }
            $show_ket .= 'Sales Order has been made with a number : ' . $nomorso;
            $pesan_telegram .= " Approve dengan no SO $nomorso (Approve By $user_name_in)";

            if ($sales_org == 4000) {
                botTelegram('-394888712', $pesan_telegram);
            }
        }

        if (isset($_POST['lasthalaman'])) {
            $habis = "smi_list_approveppsp.php";
        } else {
            $habis = "smi_list_approveppsp.php";
        }
        break;

  case 'buatsomki':
    // require './_formula_buatsomki.php';    
    require './_formula_buatsomki_with_po.php';    
    break;
  
  case 'edit_po_mki':
    require './_formula_edit_po_mki.php';    
    break;

}
?>
